(function(e){function t(t){for(var r,o,s=t[0],c=t[1],u=t[2],l=0,p=[];l<s.length;l++)o=s[l],Object.prototype.hasOwnProperty.call(i,o)&&i[o]&&p.push(i[o][0]),i[o]=0;for(r in c)Object.prototype.hasOwnProperty.call(c,r)&&(e[r]=c[r]);f&&f(t);while(p.length)p.shift()();return a.push.apply(a,u||[]),n()}function n(){for(var e,t=0;t<a.length;t++){for(var n=a[t],r=!0,s=1;s<n.length;s++){var c=n[s];0!==i[c]&&(r=!1)}r&&(a.splice(t--,1),e=o(o.s=n[0]))}return e}var r={},i={app:0},a=[];function o(t){if(r[t])return r[t].exports;var n=r[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,o),n.l=!0,n.exports}o.m=e,o.c=r,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/";var s=window["webpackJsonp"]=window["webpackJsonp"]||[],c=s.push.bind(s);s.push=t,s=s.slice();for(var u=0;u<s.length;u++)t(s[u]);var f=c;a.push([0,"chunk-vendors"]),n()})({0:function(e,t,n){e.exports=n("56d7")},"034f":function(e,t,n){"use strict";var r=n("13e9"),i=n.n(r);i.a},"13e9":function(e,t,n){},"278c":function(e,t,n){"use strict";var r=n("3e5c"),i=n.n(r);i.a},"3e5c":function(e,t,n){},"56d7":function(e,t,n){"use strict";n.r(t);var r,i,a=n("7b01"),o=n("951b"),s=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[n("select",{directives:[{name:"model",rawName:"v-model",value:e.presetName,expression:"presetName"}],on:{change:[function(t){var n=Array.prototype.filter.call(t.target.options,(function(e){return e.selected})).map((function(e){var t="_value"in e?e._value:e.value;return t}));e.presetName=t.target.multiple?n:n[0]},function(t){return e.onChange(t)}]}},e._l(e.presets,(function(t){return n("option",{domProps:{value:t.name,selected:t===e.presetName}},[e._v(e._s(t.name))])})),0),n("div",{ref:"scrollContainer",staticClass:"pathicles__scroll-container",style:{height:e.scrollHeight}},[n("div",{ref:"container",staticClass:"pathicles__container",style:e.cssStyles},[n("canvas",{ref:"canvas",style:e.cssStyles,attrs:{width:e.canvasWidth,height:e.canvasHeight}})])])])},c=[],u=n("c3dd");try{r=Map}catch(W){}try{i=Set}catch(W){}function f(e){if(!e||"object"!==typeof e||"function"===typeof e)return e;if(e.nodeType&&"cloneNode"in e)return e.cloneNode(!0);if(e instanceof Date)return new Date(e.getTime());if(e instanceof RegExp)return new RegExp(e);if(Array.isArray(e))return e.map(f);if(r&&e instanceof r)return new Map(Array.from(e.entries()));if(i&&e instanceof i)return new Set(Array.from(e.values()));if(e instanceof Object){var t={};for(var n in e)t[n]=f(e[n]);return t}return e}var l=f,p=[{name:"primitive",is:function(e){var t=typeof e;return"number"===t||"string"===t||"boolean"===t},default:"default",merge:{default:function(e,t,n){return n}}},{name:"object",is:function(e){return null!==e&&"object"===typeof e},default:"deep",merge:{deep:function(e,t,n){var r={},i={a:Object.keys(t),b:Object.keys(n)};return i.a.concat(i.b).forEach((function(i){r[i]=e(t[i],n[i])})),r}}},{name:"array",is:function(e){return Array.isArray(e)},default:"replace",merge:{merge:function(e,t,n){for(var r=[],i=0;i<Math.max(t.length,n.length);++i)r.push(e(t[i],n[i]));return r},replace:function(e,t,n){return l(n)},concat:function(e,t,n){return[].concat(t).concat(n)}}}],h=p;function d(e){return{strategy:e.strategy||{},types:{mode:(e.types||{}).mode||"add",list:(e.types||{}).list||[]}}}function m(e){e=d(e||{}),this.types=("add"===e.types.mode?h:[]).concat(e.types.list),this.config=e}m.prototype.determineType=function(e,t){for(var n=this.types.length-1;n>=0;--n){var r=this.types[n];if(r.is(e)&&r.is(t))return r;if(r.is(e)||r.is(t))break}return null},m.prototype.step=function(e,t){if(void 0===t)return l(e);var n=this.determineType(e,t);if(!n)return l(t);var r=this.config.strategy[n.name]||n.default;return n.merge[r](this.step.bind(this),e,t)},m.prototype.merge=function(){for(var e,t=Array.prototype.slice.call(arguments),n=t.length;n>0;--n)e=this.step(t.pop(),e);return e};var v=m,g=new v,b=function(){return g.merge.apply(g,arguments)};const y={MAX_CANVAS_SIZE:1024,MAX_PARTICLE_COUNT:512,MAX_BUFFER_LENGTH:256,logPushing:!1,logPerformance:!1,stats:!1,profile:!1,colors:[[.92,.75,0],[.12,.45,.65],[.12,.45,.65],[.77,.2,.2]],mass:[0,510998.94,510998.94,938272081],charge:[0,-1,1,1],chargeMassRatio:[0,-175882004556.243,175882004556.243,95788332.3113771],usePostProcessing:!1,pusher:"boris",runner:{prerender:!1,looping:!0,mode:"framewise",stepsPerTick:2,stepCount:256},model:{bufferLength:128,tickDurationOverC:.2,boundingBoxSize:-1,emitter:{particleType:"ELECTRON",randomize:!1,bunchShape:"disc",particleCount:256,particleSeparation:.1,gamma:0,position:[0,0,0],direction:[0,0,1],directionJitter:[0,0,0],positionJitter:[0,0,0]},interactions:{particleInteraction:!1,gravityConstant:0,electricField:[0,0,0],magneticField:[0,0,0]},lattice:{elements:{},beamline:[]}},view:{ssaoEnabled:!1,stageGrid:{resolution:256,y:-1,size:20,dark:1,light:.8},sky:[.9,1,0,1],shadowColor:[.3,.3,.3],ambientIntensity:.6,diffuse:0,exposure:.2,fresnel:1,fxaa:!1,rgbGamma:1,isStageVisible:!0,isShadowEnabled:!1,isLatticeVisible:!1,pathicleRelativeGap:1,pathicleRelativeHeight:5,pathicleWidth:.005,roughness:.7,specular:1,ssaoBlurPower:2,ssaoBlurRadius:.1,ssaoPower:1,ssaoSampleCount:32,showTextures:!1,texelSize:2,viewRange:[0,1],lights:[{position:[0,1,0],direction:[1,1,0],color:new Array(3).fill(0)},{position:[0,1,0],direction:[-1,-1,0],color:new Array(3).fill(0)}],camera:{center:[0,0,0],theta:Math.PI/2,phi:0,distance:10,fovY:Math.PI/2.5,dTheta:.01,autorotate:!0,rotateAboutCenter:!0,zoomAboutCursor:!1,zoomDecayTime:1,far:50,near:1e-4}},dumpData:!1},w={name:"story-dipole",view:{camera:{center:[0,.1,0],theta:2*Math.PI/4,phi:2*Math.PI/24,distance:5}},model:{emitter:{particleType:"ELECTRON",bunchShape:"SQUARE",direction:[0,.15,-1],position:[3.2,-1.5,0],directionJitter:[.05,0,.05],positionJitter:[.5,.5,.1],gamma:900},interactions:{magneticField:[0,.5,0],particleInteraction:!1},lattice:{elements:{l2:{type:"DRIF",l:0},bm:{type:"SBEN",angle:.78539816,e1:.39269908,e2:.39269908,l:10,k1:-.5}},beamline:[],origin:{phi:0,position:[-5,1,0]}}}},x={name:"story-electric",view:{camera:{center:[-2,0,0],theta:Math.PI/4,phi:0,distance:5}},model:{emitter:{particleType:"ELECTRON ELECTRON ELECTRON PROTON PROTON PROTON   PHOTON PHOTON PHOTON",bunchShape:"SQUARE",direction:[0,0,1],position:[0,1,-10],directionJitter:[.01,.01,0],positionJitter:[.1,.1,0],gamma:10},interactions:{electricField:[0,0,.001],particleInteraction:!1,magneticField:[0,0,0]},lattice:{elements:{l1:{type:"DRIF",l:3},q1:{type:"QUAD",k1:0,l:3},q2:{type:"QUAD",k1:-0,l:3},l2:{type:"DRIF",l:3}},beamline:["l1","q1","q2","l2"],origin:{phi:0,position:[0,1,-6]}}}},_={name:"story-quadrupole",view:{camera:{center:[0,1,0],theta:2*Math.PI/8,phi:2*Math.PI/72,distance:6}},model:{emitter:{bunchShape:"SQUARE_YZ",particleType:"ELECTRON ELECTRON ELECTRON PROTON ELECTRON ELECTRON ELECTRON ELECTRON PHOTON",position:[-5,1,0],direction:[1,0,0],directionJitter:[0,.1,.1],positionJitter:[0,.1,.1],gamma:1e3},lattice:{elements:{l1:{type:"DRIF",l:3},q1:{type:"QUAD",k1:-.05,l:3},q2:{type:"QUAD",k1:.15,l:3},l2:{type:"DRIF",l:3}},beamline:["l1","q1","q2","l2"],origin:{phi:-Math.PI/2,position:[-10,1,0]}}}},A={name:"random",view:{camera:{center:[0,0,0],theta:-.6163632477299,phi:.04608544417465289,distance:5}},model:{boundingBoxSize:2,emitter:{randomize:!0,gamma:100,particleType:"PHOTON ELECTRON PROTON"},lattice:{elements:{l2:{type:"DRIF",l:5},bm:{type:"SBEN",angle:.78539816,e1:.39269908,e2:.39269908,l:1.8,k1:-.4}},beamline:[],origin:{phi:-Math.PI,position:[0,1,5]}}}},E={name:"free-electron",view:{camera:{center:[0,0,0],theta:Math.PI/2,phi:0,distance:2,fovY:Math.PI/3,dTheta:.001,autorotate:!1,rotateAboutCenter:!0,zoomAboutCursor:!1,zoomDecayTime:1,far:50,near:1e-4}},runner:{prerender:!0,looping:!0,mode:"framewise",stepsPerTick:1,stepCount:10},model:{bufferLength:11,tickDurationOverC:.1,emitter:{particleCount:1,particleType:"ELECTRON",bunchShape:"SQUARE",direction:[0,0,1],position:[0,0,0],directionJitter:[0,0,0],positionJitter:[0,0,0],gamma:2},interactions:{electricField:[0,0,1],particleInteraction:!1,magneticField:[0,0,0]}}},T={name:"free-photon",view:{camera:{center:[0,-.5,0],theta:Math.PI/2,phi:Math.PI/4,distance:1,fovY:Math.PI/3,dTheta:.001,autorotate:!1,rotateAboutCenter:!0,zoomAboutCursor:!1,zoomDecayTime:1,far:50,near:1e-4}},runner:{prerender:!0,looping:!0,mode:"framewise",stepsPerTick:1,stepCount:10},model:{bufferLength:11,tickDurationOverC:.1,emitter:{particleCount:1,particleType:"PHOTON",bunchShape:"SQUARE",direction:[0,0,1],position:[0,0,0],directionJitter:[0,0,0],positionJitter:[0,0,0],gamma:10},interactions:{electricField:[0,0,.01],particleInteraction:!1,magneticField:[0,0,0]}}},C={name:"free-photons",view:{camera:{center:[0,0,0],theta:Math.PI/2,phi:0,distance:2,fovY:Math.PI/3,dTheta:.001,autorotate:!1,rotateAboutCenter:!0,zoomAboutCursor:!1,zoomDecayTime:1,far:50,near:1e-4}},runner:{prerender:!0,looping:!0,mode:"framewise",stepsPerTick:1,stepCount:8},model:{bufferLength:8,tickDurationOverC:.1,emitter:{particleCount:2,particleType:"PHOTON ELECTRON PROTON",bunchShape:"SQUARE",direction:[0,0,1],position:[0,-.5,0],directionJitter:[0,0,0],positionJitter:[0,0,0],gamma:1.1},interactions:{electricField:[0,0,.091],particleInteraction:!1,magneticField:[0,0,0]}}},O={[w.name]:w,[x.name]:x,[_.name]:_,[E.name]:E,[T.name]:T,[C.name]:C,[A.name]:A},P=e=>b(y,O[e])||y;var k=n("56ec"),D={name:"PathiclesSimulator",props:{maxScreenWidth:{type:Number,default:300},maxScreenHeight:{type:Number,default:600},scrollFactor:{type:Number,default:1},maxPixelRatio:{type:Number,default:2},pixelRatio:{type:Number,default:2}},data:()=>({screenWidth:600,screenHeight:600,progress:.5,cameraMode:"free",viewRange:[0,1],presets:O,presetName:"story-electric",config:{}}),computed:{scrollHeight(){return 100*this.scrollFactor+"vh"},cssStyles(){return{width:this.screenWidth+"px",height:this.screenHeight+"px"}},canvasWidth(){return this.screenWidth*this.pixelRatio},canvasHeight(){return this.screenHeight*this.pixelRatio}},mounted(){if("undefined"!==typeof window&&window.document){const e=new URL(window.location.href);null!==e.searchParams.get("presetName")&&(this.presetName=e.searchParams.get("presetName")),this.config=P(this.presetName),this._gui=this.initGui(P(this.presetName)),this.screenWidth=window.innerWidth,this.screenHeight=window.innerHeight,this.reglInstance=new u["a"]({canvas:this.$refs.canvas,config:this.config,pixelRatio:this.pixelRatio,simulate:!0,control:{viewRange:this.viewRange,progress:this.progress,cameraMode:this.cameraMode}})}this.$nextTick(()=>{this.scrollyHeight=this.$refs.scrollContainer.clientHeight})},destroyed(){"undefined"!==typeof window&&window.document&&(this.reglInstance.destroy(),this._gui.destroy())},methods:{handleResize(){this.scrollyHeight=document.documentElement.clientHeight},onChange(){const e={presetName:this.presetName};history.pushState({},null,this.$route.path+"?"+Object.keys(e).map(t=>encodeURIComponent(t)+"="+encodeURIComponent(e[t])).join("&")),this.config=P(this.presetName),this.reglInstance.loadConfig(this.config)},update(){this.reglInstance.loadConfig(this.config)},initGui(e){console.log(e);const t=this.guiDatValues={stepCount:128,tickDuration__c_1:.1,stepHistoryLength:128,ticksPerFrame:2,looping:e.runner.looping,prerender:e.runner.prerender,stepWise:e.runner.mode,particleType:e.model.emitter.particleType,bunchShape:e.model.emitter.bunchShape,particleCount:e.model.emitter.particleCount,electricField_z:e.model.interactions.electricField[2],magneticField_y:e.model.interactions.magneticField[1],electricFieldStrength:0,particleInteraction:!1,particleSeparation:.1},n=this.update,r=new k["a"]({width:300,closed:!1,closeOnTop:!1});return r.remember(this.guiDatValues),this.guiFolders={},this.controllers={},this.guiFolders.integrator=r.addFolder("Integrator"),this.guiFolders.integrator.add(t,"stepCount",0,512).step(1).onFinishChange(()=>{this.configuration=t}),this.guiFolders.integrator.add(t,"tickDuration__c_1",{".01/c":.01,".1/c":.1,".25/c":.25,".5/c":.5,".75/c":.75,"1/c":1}),this.guiFolders.integrator.add(t,"stepHistoryLength",0,512).step(2),this.guiFolders.integrator.add(t,"ticksPerFrame",1,10).step(1).onChange(()=>{}),this.controllers.looping=this.guiFolders.integrator.add(t,"looping").onChange(()=>{this._parentConfiguration.looping=t.looping}),this.controllers.stepWise=this.guiFolders.integrator.add(t,"stepWise").onChange(()=>{this._parentConfiguration.stepWise=t.stepWise}),this.guiFolders.bunch=r.addFolder("Bunch"),this.guiFolders.bunch.add(t,"particleCount",1,512).step(1),this.guiFolders.bunch.add(t,"particleType",{ELECTRON:"electrons",PROTON:"protons",PHOTON:"photons","PHOTON ELECTRON PROTON":"PHOTON ELECTRON PROTON"}),this.guiFolders.bunch.add(t,"bunchShape",{row:"ROW",square:"SQUARE"}),this.guiFolders.bunch.add(t,"particleSeparation",{".1 m":.1,"10 mm":.01,"20 mm":.02,"1 mm":.001,"1 µm":1e-6,"1 nm":1e-9}),this.guiFolders.interaction=r.addFolder("Interaction"),this.guiFolders.interaction.add(t,"particleInteraction").onFinishChange(()=>{n(t,!1)}),this.guiFolders.interaction.add(t,"electricField_z",{"0.0000001":1e-7,1e-6:1e-6,1e-5:1e-5,1e-4:1e-4,.001:.001,.01:.01,0:0,1:1,10:10,100:100,1e3:1e3,1e4:1e4,1e5:1e5,1e6:1e6,1e7:1e7,1e8:1e8}).onChange(()=>{n(t,!1)}),this.guiFolders.interaction.add(t,"magneticField_y",{".001":.001,".01":.01,".5":.5,".1":.1,0:0,1:1,10:10}).onChange(()=>{n(t,!1)}),r}}},M=D,S=(n("278c"),n("b41a")),z=Object(S["a"])(M,s,c,!1,null,null,null),F=z.exports,L=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[n("pathicles-story",{attrs:{story:e.story}})],1)},R=[],j={data(){return{story:{scenes:[{type:"caption",title:"<strong>Wir&nbsp;beschleunigen</strong>",subtitle_1_1:"<strong>Teilchen</strong> in&nbsp;unseren&nbsp;Berufen",subtitle_1_2:"<strong>und die Beschleunigerphysik</strong> im Berufsverband.",image:"/images/story/story-electric.jpg",pathicles:{preset:"story-loop",data:"story-electric.json",camera:{position:[-2,0,2],target:[2.5,0,-2.5]}}},{type:"caption",title:"Beschleunigung<br><strong>macht&nbsp;schneller</strong>.",body:'Elektrische Kräfte wirken sich auf Photonen, Elektronen und Protonen verschieden aus: Masselose <span class="photon">Photonen</span> sind immer mit Lichtgeschwindigkeit unterwegs, daran ändert auch eine Kraft nichts.  <span class="electron">Elektronen</span> werden rasch auf Fast-Lichtgeschwindigkeit beschleunigt, erreichen diese aber nie ganz. <span class="proton">Protonen</span> sind schwerer und brauchen etwas länger, um in Fahrt zu kommen.\n',image:"/images/story/story-electric.jpg",scene_index:1,pathicles:{preset:"story-electric",data:"story-electric.json",camera:{position:[-5,0,0],target:[0,0,0]}}},{type:"caption",title:"Beschleunigung<br><strong>hält&nbsp;auf&nbsp;Spur</strong>.",scene_index:2,body:"Magnetfelder wirken senkrecht zur Geschwindigkeit geladener Teilchen, die dadurch ihre Richtung ändern. Gleichförmige Magnetfelder führen zu einer Kreisbahn und kommen etwa in Ringbeschleunigern zum Einsatz.\n",image:"/images/story/story-dipole.jpg",pathicles:{preset:"story-dipole",data:"story-dipole.json",camera:{position:[0,0,-10],target:[0,0,0]}}},{type:"caption",title:"Beschleunigung<br><strong>schafft Zusammenhalt</strong>.",scene_index:3,body:"Magnetfelder, deren Stärke mit Abstand zur optimalen Teilchenbahn zunimmt, wirken wie optische Linsen: In einer Ebene bringen sie die Teilchen zusammen, in der dazu senkrechten Ebene jedoch auseinander. In modernen Beschleunigern sorgen hunderte solcher Bündelungsmagnete für den Zusammenhalt.\n",image:"/images/story/story-quadrupole.jpg",pathicles:{preset:"story-quadrupole",data:"story-quadrupole.json",camera:{position:[10,0,-1],target:[0,0,-1]}}},{type:"options",pathicles:{preset:"story-empty",camera:{position:[1,5,0],target:[-1,0,0]}}}]}}}},B=j,I=Object(S["a"])(B,L,R,!1,null,null,null),N=I.exports;a["a"].use(o["a"]);var V=new o["a"]({mode:"history",routes:[{path:"/simulator/",component:F},{path:"/story/",component:N}]}),U=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{attrs:{id:"app"}},[n("router-view",{key:e.$route.fullPath}),e.printMode?e._e():n("nav")],1)},H=[],q={name:"App",computed:{printMode:function(){const e=new URL(window.location.href);return null!==e.searchParams.get("print")}}},Y=q,G=(n("034f"),Object(S["a"])(Y,U,H,!1,null,null,null)),Q=G.exports;a["a"].config.productionTip=!1,a["a"].directive("scroll",{inserted:function(e,t){let n=function(r){t.value(r,e)&&window.removeEventListener("scroll",n)};window.addEventListener("scroll",n)}}),new a["a"]({router:V,render:e=>e(Q)}).$mount("#app")},c3dd:function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return _r}));var r=n("f8e2"),i=n.n(r),a=n("498f"),o=n.n(a),s=c;function c(e,t,n){var r=t[0],i=t[1],a=t[2],o=n[3]*r+n[7]*i+n[11]*a+n[15];return o=o||1,e[0]=(n[0]*r+n[4]*i+n[8]*a+n[12])/o,e[1]=(n[1]*r+n[5]*i+n[9]*a+n[13])/o,e[2]=(n[2]*r+n[6]*i+n[10]*a+n[14])/o,e}var u=f;function f(e,t,n,r){var i=n[0],a=n[2],o=t[0]-i,s=t[2]-a,c=Math.sin(r),u=Math.cos(r);return e[0]=i+s*c+o*u,e[1]=t[1],e[2]=a+s*u-o*c,e}var l=p;function p(e,t,n,r){var i=n[1],a=n[2],o=t[1]-i,s=t[2]-a,c=Math.sin(r),u=Math.cos(r);return e[0]=t[0],e[1]=i+o*u-s*c,e[2]=a+o*c+s*u,e}var h=1e-6,d=m;function m(e,t){var n=e[0],r=e[1],i=e[2],a=t[0],o=t[1],s=t[2];return Math.abs(n-a)<=h*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(r-o)<=h*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-s)<=h*Math.max(1,Math.abs(i),Math.abs(s))}var v=g;function g(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e}var b=y;function y(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e}var w=x;function x(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}var _=A;function A(e,t){var n=t[0],r=t[1],i=t[2],a=n*n+r*r+i*i;return a>0&&(a=1/Math.sqrt(a),e[0]=t[0]*a,e[1]=t[1]*a,e[2]=t[2]*a),e}var E=T;function T(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}var C=O;function O(e,t){var n=t[0],r=t[1],i=t[2],a=t[3],o=t[4],s=t[5],c=t[6],u=t[7],f=t[8],l=t[9],p=t[10],h=t[11],d=t[12],m=t[13],v=t[14],g=t[15],b=n*s-r*o,y=n*c-i*o,w=n*u-a*o,x=r*c-i*s,_=r*u-a*s,A=i*u-a*c,E=f*m-l*d,T=f*v-p*d,C=f*g-h*d,O=l*v-p*m,P=l*g-h*m,k=p*g-h*v,D=b*k-y*P+w*O+x*C-_*T+A*E;return D?(D=1/D,e[0]=(s*k-c*P+u*O)*D,e[1]=(i*P-r*k-a*O)*D,e[2]=(m*A-v*_+g*x)*D,e[3]=(p*_-l*A-h*x)*D,e[4]=(c*C-o*k-u*T)*D,e[5]=(n*k-i*C+a*T)*D,e[6]=(v*w-d*A-g*y)*D,e[7]=(f*A-p*w+h*y)*D,e[8]=(o*P-s*C+u*E)*D,e[9]=(r*C-n*P-a*E)*D,e[10]=(d*_-m*w+g*b)*D,e[11]=(l*w-f*_-h*b)*D,e[12]=(s*T-o*O-c*E)*D,e[13]=(n*O-r*T+i*E)*D,e[14]=(m*y-d*x-v*b)*D,e[15]=(f*x-l*y+p*b)*D,e):null}var P=k;function k(e,t,n){var r,i,a,o,s,c,u,f,l,p,h,d,m=n[0],v=n[1],g=n[2];return t===e?(e[12]=t[0]*m+t[4]*v+t[8]*g+t[12],e[13]=t[1]*m+t[5]*v+t[9]*g+t[13],e[14]=t[2]*m+t[6]*v+t[10]*g+t[14],e[15]=t[3]*m+t[7]*v+t[11]*g+t[15]):(r=t[0],i=t[1],a=t[2],o=t[3],s=t[4],c=t[5],u=t[6],f=t[7],l=t[8],p=t[9],h=t[10],d=t[11],e[0]=r,e[1]=i,e[2]=a,e[3]=o,e[4]=s,e[5]=c,e[6]=u,e[7]=f,e[8]=l,e[9]=p,e[10]=h,e[11]=d,e[12]=r*m+s*v+l*g+t[12],e[13]=i*m+c*v+p*g+t[13],e[14]=a*m+u*v+h*g+t[14],e[15]=o*m+f*v+d*g+t[15]),e}var D=M;function M(e,t,n){var r=n[0],i=n[1],a=n[2];return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*a,e[9]=t[9]*a,e[10]=t[10]*a,e[11]=t[11]*a,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}var S=z;function z(e,t,n,r){var i,a,o,s,c,u,f,l,p,h,d=t[0],m=t[1],v=t[2],g=r[0],b=r[1],y=r[2],w=n[0],x=n[1],_=n[2];return Math.abs(d-w)<1e-6&&Math.abs(m-x)<1e-6&&Math.abs(v-_)<1e-6?E(e):(f=d-w,l=m-x,p=v-_,h=1/Math.sqrt(f*f+l*l+p*p),f*=h,l*=h,p*=h,i=b*p-y*l,a=y*f-g*p,o=g*l-b*f,h=Math.sqrt(i*i+a*a+o*o),h?(h=1/h,i*=h,a*=h,o*=h):(i=0,a=0,o=0),s=l*o-p*a,c=p*i-f*o,u=f*a-l*i,h=Math.sqrt(s*s+c*c+u*u),h?(h=1/h,s*=h,c*=h,u*=h):(s=0,c=0,u=0),e[0]=i,e[1]=s,e[2]=f,e[3]=0,e[4]=a,e[5]=c,e[6]=l,e[7]=0,e[8]=o,e[9]=u,e[10]=p,e[11]=0,e[12]=-(i*d+a*m+o*v),e[13]=-(s*d+c*m+u*v),e[14]=-(f*d+l*m+p*v),e[15]=1,e)}var F=L;function L(e,t,n,r,i){var a=1/Math.tan(t/2),o=1/(r-i);return e[0]=a/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(i+r)*o,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*i*r*o,e[15]=0,e}var R=.5*Math.PI-1e-4,j=.5*-Math.PI+1e-4,B=function(e){e=e||{};var t=!0,n={aspectRatio:e.aspectRatio?e.aspectRatio:1,zoomAboutCursor:void 0===e.zoomAboutCursor||e.zoomAboutCursor,distance:void 0===e.distance?10:e.distance,phi:void 0===e.phi?0:e.phi,theta:void 0===e.theta?0:e.theta,fovY:void 0===e.fovY?Math.PI/4:e.fovY,near:void 0===e.near?.1:e.near,far:void 0===e.far?100:e.far,panDecayTime:e.panDecayTime||100,zoomDecayTime:e.zoomDecayTime||100,rotationDecayTime:e.rotationDecayTime||100,dirty:!0,up:e.up||new Float32Array([0,1,0]),center:e.center||new Float32Array(3),rotationCenter:e.rotationCenter||e.center&&e.center.slice()||new Float32Array(3),zoom:0,panX:0,panY:0,panZ:0,pitch:0,yaw:0,dTheta:0,dPhi:0,mouseX:0,mouseY:0},r=null,i={tick:function(e){if(B.zoom&&(n.zoom=B.zoom),B.dTheta&&(n.dTheta=B.dTheta),B.dPhi&&(n.dPhi=B.dPhi),B.panX&&(n.panX=B.panX),B.panY&&(n.panY=B.panY),B.panZ&&(n.panZ=B.panZ),B.yaw&&(n.yaw=B.yaw),B.pitch&&(n.pitch=B.pitch),z(B),e){var a=n.dPhi,o=n.dTheta,s=n.zoom,c=n.panX,u=n.panY,f=n.panZ,l=n.pitch,p=n.yaw;Object.assign(n,e),void 0!==e.dPhi&&(n.dPhi+=a),void 0!==e.dTheta&&(n.dTheta+=o),void 0!==e.zoom&&(n.zoom+=s),void 0!==e.panX&&(n.panX+=c),void 0!==e.panY&&(n.panY+=u),void 0!==e.panZ&&(n.panZ+=f),void 0!==e.pitch&&(n.pitch+=l),void 0!==e.yaw&&(n.yaw+=p)}y()&&A(),M()?H(n):z(n);var h=Date.now();null!==r&&L(h-r),r=h,i.state.dirty=t,t=!1,g()},taint:O,resize:k,params:n,rotate:U,pivot:V,pan:I,zoom:N,state:{}};i.state.projection=new Float32Array(16),i.state.viewInv=new Float32Array(16),i.state.view=new Float32Array(16),i.state.width=null,i.state.height=null,i.state.eye=new Float32Array(3);var a=new Float32Array(3),o=new Float32Array(3),c=new Float32Array(3),f=new Float32Array(3),p=new Float32Array(3),h=new Float32Array(16),m={up:new Float32Array(3),center:new Float32Array(3)};function g(){w(m.up,n.up),w(m.center,n.center),m.near=n.near,m.far=n.far,m.distance=n.distance,m.phi=n.phi,m.theta=n.theta,m.fovY=n.fovY}function y(){return!d(n.up,m.up)||(!d(n.center,m.center)||(n.near!==m.near||(n.far!==m.far||(n.phi!==m.phi||(n.theta!==m.theta||(n.distance!==m.distance||n.fovY!==m.fovY))))))}g();var x={};function A(){x.dPhi=n.phi-m.phi,x.dTheta=n.theta-m.theta,x.zoom=n.distance/m.distance-1,n.theta=m.theta,n.distance=m.distance,n.phi=m.phi,x.yaw=0,x.pitch=0,x.panX=0,x.panY=0,x.panZ=0,x.mouseX=0,x.mouseY=0,H(x)}function T(){i.state.eye[0]=0,i.state.eye[1]=0,i.state.eye[2]=n.distance,l(i.state.eye,i.state.eye,p,-n.phi),u(i.state.eye,i.state.eye,p,n.theta),v(i.state.eye,i.state.eye,n.center),S(i.state.view,i.state.eye,n.center,n.up),F(i.state.projection,n.fovY,i.params.aspectRatio,n.near,n.far),C(i.state.viewInv,i.state.view)}function O(){t=!0}function k(e){i.params.aspectRatio=e,T(),O()}function M(){return Math.abs(n.zoom)>1e-4||(Math.abs(n.panX)>1e-4||(Math.abs(n.panY)>1e-4||(Math.abs(n.panZ)>1e-4||(Math.abs(n.dTheta)>1e-4||(Math.abs(n.dPhi)>1e-4||(Math.abs(n.yaw)>1e-4||(Math.abs(n.pitch)>1e-4||void 0)))))))}function z(e){e.zoom=0,e.dTheta=0,e.dPhi=0,e.panX=0,e.panY=0,e.panZ=0,e.yaw=0,e.pitch=0}function L(e){var t=n.panDecayTime?Math.exp(-e/n.panDecayTime/Math.LN2):0,r=n.zoomDecayTime?Math.exp(-e/n.zoomDecayTime/Math.LN2):0,i=n.rotationDecayTime?Math.exp(-e/n.rotationDecayTime/Math.LN2):0;n.zoom*=r,n.panX*=t,n.panY*=t,n.panZ*=t,n.dTheta*=i,n.dPhi*=i,n.yaw*=i,n.pitch*=i}var B={};function I(e,t){var r=i.params.distance*Math.tan(.5*i.params.fovY)*2;return B.panX+=e*n.aspectRatio*r,B.panY+=t*r,i}function N(e,t,r){return B.zoom+=r,n.mouseX=e,n.mouseY=t,i}function V(e,t){var r=i.params.fovY;B.yaw+=e*r*n.aspectRatio,B.pitch+=t*r}function U(e,t){B.dTheta+=e,B.dPhi+=t}function H(e){var t;E(h),n.zoomAboutCursor&&(t=n.distance*Math.tan(.5*n.fovY),a[0]=e.mouseX*n.aspectRatio*t,a[1]=e.mouseY*t,a[2]=0,P(h,h,a)),a[0]=1+e.zoom,a[1]=1+e.zoom,a[2]=1,D(h,h,a),n.zoomAboutCursor&&(t=n.distance*Math.tan(.5*n.fovY),a[0]=-e.mouseX*n.aspectRatio*t,a[1]=-e.mouseY*t,a[2]=0,P(h,h,a)),h[12]-=.5*e.panX,h[13]-=.5*e.panY,s(n.center,n.center,i.state.view),s(n.center,n.center,h),s(n.center,n.center,i.state.viewInv),n.rotateAboutCenter&&w(n.rotationCenter,n.center),n.distance*=1+e.zoom;var r=n.phi;n.phi+=e.dPhi,n.phi=Math.min(R,Math.max(j,n.phi));var p=n.phi-r,d=n.theta;n.theta+=e.dTheta;var m=n.theta-d;if(u(n.center,n.center,n.rotationCenter,m-n.theta),l(n.center,n.center,n.rotationCenter,-p),u(n.center,n.center,n.rotationCenter,n.theta),0!==e.yaw||0!==e.pitch){c[0]=i.state.view[0],c[1]=i.state.view[4],c[2]=i.state.view[8],_(c,c),o[0]=i.state.view[1],o[1]=i.state.view[5],o[2]=i.state.view[9],_(o,o),f[0]=i.state.view[2],f[1]=i.state.view[6],f[2]=i.state.view[10],_(f,f);var v=Math.min(R,Math.max(j,n.phi+.5*e.pitch)),g=v-n.phi;b(n.center,n.center,c,-Math.sin(.5*e.yaw)*n.distance),b(n.center,n.center,o,-Math.sin(g)*n.distance),b(n.center,n.center,f,(2-Math.cos(.5*e.yaw)-Math.cos(g))*n.distance),n.phi=v,n.theta+=.5*e.yaw}T(),O()}return z(B),k(i.params.aspectRatio),i};function I(e){if("object"===typeof e){if("buttons"in e)return e.buttons;if("which"in e){var t=e.which;if(2===t)return 4;if(3===t)return 2;if(t>0)return 1<<t-1}else if("button"in e){t=e.button;if(1===t)return 4;if(2===t)return 2;if(t>=0)return 1<<t}}return 0}var N=I;function V(e){return e.target||e.srcElement||window}var U=V;function H(e){if("object"===typeof e){if("offsetX"in e)return e.offsetX;var t=V(e),n=t.getBoundingClientRect();return e.clientX-n.left}return 0}var q=H;function Y(e){if("object"===typeof e){if("offsetY"in e)return e.offsetY;var t=V(e),n=t.getBoundingClientRect();return e.clientY-n.top}return 0}var G=Y,Q={buttons:N,element:U,x:q,y:G},W=X;function X(e,t){t||(t=e,e=window);var n=0,r=0,i=0,a={shift:!1,alt:!1,control:!1,meta:!1},o=!1;function s(e){var t=!1;return"altKey"in e&&(t=t||e.altKey!==a.alt,a.alt=!!e.altKey),"shiftKey"in e&&(t=t||e.shiftKey!==a.shift,a.shift=!!e.shiftKey),"ctrlKey"in e&&(t=t||e.ctrlKey!==a.control,a.control=!!e.ctrlKey),"metaKey"in e&&(t=t||e.metaKey!==a.meta,a.meta=!!e.metaKey),t}function c(e,o){var c=Q.x(o),u=Q.y(o);"buttons"in o&&(e=0|o.buttons),(e!==n||c!==r||u!==i||s(o))&&(n=0|e,r=c||0,i=u||0,t&&t(n,r,i,a))}function u(e){c(0,e)}function f(){(n||r||i||a.shift||a.alt||a.meta||a.control)&&(r=i=0,n=0,a.shift=a.alt=a.control=a.meta=!1,t&&t(0,0,0,a))}function l(e){s(e)&&t&&t(n,r,i,a)}function p(e){0===Q.buttons(e)?c(0,e):c(n,e)}function h(e){c(n|Q.buttons(e),e)}function d(e){c(n&~Q.buttons(e),e)}function m(){o||(o=!0,e.addEventListener("mousemove",p),e.addEventListener("mousedown",h),e.addEventListener("mouseup",d),e.addEventListener("mouseleave",u),e.addEventListener("mouseenter",u),e.addEventListener("mouseout",u),e.addEventListener("mouseover",u),e.addEventListener("blur",f),e.addEventListener("keyup",l),e.addEventListener("keydown",l),e.addEventListener("keypress",l),e!==window&&(window.addEventListener("blur",f),window.addEventListener("keyup",l),window.addEventListener("keydown",l),window.addEventListener("keypress",l)))}function v(){o&&(o=!1,e.removeEventListener("mousemove",p),e.removeEventListener("mousedown",h),e.removeEventListener("mouseup",d),e.removeEventListener("mouseleave",u),e.removeEventListener("mouseenter",u),e.removeEventListener("mouseout",u),e.removeEventListener("mouseover",u),e.removeEventListener("blur",f),e.removeEventListener("keyup",l),e.removeEventListener("keydown",l),e.removeEventListener("keypress",l),e!==window&&(window.removeEventListener("blur",f),window.removeEventListener("keyup",l),window.removeEventListener("keydown",l),window.removeEventListener("keypress",l)))}m();var g={element:e};return Object.defineProperties(g,{enabled:{get:function(){return o},set:function(e){e?m():v()},enumerable:!0},buttons:{get:function(){return n},enumerable:!0},x:{get:function(){return r},enumerable:!0},y:{get:function(){return i},enumerable:!0},mods:{get:function(){return a},enumerable:!0}}),g}var J={left:0,top:0},Z=$;function $(e,t,n){t=t||e.currentTarget||e.srcElement,Array.isArray(n)||(n=[0,0]);var r=e.clientX||0,i=e.clientY||0,a=K(t);return n[0]=r-a.left,n[1]=i-a.top,n}function K(e){return e===window||e===document||e===document.body?J:e.getBoundingClientRect()}function ee(e,t){return t={exports:{}},e(t,t.exports),t.exports}var te=void 0,ne=function(e){return e!==te&&null!==e},re={object:!0,function:!0,undefined:!0},ie=function(e){return!!ne(e)&&hasOwnProperty.call(re,typeof e)},ae=function(e){if(!ie(e))return!1;try{return!!e.constructor&&e.constructor.prototype===e}catch(_n){return!1}},oe=function(e){if("function"!==typeof e)return!1;if(!hasOwnProperty.call(e,"length"))return!1;try{if("number"!==typeof e.length)return!1;if("function"!==typeof e.call)return!1;if("function"!==typeof e.apply)return!1}catch(_n){return!1}return!ae(e)},se=/^\s*class[\s{/}]/,ce=Function.prototype.toString,ue=function(e){return!!oe(e)&&!se.test(ce.call(e))},fe=function(){var e,t=Object.assign;return"function"===typeof t&&(e={foo:"raz"},t(e,{bar:"dwa"},{trzy:"trzy"}),e.foo+e.bar+e.trzy==="razdwatrzy")},le=function(){try{return Object.keys("primitive"),!0}catch(e){return!1}},pe=function(){},he=pe(),de=function(e){return e!==he&&null!==e},me=Object.keys,ve=function(e){return me(de(e)?Object(e):e)},ge=le()?Object.keys:ve,be=function(e){if(!de(e))throw new TypeError("Cannot use null or undefined");return e},ye=Math.max,we=function(e,t){var n,r,i,a=ye(arguments.length,2);for(e=Object(be(e)),i=function(r){try{e[r]=t[r]}catch(i){n||(n=i)}},r=1;r<a;++r)t=arguments[r],ge(t).forEach(i);if(void 0!==n)throw n;return e},xe=fe()?Object.assign:we,_e=Array.prototype.forEach,Ae=Object.create,Ee=function(e,t){var n;for(n in e)t[n]=e[n]},Te=function(e){var t=Ae(null);return _e.call(arguments,(function(e){de(e)&&Ee(Object(e),t)})),t},Ce="razdwatrzy",Oe=function(){return"function"===typeof Ce.contains&&(!0===Ce.contains("dwa")&&!1===Ce.contains("foo"))},Pe=String.prototype.indexOf,ke=function(e){return Pe.call(this,e,arguments[1])>-1},De=Oe()?String.prototype.contains:ke,Me=ee((function(e){var t=e.exports=function(e,t){var n,r,i,a,o;return arguments.length<2||"string"!==typeof e?(a=t,t=e,e=null):a=arguments[2],ne(e)?(n=De.call(e,"c"),r=De.call(e,"e"),i=De.call(e,"w")):(n=i=!0,r=!1),o={value:t,configurable:n,enumerable:r,writable:i},a?xe(Te(a),o):o};t.gs=function(e,t,n){var r,i,a,o;return"string"!==typeof e?(a=n,n=t,t=e,e=null):a=arguments[3],ne(t)?ue(t)?ne(n)?ue(n)||(a=n,n=void 0):n=void 0:(a=t,t=n=void 0):t=void 0,ne(e)?(r=De.call(e,"c"),i=De.call(e,"e")):(r=!0,i=!1),o={get:t,set:n,configurable:r,enumerable:i},a?xe(Te(a),o):o}})),Se=function(e){if("function"!==typeof e)throw new TypeError(e+" is not a function");return e},ze=ee((function(e,t){var n,r,i,a,o,s,c,u=Function.prototype.apply,f=Function.prototype.call,l=Object.create,p=Object.defineProperty,h=Object.defineProperties,d=Object.prototype.hasOwnProperty,m={configurable:!0,enumerable:!1,writable:!0};n=function(e,t){var n;return Se(t),d.call(this,"__ee__")?n=this.__ee__:(n=m.value=l(null),p(this,"__ee__",m),m.value=null),n[e]?"object"===typeof n[e]?n[e].push(t):n[e]=[n[e],t]:n[e]=t,this},r=function(e,t){var r,a;return Se(t),a=this,n.call(this,e,r=function(){i.call(a,e,r),u.call(t,this,arguments)}),r.__eeOnceListener__=t,this},i=function(e,t){var n,r,i,a;if(Se(t),!d.call(this,"__ee__"))return this;if(n=this.__ee__,!n[e])return this;if(r=n[e],"object"===typeof r)for(a=0;i=r[a];++a)i!==t&&i.__eeOnceListener__!==t||(2===r.length?n[e]=r[a?0:1]:r.splice(a,1));else r!==t&&r.__eeOnceListener__!==t||delete n[e];return this},a=function(e){var t,n,r,i,a;if(d.call(this,"__ee__")&&(i=this.__ee__[e],i))if("object"===typeof i){for(n=arguments.length,a=new Array(n-1),t=1;t<n;++t)a[t-1]=arguments[t];for(i=i.slice(),t=0;r=i[t];++t)u.call(r,this,a)}else switch(arguments.length){case 1:f.call(i,this);break;case 2:f.call(i,this,arguments[1]);break;case 3:f.call(i,this,arguments[1],arguments[2]);break;default:for(n=arguments.length,a=new Array(n-1),t=1;t<n;++t)a[t-1]=arguments[t];u.call(i,this,a)}},o={on:n,once:r,off:i,emit:a},s={on:Me(n),once:Me(r),off:Me(i),emit:Me(a)},c=h({},s),e.exports=t=function(e){return null==e?l(c):h(Object(e),s)},t.methods=o})),Fe=(ze.methods,Le);function Le(e){e=e||window;var t,n,r,i,a=ze(),o=[null,null],s=[null,null],c=[null,null],u=[null,null],f=0,l={},p=e===window?function(){t=window.innerWidth,n=window.innerHeight}:function(){t=e.clientWidth,n=e.clientHeight},h=0,d={},m=W(e,(function(e,t,n,a){r=t,i=n,h=e,d=a}));function v(r){Z(r,e,c),p(),l.buttons=h,l.mods=d,l.x0=l.x=l.x1=2*c[0]/t-1,l.y0=l.y=l.y1=1-2*c[1]/n,l.x2=null,l.y2=null,l.dx=2*r.deltaX/t,l.dy=-2*r.deltaY/n,l.dz=2*r.deltaZ/t,l.active=1,l.zoomx=1,l.zoomy=1,l.theta=0,l.dtheta=0,l.originalEvent=r,a.emit("wheel",l),o[0]=c[0],o[1]=c[1]}var g=null,b=null,y=0;function w(r){Z(r,e,c),y=0,p(),l.buttons=h,l.mods=d,l.x=l.x1=2*c[0]/t-1,l.y=l.y1=1-2*c[1]/n,l.x2=null,l.y2=null,l.active=y,l.x0=2*g/t-1,l.y0=1-2*b/n,l.dx=0,l.dy=0,l.dz=0,l.zoomx=1,l.zoomy=1,l.theta=0,l.dtheta=0,l.originalEvent=r,a.emit("mouseup",l),g=b=null,o[0]=c[0],o[1]=c[1]}function x(s){Z(s,e,c),y=1,p(),g=r,b=i,l.buttons=h,l.mods=d,l.x=l.x0=l.x1=2*c[0]/t-1,l.y=l.y0=l.y1=1-2*c[1]/n,l.x2=null,l.y2=null,l.active=y,l.dx=0,l.dy=0,l.dz=0,l.zoomx=1,l.zoomy=1,l.theta=0,l.dtheta=0,l.originalEvent=s,a.emit("mousedown",l),o[0]=c[0],o[1]=c[1]}function _(r){Z(r,e,c),p(),l.buttons=h,l.mods=d,l.x0=2*g/t-1,l.y0=1-2*b/n,l.x=l.x1=2*c[0]/t-1,l.y=l.y1=1-2*c[1]/n,l.x2=null,l.y2=null,l.dx=2*(c[0]-o[0])/t,l.dy=-2*(c[1]-o[1])/n,l.active=y,l.dz=0,l.zoomx=1,l.zoomy=1,l.theta=0,l.dtheta=0,l.originalEvent=r,a.emit("mousemove",l),o[0]=c[0],o[1]=c[1]}function A(e){for(var t=e.identifier,n=0;n<u.length;n++)if(u[n]&&u[n].touch&&u[n].touch.identifier===t)return n;return-1}function E(r){s[0]=null,s[1]=null;for(var i=0;i<r.changedTouches.length;i++){var o=r.changedTouches[i],c=o.identifier,h=A(c);if(-1===h&&f<2){var d=u[0]?1:0,m=u[0]?0:1,v={position:[0,0],touch:null};u[d]=v,f++,v.touch=o,Z(o,e,v.position);u[m]&&u[m].touch}}var y=0,w=0,x=0;for(i=0;i<u.length;i++)u[i]&&(y+=u[i].position[0],w+=u[i].position[1],x++);if(y/=x,w/=x,f>0){if(l.theta=0,x>1){var _=u[1].position[0]-u[0].position[0],E=(u[0].position[1]-u[1].position[1])*t/n;l.theta=Math.atan2(E,_)}p(),l.buttons=0,l.mods={},l.active=f,g=y,b=w,l.x0=2*g/t-1,l.y0=1-2*b/n,l.x=2*y/t-1,l.y=1-2*w/n,l.x1=2*u[0].position[0]/t-1,l.y1=1-2*u[0].position[1]/n,f>1&&(l.x2=2*u[1].position[0]/t-1,l.y2=1-2*u[1].position[1]/n),l.active=f,l.dx=0,l.dy=0,l.dz=0,l.zoomx=1,l.zoomy=1,l.dtheta=0,l.originalEvent=r,a.emit(1===f?"touchstart":"pinchstart",l)}}function T(r){for(var i,o=!1,c=0;c<r.changedTouches.length;c++){var p=r.changedTouches[c];i=A(p),-1!==i&&(o=!0,u[i].touch=p,Z(p,e,u[i].position))}if(o)if(1===f){for(i=0;i<u.length;i++)if(u[i])break;if(u[i]&&s[i]){var h=u[i].position[0],m=u[i].position[1],v=h-s[i][0],y=m-s[i][1];l.buttons=0,l.mods={},l.active=f,l.x=l.x1=2*h/t-1,l.y=l.y1=1-2*m/n,l.x2=null,l.y2=null,l.x0=2*g/t-1,l.y0=1-2*b/n,l.dx=2*v/t,l.dy=-2*y/n,l.dz=0,l.zoomx=1,l.zoomy=1,l.theta=0,l.dtheta=0,l.originalEvent=r,a.emit("touchmove",l)}}else if(2===f&&s[0]&&s[1]){var w=s[0],x=s[1],_=x[0]-w[0],E=(x[1]-w[1])*t/n,T=u[0].position,C=u[1].position,O=C[0]-T[0],P=(T[1]-C[1])*t/n,k=.5*Math.sqrt(_*_+E*E),D=Math.atan2(E,_),M=.5*Math.sqrt(O*O+P*P),S=Math.atan2(P,O),z=.5*(x[0]+w[0]),F=.5*(x[1]+w[1]),L=(v=.5*(C[0]+T[0]-w[0]-x[0]),y=.5*(C[1]+T[1]-w[1]-x[1]),M/k),R=S-D;l.buttons=0,l.mods=d,l.active=f,l.x=2*z/t-1,l.y=1-2*F/n,l.x0=2*g/t-1,l.y0=1-2*b/n,l.x1=2*T[0]/t-1,l.y1=1-2*T[1]/n,l.x2=2*C[0]/t-1,l.y2=1-2*C[1]/n,l.dx=2*v/t,l.dy=-2*y/n,l.dz=0,l.zoomx=L,l.zoomy=L,l.theta=S,l.dtheta=R,l.originalEvent=r,a.emit("pinchmove",l)}u[0]&&(s[0]=u[0].position.slice()),u[1]&&(s[1]=u[1].position.slice())}function C(e){for(var r,i=0;i<e.changedTouches.length;i++){var o=e.changedTouches[i],s=A(o);if(-1!==s){r=u[s],u[s]=null,f--;var c=0===s?1:0;u[c]&&u[c].touch}}var p=0,h=0;if(0===f)r&&(p=r.position[0],h=r.position[1]);else{var m=0;for(i=0;i<u.length;i++)u[i]&&(p+=u[i].position[0],h+=u[i].position[1],m++);p/=m,h/=m}f<2&&(l.buttons=0,l.mods=d,l.active=f,l.x=2*p/t-1,l.y=1-2*h/n,l.x0=2*g/t-1,l.y0=1-2*b/n,l.dx=0,l.dy=0,l.dz=0,l.zoomx=1,l.zoomy=1,l.theta=0,l.dtheta=0,l.originalEvent=e,a.emit(0===f?"touchend":"pinchend",l)),0===f&&(g=b=null)}var O=!1;function P(){O||(O=!0,m.enabled=!0,e.addEventListener("wheel",v,!1),e.addEventListener("mousedown",x,!1),window.addEventListener("mousemove",_,!1),window.addEventListener("mouseup",w,!1),e.addEventListener("touchstart",E,!1),window.addEventListener("touchmove",T,!1),window.addEventListener("touchend",C,!1),window.addEventListener("touchcancel",C,!1))}function k(){O&&(O=!1,m.enabled=!1,e.removeEventListener("wheel",v,!1),e.removeEventListener("mousedown",x,!1),window.removeEventListener("mousemove",_,!1),window.removeEventListener("mouseup",w,!1),e.removeEventListener("touchstart",E,!1),window.removeEventListener("touchmove",T,!1),window.removeEventListener("touchend",C,!1),window.removeEventListener("touchcancel",C,!1))}return P(),a.enable=P,a.disable=k,a}var Re=je;function je(){var e=new Float32Array(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}var Be=Ie;function Ie(e){var t=new Float32Array(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}var Ne=Ve;function Ve(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}var Ue=He;function He(e,t){if(e===t){var n=t[1],r=t[2],i=t[3],a=t[6],o=t[7],s=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=n,e[6]=t[9],e[7]=t[13],e[8]=r,e[9]=a,e[11]=t[14],e[12]=i,e[13]=o,e[14]=s}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e}var qe=Ye;function Ye(e,t){var n=t[0],r=t[1],i=t[2],a=t[3],o=t[4],s=t[5],c=t[6],u=t[7],f=t[8],l=t[9],p=t[10],h=t[11],d=t[12],m=t[13],v=t[14],g=t[15];return e[0]=s*(p*g-h*v)-l*(c*g-u*v)+m*(c*h-u*p),e[1]=-(r*(p*g-h*v)-l*(i*g-a*v)+m*(i*h-a*p)),e[2]=r*(c*g-u*v)-s*(i*g-a*v)+m*(i*u-a*c),e[3]=-(r*(c*h-u*p)-s*(i*h-a*p)+l*(i*u-a*c)),e[4]=-(o*(p*g-h*v)-f*(c*g-u*v)+d*(c*h-u*p)),e[5]=n*(p*g-h*v)-f*(i*g-a*v)+d*(i*h-a*p),e[6]=-(n*(c*g-u*v)-o*(i*g-a*v)+d*(i*u-a*c)),e[7]=n*(c*h-u*p)-o*(i*h-a*p)+f*(i*u-a*c),e[8]=o*(l*g-h*m)-f*(s*g-u*m)+d*(s*h-u*l),e[9]=-(n*(l*g-h*m)-f*(r*g-a*m)+d*(r*h-a*l)),e[10]=n*(s*g-u*m)-o*(r*g-a*m)+d*(r*u-a*s),e[11]=-(n*(s*h-u*l)-o*(r*h-a*l)+f*(r*u-a*s)),e[12]=-(o*(l*v-p*m)-f*(s*v-c*m)+d*(s*p-c*l)),e[13]=n*(l*v-p*m)-f*(r*v-i*m)+d*(r*p-i*l),e[14]=-(n*(s*v-c*m)-o*(r*v-i*m)+d*(r*c-i*s)),e[15]=n*(s*p-c*l)-o*(r*p-i*l)+f*(r*c-i*s),e}var Ge=Qe;function Qe(e){var t=e[0],n=e[1],r=e[2],i=e[3],a=e[4],o=e[5],s=e[6],c=e[7],u=e[8],f=e[9],l=e[10],p=e[11],h=e[12],d=e[13],m=e[14],v=e[15],g=t*o-n*a,b=t*s-r*a,y=t*c-i*a,w=n*s-r*o,x=n*c-i*o,_=r*c-i*s,A=u*d-f*h,E=u*m-l*h,T=u*v-p*h,C=f*m-l*d,O=f*v-p*d,P=l*v-p*m;return g*P-b*O+y*C+w*T-x*E+_*A}var We=Xe;function Xe(e,t,n){var r=t[0],i=t[1],a=t[2],o=t[3],s=t[4],c=t[5],u=t[6],f=t[7],l=t[8],p=t[9],h=t[10],d=t[11],m=t[12],v=t[13],g=t[14],b=t[15],y=n[0],w=n[1],x=n[2],_=n[3];return e[0]=y*r+w*s+x*l+_*m,e[1]=y*i+w*c+x*p+_*v,e[2]=y*a+w*u+x*h+_*g,e[3]=y*o+w*f+x*d+_*b,y=n[4],w=n[5],x=n[6],_=n[7],e[4]=y*r+w*s+x*l+_*m,e[5]=y*i+w*c+x*p+_*v,e[6]=y*a+w*u+x*h+_*g,e[7]=y*o+w*f+x*d+_*b,y=n[8],w=n[9],x=n[10],_=n[11],e[8]=y*r+w*s+x*l+_*m,e[9]=y*i+w*c+x*p+_*v,e[10]=y*a+w*u+x*h+_*g,e[11]=y*o+w*f+x*d+_*b,y=n[12],w=n[13],x=n[14],_=n[15],e[12]=y*r+w*s+x*l+_*m,e[13]=y*i+w*c+x*p+_*v,e[14]=y*a+w*u+x*h+_*g,e[15]=y*o+w*f+x*d+_*b,e}var Je=Ze;function Ze(e,t,n,r){var i,a,o,s,c,u,f,l,p,h,d,m,v,g,b,y,w,x,_,A,E,T,C,O,P=r[0],k=r[1],D=r[2],M=Math.sqrt(P*P+k*k+D*D);return Math.abs(M)<1e-6?null:(M=1/M,P*=M,k*=M,D*=M,i=Math.sin(n),a=Math.cos(n),o=1-a,s=t[0],c=t[1],u=t[2],f=t[3],l=t[4],p=t[5],h=t[6],d=t[7],m=t[8],v=t[9],g=t[10],b=t[11],y=P*P*o+a,w=k*P*o+D*i,x=D*P*o-k*i,_=P*k*o-D*i,A=k*k*o+a,E=D*k*o+P*i,T=P*D*o+k*i,C=k*D*o-P*i,O=D*D*o+a,e[0]=s*y+l*w+m*x,e[1]=c*y+p*w+v*x,e[2]=u*y+h*w+g*x,e[3]=f*y+d*w+b*x,e[4]=s*_+l*A+m*E,e[5]=c*_+p*A+v*E,e[6]=u*_+h*A+g*E,e[7]=f*_+d*A+b*E,e[8]=s*T+l*C+m*O,e[9]=c*T+p*C+v*O,e[10]=u*T+h*C+g*O,e[11]=f*T+d*C+b*O,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)}var $e=Ke;function Ke(e,t,n){var r=Math.sin(n),i=Math.cos(n),a=t[4],o=t[5],s=t[6],c=t[7],u=t[8],f=t[9],l=t[10],p=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=a*i+u*r,e[5]=o*i+f*r,e[6]=s*i+l*r,e[7]=c*i+p*r,e[8]=u*i-a*r,e[9]=f*i-o*r,e[10]=l*i-s*r,e[11]=p*i-c*r,e}var et=tt;function tt(e,t,n){var r=Math.sin(n),i=Math.cos(n),a=t[0],o=t[1],s=t[2],c=t[3],u=t[8],f=t[9],l=t[10],p=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=a*i-u*r,e[1]=o*i-f*r,e[2]=s*i-l*r,e[3]=c*i-p*r,e[8]=a*r+u*i,e[9]=o*r+f*i,e[10]=s*r+l*i,e[11]=c*r+p*i,e}var nt=rt;function rt(e,t,n){var r=Math.sin(n),i=Math.cos(n),a=t[0],o=t[1],s=t[2],c=t[3],u=t[4],f=t[5],l=t[6],p=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=a*i+u*r,e[1]=o*i+f*r,e[2]=s*i+l*r,e[3]=c*i+p*r,e[4]=u*i-a*r,e[5]=f*i-o*r,e[6]=l*i-s*r,e[7]=p*i-c*r,e}var it=at;function at(e,t,n){var r,i,a,o=n[0],s=n[1],c=n[2],u=Math.sqrt(o*o+s*s+c*c);return Math.abs(u)<1e-6?null:(u=1/u,o*=u,s*=u,c*=u,r=Math.sin(t),i=Math.cos(t),a=1-i,e[0]=o*o*a+i,e[1]=s*o*a+c*r,e[2]=c*o*a-s*r,e[3]=0,e[4]=o*s*a-c*r,e[5]=s*s*a+i,e[6]=c*s*a+o*r,e[7]=0,e[8]=o*c*a+s*r,e[9]=s*c*a-o*r,e[10]=c*c*a+i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)}var ot=st;function st(e,t,n){var r=t[0],i=t[1],a=t[2],o=t[3],s=r+r,c=i+i,u=a+a,f=r*s,l=r*c,p=r*u,h=i*c,d=i*u,m=a*u,v=o*s,g=o*c,b=o*u;return e[0]=1-(h+m),e[1]=l+b,e[2]=p-g,e[3]=0,e[4]=l-b,e[5]=1-(f+m),e[6]=d+v,e[7]=0,e[8]=p+g,e[9]=d-v,e[10]=1-(f+h),e[11]=0,e[12]=n[0],e[13]=n[1],e[14]=n[2],e[15]=1,e}var ct=ut;function ut(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}var ft=lt;function lt(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}var pt=ht;function ht(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=n,e[7]=0,e[8]=0,e[9]=-n,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}var dt=mt;function mt(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=0,e[2]=-n,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=n,e[9]=0,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}var vt=gt;function gt(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=n,e[2]=0,e[3]=0,e[4]=-n,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}var bt=yt;function yt(e,t){var n=t[0],r=t[1],i=t[2],a=t[3],o=n+n,s=r+r,c=i+i,u=n*o,f=r*o,l=r*s,p=i*o,h=i*s,d=i*c,m=a*o,v=a*s,g=a*c;return e[0]=1-l-d,e[1]=f+g,e[2]=p-v,e[3]=0,e[4]=f-g,e[5]=1-u-d,e[6]=h+m,e[7]=0,e[8]=p+v,e[9]=h-m,e[10]=1-u-l,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}var wt=xt;function xt(e,t,n,r,i,a,o){var s=1/(n-t),c=1/(i-r),u=1/(a-o);return e[0]=2*a*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*a*c,e[6]=0,e[7]=0,e[8]=(n+t)*s,e[9]=(i+r)*c,e[10]=(o+a)*u,e[11]=-1,e[12]=0,e[13]=0,e[14]=o*a*2*u,e[15]=0,e}var _t=At;function At(e,t,n,r){var i=Math.tan(t.upDegrees*Math.PI/180),a=Math.tan(t.downDegrees*Math.PI/180),o=Math.tan(t.leftDegrees*Math.PI/180),s=Math.tan(t.rightDegrees*Math.PI/180),c=2/(o+s),u=2/(i+a);return e[0]=c,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=u,e[6]=0,e[7]=0,e[8]=-(o-s)*c*.5,e[9]=(i-a)*u*.5,e[10]=r/(n-r),e[11]=-1,e[12]=0,e[13]=0,e[14]=r*n/(n-r),e[15]=0,e}var Et=Tt;function Tt(e,t,n,r,i,a,o){var s=1/(t-n),c=1/(r-i),u=1/(a-o);return e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*c,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*u,e[11]=0,e[12]=(t+n)*s,e[13]=(i+r)*c,e[14]=(o+a)*u,e[15]=1,e}var Ct=Ot;function Ot(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"}var Pt={create:Re,clone:Be,copy:Ne,identity:E,transpose:Ue,invert:C,adjoint:qe,determinant:Ge,multiply:We,translate:P,scale:D,rotate:Je,rotateX:$e,rotateY:et,rotateZ:nt,fromRotation:it,fromRotationTranslation:ot,fromScaling:ct,fromTranslation:ft,fromXRotation:pt,fromYRotation:dt,fromZRotation:vt,fromQuat:bt,frustum:wt,perspective:F,perspectiveFromFieldOfView:_t,ortho:Et,lookAt:S,str:Ct},kt=Pt.invert;function Dt(e,t){const n=B({...e,aspectRatio:t._gl.canvas.clientWidth/t._gl.canvas.clientHeight});Mt(n,t._gl.canvas),n.toConfig=()=>({center:n.params.center,theta:n.params.theta,phi:n.params.phi,distance:n.params.distance});const r=t({uniforms:{projection:(e,t)=>t.state.projection,iProj:(e,t)=>kt([],t.state.projection),view:(e,t)=>t.state.view,eye:(e,t)=>t.state.eye}});return[n,r]}function Mt(e,t){const n={left:37,up:38,right:39,down:40},r=-.01;window.addEventListener("keydown",(function(t){switch(t.keyCode){case n.left:e.pan(-r,0);break;case n.up:e.pan(0,+r);break;case n.right:e.pan(+r,0);break;case n.down:e.pan(0,-r);break}}));const i=.5*Math.PI;Fe(t).on("wheel",(function(t){t.mods.shift&&e.zoom(t.x,t.y,Math.exp(-t.dy)-1)})).on("mousemove",(function(t){t.active&&1===t.buttons&&(t.mods.shift?e.pan(t.dx,t.dy):t.mods.meta||e.rotate(-t.dx*i,-t.dy*i))})).on("touchmove",(function(t){t.active&&e.rotate(-t.dx*i,-t.dy*i)}))}const St={name:"PHOTON",mass__eVc_2:0,charge__qe:0,chargeMassRatio__Ckg_1:0,id:0,color:[.92,.75,0],icolor:[237,197,0]},zt={name:"ELECTRON",mass__eVc_2:510998.94,chargeMassRatio__Ckg_1:-175882004556.243,charge__qe:-1,id:1,color:[.12,.45,.65],icolor:[33,116,168]},Ft={name:"POSITRON",mass__eVc_2:510998.94,chargeMassRatio__Ckg_1:175882004556.243,charge__qe:1,id:2,color:[.22,.9,.9],icolor:[133,116,168]},Lt={name:"PROTON",mass__eVc_2:938272081,charge__qe:1,chargeMassRatio__Ckg_1:95788332.3113771,id:3,color:[.77,.2,.2],icolor:[197,50,40]},Rt=[St,zt,Ft,Lt],jt=new Map(Rt.map(e=>[e.name,e]));var Bt={PHOTON:St,ELECTRON:zt,POSITRON:Ft,PROTON:Lt,byNameMap:jt,byName:e=>jt.get(e),idByName:e=>Rt.indexOf(jt.get(e))};function It({n:e=0,d:t=0}){const n=t*(e-1)/2;return[...Array(e)].fill(0).map((e,r)=>[r*t-n,0,0]).reduce((e,t)=>e.concat(t),[])}function Nt({n:e=0,d:t=0}){const n=t*(e-1)/2;return[...Array(e)].fill(0).map((e,r)=>[0,r*t-n,0]).reduce((e,t)=>e.concat(t),[])}function Vt({n:e=0,d:t=0}){const n=Math.ceil(Math.sqrt(e)),r=Math.ceil(e/n),i=t*(n-1)/2,a=t*(r-1)/2;return[...Array(e)].fill(0).map((e,r)=>{const o=r%n,s=Math.floor(r/n);return[o*t-i,s*t-a,0]}).reduce((e,t)=>e.concat(t),[])}function Ut({n:e=0,d:t=0}){const n=Math.ceil(Math.sqrt(e)),r=Math.ceil(e/n),i=t*(n-1)/2,a=t*(r-1)/2;return Array(e).fill(0).map((e,r)=>{const o=r%n,s=Math.floor(r/n);return[o*t-i,0,s*t-a]}).reduce((e,t)=>e.concat(t),[])}function Ht({n:e=0,d:t=0}){const n=Math.ceil(Math.sqrt(e)),r=Math.ceil(e/n),i=t*(n-1)/2,a=t*(r-1)/2;return Array(e).fill(0).map((e,r)=>{const o=r%n,s=Math.floor(r/n);return[0,s*t-a,o*t-i]}).reduce((e,t)=>e.concat(t),[])}function qt({n:e=0,d:t=0}){const n=Math.ceil(Math.sqrt(e)),r=Math.ceil(e/n),i=t*(n-1)/2,a=t*(r-1)/2;return Array(e).fill(0).map((e,r)=>{const o=r%n,s=Math.floor(r/n);return(o*t-i)**2+(s*t-a)**2<(n*t/2)**2?[o*t-i,s*t-a,0]:[o*t-i,s*t-a-10,0]}).reduce((e,t)=>e.concat(t),[])}function Yt({n:e=0,d:t=0}){const n=Math.ceil(Math.sqrt(e)),r=Math.ceil(e/n),i=t*(n-1)/2,a=t*(r-1)/2;return Array(e).fill(0).map((e,r)=>{const o=r%n,s=Math.floor(r/n);return(o*t-i)**2+(s*t-a)**2<(n*t/2)**2?[0,s*t-a,o*t-i]:[0,s*t-a-10,o*t-i]}).reduce((e,t)=>e.concat(t),[])}var Gt={sum:function(e){var t=0;if(e.constructor===Array&&e.length)for(var n=0,r=e.length;n<r;++n)t+=e[n];else if(e.constructor===Object)for(var i in e)e.hasOwnProperty(i)&&(t+=e[i]);return t},mean:function(e){var t,n=this.sum(e);if(e.constructor===Array&&e.length)t=e.length;else if(e.constructor===Object)for(var r in t=0,e)e.hasOwnProperty(r)&&++t;return n/t},variance:function(e,t){t=t?1:0;var n=this.mean(e),r=0,i=0;if(e.constructor===Array&&e.length){r=e.length;for(var a=0;a<r;++a)i+=Math.pow(e[a]-n,2)}else if(e.constructor===Object)for(var o in r=0,e)e.hasOwnProperty(o)&&(i+=Math.pow(e[o]-n,2),++r);if(r<2)throw new Error("variance not defined for length < 2");return i/(r-t)},std:function(e,t){return Math.sqrt(this.variance(e,t))},norm:function(e,t){var n,r,i,a=0;if(e)if(t)switch(t.toLowerCase()){case"l1":if(e.constructor===Array&&e.length)for(i=e.length,n=0;n<i;++n)a+=Math.abs(e[n]);else if(e.constructor===Object)for(r in e)e.hasOwnProperty(r)&&(a+=Math.abs(e[r]));break;case"euclidean":if(e.constructor===Array&&e.length)for(i=e.length,n=0;n<i;++n)a+=Math.pow(e[n],2);else if(e.constructor===Object)for(r in e)e.hasOwnProperty(r)&&(a+=Math.pow(e[r],2));a=Math.sqrt(a);break;case"max":if(e.constructor===Array&&e.length)a=Math.max.apply(null,e);else if(e.constructor===Object)for(r in a=null,e)e.hasOwnProperty(r)&&(a=null===a?e[r]:Math.max(a,e[r]));break;case"min":if(e.constructor===Array&&e.length)a=Math.min.apply(null,e);else if(e.constructor===Object)for(r in a=null,e)e.hasOwnProperty(r)&&(a=null===a?e[r]:Math.min(a,e[r]));break;default:a=this.sum(e)}else a=this.sum(e);return a},rescale:function(e,t){if(e&&t)if(e.constructor===Array&&e.length)for(var n=0,r=e.length;n<r;++n)e[n]/=t;else if(e.constructor===Object)for(var i in e)e.hasOwnProperty(i)&&(e[i]/=t);return e},standardize:function(e,t){return this.rescale(e,this.std(e,t))},normalize:function(e,t){return this.rescale(e,this.norm(e,t))}},Qt=Gt;let Wt=1;const Xt=()=>{let e=1e4*Math.sin(Wt++);return e-Math.floor(e)},Jt=(e=-1,t=1)=>Xt()*(t-e)+e;function Zt(e,t=0){const n=e.trim().split(/\s+/).map(e=>Bt.byName(e));if(0===t)return n;const r=Array(t).fill(0).map((e,t)=>{const r=n[t%n.length];return r});return r}function $t({position:e=[0,0,0],jitter:t=[0,0,0]}){const n=e.map((e,n)=>e+Math.floor(Jt()*t[n]*100)/100);return n}function Kt({direction:e=[0,0,1],directionJitter:t=[0,0,0],localPosition:n=[0,0,0]}){const r=e.map((e,r)=>e+Math.floor(Math.abs(Jt())*n[r]*t[r]*100)/100);return Qt.normalize(r,"Euclidean")}function en(e=0){return 0===e?NaN:Math.sqrt(1-1/Math.pow(e,2))}function tn({particleCount:e=3,particleTypeDescriptor:t="PHOTON ELECTRON PROTON",bunchShape:n="ROW",particleSeparation:r=.1,gamma:i=1,position:a=[0,0,0],direction:o=[0,0,1],positionJitter:s=[0,0,0],directionJitter:c=[0,0,0]}){const u=Zt(t,e);if(-1===["SQUARE","ROW","DISC","DISC_YZ","COLUMN","SQUARE_YZ","SQUARE_HORIZONTAL"].indexOf(n))throw new Error("unknown distribution type");const f="SQUARE"===n?Vt({n:e,d:r}):"SQUARE_YZ"===n?Ht({n:e,d:r}):"DISC"===n?qt({n:e,d:r}):"DISC_YZ"===n?Yt({n:e,d:r}):"SQUARE_HORIZONTAL"===n?Ut({n:e,d:r}):"ROW"===n?It({n:e,d:r}):Nt({n:e,d:r}),l=u.map((e,t)=>{const n=$t({position:a,jitter:s});return[f[3*t+0]+n[0],f[3*t+1]+n[1],f[3*t+2]+n[2],0]}).reduce((e,t)=>e.concat(t),[]),p=u.map((e,t)=>{const n=0===e.mass__eVc_2?1:en(i),r=Kt({direction:o,directionJitter:c,localPosition:[f[3*t+0],f[3*t+1],f[3*t+2]]});return[n*r[0],n*r[1],n*r[2],i]}).reduce((e,t)=>e.concat(t),[]);return{fourPositions:l,fourVelocities:p,particleTypes:u.map(e=>e.id)}}function nn(e,{randomize:t,bunchShape:n,particleCount:r,particleType:i,particleSeparation:a,direction:o,position:s,directionJitter:c,positionJitter:u,gamma:f},l=-1){let p=new Float32Array(r*e*4),h=new Float32Array(r*e*4),d=new Array(r);if(t){for(let e=0;e<r;e++)p[4*e]=0*Jt(),p[4*e+1]=0*Jt(),p[4*e+2]=0*Jt(),p[4*e+3]=0,h[4*e]=Jt(),h[4*e+1]=Jt(),h[4*e+2]=Jt(),h[4*e+3]=0,d[e]=Math.floor(4*Xt());console.log(h)}else{const t=tn({particleCount:r,particleTypeDescriptor:i,bunchShape:n,particleSeparation:a,gamma:f,position:s,positionJitter:u,direction:o,directionJitter:c});p=new Float32Array([...t.fourPositions].concat(new Array(r*(e-1)*4).fill(0))),h=new Float32Array([...t.fourVelocities].concat(new Array(r*(e-1)*4).fill(0))),d=t.particleTypes}return{particleCount:r,bufferLength:e,fourPositions:p,fourVelocities:h,particleTypes:d}}const rn="\n  struct ParticleData {\n    float charge;\n    float mass;\n    float chargeMassRatio;\n    float particleType;\n  };\n  vec4 EncodeFloatRGBA( float v ) {\n    vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n    enc = fract(enc);\n    enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n    return enc;\n  }\n  float DecodeFloatRGBA( vec4 rgba ) {\n    return dot( rgba, vec4(1.0, 1./255.0, 1./65025.0, 1./16581375.0) );\n  }\n  ParticleData getParticleData(float p) {\n    vec2 coords = vec2(p, 0.) / vec2(particleCount, 1.);\n    vec4 data = texture2D(utParticleChargesMassesChargeMassRatios, coords);\n    return ParticleData(data.x, data.y, data.z, data.w);\n  }\n  vec4 get_color(float p) {\n    vec2 coords = vec2(p, 0.) / vec2(particleCount, 1.);\n    return texture2D(utParticleColorAndType, coords);\n  }\n  vec4 get_position(float p, float b) {\n    vec2 coords = vec2(p, b) / vec2(particleCount, bufferLength);\n    return texture2D(utPositionBuffer, coords);\n  }\n  vec4 get_velocity(float p, float b) {\n    vec2 coords = vec2(p, b) / vec2(particleCount, bufferLength);\n    return texture2D(utVelocityBuffer, coords);\n  }\n";function an(e){return`\n  int BEAMLINE_ELEMENT_TYPE_DRIFT = 0;\n  int BEAMLINE_ELEMENT_TYPE_DIPOLE = 1;\n  int BEAMLINE_ELEMENT_TYPE_QUADRUPOLE = 2;\n  struct BeamlineElement {\n    vec3 start;\n    vec3 end;\n    int type; //0: drift, 1: dipole, 2: quadrupole\n    float strength;\n  };\n\n  ${e.beamline.length>0?"BeamlineElement beamline["+e.beamline.length+"];":"BeamlineElement beamline[1];"}\n\n  BeamlineElement getBeamlineElement(float id) {\n    for (int i=0; i < ${Math.min(e.beamline.length,1e3)}; i++) {\n        if (float(i) == id) return beamline[i];\n    }\n  }\n\n  BeamlineElement getClosestBeamlineElement(vec3 position) {\n\n    float bestLength = 1000.;\n    int bestIndex = 0;\n\n    for (int i=0; i < ${e.beamline.length}; i++) {\n\n      BeamlineElement bl = getBeamlineElement(float(i));\n      float currentLength = length(position - (bl.start+bl.end)/2.) ;\n      if (currentLength < bestLength) {\n\n        bestIndex = i;\n        bestLength = currentLength;\n      }\n  }\n  return getBeamlineElement(float(bestIndex));\n  }\n\n  void initLatticeData() {\n    ${e.toGLSLDefinition()};\n  }\n  `}function on(e,{variables:t,model:n}){const r=r=>e({framebuffer:(e,n)=>t[r][n.pathiclesTick%2],primitive:"triangles",elements:null,offset:0,count:3,attributes:{aPosition:[0,-4,0,4,4,0,-4,4,0]},uniforms:{boundingBoxSize:n.boundingBoxSize,bufferLength:n.bufferLength,particleCount:n.particleCount,tick:e.prop("pathiclesTick"),halfDeltaTOverC:n.halfDeltaTOverC,particleInteraction:n.interactions.particleInteraction?1:0,gravityConstant:n.interactions.gravityConstant,electricField:n.interactions.electricField||[0,0,0],magneticField:n.interactions.magneticField||[0,0,1],utParticleChargesMassesChargeMassRatios:()=>t.particleChargesMassesChargeMassRatios,utPositionBuffer:(e,n)=>t.position[(n.pathiclesTick+1)%2],utVelocityBuffer:(e,n)=>"position"===r?t.velocity[n.pathiclesTick%2]:t.velocity[(n.pathiclesTick+1)%2]},vert:"\n\n        precision mediump float;\n        attribute vec3 aPosition;\n\n        void main () {\n          gl_Position = vec4(aPosition, 1.);\n        }\n        ",frag:`\n        precision highp float;\n\n        const highp float c = 2.99792458e+8;\n        uniform sampler2D utParticleColorAndType;\n        uniform sampler2D utParticleChargesMassesChargeMassRatios;\n        uniform sampler2D utPositionBuffer;\n        uniform sampler2D utVelocityBuffer;\n        uniform float tick;\n        uniform float halfDeltaTOverC;\n        uniform float boundingBoxSize;\n        uniform float particleCount;\n        uniform float bufferLength;\n        uniform float gravityConstant;\n        uniform vec3 electricField;\n        uniform vec3 magneticField;\n\n        uniform float particleInteraction;\n\n        ${rn}\n\n        ${an(n.lattice)}\n\n\n        vec3 get_efield(vec3 position, ParticleData particleData, float p, float previousBufferHead) {\n\n          vec3 E = electricField * particleData.charge;\n\n\n\n          // if (particleInteraction != 0.) {\n          //\n          //   for ( int p2 = 0; p2 < 24; p2++ ) {\n          //\n          //     if ( p == float(p2) ) { continue; }\n          //\n          //       ParticleData particleData2 = getParticleData(float(p2));\n          //\n          //     if (particleData2.charge > 0.) {\n          //\n          //       vec3 position2 = get_position(float(p2), previousBufferHead).xyz;\n          //\n          //       // float particleCharge2 = 1.; // POSITRON / PROTRON\n          //       // if (particleType == 1.) { // ELECTRON\n          //       //     particleCharge2 = charge_unit_qe[1];\n          //       //  }\n          //\n          //       vec3 dPosition = position2 - position;\n          //       float distance = length( dPosition );\n          //\n          //       E += .000000000001 *  particleData.charge * particleData2.charge / (distance * distance) * normalize(dPosition);\n          //\n          //     }\n          //   }\n          // }\n          return E;\n        }\n\n        vec3 get_bfield(vec3 position) {\n\n          BeamlineElement ble = getClosestBeamlineElement(position);\n\n          vec3 B = magneticField;\n\n          if (ble.type == BEAMLINE_ELEMENT_TYPE_DIPOLE) {\n            B += vec3(0., ble.strength, 0.);\n          } else if (ble.type == BEAMLINE_ELEMENT_TYPE_QUADRUPOLE) {\n          B += (ble.strength > 0.) ?\n              ble.strength * vec3(0, position.z, position.y- 1.)\n              : abs(ble.strength) * vec3(0, -position.z, -(position.y-1.));\n              }\n\n          // if (position.z > dipole_minZ && position.z < dipole_maxZ ) {\n          //    B += vec3(0., dipole_strength, 0);\n          //  }\n          //\n          //  if (position.z >  quadrupole_1_minZ && position.z < quadrupole_1_maxZ ) {\n          //    float orientation = (quadrupole_1_rotated > 0.) ? -1. : 1.;\n          //    B += quadrupole_1_strength * vec3(position.y-1., position.x, 0);\n          //  }\n          //\n          // if (position.z >  quadrupole_2_minZ && position.z < quadrupole_2_maxZ ) {\n          //    float orientation = (quadrupole_2_rotated > 0.) ? -1. : 1.;\n          //    B +=  quadrupole_2_strength * vec3( position.y-1., -position.x, 0);\n          //  }\n           return B;\n\n        }\n\n        vec4 push_position(float p, float bufferHead, float previousBufferHead) {\n\n          vec4 previousValue = get_position(p, previousBufferHead);\n\n          vec3 previousPosition = previousValue.xyz;\n          float previousTime  = previousValue.w;\n\n          vec3 previousVelocity = get_velocity(p, previousBufferHead).xyz;\n          vec3 currentVelocity = get_velocity(p, bufferHead).xyz;\n\n          return vec4(\n            previousPosition + previousVelocity * halfDeltaTOverC + currentVelocity * halfDeltaTOverC,\n            previousTime + 2. * halfDeltaTOverC);\n        }\n\n\n        vec4 push_velocity(float p, float bufferHead, float previousBufferHead) {\n\n          ParticleData particleData = getParticleData(p);\n\n          vec4 previous4Position = get_position(p, previousBufferHead);\n\n          vec4 previous4Velocity = get_velocity(p, previousBufferHead);\n          vec3 previousVelocity = previous4Velocity.xyz;\n          float previousGamma = previous4Velocity.w;\n\n\n          vec3 intermediatePosition = previous4Position.xyz + previousVelocity * halfDeltaTOverC;\n\n          vec3 E = get_efield(intermediatePosition, particleData, p, previousBufferHead);\n          vec3 B = get_bfield(intermediatePosition);\n          // vec3 G = vec3(0., -gravityConstant, 0.);\n\n\n          vec3 dv_el_unit_c_1 = particleData.chargeMassRatio / c * E * halfDeltaTOverC;\n          vec3 v_el1_unit_c_1 = previousVelocity + dv_el_unit_c_1;\n\n          float gamma_el1_unit_c_1 = 1.0 / (sqrt(1.0 - dot( v_el1_unit_c_1, v_el1_unit_c_1)));\n          gamma_el1_unit_c_1 = previousGamma;\n\n\n          vec3 b_0_unit_c_1 =  particleData.chargeMassRatio / gamma_el1_unit_c_1 *  halfDeltaTOverC / c * B;\n          float b_0_unit_c_1_square = dot(b_0_unit_c_1, b_0_unit_c_1);\n\n          vec3 v_mag_unit_c_1 = v_el1_unit_c_1 + (2.0 / 1.0 + b_0_unit_c_1_square) * cross(  v_el1_unit_c_1 + cross(  v_el1_unit_c_1, b_0_unit_c_1), b_0_unit_c_1) ;\n\n          vec3 nextVelocity_unit_c_1 = v_mag_unit_c_1 + dv_el_unit_c_1;\n\n\n          if (boundingBoxSize > 0.) {\n            if (intermediatePosition.x < -boundingBoxSize || intermediatePosition.x > boundingBoxSize) {\n              nextVelocity_unit_c_1.x *= -1.0;\n            }\n            if (intermediatePosition.y < -boundingBoxSize || intermediatePosition.y > boundingBoxSize) {\n              nextVelocity_unit_c_1.y *= -1.0;\n            }\n            if (intermediatePosition.z < -boundingBoxSize || intermediatePosition.z > boundingBoxSize) {\n              nextVelocity_unit_c_1.z *= -1.0;\n            }\n          }\n\n          return vec4( nextVelocity_unit_c_1, gamma_el1_unit_c_1 );\n          // return vec4( nextVelocity_unit_c_1, previousGamma );\n        }\n\n        void main () {\n\n          initLatticeData();\n          //initParticleData();\n          float p, b;\n\n          p = floor(gl_FragCoord.x);\n          b = floor(gl_FragCoord.y);\n\n          float currentBufferHead = floor(mod(tick, bufferLength + 1.));\n          float previousBufferHead = (b == 0.) ? bufferLength : b - 1.;\n\n          if (currentBufferHead == b) {\n\n            gl_FragColor = push_${r}(p, currentBufferHead, previousBufferHead);\n\n          } else {\n\n            gl_FragColor = get_${r}(p, b);\n\n          }\n        }\n        `}),i=r("velocity"),a=r("position");return()=>{t.tick.value++;const e=t.tick.value*n.halfDeltaTOverC*2;t.pingPong=t.tick.value%2,t.referencePoint=n.lattice.beamline.length&&n.lattice.beamline[n.lattice.segmentIndexForZ(e)].start,i({pathiclesTick:t.tick.value}),a({pathiclesTick:t.tick.value})}}function sn(e,{variables:t,model:n}){const r={},i=Object.keys(t).filter(e=>"position"===e||"velocity"===e);return i.forEach(e=>{r[e]=[new Float32Array(n.particleCount*n.bufferLength*4),new Float32Array(n.particleCount*n.bufferLength*4)]}),i.forEach(n=>{e({framebuffer:t[n][0]})(()=>{e.read({data:r[n][0]})}),e({framebuffer:t[n][1]})(()=>{e.read({data:r[n][1]})})}),{tick:t.tick.value,data:{position:Object.values(r.position[t.tick.value%2]).map(e=>Math.floor(1e3*e)/1e3),particleTypes:t.initialData.particleTypes}}}function cn(e,t,n){return[0,1].map(()=>e.framebuffer({width:t,height:n,format:"rgba",colorType:"float32",depthStencil:!1,color:e.texture({width:t,height:n,min:"nearest",mag:"nearest",format:"rgba",type:"float32"})}))}function un(e,t){return[0,1].forEach(n=>e[n].color[0].subimage({width:e[n].width,height:e[n].height,data:t})),e}function fn(e,{variables:t,texelSize:n=1,y0:r=5}){return e({vert:"\n      precision mediump float;\n      attribute vec2 position;\n      varying vec2 uv;\n      void main () {\n        uv = position;\n        gl_Position = vec4(1.0 - 2.0 * position, 0, 1);\n      }",frag:"\n      precision mediump float;\n      uniform sampler2D texture;\n      varying vec2 uv;\n      void main () {\n        gl_FragColor = vec4(texture2D(texture, uv).xyz, texture2D(texture, uv).w + .5);\n      }",attributes:{position:[2,0,0,2,-2,-2]},uniforms:{texture:({tick:e},n)=>t[n.variableName][e%2]},viewport:{x:(e,r)=>"velocity"===r.variableName?(t.initialData.particleCount+1)*n:0,y:r,width:t.initialData.particleCount*n,height:t.initialData.bufferLength*n},depth:{enable:!1},count:3})}const ln="DRIF",pn="QUAD",hn="SBEN",dn={DRIF:ln,SBEN:hn,QUAD:pn},mn=[ln,hn,pn],vn={DRIF:[.2,.2,.2],QUAD:[.17,.03,.02],QUAD1:[.27,.13,.12],SBEN:[.6,.3,0]};class gn{constructor(e){if("undefined"===typeof e)throw new Error("no default constructor");this.origin=e.origin||{phi:0,position:[0,0,0]};let t=0;this.beamline=e.beamline.map(n=>{if(!e.elements[n])throw new Error(`element ${n} not defined`);const r=e.elements[n];return t+=r.l,{...r,z_min:t-r.l,z_max:t}});const n=this.startEnds;this.beamline.forEach((e,t)=>{e.start=n[t].start,e.end=n[t].end})}segmentIndexForZ(e){const t=e%this.length();for(let n=0;n<Math.min(this.beamline.length,1e3);n++)if(t>=this.beamline[n].z_min&&t<=this.beamline[n].z_max)return n}length(){return this.beamline.length&&this.beamline[this.beamline.length-1].z_max}toGLSLDefinition(){const e=this.startEnds;return this.beamline.map((t,n)=>`beamline[${n}] = BeamlineElement(vec3(${e[n].start.join(",")}), vec3(${e[n].end.join(",")}), ${mn.indexOf(t.type)},\n          ${t.k1?t.k1.toFixed(2):"0."})`).join(",")}getClosestBeamlineElement(e){let t=1e3,n=0;const r=this.startEnds;for(let i=0;i<this.beamline.length;i++){const a=Math.pow(e[0]-r[i].start[0],2)+Math.pow(e[1]-r[i].start[1],2)+Math.pow(e[2]-r[i].start[2],2);a<t&&(n=i,t=a)}return this.beamline[n]}get startEnds(){let e=this.origin.phi,[t,n,r]=this.origin.position;return this.beamline.map(i=>{const a=[t,n,r],o=i.angle?e+i.angle/2:e,s=[t-Math.sin(o)*i.l,n,r+Math.cos(o)*i.l];return[t,n,r]=s,e=i.angle?e+i.angle:e,{start:a,end:s}})}get transformations(){let e=this.origin.phi,[t,n,r]=this.origin.position;return n=-1,this.beamline.map(i=>{const a=[t,n,r],o=i.angle?e+i.angle/2:e,s=[t-Math.sin(o)*i.l,n,r+Math.cos(o)*i.l],c=[(a[0]+s[0])/2,n,(a[2]+s[2])/2];return[t,n,r]=s,e=i.angle?e+i.angle:e,{translation:c,phi:o,scale:[2,.15,i.l-.2-("SBEN"===i.type?.4:0)]}})}get colors(){return this.beamline.map(e=>e.type===dn.QUAD&&e.k1<0?vn["QUAD1"]:vn[e.type])}}class bn{constructor(e,t){this._regl=e,this._logStore=[],this.configuration=t,this.configuration.simulate=!0;const{particleCount:n,bufferLength:r,fourPositions:i,particleTypes:a,fourVelocities:o}=this.initialData=nn(t.model.bufferLength,t.model.emitter),s=new gn(this.configuration.model.lattice);this.variables={initialData:this.initialData,position:un(cn(e,n,r),i),velocity:un(cn(e,n,r),o),tick:{value:0},referencePoint:[0,0,0],pingPong:0,particleColorsAndTypes:e.texture({data:a.map(e=>t.colors[e].concat(e)).flat(),shape:[n,1,4],type:"float"}),particleChargesMassesChargeMassRatios:e.texture({data:a.map(e=>[t.charge[e],t.mass[e],t.chargeMassRatio[e],e]).flat(),shape:[n,1,4],type:"float"})},this.model={halfDeltaTOverC:this.configuration.model.tickDurationOverC/2,particleCount:this.initialData.particleCount,particleTypes:this.initialData.particleTypes,bufferLength:this.initialData.bufferLength,stepCount:this.configuration.runner.stepCount,boundingBoxSize:this.configuration.model.boundingBoxSize,lattice:s,latticeConfig:this.configuration.model.lattice,interactions:{gravityConstant:this.configuration.model.interactions.gravityConstant,particleInteraction:this.configuration.model.interactions.particleInteraction,electricField:this.configuration.model.interactions.electricField,magneticField:this.configuration.model.interactions.magneticField}},t.simulate&&(this.push=on(this._regl,{variables:this.variables,model:this.model})),this.drawVariableTexture=fn(e,{variables:this.variables,particleCount:this.model.particleCount,bufferLength:this.model.bufferLength,texelSize:t.view.texelSize,x0:t.view.texelSize,y0:t.view.texelSize}),this.log=()=>{if(this.configuration.dumpData){const e=sn(this._regl,{variables:this.variables,model:this.model});this._logStore.push({tick:this.variables.tick.value,data:e})}},this.dump=()=>sn(this._regl,{variables:this.variables,model:this.model})}push(e=1){Array(e).fill().map(()=>{this.push({})})}reset(){un(this.variables.position,this.initialData.fourPositions),un(this.variables.velocity,this.initialData.fourVelocities),this.variables.tick.value=0}prerender(){const e=1,t=this.model.bufferLength-1,n=Array(Math.floor(t/e)).fill(e);t%e>0&&n.push(t%e),n.forEach(e=>{this.push(e),this.log()})}}class yn{constructor(e=!0){if(window.performanceLogger)return window.performanceLogger;this.current=null,this.active=e,this.entries=[],window.performanceLogger=this}start(e){this.active&&(this.current={label:e,t0:performance.now()})}stop(){this.active&&(this.current.t1=performance.now(),this.current.dt=this.current.t1-this.current.t0,this.entries.push(this.current))}}var wn=new yn;const xn=i()("pathicles:log"),_n=i()("pathicles:error");class An{constructor(e,{prerender:t=!1,stepCount:n=-1,stepsPerTick:r=1,looping:i=!1,mode:a="stepwise",simulate:o=!1}){this.simulate=o,this._simulation=e,this._prerender=t,this._stepCount=n<0?this._simulation.constants.model.bufferLength-1:n,this._stepsPerTick=r,this._looping=i,this._mode=a,this.fsm={state:"initial"}}toggleLooping(){this._looping=!this._looping}toggleMode(){this._mode="stepwise"===this._mode?"framewise":"stepwise"}toggleActivity(){"active"===this.fsm.state?this.fsm={state:"paused"}:"paused"===this.fsm.state&&(this.fsm={state:"active"}),xn("toggleActivity() for this.fsm.state: "+this.fsm.state)}start(){if("initial"!==this.fsm.state)throw _n("PathiclesRunner.start can be called in state initial only"),new Error("PathiclesRunner.start can be called in state initial only");this._prerender?(xn("start.prerender"),wn.start("prerender"),this.simulate&&(this._simulation.prerender(),wn.stop()),this._simulation.variables.tick.value=this._stepCount,this.fsm={state:"paused"}):this.fsm={state:"restart"}}next(){const e=this.fsm.state;if("active"===this.fsm.state)if(this._simulation.variables.tick.value>=this._stepCount-1)this._looping?this.fsm.state="restart":this.fsm.state="paused";else{for(let e=0;e<this._stepsPerTick;e++)if(this._simulation.push({}),this._simulation.variables.tick.value>=this._stepCount)break;"stepwise"===this._mode&&(this.fsm.state="paused")}else"restart"===this.fsm.state&&(this._simulation.reset({}),this.fsm.state=this.fsm.state.replace(/restart/,"active"));e!==this.fsm.state&&xn(e+" ==> "+this.fsm.state+" // "+this._simulation.variables.tick.value)}}var En=Tn;function Tn(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Cn(e,t,n,r,i,a){void 0===e&&(e=1),void 0===t&&(t=e),void 0===n&&(n=e),void 0===r&&(r=1),void 0===i&&(i=r),void 0===a&&(a=r);var o=0,s=[],c=[],u=[],f=[];function l(e,t,n,r,i,a,l,p,h,d){for(var m=o,v=0;v<=l;v++)for(var g=0;g<=a;g++){var b=s[o]=[0,0,0];b[e]=(-r/2+g*r/a)*h,b[t]=(-i/2+v*i/l)*d,b[n]=p;var y=c[o]=[0,0,0];y[e]=0,y[t]=0,y[n]=p/Math.abs(p);var w=u[o]=[0,0];w[0]=g/a,w[1]=1-v/l,++o}for(v=0;v<l;v++)for(g=0;g<a;g++){var x=m+v*(a+1)+g;f.push([x,x+a+1,x+a+2]),f.push([x,x+a+2,x+1])}}return l(0,1,2,e,t,r,i,n/2,1,-1),l(0,1,2,e,t,r,i,-n/2,-1,-1),l(2,1,0,n,t,a,i,-e/2,1,-1),l(2,1,0,n,t,a,i,e/2,-1,-1),l(0,2,1,e,n,r,a,t/2,1,1),l(0,2,1,e,n,r,a,-t/2,1,-1),{positions:s,normals:c,uvs:u,cells:f}}var On=Cn,Pn="precision mediump float;\n#extension GL_OES_standard_derivatives : enable\n#define GLSLIFY 1\n\nuniform vec2 uResolution;\nuniform vec2 uSunPosition;\nvarying vec2 vUv;\nuniform vec3 eye;\nvarying vec3 vPosition;\n\nconst vec3 fogColor = vec3(1.0);\nconst float FogDensity = 0.;\n\nvec3 getSky(vec2 uv) {\n  float atmosphere = sqrt(1.0-uv.y);\n  vec3 skyColor = vec3(0., 0., 0.);\n\n  float scatter = pow(uSunPosition.y / uResolution.y, 1.0 / 15.0);\n  scatter = 1.0 - clamp(scatter, 0.8, 1.0);\n\n  vec3 scatterColor = mix(vec3(1.0), vec3(1.0, 0.3, 0.0) * 1.5, scatter);\n  return mix(skyColor, vec3(scatterColor), atmosphere / 1.);\n\n}\n\nvec3 getSun(vec2 uv){\n  float sun = 1. - distance(uv, uSunPosition.xy / uResolution.x);\n  sun = clamp(sun, 0.0, 1.0);\n\n  float glow = sun;\n  glow = clamp(glow, 0.0, 1.0);\n\n  sun = pow(sun, 200.0);\n  sun *= 1.0;\n  sun = clamp(sun, 0.0, 1.0);\n\n  glow = pow(glow, 10.0) * 1.0;\n  glow = pow(glow, (uv.y));\n  glow = clamp(glow, 0.0, 1.0);\n\n  sun *= pow(dot(uv.y, uv.y), 1.0 / 1.65);\n\n  glow *= pow(dot(uv.y, uv.y), 1.0 / 2.0);\n\n  sun += glow;\n\n  vec3 sunColor = vec3(1.0, 1., 1.) * sun;\n\n  return vec3(sunColor);\n}\n\nfloat grid(vec2 st, float res){\n  vec2 grid = fract(st*res);\n  grid /= fwidth(st);\n  return 1. - (step(res, grid.x) * step(res, grid.y));\n}\n\nvoid main () {\n  vec3 sky = getSky(vUv);\n  vec3 sun = getSun(vUv);\n\n//\n//  float resolution = 1000.;\n//  vec2 grid_st = vUv * uResolution * resolution;\n//  vec3 color = vec3(.5);\n//  color += vec3(.5, .5, 0.) * grid(grid_st, 1. / resolution);\n//  color += vec3(0.2) * grid(grid_st, 10. / resolution);\n//\n//  float fogDistance = length(eye - vPosition);\n//\n//  gl_FragColor = vec4(color.rgb, exp(- fogDistance * FogDensity));\n\n    gl_FragColor = vec4(sky + sun, 1.);\n}\n",kn="precision highp float;\n#define GLSLIFY 1\nvarying vec3 vPosition;\nvarying vec2 vUv;\nattribute vec3 aPosition;\nattribute vec2 uv;\n\nuniform mat4 projection;\nuniform mat4 model;\nuniform mat4 view;\n\nvoid main()\n{\n  vUv = uv;\n  vec4 worldPosition = model * vec4(aPosition, 1.0);\n  vPosition = worldPosition.xyz;\n  gl_Position = projection * view * model * vec4(aPosition, 1.0);\n}\n";function Dn(e,{stageGrid:t}){const n=On(2*t.size,2*t.size,2*t.size);let r=En([]);return e({primitive:"triangles",elements:n.cells,attributes:{aPosition:n.positions,uv:n.uvs},uniforms:{uResolution:[t.size,t.size],uSunPosition:e=>[e.viewportHeight/2,e.viewportWidth/4*3],model:r},vert:kn,frag:Pn})}var Mn="precision highp float;\n#define GLSLIFY 1\nfloat inverse(float m) {\n  return 1.0 / m;\n}\n\nmat2 inverse(mat2 m) {\n  return mat2(m[1][1],-m[0][1],\n             -m[1][0], m[0][0]) / (m[0][0]*m[1][1] - m[0][1]*m[1][0]);\n}\n\nmat3 inverse(mat3 m) {\n  float a00 = m[0][0], a01 = m[0][1], a02 = m[0][2];\n  float a10 = m[1][0], a11 = m[1][1], a12 = m[1][2];\n  float a20 = m[2][0], a21 = m[2][1], a22 = m[2][2];\n\n  float b01 = a22 * a11 - a12 * a21;\n  float b11 = -a22 * a10 + a12 * a20;\n  float b21 = a21 * a10 - a11 * a20;\n\n  float det = a00 * b01 + a01 * b11 + a02 * b21;\n\n  return mat3(b01, (-a22 * a01 + a02 * a21), (a12 * a01 - a02 * a11),\n              b11, (a22 * a00 - a02 * a20), (-a12 * a00 + a02 * a10),\n              b21, (-a21 * a00 + a01 * a20), (a11 * a00 - a01 * a10)) / det;\n}\n\nmat4 inverse(mat4 m) {\n  float\n      a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n      a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n      a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n      a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\n\n      b00 = a00 * a11 - a01 * a10,\n      b01 = a00 * a12 - a02 * a10,\n      b02 = a00 * a13 - a03 * a10,\n      b03 = a01 * a12 - a02 * a11,\n      b04 = a01 * a13 - a03 * a11,\n      b05 = a02 * a13 - a03 * a12,\n      b06 = a20 * a31 - a21 * a30,\n      b07 = a20 * a32 - a22 * a30,\n      b08 = a20 * a33 - a23 * a30,\n      b09 = a21 * a32 - a22 * a31,\n      b10 = a21 * a33 - a23 * a31,\n      b11 = a22 * a33 - a23 * a32,\n\n      det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n\n  return mat4(\n      a11 * b11 - a12 * b10 + a13 * b09,\n      a02 * b10 - a01 * b11 - a03 * b09,\n      a31 * b05 - a32 * b04 + a33 * b03,\n      a22 * b04 - a21 * b05 - a23 * b03,\n      a12 * b08 - a10 * b11 - a13 * b07,\n      a00 * b11 - a02 * b08 + a03 * b07,\n      a32 * b02 - a30 * b05 - a33 * b01,\n      a20 * b05 - a22 * b02 + a23 * b01,\n      a10 * b10 - a11 * b08 + a13 * b06,\n      a01 * b08 - a00 * b10 - a03 * b06,\n      a30 * b04 - a31 * b02 + a33 * b00,\n      a21 * b02 - a20 * b04 - a23 * b00,\n      a11 * b07 - a10 * b09 - a12 * b06,\n      a00 * b09 - a01 * b07 + a02 * b06,\n      a31 * b01 - a30 * b03 - a32 * b00,\n      a20 * b03 - a21 * b01 + a22 * b00) / det;\n}\n\nfloat transpose(float m) {\n  return m;\n}\n\nmat2 transpose(mat2 m) {\n  return mat2(m[0][0], m[1][0],\n              m[0][1], m[1][1]);\n}\n\nmat3 transpose(mat3 m) {\n  return mat3(m[0][0], m[1][0], m[2][0],\n              m[0][1], m[1][1], m[2][1],\n              m[0][2], m[1][2], m[2][2]);\n}\n\nmat4 transpose(mat4 m) {\n  return mat4(m[0][0], m[1][0], m[2][0], m[3][0],\n              m[0][1], m[1][1], m[2][1], m[3][1],\n              m[0][2], m[1][2], m[2][2], m[3][2],\n              m[0][3], m[1][3], m[2][3], m[3][3]);\n}\n\nmat4 lookAt(vec3 eye, vec3 at, vec3 up) {\n  vec3 zaxis = normalize(eye - at);\n  vec3 xaxis = normalize(cross(zaxis, up));\n  vec3 yaxis = cross(xaxis, zaxis);\n  zaxis *= -1.;\n  return mat4(\n  vec4(xaxis.x, xaxis.y, xaxis.z, -dot(xaxis, eye)),\n  vec4(yaxis.x, yaxis.y, yaxis.z, -dot(yaxis, eye)),\n  vec4(zaxis.x, zaxis.y, zaxis.z, -dot(zaxis, eye)),\n  vec4(0, 0, 0, 1)\n  );\n}\n\nattribute vec3 aPosition;\nattribute vec3 aNormal;\nattribute float aParticle;\nattribute float aColorCorrection;\nattribute float aStep;\n\nuniform float particleCount;\nuniform float bufferLength;\nuniform float stepCount;\n\nuniform float dt;\nuniform vec2 viewRange;\n\nuniform float pathicleWidth;\nuniform float pathicleGap;\nuniform float stageGrid_y;\nuniform float stageGrid_size;\nuniform vec3 shadowColor;\n\nuniform sampler2D utParticleColorAndType;\nuniform sampler2D utPositionBuffer;\nuniform sampler2D utVelocityBuffer;\nuniform mat4 projection, view, model;\n\nvarying float toBeDiscarded;\nvarying vec3 vPosition;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nvarying vec3 vDiffuseColor;\nvarying float vColorCorrection;\n\nvec4 get_color(float p) {\n  vec2 coords = vec2(p, 0.) / vec2(particleCount, 1.);\n  return texture2D(utParticleColorAndType, coords);\n}\nvec4 get_position(float p, float b) {\n  vec2 coords = vec2(p, b) / vec2(particleCount, bufferLength);\n  return texture2D(utPositionBuffer, coords);\n}\nfloat calculateToBeDiscarded(vec4 previousFourPosition, vec4 currentFourPosition) {\n\n  float undefinedBuffer = (currentFourPosition.w == 0. || previousFourPosition.w > currentFourPosition.w) ? 1.0 : 0.0;\n  float beyondProgressLower = (currentFourPosition.w / dt < viewRange[0] * stepCount) ? 1.0 : 0.0;\n  float beyondProgressUpper =  (currentFourPosition.w / dt > viewRange[1] * stepCount) ? 1.0 : 0.0;\n  float outsideGrid = (currentFourPosition.x > stageGrid_size || currentFourPosition.x < -stageGrid_size\n  || currentFourPosition.y > stageGrid_size || currentFourPosition.y < -stageGrid_size\n  || currentFourPosition.z > stageGrid_size || currentFourPosition.z < -stageGrid_size) ? 1.0 : 0.0;\n\n  return (outsideGrid > 0. || undefinedBuffer > 0. || beyondProgressLower > 0. || beyondProgressUpper > 0.) ? 1.0 : 0.0;\n\n}\n\nvoid main () {\n\n  #ifdef lighting\n  vDiffuseColor = get_color(aParticle).rgb;\n  #endif\n\n  #ifdef shadow\n  vDiffuseColor = shadowColor;\n  #endif\n\n  float previousBufferHead = (aStep < 1.) ? bufferLength : aStep - 1.;\n  vec4 previousFourPosition = get_position(aParticle, previousBufferHead);\n  vec4 currentFourPosition = get_position(aParticle, aStep);\n\n  mat4 lookAtMat4 = lookAt(currentFourPosition.xyz, previousFourPosition.xyz, vec3(0., 1, 0.));\n\n  float scale = 1.;\n  #ifdef lighting\n  scale = 1.;\n  #endif\n\n  #ifdef shadow\n//  scale = 2.;\n  if (aPosition.z < 0.) toBeDiscarded = 1.;\n  #endif\n\n  vec3 scaledPosition = vec3(\n  scale * aPosition.x,\n  aPosition.y,\n  scale * aPosition.z * (length(previousFourPosition.xyz - currentFourPosition.xyz) - pathicleGap));\n\n  vPosition = vec3(1., 1., 1.) * (((lookAtMat4 * vec4(scaledPosition, 1.)).xyz\n  + 0.5 * (currentFourPosition.xyz + previousFourPosition.xyz)));\n  #ifdef shadow\n  vPosition.y = vPosition.y * 0. + stageGrid_y + .1;\n  #endif\n  vNormal = normalize((transpose(inverse(lookAtMat4)) * vec4(aNormal, 0.)).xyz);\n\n  gl_Position = projection * view * model * vec4(vPosition, 1.0);\n\n  #ifdef lighting\n  vColorCorrection =  -1. * aColorCorrection;\n\n  if (\n  abs(dot(\n  aNormal,\n  vec3(0., 0., 1.)\n  )) == 1.) { vColorCorrection += -.2; }\n\n    #endif\n\n    #ifdef shadow\n  vColorCorrection = 0.;\n  #endif\n\n  toBeDiscarded = calculateToBeDiscarded(previousFourPosition, currentFourPosition);\n\n}\n\n",Sn="precision highp float;\n#define GLSLIFY 1\n\nvarying float toBeDiscarded;\nvarying vec3 vPosition;\nvarying vec3 vNormal;\nvarying vec3 vDiffuseColor;\nvarying float vColorCorrection;\n\nuniform float ambientIntensity;\nuniform float stageGrid_size;\nuniform vec3 eye;\n\nvoid main () {\n\n  if (toBeDiscarded > .0) discard;\n\n  //if (length(vPosition.z) > stageGrid_size/2. - .5) discard;\n\n  vec3 materialColor = (1. + vColorCorrection) * vDiffuseColor;\n  vec3 ambientColor = (ambientIntensity * vec3(1., 1., 1.) * materialColor).rgb;\n  vec3 lightingColor = 3. * ambientColor;\n\n  float opacity = 1.;\n  #ifdef shadow\n  gl_FragColor = vec4(0.6, 0.6, 0.6, .5);\n  #endif\n  #ifdef lighting\n  gl_FragColor = vec4(lightingColor, opacity);\n  #endif\n\n}\n\n",zn=Fn;function Fn(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function Ln(e,{variables:t,model:n,view:r}){const i=({pathicleWidth:e,pathicleRelativeHeight:t})=>On(e,e*t,1),a=i({pathicleWidth:r.pathicleWidth,pathicleRelativeHeight:r.pathicleRelativeHeight});let o=En([]);const s=i=>e({blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:1},equation:{rgb:"add",alpha:"add"},color:[1,1,0,1]},primitive:"triangles",elements:a.cells,instances:()=>n.particleCount*Math.min(t.tick.value,n.bufferLength),attributes:{aPosition:a.positions,aNormal:a.normals,aParticle:{buffer:e.buffer(Array(n.particleCount*n.bufferLength).fill(0).map((e,t)=>t%n.particleCount)),divisor:1},aColorCorrection:{buffer:e.buffer(Array(n.particleCount*n.bufferLength).fill(0).map((e,t)=>{const r=Math.sqrt(n.particleCount),i=t%n.particleCount,a=Math.floor(i/r)-r/2,o=i%Math.sqrt(n.particleCount)-r/2,s=(o**2+a**2)/r**2;return.5*Math.pow(Math.cos(2*s),4)})),divisor:1},aStep:{buffer:e.buffer(Array(n.particleCount*n.bufferLength).fill(0).map((e,t)=>Math.floor(t/n.particleCount))),divisor:1}},vert:[`#define ${i} 1`,Mn].join("\n"),frag:[`#define ${i} 1`,Sn].join("\n"),uniforms:{ambientIntensity:r.ambientIntensity,utParticleColorAndType:()=>t.particleColorsAndTypes,utPositionBuffer:()=>t.position[0],viewRange:(e,t)=>t.viewRange||[0,1],stageGrid_y:r.stageGrid.y,shadowColor:r.shadowColor,stageGrid_size:r.stageGrid.size,model:(e,t)=>zn(o,[t.modelTranslateX||0,t.modelTranslateY||0,0])}});return{lighting:s("lighting"),shadow:s("shadow")}}function Rn(e,t,n,r,i){e=e||1,t=t||1,n=n||1,r=r||1;const a=!(!i||!i.quads)&&i.quads,o=[],s=[],c=[],u=[];for(let f=0;f<=r;f++)for(let i=0;i<=n;i++){const l=i/n,p=f/r,h=-e/2+l*e,d=t/2-p*t;o.push([h,0,d]),s.push([l,1-p]),c.push([0,0,1]),f<r&&i<n&&(a?u.push([f*(n+1)+i,(f+1)*(n+1)+i,(f+1)*(n+1)+i+1,f*(n+1)+i+1]):(u.push([f*(n+1)+i,(f+1)*(n+1)+i+1,f*(n+1)+i+1]),u.push([(f+1)*(n+1)+i+1,f*(n+1)+i,(f+1)*(n+1)+i])))}return{positions:o,normals:c,uvs:s,cells:u}}var jn,Bn,In="precision mediump float;\n#extension GL_OES_standard_derivatives : enable\n#define GLSLIFY 1\n\nuniform vec2 uResolution;\nuniform vec3 eye;\nuniform sampler2D uTex;\nuniform float ambientIntensity;\nvarying vec3 vPosition;\nvarying vec3 vNormal;\nvarying vec2 vUv;\n\nconst vec3 fogColor = vec3(1.0);\nconst float FogDensity = 0.3;\n\nfloat grid(vec2 st, float res, float width) {\n  vec2 grid =  fract(st*res) / width;\n  grid /= fwidth(st);\n  return 1. - (step(res, grid.x) * step(res, grid.y));\n}\n\nvoid main() {\n\n  float resolution = 1.;\n  vec2 grid_st = vUv * uResolution * resolution;\n  vec3 color = vec3(.6);\n  color -= vec3(.75) * grid(grid_st, 1. / resolution, 3.);\n  color -= vec3(.5) * grid(grid_st, 10. / resolution, 1.);\n\n  float fogDistance = length(eye - vPosition);\n\n  gl_FragColor = vec4(color.rgb, exp(- fogDistance * FogDensity));\n\n}\n",Nn="precision mediump float;\n#define GLSLIFY 1\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 uv;\n//\nuniform vec3 uOffset;\nuniform mat4 projection;\nuniform mat4 view;\n//\nvarying vec2 vUv;\nvarying vec3 vPosition;\n\nvoid main () {\n  vUv = uv / 1.;\n  vPosition = position + uOffset;\n\n  gl_Position = projection * view * vec4(vPosition, 1.);\n}\n";function Vn(e,{stageGrid:t}){const n=Rn(t.size,t.size),r=()=>e({cull:{enable:!0,face:"front"},primitive:"triangles",elements:n.cells,attributes:{position:n.positions,uv:n.uvs},uniforms:{uOffset:[0,t.y-0,0],uResolution:[t.size,t.size]},vert:Nn,frag:In});return{lighting:r()}}function Un(e,{variables:t,model:n,config:r}){const i={bufferLength:n.bufferLength,particleCount:n.particleCount,stepCount:n.stepCount||n.bufferLength,pathicleGap:r.view.pathicleRelativeGap*r.view.pathicleWidth,pathicleWidth:r.view.pathicleWidth,viewRange:e.prop("viewRange"),ambient:(e,t)=>new Array(3).fill(t.ambientIntensity),pointLightPosition:r.view.lights[0].position,dt:2*n.halfDeltaTOverC,rgbGamma:r.view.rgbGamma},a=e({uniforms:i}),o=Ln(e,{variables:t,model:n,view:r.view}),s=Vn(e,r.view),c=Dn(e,r.view);function u(e){a(r.view,()=>{c(),r.view.isStageVisible&&s.lighting(e),r.view.isShadowEnabled&&o.shadow(e),o.lighting(e)})}const f=()=>{};return{destroy:f,drawDiffuse:u}}try{jn=Map}catch(Ar){}try{Bn=Set}catch(Ar){}function Hn(e){if(!e||"object"!==typeof e||"function"===typeof e)return e;if(e.nodeType&&"cloneNode"in e)return e.cloneNode(!0);if(e instanceof Date)return new Date(e.getTime());if(e instanceof RegExp)return new RegExp(e);if(Array.isArray(e))return e.map(Hn);if(jn&&e instanceof jn)return new Map(Array.from(e.entries()));if(Bn&&e instanceof Bn)return new Set(Array.from(e.values()));if(e instanceof Object){var t={};for(var n in e)t[n]=Hn(e[n]);return t}return e}var qn=Hn,Yn=[{name:"primitive",is:function(e){var t=typeof e;return"number"===t||"string"===t||"boolean"===t},default:"default",merge:{default:function(e,t,n){return n}}},{name:"object",is:function(e){return null!==e&&"object"===typeof e},default:"deep",merge:{deep:function(e,t,n){var r={},i={a:Object.keys(t),b:Object.keys(n)};return i.a.concat(i.b).forEach((function(i){r[i]=e(t[i],n[i])})),r}}},{name:"array",is:function(e){return Array.isArray(e)},default:"replace",merge:{merge:function(e,t,n){for(var r=[],i=0;i<Math.max(t.length,n.length);++i)r.push(e(t[i],n[i]));return r},replace:function(e,t,n){return qn(n)},concat:function(e,t,n){return[].concat(t).concat(n)}}}],Gn=Yn;function Qn(e){return{strategy:e.strategy||{},types:{mode:(e.types||{}).mode||"add",list:(e.types||{}).list||[]}}}function Wn(e){e=Qn(e||{}),this.types=("add"===e.types.mode?Gn:[]).concat(e.types.list),this.config=e}Wn.prototype.determineType=function(e,t){for(var n=this.types.length-1;n>=0;--n){var r=this.types[n];if(r.is(e)&&r.is(t))return r;if(r.is(e)||r.is(t))break}return null},Wn.prototype.step=function(e,t){if(void 0===t)return qn(e);var n=this.determineType(e,t);if(!n)return qn(t);var r=this.config.strategy[n.name]||n.default;return n.merge[r](this.step.bind(this),e,t)},Wn.prototype.merge=function(){for(var e,t=Array.prototype.slice.call(arguments),n=t.length;n>0;--n)e=this.step(t.pop(),e);return e};var Xn=Wn,Jn=new Xn,Zn=function(){return Jn.merge.apply(Jn,arguments)};const $n={MAX_CANVAS_SIZE:1024,MAX_PARTICLE_COUNT:512,MAX_BUFFER_LENGTH:256,logPushing:!1,logPerformance:!1,stats:!1,profile:!1,colors:[[.92,.75,0],[.12,.45,.65],[.12,.45,.65],[.77,.2,.2]],mass:[0,510998.94,510998.94,938272081],charge:[0,-1,1,1],chargeMassRatio:[0,-175882004556.243,175882004556.243,95788332.3113771],usePostProcessing:!1,pusher:"boris",runner:{prerender:!1,looping:!0,mode:"framewise",stepsPerTick:2,stepCount:256},model:{bufferLength:128,tickDurationOverC:.2,boundingBoxSize:-1,emitter:{particleType:"ELECTRON",randomize:!1,bunchShape:"disc",particleCount:256,particleSeparation:.1,gamma:0,position:[0,0,0],direction:[0,0,1],directionJitter:[0,0,0],positionJitter:[0,0,0]},interactions:{particleInteraction:!1,gravityConstant:0,electricField:[0,0,0],magneticField:[0,0,0]},lattice:{elements:{},beamline:[]}},view:{ssaoEnabled:!1,stageGrid:{resolution:256,y:-1,size:20,dark:1,light:.8},sky:[.9,1,0,1],shadowColor:[.3,.3,.3],ambientIntensity:.6,diffuse:0,exposure:.2,fresnel:1,fxaa:!1,rgbGamma:1,isStageVisible:!0,isShadowEnabled:!1,isLatticeVisible:!1,pathicleRelativeGap:1,pathicleRelativeHeight:5,pathicleWidth:.005,roughness:.7,specular:1,ssaoBlurPower:2,ssaoBlurRadius:.1,ssaoPower:1,ssaoSampleCount:32,showTextures:!1,texelSize:2,viewRange:[0,1],lights:[{position:[0,1,0],direction:[1,1,0],color:new Array(3).fill(0)},{position:[0,1,0],direction:[-1,-1,0],color:new Array(3).fill(0)}],camera:{center:[0,0,0],theta:Math.PI/2,phi:0,distance:10,fovY:Math.PI/2.5,dTheta:.01,autorotate:!0,rotateAboutCenter:!0,zoomAboutCursor:!1,zoomDecayTime:1,far:50,near:1e-4}},dumpData:!1},Kn={name:"story-dipole",view:{camera:{center:[0,.1,0],theta:2*Math.PI/4,phi:2*Math.PI/24,distance:5}},model:{emitter:{particleType:"ELECTRON",bunchShape:"SQUARE",direction:[0,.15,-1],position:[3.2,-1.5,0],directionJitter:[.05,0,.05],positionJitter:[.5,.5,.1],gamma:900},interactions:{magneticField:[0,.5,0],particleInteraction:!1},lattice:{elements:{l2:{type:"DRIF",l:0},bm:{type:"SBEN",angle:.78539816,e1:.39269908,e2:.39269908,l:10,k1:-.5}},beamline:[],origin:{phi:0,position:[-5,1,0]}}}},er={name:"story-electric",view:{camera:{center:[-2,0,0],theta:Math.PI/4,phi:0,distance:5}},model:{emitter:{particleType:"ELECTRON ELECTRON ELECTRON PROTON PROTON PROTON   PHOTON PHOTON PHOTON",bunchShape:"SQUARE",direction:[0,0,1],position:[0,1,-10],directionJitter:[.01,.01,0],positionJitter:[.1,.1,0],gamma:10},interactions:{electricField:[0,0,.001],particleInteraction:!1,magneticField:[0,0,0]},lattice:{elements:{l1:{type:"DRIF",l:3},q1:{type:"QUAD",k1:0,l:3},q2:{type:"QUAD",k1:-0,l:3},l2:{type:"DRIF",l:3}},beamline:["l1","q1","q2","l2"],origin:{phi:0,position:[0,1,-6]}}}},tr={name:"story-quadrupole",view:{camera:{center:[0,1,0],theta:2*Math.PI/8,phi:2*Math.PI/72,distance:6}},model:{emitter:{bunchShape:"SQUARE_YZ",particleType:"ELECTRON ELECTRON ELECTRON PROTON ELECTRON ELECTRON ELECTRON ELECTRON PHOTON",position:[-5,1,0],direction:[1,0,0],directionJitter:[0,.1,.1],positionJitter:[0,.1,.1],gamma:1e3},lattice:{elements:{l1:{type:"DRIF",l:3},q1:{type:"QUAD",k1:-.05,l:3},q2:{type:"QUAD",k1:.15,l:3},l2:{type:"DRIF",l:3}},beamline:["l1","q1","q2","l2"],origin:{phi:-Math.PI/2,position:[-10,1,0]}}}},nr={name:"random",view:{camera:{center:[0,0,0],theta:-.6163632477299,phi:.04608544417465289,distance:5}},model:{boundingBoxSize:2,emitter:{randomize:!0,gamma:100,particleType:"PHOTON ELECTRON PROTON"},lattice:{elements:{l2:{type:"DRIF",l:5},bm:{type:"SBEN",angle:.78539816,e1:.39269908,e2:.39269908,l:1.8,k1:-.4}},beamline:[],origin:{phi:-Math.PI,position:[0,1,5]}}}},rr={name:"free-electron",view:{camera:{center:[0,0,0],theta:Math.PI/2,phi:0,distance:2,fovY:Math.PI/3,dTheta:.001,autorotate:!1,rotateAboutCenter:!0,zoomAboutCursor:!1,zoomDecayTime:1,far:50,near:1e-4}},runner:{prerender:!0,looping:!0,mode:"framewise",stepsPerTick:1,stepCount:10},model:{bufferLength:11,tickDurationOverC:.1,emitter:{particleCount:1,particleType:"ELECTRON",bunchShape:"SQUARE",direction:[0,0,1],position:[0,0,0],directionJitter:[0,0,0],positionJitter:[0,0,0],gamma:2},interactions:{electricField:[0,0,1],particleInteraction:!1,magneticField:[0,0,0]}}},ir={name:"free-photon",view:{camera:{center:[0,-.5,0],theta:Math.PI/2,phi:Math.PI/4,distance:1,fovY:Math.PI/3,dTheta:.001,autorotate:!1,rotateAboutCenter:!0,zoomAboutCursor:!1,zoomDecayTime:1,far:50,near:1e-4}},runner:{prerender:!0,looping:!0,mode:"framewise",stepsPerTick:1,stepCount:10},model:{bufferLength:11,tickDurationOverC:.1,emitter:{particleCount:1,particleType:"PHOTON",bunchShape:"SQUARE",direction:[0,0,1],position:[0,0,0],directionJitter:[0,0,0],positionJitter:[0,0,0],gamma:10},interactions:{electricField:[0,0,.01],particleInteraction:!1,magneticField:[0,0,0]}}},ar={name:"free-photons",view:{camera:{center:[0,0,0],theta:Math.PI/2,phi:0,distance:2,fovY:Math.PI/3,dTheta:.001,autorotate:!1,rotateAboutCenter:!0,zoomAboutCursor:!1,zoomDecayTime:1,far:50,near:1e-4}},runner:{prerender:!0,looping:!0,mode:"framewise",stepsPerTick:1,stepCount:8},model:{bufferLength:8,tickDurationOverC:.1,emitter:{particleCount:2,particleType:"PHOTON ELECTRON PROTON",bunchShape:"SQUARE",direction:[0,0,1],position:[0,-.5,0],directionJitter:[0,0,0],positionJitter:[0,0,0],gamma:1.1},interactions:{electricField:[0,0,.091],particleInteraction:!1,magneticField:[0,0,0]}}},or={[Kn.name]:Kn,[er.name]:er,[tr.name]:tr,[rr.name]:rr,[ir.name]:ir,[ar.name]:ar,[nr.name]:nr},sr=e=>Zn($n,or[e])||$n;var cr,ur;Object.freeze({__proto__:null,config:sr,defaultConfig:$n,presets:or});try{cr=Map}catch(Ar){}try{ur=Set}catch(Ar){}function fr(e){if(!e||"object"!==typeof e||"function"===typeof e)return e;if(e.nodeType&&"cloneNode"in e)return e.cloneNode(!0);if(e instanceof Date)return new Date(e.getTime());if(e instanceof RegExp)return new RegExp(e);if(Array.isArray(e))return e.map(fr);if(cr&&e instanceof cr)return new Map(Array.from(e.entries()));if(ur&&e instanceof ur)return new Set(Array.from(e.values()));if(e instanceof Object){var t={};for(var n in e)t[n]=fr(e[n]);return t}return e}var lr=fr,pr=[{name:"primitive",is:function(e){var t=typeof e;return"number"===t||"string"===t||"boolean"===t},default:"default",merge:{default:function(e,t,n){return n}}},{name:"object",is:function(e){return null!==e&&"object"===typeof e},default:"deep",merge:{deep:function(e,t,n){var r={},i={a:Object.keys(t),b:Object.keys(n)};return i.a.concat(i.b).forEach((function(i){r[i]=e(t[i],n[i])})),r}}},{name:"array",is:function(e){return Array.isArray(e)},default:"replace",merge:{merge:function(e,t,n){for(var r=[],i=0;i<Math.max(t.length,n.length);++i)r.push(e(t[i],n[i]));return r},replace:function(e,t,n){return lr(n)},concat:function(e,t,n){return[].concat(t).concat(n)}}}],hr=pr;function dr(e){return{strategy:e.strategy||{},types:{mode:(e.types||{}).mode||"add",list:(e.types||{}).list||[]}}}function mr(e){e=dr(e||{}),this.types=("add"===e.types.mode?hr:[]).concat(e.types.list),this.config=e}mr.prototype.determineType=function(e,t){for(var n=this.types.length-1;n>=0;--n){var r=this.types[n];if(r.is(e)&&r.is(t))return r;if(r.is(e)||r.is(t))break}return null},mr.prototype.step=function(e,t){if(void 0===t)return lr(e);var n=this.determineType(e,t);if(!n)return lr(t);var r=this.config.strategy[n.name]||n.default;return n.merge[r](this.step.bind(this),e,t)},mr.prototype.merge=function(){for(var e,t=Array.prototype.slice.call(arguments),n=t.length;n>0;--n)e=this.step(t.pop(),e);return e};var vr=mr;new vr,"undefined"!==typeof globalThis?globalThis:"undefined"!==typeof window?window:"undefined"!==typeof e||"undefined"!==typeof self&&self;function gr(e,t){return t={exports:{}},e(t,t.exports),t.exports}gr((function(e,t){(function(t,n){e.exports=n()})(0,(function(){var e=function(e,t){for(var n=Object.keys(t),r=0;r<n.length;++r)e[n[r]]=t[n[r]];return e},t=0,n=0;function r(e,n){this.id=t++,this.type=e,this.data=n}function i(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function a(e){if(0===e.length)return[];var t=e.charAt(0),n=e.charAt(e.length-1);if(e.length>1&&t===n&&('"'===t||"'"===t))return['"'+i(e.substr(1,e.length-2))+'"'];var r=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(e);if(r)return a(e.substr(0,r.index)).concat(a(r[1])).concat(a(e.substr(r.index+r[0].length)));var o=e.split(".");if(1===o.length)return['"'+i(e)+'"'];for(var s=[],c=0;c<o.length;++c)s=s.concat(a(o[c]));return s}function o(e){return"["+a(e).join("][")+"]"}function s(e,t){return new r(e,o(t+""))}function c(e){return"function"===typeof e&&!e._reglType||e instanceof r}function u(e,t){return"function"===typeof e?new r(n,e):e}var f={DynamicVariable:r,define:s,isDynamic:c,unbox:u,accessor:o},l={next:"function"===typeof requestAnimationFrame?function(e){return requestAnimationFrame(e)}:function(e){return setTimeout(e,16)},cancel:"function"===typeof cancelAnimationFrame?function(e){return cancelAnimationFrame(e)}:clearTimeout},p="undefined"!==typeof performance&&performance.now?function(){return performance.now()}:function(){return+new Date};function h(){var e={"":0},t=[""];return{id:function(n){var r=e[n];return r||(r=e[n]=t.length,t.push(n),r)},str:function(e){return t[e]}}}function d(t,n,r){var i=document.createElement("canvas");function a(){var n=window.innerWidth,a=window.innerHeight;if(t!==document.body){var o=t.getBoundingClientRect();n=o.right-o.left,a=o.bottom-o.top}i.width=r*n,i.height=r*a,e(i.style,{width:n+"px",height:a+"px"})}function o(){window.removeEventListener("resize",a),t.removeChild(i)}return e(i.style,{border:0,margin:0,padding:0,top:0,left:0}),t.appendChild(i),t===document.body&&(i.style.position="absolute",e(t.style,{margin:0,padding:0})),window.addEventListener("resize",a,!1),a(),{canvas:i,onDestroy:o}}function m(e,t){function n(n){try{return e.getContext(n,t)}catch(r){return null}}return n("webgl")||n("experimental-webgl")||n("webgl-experimental")}function v(e){return"string"===typeof e.nodeName&&"function"===typeof e.appendChild&&"function"===typeof e.getBoundingClientRect}function g(e){return"function"===typeof e.drawArrays||"function"===typeof e.drawElements}function b(e){return"string"===typeof e?e.split():e}function y(e){return"string"===typeof e?document.querySelector(e):e}function w(e){var t,n,r,i,a=e||{},o={},s=[],c=[],u="undefined"===typeof window?1:window.devicePixelRatio,f=!1,l=function(e){},p=function(){};if("string"===typeof a?t=document.querySelector(a):"object"===typeof a&&(v(a)?t=a:g(a)?(i=a,r=i.canvas):("gl"in a?i=a.gl:"canvas"in a?r=y(a.canvas):"container"in a&&(n=y(a.container)),"attributes"in a&&(o=a.attributes),"extensions"in a&&(s=b(a.extensions)),"optionalExtensions"in a&&(c=b(a.optionalExtensions)),"onDone"in a&&(l=a.onDone),"profile"in a&&(f=!!a.profile),"pixelRatio"in a&&(u=+a.pixelRatio))),t&&("canvas"===t.nodeName.toLowerCase()?r=t:n=t),!i){if(!r){var h=d(n||document.body,l,u);if(!h)return null;r=h.canvas,p=h.onDestroy}o.premultipliedAlpha=o.premultipliedAlpha||!1,i=m(r,o)}return i?{gl:i,canvas:r,container:n,extensions:s,optionalExtensions:c,pixelRatio:u,profile:f,onDone:l,onDestroy:p}:(p(),l("webgl not supported, try upgrading your browser or graphics drivers http://get.webgl.org"),null)}function x(e,t){var n={};function r(t){var r,i=t.toLowerCase();try{r=n[i]=e.getExtension(i)}catch(a){}return!!r}for(var i=0;i<t.extensions.length;++i){var a=t.extensions[i];if(!r(a))return t.onDestroy(),t.onDone('"'+a+'" extension is not supported by the current WebGL context, try upgrading your system or a different browser'),null}return t.optionalExtensions.forEach(r),{extensions:n,restore:function(){Object.keys(n).forEach((function(e){if(n[e]&&!r(e))throw new Error("(regl): error restoring extension "+e)}))}}}function _(e,t){for(var n=Array(e),r=0;r<e;++r)n[r]=t(r);return n}var A=5120,E=5121,T=5122,C=5123,O=5124,P=5125,k=5126;function D(e){for(var t=16;t<=1<<28;t*=16)if(e<=t)return t;return 0}function M(e){var t,n;return t=(e>65535)<<4,e>>>=t,n=(e>255)<<3,e>>>=n,t|=n,n=(e>15)<<2,e>>>=n,t|=n,n=(e>3)<<1,e>>>=n,t|=n,t|e>>1}function S(){var e=_(8,(function(){return[]}));function t(t){var n=D(t),r=e[M(n)>>2];return r.length>0?r.pop():new ArrayBuffer(n)}function n(t){e[M(t.byteLength)>>2].push(t)}function r(e,n){var r=null;switch(e){case A:r=new Int8Array(t(n),0,n);break;case E:r=new Uint8Array(t(n),0,n);break;case T:r=new Int16Array(t(2*n),0,n);break;case C:r=new Uint16Array(t(2*n),0,n);break;case O:r=new Int32Array(t(4*n),0,n);break;case P:r=new Uint32Array(t(4*n),0,n);break;case k:r=new Float32Array(t(4*n),0,n);break;default:return null}return r.length!==n?r.subarray(0,n):r}function i(e){n(e.buffer)}return{alloc:t,free:n,allocType:r,freeType:i}}var z=S();z.zero=S();var F=3408,L=3410,R=3411,j=3412,B=3413,I=3414,N=3415,V=33901,U=33902,H=3379,q=3386,Y=34921,G=36347,Q=36348,W=35661,X=35660,J=34930,Z=36349,$=34076,K=34024,ee=7936,te=7937,ne=7938,re=35724,ie=34047,ae=36063,oe=34852,se=3553,ce=34067,ue=34069,fe=33984,le=6408,pe=5126,he=5121,de=36160,me=36053,ve=36064,ge=16384,be=function(e,t){var n=1;t.ext_texture_filter_anisotropic&&(n=e.getParameter(ie));var r=1,i=1;t.webgl_draw_buffers&&(r=e.getParameter(oe),i=e.getParameter(ae));var a=!!t.oes_texture_float;if(a){var o=e.createTexture();e.bindTexture(se,o),e.texImage2D(se,0,le,1,1,0,le,pe,null);var s=e.createFramebuffer();if(e.bindFramebuffer(de,s),e.framebufferTexture2D(de,ve,se,o,0),e.bindTexture(se,null),e.checkFramebufferStatus(de)!==me)a=!1;else{e.viewport(0,0,1,1),e.clearColor(1,0,0,1),e.clear(ge);var c=z.allocType(pe,4);e.readPixels(0,0,1,1,le,pe,c),e.getError()?a=!1:(e.deleteFramebuffer(s),e.deleteTexture(o),a=1===c[0]),z.freeType(c)}}var u="undefined"!==typeof navigator&&(/MSIE/.test(navigator.userAgent)||/Trident\//.test(navigator.appVersion)||/Edge/.test(navigator.userAgent)),f=!0;if(!u){var l=e.createTexture(),p=z.allocType(he,36);e.activeTexture(fe),e.bindTexture(ce,l),e.texImage2D(ue,0,le,3,3,0,le,he,p),z.freeType(p),e.bindTexture(ce,null),e.deleteTexture(l),f=!e.getError()}return{colorBits:[e.getParameter(L),e.getParameter(R),e.getParameter(j),e.getParameter(B)],depthBits:e.getParameter(I),stencilBits:e.getParameter(N),subpixelBits:e.getParameter(F),extensions:Object.keys(t).filter((function(e){return!!t[e]})),maxAnisotropic:n,maxDrawbuffers:r,maxColorAttachments:i,pointSizeDims:e.getParameter(V),lineWidthDims:e.getParameter(U),maxViewportDims:e.getParameter(q),maxCombinedTextureUnits:e.getParameter(W),maxCubeMapSize:e.getParameter($),maxRenderbufferSize:e.getParameter(K),maxTextureUnits:e.getParameter(J),maxTextureSize:e.getParameter(H),maxAttributes:e.getParameter(Y),maxVertexUniforms:e.getParameter(G),maxVertexTextureUnits:e.getParameter(X),maxVaryingVectors:e.getParameter(Q),maxFragmentUniforms:e.getParameter(Z),glsl:e.getParameter(re),renderer:e.getParameter(te),vendor:e.getParameter(ee),version:e.getParameter(ne),readFloat:a,npotTextureCube:f}},ye=function(e){return e instanceof Uint8Array||e instanceof Uint16Array||e instanceof Uint32Array||e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array||e instanceof Float32Array||e instanceof Float64Array||e instanceof Uint8ClampedArray};function we(e){return!!e&&"object"===typeof e&&Array.isArray(e.shape)&&Array.isArray(e.stride)&&"number"===typeof e.offset&&e.shape.length===e.stride.length&&(Array.isArray(e.data)||ye(e.data))}var xe=function(e){return Object.keys(e).map((function(t){return e[t]}))},_e={shape:Pe,flatten:Oe};function Ae(e,t,n){for(var r=0;r<t;++r)n[r]=e[r]}function Ee(e,t,n,r){for(var i=0,a=0;a<t;++a)for(var o=e[a],s=0;s<n;++s)r[i++]=o[s]}function Te(e,t,n,r,i,a){for(var o=a,s=0;s<t;++s)for(var c=e[s],u=0;u<n;++u)for(var f=c[u],l=0;l<r;++l)i[o++]=f[l]}function Ce(e,t,n,r,i){for(var a=1,o=n+1;o<t.length;++o)a*=t[o];var s=t[n];if(t.length-n===4){var c=t[n+1],u=t[n+2],f=t[n+3];for(o=0;o<s;++o)Te(e[o],c,u,f,r,i),i+=a}else for(o=0;o<s;++o)Ce(e[o],t,n+1,r,i),i+=a}function Oe(e,t,n,r){var i=1;if(t.length)for(var a=0;a<t.length;++a)i*=t[a];else i=0;var o=r||z.allocType(n,i);switch(t.length){case 0:break;case 1:Ae(e,t[0],o);break;case 2:Ee(e,t[0],t[1],o);break;case 3:Te(e,t[0],t[1],t[2],o,0);break;default:Ce(e,t,0,o,0)}return o}function Pe(e){for(var t=[],n=e;n.length;n=n[0])t.push(n.length);return t}var ke={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121},De=5120,Me=5122,Se=5124,ze=5121,Fe=5123,Le=5125,Re=5126,je=5126,Be={int8:De,int16:Me,int32:Se,uint8:ze,uint16:Fe,uint32:Le,float:Re,float32:je},Ie=35048,Ne=35040,Ve={dynamic:Ie,stream:Ne,static:35044},Ue=_e.flatten,He=_e.shape,qe=35044,Ye=35040,Ge=5121,Qe=5126,We=[];function Xe(e){return 0|ke[Object.prototype.toString.call(e)]}function Je(e,t){for(var n=0;n<t.length;++n)e[n]=t[n]}function Ze(e,t,n,r,i,a,o){for(var s=0,c=0;c<n;++c)for(var u=0;u<r;++u)e[s++]=t[i*c+a*u+o]}function $e(e,t,n,r){var i=0,a={};function o(t){this.id=i++,this.buffer=e.createBuffer(),this.type=t,this.usage=qe,this.byteLength=0,this.dimension=1,this.dtype=Ge,this.persistentData=null,n.profile&&(this.stats={size:0})}o.prototype.bind=function(){e.bindBuffer(this.type,this.buffer)},o.prototype.destroy=function(){p(this)};var s=[];function c(e,t){var n=s.pop();return n||(n=new o(e)),n.bind(),l(n,t,Ye,0,1,!1),n}function u(e){s.push(e)}function f(t,n,r){t.byteLength=n.byteLength,e.bufferData(t.type,n,r)}function l(e,t,n,r,i,a){var o,s;if(e.usage=n,Array.isArray(t)){if(e.dtype=r||Qe,t.length>0)if(Array.isArray(t[0])){o=He(t);for(var c=1,u=1;u<o.length;++u)c*=o[u];e.dimension=c,s=Ue(t,o,e.dtype),f(e,s,n),a?e.persistentData=s:z.freeType(s)}else if("number"===typeof t[0]){e.dimension=i;var l=z.allocType(e.dtype,t.length);Je(l,t),f(e,l,n),a?e.persistentData=l:z.freeType(l)}else ye(t[0])&&(e.dimension=t[0].length,e.dtype=r||Xe(t[0])||Qe,s=Ue(t,[t.length,t[0].length],e.dtype),f(e,s,n),a?e.persistentData=s:z.freeType(s))}else if(ye(t))e.dtype=r||Xe(t),e.dimension=i,f(e,t,n),a&&(e.persistentData=new Uint8Array(new Uint8Array(t.buffer)));else if(we(t)){o=t.shape;var p=t.stride,h=t.offset,d=0,m=0,v=0,g=0;1===o.length?(d=o[0],m=1,v=p[0],g=0):2===o.length&&(d=o[0],m=o[1],v=p[0],g=p[1]),e.dtype=r||Xe(t.data)||Qe,e.dimension=m;var b=z.allocType(e.dtype,d*m);Ze(b,t.data,d,m,v,g,h),f(e,b,n),a?e.persistentData=b:z.freeType(b)}else t instanceof ArrayBuffer&&(e.dtype=Ge,e.dimension=i,f(e,t,n),a&&(e.persistentData=new Uint8Array(new Uint8Array(t))))}function p(n){t.bufferCount--,r(n);var i=n.buffer;e.deleteBuffer(i),n.buffer=null,delete a[n.id]}function h(r,i,s,c){t.bufferCount++;var u=new o(i);function f(t){var r=qe,i=null,a=0,o=0,s=1;return Array.isArray(t)||ye(t)||we(t)||t instanceof ArrayBuffer?i=t:"number"===typeof t?a=0|t:t&&("data"in t&&(i=t.data),"usage"in t&&(r=Ve[t.usage]),"type"in t&&(o=Be[t.type]),"dimension"in t&&(s=0|t.dimension),"length"in t&&(a=0|t.length)),u.bind(),i?l(u,i,r,o,s,c):(a&&e.bufferData(u.type,a,r),u.dtype=o||Ge,u.usage=r,u.dimension=s,u.byteLength=a),n.profile&&(u.stats.size=u.byteLength*We[u.dtype]),f}function h(t,n){e.bufferSubData(u.type,n,t)}function d(e,t){var n,r=0|(t||0);if(u.bind(),ye(e)||e instanceof ArrayBuffer)h(e,r);else if(Array.isArray(e)){if(e.length>0)if("number"===typeof e[0]){var i=z.allocType(u.dtype,e.length);Je(i,e),h(i,r),z.freeType(i)}else if(Array.isArray(e[0])||ye(e[0])){n=He(e);var a=Ue(e,n,u.dtype);h(a,r),z.freeType(a)}}else if(we(e)){n=e.shape;var o=e.stride,s=0,c=0,l=0,p=0;1===n.length?(s=n[0],c=1,l=o[0],p=0):2===n.length&&(s=n[0],c=n[1],l=o[0],p=o[1]);var d=Array.isArray(e.data)?u.dtype:Xe(e.data),m=z.allocType(d,s*c);Ze(m,e.data,s,c,l,p,e.offset),h(m,r),z.freeType(m)}return f}return a[u.id]=u,s||f(r),f._reglType="buffer",f._buffer=u,f.subdata=d,n.profile&&(f.stats=u.stats),f.destroy=function(){p(u)},f}function d(){xe(a).forEach((function(t){t.buffer=e.createBuffer(),e.bindBuffer(t.type,t.buffer),e.bufferData(t.type,t.persistentData||t.byteLength,t.usage)}))}return n.profile&&(t.getTotalBufferSize=function(){var e=0;return Object.keys(a).forEach((function(t){e+=a[t].stats.size})),e}),{create:h,createStream:c,destroyStream:u,clear:function(){xe(a).forEach(p),s.forEach(p)},getBuffer:function(e){return e&&e._buffer instanceof o?e._buffer:null},restore:d,_initBuffer:l}}We[5120]=1,We[5122]=2,We[5124]=4,We[5121]=1,We[5123]=2,We[5125]=4,We[5126]=4;var Ke=0,et=0,tt=1,nt=1,rt=4,it=4,at={points:Ke,point:et,lines:tt,line:nt,triangles:rt,triangle:it,"line loop":2,"line strip":3,"triangle strip":5,"triangle fan":6},ot=0,st=1,ct=4,ut=5120,ft=5121,lt=5122,pt=5123,ht=5124,dt=5125,mt=34963,vt=35040,gt=35044;function bt(e,t,n,r){var i={},a=0,o={uint8:ft,uint16:pt};function s(e){this.id=a++,i[this.id]=this,this.buffer=e,this.primType=ct,this.vertCount=0,this.type=0}t.oes_element_index_uint&&(o.uint32=dt),s.prototype.bind=function(){this.buffer.bind()};var c=[];function u(e){var t=c.pop();return t||(t=new s(n.create(null,mt,!0,!1)._buffer)),l(t,e,vt,-1,-1,0,0),t}function f(e){c.push(e)}function l(r,i,a,o,s,c,u){var f;if(r.buffer.bind(),i){var l=u;u||ye(i)&&(!we(i)||ye(i.data))||(l=t.oes_element_index_uint?dt:pt),n._initBuffer(r.buffer,i,a,l,3)}else e.bufferData(mt,c,a),r.buffer.dtype=f||ft,r.buffer.usage=a,r.buffer.dimension=3,r.buffer.byteLength=c;if(f=u,!u){switch(r.buffer.dtype){case ft:case ut:f=ft;break;case pt:case lt:f=pt;break;case dt:case ht:f=dt;break}r.buffer.dtype=f}r.type=f;var p=s;p<0&&(p=r.buffer.byteLength,f===pt?p>>=1:f===dt&&(p>>=2)),r.vertCount=p;var h=o;if(o<0){h=ct;var d=r.buffer.dimension;1===d&&(h=ot),2===d&&(h=st),3===d&&(h=ct)}r.primType=h}function p(e){r.elementsCount--,delete i[e.id],e.buffer.destroy(),e.buffer=null}function h(e,t){var i=n.create(null,mt,!0),a=new s(i._buffer);function c(e){if(e)if("number"===typeof e)i(e),a.primType=ct,a.vertCount=0|e,a.type=ft;else{var t=null,n=gt,r=-1,s=-1,u=0,f=0;Array.isArray(e)||ye(e)||we(e)?t=e:("data"in e&&(t=e.data),"usage"in e&&(n=Ve[e.usage]),"primitive"in e&&(r=at[e.primitive]),"count"in e&&(s=0|e.count),"type"in e&&(f=o[e.type]),"length"in e?u=0|e.length:(u=s,f===pt||f===lt?u*=2:f!==dt&&f!==ht||(u*=4))),l(a,t,n,r,s,u,f)}else i(),a.primType=ct,a.vertCount=0,a.type=ft;return c}return r.elementsCount++,c(e),c._reglType="elements",c._elements=a,c.subdata=function(e,t){return i.subdata(e,t),c},c.destroy=function(){p(a)},c}return{create:h,createStream:u,destroyStream:f,getElements:function(e){return"function"===typeof e&&e._elements instanceof s?e._elements:null},clear:function(){xe(i).forEach(p)}}}var yt=new Float32Array(1),wt=new Uint32Array(yt.buffer),xt=5123;function _t(e){for(var t=z.allocType(xt,e.length),n=0;n<e.length;++n)if(isNaN(e[n]))t[n]=65535;else if(e[n]===1/0)t[n]=31744;else if(e[n]===-1/0)t[n]=64512;else{yt[0]=e[n];var r=wt[0],i=r>>>31<<15,a=(r<<1>>>24)-127,o=r>>13&1023;if(a<-24)t[n]=i;else if(a<-14){var s=-14-a;t[n]=i+(o+1024>>s)}else t[n]=a>15?i+31744:i+(a+15<<10)+o}return t}function At(e){return Array.isArray(e)||ye(e)}var Et=34467,Tt=3553,Ct=34067,Ot=34069,Pt=6408,kt=6406,Dt=6407,Mt=6409,St=6410,zt=32854,Ft=32855,Lt=36194,Rt=32819,jt=32820,Bt=33635,It=34042,Nt=6402,Vt=34041,Ut=35904,Ht=35906,qt=36193,Yt=33776,Gt=33777,Qt=33778,Wt=33779,Xt=35986,Jt=35987,Zt=34798,$t=35840,Kt=35841,en=35842,tn=35843,nn=36196,rn=5121,an=5123,on=5125,sn=5126,cn=10242,un=10243,fn=10497,ln=33071,pn=33648,hn=10240,dn=10241,mn=9728,vn=9729,gn=9984,bn=9985,yn=9986,wn=9987,xn=33170,_n=4352,An=4353,En=4354,Tn=34046,Cn=3317,On=37440,Pn=37441,kn=37443,Dn=37444,Mn=33984,Sn=[gn,yn,bn,wn],zn=[0,Mt,St,Dt,Pt],Fn={};function Ln(e){return"[object "+e+"]"}Fn[Mt]=Fn[kt]=Fn[Nt]=1,Fn[Vt]=Fn[St]=2,Fn[Dt]=Fn[Ut]=3,Fn[Pt]=Fn[Ht]=4;var Rn=Ln("HTMLCanvasElement"),jn=Ln("OffscreenCanvas"),Bn=Ln("CanvasRenderingContext2D"),In=Ln("ImageBitmap"),Nn=Ln("HTMLImageElement"),Vn=Ln("HTMLVideoElement"),Un=Object.keys(ke).concat([Rn,jn,Bn,In,Nn,Vn]),Hn=[];Hn[rn]=1,Hn[sn]=4,Hn[qt]=2,Hn[an]=2,Hn[on]=4;var qn=[];function Yn(e){return Array.isArray(e)&&(0===e.length||"number"===typeof e[0])}function Gn(e){if(!Array.isArray(e))return!1;var t=e.length;return!(0===t||!At(e[0]))}function Qn(e){return Object.prototype.toString.call(e)}function Wn(e){return Qn(e)===Rn}function Xn(e){return Qn(e)===jn}function Jn(e){return Qn(e)===Bn}function Zn(e){return Qn(e)===In}function $n(e){return Qn(e)===Nn}function Kn(e){return Qn(e)===Vn}function er(e){if(!e)return!1;var t=Qn(e);return Un.indexOf(t)>=0||(Yn(e)||Gn(e)||we(e))}function tr(e){return 0|ke[Object.prototype.toString.call(e)]}function nr(e,t){var n=t.length;switch(e.type){case rn:case an:case on:case sn:var r=z.allocType(e.type,n);r.set(t),e.data=r;break;case qt:e.data=_t(t);break}}function rr(e,t){return z.allocType(e.type===qt?sn:e.type,t)}function ir(e,t){e.type===qt?(e.data=_t(t),z.freeType(t)):e.data=t}function ar(e,t,n,r,i,a){for(var o=e.width,s=e.height,c=e.channels,u=o*s*c,f=rr(e,u),l=0,p=0;p<s;++p)for(var h=0;h<o;++h)for(var d=0;d<c;++d)f[l++]=t[n*h+r*p+i*d+a];ir(e,f)}function or(e,t,n,r,i,a){var o;if(o="undefined"!==typeof qn[e]?qn[e]:Fn[e]*Hn[t],a&&(o*=6),i){var s=0,c=n;while(c>=1)s+=o*c*c,c/=2;return s}return o*n*r}function sr(t,n,r,i,a,o,s){var c={"don't care":_n,"dont care":_n,nice:En,fast:An},u={repeat:fn,clamp:ln,mirror:pn},f={nearest:mn,linear:vn},l=e({mipmap:wn,"nearest mipmap nearest":gn,"linear mipmap nearest":bn,"nearest mipmap linear":yn,"linear mipmap linear":wn},f),p={none:0,browser:Dn},h={uint8:rn,rgba4:Rt,rgb565:Bt,"rgb5 a1":jt},d={alpha:kt,luminance:Mt,"luminance alpha":St,rgb:Dt,rgba:Pt,rgba4:zt,"rgb5 a1":Ft,rgb565:Lt},m={};n.ext_srgb&&(d.srgb=Ut,d.srgba=Ht),n.oes_texture_float&&(h.float32=h.float=sn),n.oes_texture_half_float&&(h["float16"]=h["half float"]=qt),n.webgl_depth_texture&&(e(d,{depth:Nt,"depth stencil":Vt}),e(h,{uint16:an,uint32:on,"depth stencil":It})),n.webgl_compressed_texture_s3tc&&e(m,{"rgb s3tc dxt1":Yt,"rgba s3tc dxt1":Gt,"rgba s3tc dxt3":Qt,"rgba s3tc dxt5":Wt}),n.webgl_compressed_texture_atc&&e(m,{"rgb atc":Xt,"rgba atc explicit alpha":Jt,"rgba atc interpolated alpha":Zt}),n.webgl_compressed_texture_pvrtc&&e(m,{"rgb pvrtc 4bppv1":$t,"rgb pvrtc 2bppv1":Kt,"rgba pvrtc 4bppv1":en,"rgba pvrtc 2bppv1":tn}),n.webgl_compressed_texture_etc1&&(m["rgb etc1"]=nn);var v=Array.prototype.slice.call(t.getParameter(Et));Object.keys(m).forEach((function(e){var t=m[e];v.indexOf(t)>=0&&(d[e]=t)}));var g=Object.keys(d);r.textureFormats=g;var b=[];Object.keys(d).forEach((function(e){var t=d[e];b[t]=e}));var y=[];Object.keys(h).forEach((function(e){var t=h[e];y[t]=e}));var w=[];Object.keys(f).forEach((function(e){var t=f[e];w[t]=e}));var x=[];Object.keys(l).forEach((function(e){var t=l[e];x[t]=e}));var _=[];Object.keys(u).forEach((function(e){var t=u[e];_[t]=e}));var A=g.reduce((function(e,t){var r=d[t];return r===Mt||r===kt||r===Mt||r===St||r===Nt||r===Vt||n.ext_srgb&&(r===Ut||r===Ht)?e[r]=r:r===Ft||t.indexOf("rgba")>=0?e[r]=Pt:e[r]=Dt,e}),{});function E(){this.internalformat=Pt,this.format=Pt,this.type=rn,this.compressed=!1,this.premultiplyAlpha=!1,this.flipY=!1,this.unpackAlignment=1,this.colorSpace=Dn,this.width=0,this.height=0,this.channels=0}function T(e,t){e.internalformat=t.internalformat,e.format=t.format,e.type=t.type,e.compressed=t.compressed,e.premultiplyAlpha=t.premultiplyAlpha,e.flipY=t.flipY,e.unpackAlignment=t.unpackAlignment,e.colorSpace=t.colorSpace,e.width=t.width,e.height=t.height,e.channels=t.channels}function C(e,t){if("object"===typeof t&&t){if("premultiplyAlpha"in t&&(e.premultiplyAlpha=t.premultiplyAlpha),"flipY"in t&&(e.flipY=t.flipY),"alignment"in t&&(e.unpackAlignment=t.alignment),"colorSpace"in t&&(e.colorSpace=p[t.colorSpace]),"type"in t){var n=t.type;e.type=h[n]}var r=e.width,i=e.height,a=e.channels,o=!1;"shape"in t?(r=t.shape[0],i=t.shape[1],3===t.shape.length&&(a=t.shape[2],o=!0)):("radius"in t&&(r=i=t.radius),"width"in t&&(r=t.width),"height"in t&&(i=t.height),"channels"in t&&(a=t.channels,o=!0)),e.width=0|r,e.height=0|i,e.channels=0|a;var s=!1;if("format"in t){var c=t.format,u=e.internalformat=d[c];e.format=A[u],c in h&&("type"in t||(e.type=h[c])),c in m&&(e.compressed=!0),s=!0}!o&&s?e.channels=Fn[e.format]:o&&!s&&e.channels!==zn[e.format]&&(e.format=e.internalformat=zn[e.channels])}}function O(e){t.pixelStorei(On,e.flipY),t.pixelStorei(Pn,e.premultiplyAlpha),t.pixelStorei(kn,e.colorSpace),t.pixelStorei(Cn,e.unpackAlignment)}function P(){E.call(this),this.xOffset=0,this.yOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function k(e,t){var n=null;if(er(t)?n=t:t&&(C(e,t),"x"in t&&(e.xOffset=0|t.x),"y"in t&&(e.yOffset=0|t.y),er(t.data)&&(n=t.data)),t.copy){var r=a.viewportWidth,i=a.viewportHeight;e.width=e.width||r-e.xOffset,e.height=e.height||i-e.yOffset,e.needsCopy=!0}else if(n){if(ye(n))e.channels=e.channels||4,e.data=n,"type"in t||e.type!==rn||(e.type=tr(n));else if(Yn(n))e.channels=e.channels||4,nr(e,n),e.alignment=1,e.needsFree=!0;else if(we(n)){var o=n.data;Array.isArray(o)||e.type!==rn||(e.type=tr(o));var s,c,u,f,l,p,h=n.shape,d=n.stride;3===h.length?(u=h[2],p=d[2]):(u=1,p=1),s=h[0],c=h[1],f=d[0],l=d[1],e.alignment=1,e.width=s,e.height=c,e.channels=u,e.format=e.internalformat=zn[u],e.needsFree=!0,ar(e,o,f,l,p,n.offset)}else if(Wn(n)||Xn(n)||Jn(n))Wn(n)||Xn(n)?e.element=n:e.element=n.canvas,e.width=e.element.width,e.height=e.element.height,e.channels=4;else if(Zn(n))e.element=n,e.width=n.width,e.height=n.height,e.channels=4;else if($n(n))e.element=n,e.width=n.naturalWidth,e.height=n.naturalHeight,e.channels=4;else if(Kn(n))e.element=n,e.width=n.videoWidth,e.height=n.videoHeight,e.channels=4;else if(Gn(n)){var m=e.width||n[0].length,v=e.height||n.length,g=e.channels;g=At(n[0][0])?g||n[0][0].length:g||1;for(var b=_e.shape(n),y=1,w=0;w<b.length;++w)y*=b[w];var x=rr(e,y);_e.flatten(n,b,"",x),ir(e,x),e.alignment=1,e.width=m,e.height=v,e.channels=g,e.format=e.internalformat=zn[g],e.needsFree=!0}}else e.width=e.width||1,e.height=e.height||1,e.channels=e.channels||4;e.type===sn||e.type}function D(e,n,r){var a=e.element,o=e.data,s=e.internalformat,c=e.format,u=e.type,f=e.width,l=e.height;O(e),a?t.texImage2D(n,r,c,c,u,a):e.compressed?t.compressedTexImage2D(n,r,s,f,l,0,o):e.needsCopy?(i(),t.copyTexImage2D(n,r,c,e.xOffset,e.yOffset,f,l,0)):t.texImage2D(n,r,c,f,l,0,c,u,o||null)}function M(e,n,r,a,o){var s=e.element,c=e.data,u=e.internalformat,f=e.format,l=e.type,p=e.width,h=e.height;O(e),s?t.texSubImage2D(n,o,r,a,f,l,s):e.compressed?t.compressedTexSubImage2D(n,o,r,a,u,p,h,c):e.needsCopy?(i(),t.copyTexSubImage2D(n,o,r,a,e.xOffset,e.yOffset,p,h)):t.texSubImage2D(n,o,r,a,p,h,f,l,c)}var S=[];function F(){return S.pop()||new P}function L(e){e.needsFree&&z.freeType(e.data),P.call(e),S.push(e)}function R(){E.call(this),this.genMipmaps=!1,this.mipmapHint=_n,this.mipmask=0,this.images=Array(16)}function j(e,t,n){var r=e.images[0]=F();e.mipmask=1,r.width=e.width=t,r.height=e.height=n,r.channels=e.channels=4}function B(e,t){var n=null;if(er(t))n=e.images[0]=F(),T(n,e),k(n,t),e.mipmask=1;else if(C(e,t),Array.isArray(t.mipmap))for(var r=t.mipmap,i=0;i<r.length;++i)n=e.images[i]=F(),T(n,e),n.width>>=i,n.height>>=i,k(n,r[i]),e.mipmask|=1<<i;else n=e.images[0]=F(),T(n,e),k(n,t),e.mipmask=1;T(e,e.images[0]),e.compressed&&(e.internalformat===Yt||e.internalformat===Gt||e.internalformat===Qt||e.internalformat)}function I(e,t){for(var n=e.images,r=0;r<n.length;++r){if(!n[r])return;D(n[r],t,r)}}var N=[];function V(){var e=N.pop()||new R;E.call(e),e.mipmask=0;for(var t=0;t<16;++t)e.images[t]=null;return e}function U(e){for(var t=e.images,n=0;n<t.length;++n)t[n]&&L(t[n]),t[n]=null;N.push(e)}function H(){this.minFilter=mn,this.magFilter=mn,this.wrapS=ln,this.wrapT=ln,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=_n}function q(e,t){if("min"in t){var n=t.min;e.minFilter=l[n],Sn.indexOf(e.minFilter)>=0&&!("faces"in t)&&(e.genMipmaps=!0)}if("mag"in t){var r=t.mag;e.magFilter=f[r]}var i=e.wrapS,a=e.wrapT;if("wrap"in t){var o=t.wrap;"string"===typeof o?i=a=u[o]:Array.isArray(o)&&(i=u[o[0]],a=u[o[1]])}else{if("wrapS"in t){var s=t.wrapS;i=u[s]}if("wrapT"in t){var p=t.wrapT;a=u[p]}}if(e.wrapS=i,e.wrapT=a,"anisotropic"in t){t.anisotropic;e.anisotropic=t.anisotropic}if("mipmap"in t){var h=!1;switch(typeof t.mipmap){case"string":e.mipmapHint=c[t.mipmap],e.genMipmaps=!0,h=!0;break;case"boolean":h=e.genMipmaps=t.mipmap;break;case"object":e.genMipmaps=!1,h=!0;break}!h||"min"in t||(e.minFilter=gn)}}function Y(e,r){t.texParameteri(r,dn,e.minFilter),t.texParameteri(r,hn,e.magFilter),t.texParameteri(r,cn,e.wrapS),t.texParameteri(r,un,e.wrapT),n.ext_texture_filter_anisotropic&&t.texParameteri(r,Tn,e.anisotropic),e.genMipmaps&&(t.hint(xn,e.mipmapHint),t.generateMipmap(r))}var G=0,Q={},W=r.maxTextureUnits,X=Array(W).map((function(){return null}));function J(e){E.call(this),this.mipmask=0,this.internalformat=Pt,this.id=G++,this.refCount=1,this.target=e,this.texture=t.createTexture(),this.unit=-1,this.bindCount=0,this.texInfo=new H,s.profile&&(this.stats={size:0})}function Z(e){t.activeTexture(Mn),t.bindTexture(e.target,e.texture)}function $(){var e=X[0];e?t.bindTexture(e.target,e.texture):t.bindTexture(Tt,null)}function K(e){var n=e.texture,r=e.unit,i=e.target;r>=0&&(t.activeTexture(Mn+r),t.bindTexture(i,null),X[r]=null),t.deleteTexture(n),e.texture=null,e.params=null,e.pixels=null,e.refCount=0,delete Q[e.id],o.textureCount--}function ee(e,n){var r=new J(Tt);function i(e,t){var n=r.texInfo;H.call(n);var a=V();return"number"===typeof e?j(a,0|e,"number"===typeof t?0|t:0|e):e?(q(n,e),B(a,e)):j(a,1,1),n.genMipmaps&&(a.mipmask=(a.width<<1)-1),r.mipmask=a.mipmask,T(r,a),r.internalformat=a.internalformat,i.width=a.width,i.height=a.height,Z(r),I(a,Tt),Y(n,Tt),$(),U(a),s.profile&&(r.stats.size=or(r.internalformat,r.type,a.width,a.height,n.genMipmaps,!1)),i.format=b[r.internalformat],i.type=y[r.type],i.mag=w[n.magFilter],i.min=x[n.minFilter],i.wrapS=_[n.wrapS],i.wrapT=_[n.wrapT],i}function a(e,t,n,a){var o=0|t,s=0|n,c=0|a,u=F();return T(u,r),u.width=0,u.height=0,k(u,e),u.width=u.width||(r.width>>c)-o,u.height=u.height||(r.height>>c)-s,Z(r),M(u,Tt,o,s,c),$(),L(u),i}function c(e,n){var a=0|e,o=0|n||a;if(a===r.width&&o===r.height)return i;i.width=r.width=a,i.height=r.height=o,Z(r);for(var c=0;r.mipmask>>c;++c){var u=a>>c,f=o>>c;if(!u||!f)break;t.texImage2D(Tt,c,r.format,u,f,0,r.format,r.type,null)}return $(),s.profile&&(r.stats.size=or(r.internalformat,r.type,a,o,!1,!1)),i}return Q[r.id]=r,o.textureCount++,i(e,n),i.subimage=a,i.resize=c,i._reglType="texture2d",i._texture=r,s.profile&&(i.stats=r.stats),i.destroy=function(){r.decRef()},i}function te(e,n,i,a,c,u){var f=new J(Ct);Q[f.id]=f,o.cubeCount++;var l=new Array(6);function p(e,t,n,i,a,o){var c,u=f.texInfo;for(H.call(u),c=0;c<6;++c)l[c]=V();if("number"!==typeof e&&e){if("object"===typeof e)if(t)B(l[0],e),B(l[1],t),B(l[2],n),B(l[3],i),B(l[4],a),B(l[5],o);else if(q(u,e),C(f,e),"faces"in e){var h=e.faces;for(c=0;c<6;++c)T(l[c],f),B(l[c],h[c])}else for(c=0;c<6;++c)B(l[c],e)}else{var d=0|e||1;for(c=0;c<6;++c)j(l[c],d,d)}for(T(f,l[0]),r.npotTextureCube,u.genMipmaps?f.mipmask=(l[0].width<<1)-1:f.mipmask=l[0].mipmask,f.internalformat=l[0].internalformat,p.width=l[0].width,p.height=l[0].height,Z(f),c=0;c<6;++c)I(l[c],Ot+c);for(Y(u,Ct),$(),s.profile&&(f.stats.size=or(f.internalformat,f.type,p.width,p.height,u.genMipmaps,!0)),p.format=b[f.internalformat],p.type=y[f.type],p.mag=w[u.magFilter],p.min=x[u.minFilter],p.wrapS=_[u.wrapS],p.wrapT=_[u.wrapT],c=0;c<6;++c)U(l[c]);return p}function h(e,t,n,r,i){var a=0|n,o=0|r,s=0|i,c=F();return T(c,f),c.width=0,c.height=0,k(c,t),c.width=c.width||(f.width>>s)-a,c.height=c.height||(f.height>>s)-o,Z(f),M(c,Ot+e,a,o,s),$(),L(c),p}function d(e){var n=0|e;if(n!==f.width){p.width=f.width=n,p.height=f.height=n,Z(f);for(var r=0;r<6;++r)for(var i=0;f.mipmask>>i;++i)t.texImage2D(Ot+r,i,f.format,n>>i,n>>i,0,f.format,f.type,null);return $(),s.profile&&(f.stats.size=or(f.internalformat,f.type,p.width,p.height,!1,!0)),p}}return p(e,n,i,a,c,u),p.subimage=h,p.resize=d,p._reglType="textureCube",p._texture=f,s.profile&&(p.stats=f.stats),p.destroy=function(){f.decRef()},p}function ne(){for(var e=0;e<W;++e)t.activeTexture(Mn+e),t.bindTexture(Tt,null),X[e]=null;xe(Q).forEach(K),o.cubeCount=0,o.textureCount=0}function re(){for(var e=0;e<W;++e){var n=X[e];n&&(n.bindCount=0,n.unit=-1,X[e]=null)}xe(Q).forEach((function(e){e.texture=t.createTexture(),t.bindTexture(e.target,e.texture);for(var n=0;n<32;++n)if(0!==(e.mipmask&1<<n))if(e.target===Tt)t.texImage2D(Tt,n,e.internalformat,e.width>>n,e.height>>n,0,e.internalformat,e.type,null);else for(var r=0;r<6;++r)t.texImage2D(Ot+r,n,e.internalformat,e.width>>n,e.height>>n,0,e.internalformat,e.type,null);Y(e.texInfo,e.target)}))}return e(J.prototype,{bind:function(){var e=this;e.bindCount+=1;var n=e.unit;if(n<0){for(var r=0;r<W;++r){var i=X[r];if(i){if(i.bindCount>0)continue;i.unit=-1}X[r]=e,n=r;break}s.profile&&o.maxTextureUnits<n+1&&(o.maxTextureUnits=n+1),e.unit=n,t.activeTexture(Mn+n),t.bindTexture(e.target,e.texture)}return n},unbind:function(){this.bindCount-=1},decRef:function(){--this.refCount<=0&&K(this)}}),s.profile&&(o.getTotalTextureSize=function(){var e=0;return Object.keys(Q).forEach((function(t){e+=Q[t].stats.size})),e}),{create2D:ee,createCube:te,clear:ne,getTexture:function(e){return null},restore:re}}qn[zt]=2,qn[Ft]=2,qn[Lt]=2,qn[Vt]=4,qn[Yt]=.5,qn[Gt]=.5,qn[Qt]=1,qn[Wt]=1,qn[Xt]=.5,qn[Jt]=1,qn[Zt]=1,qn[$t]=.5,qn[Kt]=.25,qn[en]=.5,qn[tn]=.25,qn[nn]=.5;var cr=36161,ur=32854,fr=32855,lr=36194,pr=33189,hr=36168,dr=34041,mr=35907,vr=34836,gr=34842,br=34843,yr=[];function wr(e,t,n){return yr[e]*t*n}yr[ur]=2,yr[fr]=2,yr[lr]=2,yr[pr]=2,yr[hr]=1,yr[dr]=4,yr[mr]=4,yr[vr]=16,yr[gr]=8,yr[br]=6;var xr=function(e,t,n,r,i){var a={rgba4:ur,rgb565:lr,"rgb5 a1":fr,depth:pr,stencil:hr,"depth stencil":dr};t.ext_srgb&&(a["srgba"]=mr),t.ext_color_buffer_half_float&&(a["rgba16f"]=gr,a["rgb16f"]=br),t.webgl_color_buffer_float&&(a["rgba32f"]=vr);var o=[];Object.keys(a).forEach((function(e){var t=a[e];o[t]=e}));var s=0,c={};function u(e){this.id=s++,this.refCount=1,this.renderbuffer=e,this.format=ur,this.width=0,this.height=0,i.profile&&(this.stats={size:0})}function f(t){var n=t.renderbuffer;e.bindRenderbuffer(cr,null),e.deleteRenderbuffer(n),t.renderbuffer=null,t.refCount=0,delete c[t.id],r.renderbufferCount--}function l(t,n){var s=new u(e.createRenderbuffer());function f(t,n){var r=0,c=0,u=ur;if("object"===typeof t&&t){var l=t;if("shape"in l){var p=l.shape;r=0|p[0],c=0|p[1]}else"radius"in l&&(r=c=0|l.radius),"width"in l&&(r=0|l.width),"height"in l&&(c=0|l.height);"format"in l&&(u=a[l.format])}else"number"===typeof t?(r=0|t,c="number"===typeof n?0|n:r):t||(r=c=1);if(r!==s.width||c!==s.height||u!==s.format)return f.width=s.width=r,f.height=s.height=c,s.format=u,e.bindRenderbuffer(cr,s.renderbuffer),e.renderbufferStorage(cr,u,r,c),i.profile&&(s.stats.size=wr(s.format,s.width,s.height)),f.format=o[s.format],f}function l(t,n){var r=0|t,a=0|n||r;return r===s.width&&a===s.height||(f.width=s.width=r,f.height=s.height=a,e.bindRenderbuffer(cr,s.renderbuffer),e.renderbufferStorage(cr,s.format,r,a),i.profile&&(s.stats.size=wr(s.format,s.width,s.height))),f}return c[s.id]=s,r.renderbufferCount++,f(t,n),f.resize=l,f._reglType="renderbuffer",f._renderbuffer=s,i.profile&&(f.stats=s.stats),f.destroy=function(){s.decRef()},f}function p(){xe(c).forEach((function(t){t.renderbuffer=e.createRenderbuffer(),e.bindRenderbuffer(cr,t.renderbuffer),e.renderbufferStorage(cr,t.format,t.width,t.height)})),e.bindRenderbuffer(cr,null)}return u.prototype.decRef=function(){--this.refCount<=0&&f(this)},i.profile&&(r.getTotalRenderbufferSize=function(){var e=0;return Object.keys(c).forEach((function(t){e+=c[t].stats.size})),e}),{create:l,clear:function(){xe(c).forEach(f)},restore:p}},_r=36160,Ar=36161,Er=3553,Tr=34069,Cr=36064,Or=36096,Pr=36128,kr=33306,Dr=36193,Mr=5121,Sr=5126,zr=6407,Fr=6408,Lr=[];Lr[Fr]=4,Lr[zr]=3;var Rr=[];function jr(t,n,r,i,a,o){var s={cur:null,next:null,dirty:!1,setFBO:null},c=["rgba"],u=["rgba4","rgb565","rgb5 a1"];function f(e,t,n){this.target=e,this.texture=t,this.renderbuffer=n;var r=0,i=0;t?(r=t.width,i=t.height):n&&(r=n.width,i=n.height),this.width=r,this.height=i}function l(e){e&&(e.texture&&e.texture._texture.decRef(),e.renderbuffer&&e.renderbuffer._renderbuffer.decRef())}function p(e,t,n){if(e)if(e.texture){var r=e.texture._texture;Math.max(1,r.width),Math.max(1,r.height);r.refCount+=1}else{var i=e.renderbuffer._renderbuffer;i.refCount+=1}}function h(e,n){n&&(n.texture?t.framebufferTexture2D(_r,e,n.target,n.texture._texture.texture,0):t.framebufferRenderbuffer(_r,e,Ar,n.renderbuffer._renderbuffer.renderbuffer))}function d(e){var t=Er,n=null,r=null,i=e;"object"===typeof e&&(i=e.data,"target"in e&&(t=0|e.target));var a=i._reglType;return"texture2d"===a||"textureCube"===a?n=i:"renderbuffer"===a&&(r=i,t=Ar),new f(t,n,r)}function m(e,t,n,r,o){if(n){var s=i.create2D({width:e,height:t,format:r,type:o});return s._texture.refCount=0,new f(Er,s,null)}var c=a.create({width:e,height:t,format:r});return c._renderbuffer.refCount=0,new f(Ar,null,c)}function v(e){return e&&(e.texture||e.renderbuffer)}function g(e,t,n){e&&(e.texture?e.texture.resize(t,n):e.renderbuffer&&e.renderbuffer.resize(t,n),e.width=t,e.height=n)}n.ext_srgb&&u.push("srgba"),n.ext_color_buffer_half_float&&u.push("rgba16f","rgb16f"),n.webgl_color_buffer_float&&u.push("rgba32f"),n.oes_texture_half_float,n.oes_texture_float;var b=0,y={};function w(){this.id=b++,y[this.id]=this,this.framebuffer=t.createFramebuffer(),this.width=0,this.height=0,this.colorAttachments=[],this.depthAttachment=null,this.stencilAttachment=null,this.depthStencilAttachment=null}function x(e){e.colorAttachments.forEach(l),l(e.depthAttachment),l(e.stencilAttachment),l(e.depthStencilAttachment)}function _(e){var n=e.framebuffer;t.deleteFramebuffer(n),e.framebuffer=null,o.framebufferCount--,delete y[e.id]}function A(e){var n;t.bindFramebuffer(_r,e.framebuffer);var i=e.colorAttachments;for(n=0;n<i.length;++n)h(Cr+n,i[n]);for(n=i.length;n<r.maxColorAttachments;++n)t.framebufferTexture2D(_r,Cr+n,Er,null,0);t.framebufferTexture2D(_r,kr,Er,null,0),t.framebufferTexture2D(_r,Or,Er,null,0),t.framebufferTexture2D(_r,Pr,Er,null,0),h(Or,e.depthAttachment),h(Pr,e.stencilAttachment),h(kr,e.depthStencilAttachment);t.checkFramebufferStatus(_r);t.isContextLost(),t.bindFramebuffer(_r,s.next?s.next.framebuffer:null),s.cur=s.next,t.getError()}function E(t,n){var r=new w;function i(e,t){var n,a=0,o=0,s=!0,f=!0,l=null,h=!0,g="rgba",b="uint8",y=1,w=null,_=null,E=null,T=!1;if("number"===typeof e)a=0|e,o=0|t||a;else if(e){var C=e;if("shape"in C){var O=C.shape;a=O[0],o=O[1]}else"radius"in C&&(a=o=C.radius),"width"in C&&(a=C.width),"height"in C&&(o=C.height);("color"in C||"colors"in C)&&(l=C.color||C.colors),l||("colorCount"in C&&(y=0|C.colorCount),"colorTexture"in C&&(h=!!C.colorTexture,g="rgba4"),"colorType"in C&&(b=C.colorType,h||("half float"===b||"float16"===b?g="rgba16f":"float"!==b&&"float32"!==b||(g="rgba32f"))),"colorFormat"in C&&(g=C.colorFormat,c.indexOf(g)>=0?h=!0:u.indexOf(g)>=0&&(h=!1))),("depthTexture"in C||"depthStencilTexture"in C)&&(T=!(!C.depthTexture&&!C.depthStencilTexture)),"depth"in C&&("boolean"===typeof C.depth?s=C.depth:(w=C.depth,f=!1)),"stencil"in C&&("boolean"===typeof C.stencil?f=C.stencil:(_=C.stencil,s=!1)),"depthStencil"in C&&("boolean"===typeof C.depthStencil?s=f=C.depthStencil:(E=C.depthStencil,s=!1,f=!1))}else a=o=1;var P=null,k=null,D=null,M=null;if(Array.isArray(l))P=l.map(d);else if(l)P=[d(l)];else for(P=new Array(y),n=0;n<y;++n)P[n]=m(a,o,h,g,b);for(a=a||P[0].width,o=o||P[0].height,w?k=d(w):s&&!f&&(k=m(a,o,T,"depth","uint32")),_?D=d(_):f&&!s&&(D=m(a,o,!1,"stencil","uint8")),E?M=d(E):!w&&!_&&f&&s&&(M=m(a,o,T,"depth stencil","depth stencil")),n=0;n<P.length;++n)if(p(P[n]),P[n]&&P[n].texture)Lr[P[n].texture._texture.format],Rr[P[n].texture._texture.type];return p(k),p(D),p(M),x(r),r.width=a,r.height=o,r.colorAttachments=P,r.depthAttachment=k,r.stencilAttachment=D,r.depthStencilAttachment=M,i.color=P.map(v),i.depth=v(k),i.stencil=v(D),i.depthStencil=v(M),i.width=r.width,i.height=r.height,A(r),i}function a(e,t){var n=Math.max(0|e,1),a=Math.max(0|t||n,1);if(n===r.width&&a===r.height)return i;for(var o=r.colorAttachments,s=0;s<o.length;++s)g(o[s],n,a);return g(r.depthAttachment,n,a),g(r.stencilAttachment,n,a),g(r.depthStencilAttachment,n,a),r.width=i.width=n,r.height=i.height=a,A(r),i}return o.framebufferCount++,i(t,n),e(i,{resize:a,_reglType:"framebuffer",_framebuffer:r,destroy:function(){_(r),x(r)},use:function(e){s.setFBO({framebuffer:i},e)}})}function T(t){var n=Array(6);function r(t){var a,o,s={color:null},c=0,u=null,f="rgba",l="uint8",p=1;if("number"===typeof t)c=0|t;else if(t){var h=t;if("shape"in h){var d=h.shape;c=d[0]}else"radius"in h&&(c=0|h.radius),"width"in h?c=0|h.width:"height"in h&&(c=0|h.height);("color"in h||"colors"in h)&&(u=h.color||h.colors),u||("colorCount"in h&&(p=0|h.colorCount),"colorType"in h&&(l=h.colorType),"colorFormat"in h&&(f=h.colorFormat)),"depth"in h&&(s.depth=h.depth),"stencil"in h&&(s.stencil=h.stencil),"depthStencil"in h&&(s.depthStencil=h.depthStencil)}else c=1;if(u)if(Array.isArray(u))for(o=[],a=0;a<u.length;++a)o[a]=u[a];else o=[u];else{o=Array(p);var m={radius:c,format:f,type:l};for(a=0;a<p;++a)o[a]=i.createCube(m)}for(s.color=Array(o.length),a=0;a<o.length;++a){var v=o[a];c=c||v.width,s.color[a]={target:Tr,data:o[a]}}for(a=0;a<6;++a){for(var g=0;g<o.length;++g)s.color[g].target=Tr+a;a>0&&(s.depth=n[0].depth,s.stencil=n[0].stencil,s.depthStencil=n[0].depthStencil),n[a]?n[a](s):n[a]=E(s)}return e(r,{width:c,height:c,color:o})}function a(e){var t,i=0|e;if(i===r.width)return r;var a=r.color;for(t=0;t<a.length;++t)a[t].resize(i);for(t=0;t<6;++t)n[t].resize(i);return r.width=r.height=i,r}return r(t),e(r,{faces:n,resize:a,_reglType:"framebufferCube",destroy:function(){n.forEach((function(e){e.destroy()}))}})}function C(){s.cur=null,s.next=null,s.dirty=!0,xe(y).forEach((function(e){e.framebuffer=t.createFramebuffer(),A(e)}))}return e(s,{getFramebuffer:function(e){if("function"===typeof e&&"framebuffer"===e._reglType){var t=e._framebuffer;if(t instanceof w)return t}return null},create:E,createCube:T,clear:function(){xe(y).forEach(_)},restore:C})}Rr[Mr]=1,Rr[Sr]=4,Rr[Dr]=2;var Br=5126,Ir=34962;function Nr(){this.state=0,this.x=0,this.y=0,this.z=0,this.w=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=Br,this.offset=0,this.stride=0,this.divisor=0}function Vr(e,t,n,r,i){for(var a=n.maxAttributes,o=new Array(a),s=0;s<a;++s)o[s]=new Nr;var c=0,u={},f={Record:Nr,scope:{},state:o,currentVAO:null,targetVAO:null,restore:p()?y:function(){},createVAO:w,getVAO:d,destroyBuffer:l,setVAO:p()?m:v,clear:p()?g:function(){}};function l(t){for(var n=0;n<o.length;++n){var r=o[n];r.buffer===t&&(e.disableVertexAttribArray(n),r.buffer=null)}}function p(){return t.oes_vertex_array_object}function h(){return t.angle_instanced_arrays}function d(e){return"function"===typeof e&&e._vao?e._vao:null}function m(e){if(e!==f.currentVAO){var t=p();e?t.bindVertexArrayOES(e.vao):t.bindVertexArrayOES(null),f.currentVAO=e}}function v(t){if(t!==f.currentVAO){if(t)t.bindAttrs();else{var n=h();for(let t=0;t<o.length;++t){var r=o[t];r.buffer?(e.enableVertexAttribArray(t),e.vertexAttribPointer(t,r.size,r.type,r.normalized,r.stride,r.offfset),n&&n.vertexAttribDivisorANGLE(t,r.divisor)):(e.disableVertexAttribArray(t),e.vertexAttrib4f(t,r.x,r.y,r.z,r.w))}}f.currentVAO=t}}function g(e){xe(u).forEach(e=>{e.destroy()})}function b(){this.id=++c,this.attributes=[];var e=p();this.vao=e?e.createVertexArrayOES():null,u[this.id]=this,this.buffers=[]}function y(){var e=p();e&&xe(u).forEach((function(e){e.refresh()}))}function w(e){var t=new b;function n(e){for(var r=0;r<t.buffers.length;++r)t.buffers[r].destroy();t.buffers.length=0;var a=t.attributes;a.length=e.length;for(var o=0;o<e.length;++o){var s=e[o],c=a[o]=new Nr;if(Array.isArray(s)||ye(s)||we(s)){var u=i.create(s,Ir,!1,!0);c.buffer=i.getBuffer(u),c.size=0|c.buffer.dimension,c.normalized=!1,c.type=c.buffer.dtype,c.offset=0,c.stride=0,c.divisor=0,c.state=1,t.buffers.push(u)}else i.getBuffer(s)?(c.buffer=i.getBuffer(s),c.size=0|c.buffer.dimension,c.normalized=!1,c.type=c.buffer.dtype,c.offset=0,c.stride=0,c.divisor=0,c.state=1):i.getBuffer(s.buffer)?(c.buffer=i.getBuffer(s.buffer),c.size=0|(+s.size||c.buffer.dimension),c.normalized=!!s.normalized||!1,c.type="type"in s?Be[s.type]:c.buffer.dtype,c.offset=0|(s.offset||0),c.stride=0|(s.stride||0),c.divisor=0|(s.divisor||0),c.state=1):"x"in s&&(c.x=+s.x||0,c.y=+s.y||0,c.z=+s.z||0,c.w=+s.w||0,c.state=2)}return t.refresh(),n}return r.vaoCount+=1,n.destroy=function(){t.destroy()},n._vao=t,n._reglType="vao",n(e)}return b.prototype.bindAttrs=function(){for(var t=h(),n=this.attributes,r=0;r<n.length;++r){var i=n[r];i.buffer?(e.enableVertexAttribArray(r),e.bindBuffer(Ir,i.buffer.buffer),e.vertexAttribPointer(r,i.size,i.type,i.normalized,i.stride,i.offset),t&&t.vertexAttribDivisorANGLE(r,i.divisor)):(e.disableVertexAttribArray(r),e.vertexAttrib4f(r,i.x,i.y,i.z,i.w))}for(var o=n.length;o<a;++o)e.disableVertexAttribArray(o)},b.prototype.refresh=function(){var e=p();e&&(e.bindVertexArrayOES(this.vao),this.bindAttrs(),f.currentVAO=this)},b.prototype.destroy=function(){if(this.vao){var e=p();this===f.currentVAO&&(f.currentVAO=null,e.bindVertexArrayOES(null)),e.deleteVertexArrayOES(this.vao),this.vao=null}u[this.id]&&(delete u[this.id],r.vaoCount-=1)},f}var Ur=35632,Hr=35633,qr=35718,Yr=35721;function Gr(e,t,n,r){var i={},a={};function o(e,t,n,r){this.name=e,this.id=t,this.location=n,this.info=r}function s(e,t){for(var n=0;n<e.length;++n)if(e[n].id===t.id)return void(e[n].location=t.location);e.push(t)}function c(n,r,o){var s=n===Ur?i:a,c=s[r];if(!c){var u=t.str(r);c=e.createShader(n),e.shaderSource(c,u),e.compileShader(c),s[r]=c}return c}var u={},f=[],l=0;function p(e,t){this.id=l++,this.fragId=e,this.vertId=t,this.program=null,this.uniforms=[],this.attributes=[],r.profile&&(this.stats={uniformsCount:0,attributesCount:0})}function h(n,i,a){var u,f,l=c(Ur,n.fragId),p=c(Hr,n.vertId),h=n.program=e.createProgram();if(e.attachShader(h,l),e.attachShader(h,p),a)for(let t=0;t<a.length;++t){var d=a[t];e.bindAttribLocation(h,d[0],d[1])}e.linkProgram(h);var m=e.getProgramParameter(h,qr);r.profile&&(n.stats.uniformsCount=m);var v=n.uniforms;for(u=0;u<m;++u)if(f=e.getActiveUniform(h,u),f)if(f.size>1)for(var g=0;g<f.size;++g){var b=f.name.replace("[0]","["+g+"]");s(v,new o(b,t.id(b),e.getUniformLocation(h,b),f))}else s(v,new o(f.name,t.id(f.name),e.getUniformLocation(h,f.name),f));var y=e.getProgramParameter(h,Yr);r.profile&&(n.stats.attributesCount=y);var w=n.attributes;for(u=0;u<y;++u)f=e.getActiveAttrib(h,u),f&&s(w,new o(f.name,t.id(f.name),e.getAttribLocation(h,f.name),f))}function d(){i={},a={};for(var e=0;e<f.length;++e)h(f[e],null,f[e].attributes.map((function(e){return[e.location,e.name]})))}return r.profile&&(n.getMaxUniformsCount=function(){var e=0;return f.forEach((function(t){t.stats.uniformsCount>e&&(e=t.stats.uniformsCount)})),e},n.getMaxAttributesCount=function(){var e=0;return f.forEach((function(t){t.stats.attributesCount>e&&(e=t.stats.attributesCount)})),e}),{clear:function(){var t=e.deleteShader.bind(e);xe(i).forEach(t),i={},xe(a).forEach(t),a={},f.forEach((function(t){e.deleteProgram(t.program)})),f.length=0,u={},n.shaderCount=0},program:function(e,t,r,i){var a=u[t];a||(a=u[t]={});var o=a[e];if(o&&!i)return o;var s=new p(t,e);return n.shaderCount++,h(s,r,i),o||(a[e]=s),f.push(s),s},restore:d,shader:c,frag:-1,vert:-1}}var Qr=6408,Wr=5121,Xr=3333,Jr=5126;function Zr(e,t,n,r,i,a,o){function s(i){var o;null===t.next?o=Wr:(o=t.next.colorAttachments[0].texture._texture.type,a.oes_texture_float);var s=0,c=0,u=r.framebufferWidth,f=r.framebufferHeight,l=null;ye(i)?l=i:i&&(s=0|i.x,c=0|i.y,u=0|(i.width||r.framebufferWidth-s),f=0|(i.height||r.framebufferHeight-c),l=i.data||null),n();var p=u*f*4;return l||(o===Wr?l=new Uint8Array(p):o===Jr&&(l=l||new Float32Array(p))),e.pixelStorei(Xr,4),e.readPixels(s,c,u,f,Qr,o,l),l}function c(e){var n;return t.setFBO({framebuffer:e.framebuffer},(function(){n=s(e)})),n}function u(e){return e&&"framebuffer"in e?c(e):s(e)}return u}function $r(e){return Array.prototype.slice.call(e)}function Kr(e){return $r(e).join("")}function ei(){var t=0,n=[],r=[];function i(e){for(var i=0;i<r.length;++i)if(r[i]===e)return n[i];var a="g"+t++;return n.push(a),r.push(e),a}function a(){var n=[];function r(){n.push.apply(n,$r(arguments))}var i=[];function a(){var e="v"+t++;return i.push(e),arguments.length>0&&(n.push(e,"="),n.push.apply(n,$r(arguments)),n.push(";")),e}return e(r,{def:a,toString:function(){return Kr([i.length>0?"var "+i.join(",")+";":"",Kr(n)])}})}function o(){var t=a(),n=a(),r=t.toString,i=n.toString;function o(e,r){n(e,r,"=",t.def(e,r),";")}return e((function(){t.apply(t,$r(arguments))}),{def:t.def,entry:t,exit:n,save:o,set:function(e,n,r){o(e,n),t(e,n,"=",r,";")},toString:function(){return r()+i()}})}function s(){var t=Kr(arguments),n=o(),r=o(),i=n.toString,a=r.toString;return e(n,{then:function(){return n.apply(n,$r(arguments)),this},else:function(){return r.apply(r,$r(arguments)),this},toString:function(){var e=a();return e&&(e="else{"+e+"}"),Kr(["if(",t,"){",i(),"}",e])}})}var c=a(),u={};function f(t,n){var r=[];function i(){var e="a"+r.length;return r.push(e),e}n=n||0;for(var a=0;a<n;++a)i();var s=o(),c=s.toString,f=u[t]=e(s,{arg:i,toString:function(){return Kr(["function(",r.join(),"){",c(),"}"])}});return f}function l(){var e=['"use strict";',c,"return {"];Object.keys(u).forEach((function(t){e.push('"',t,'":',u[t].toString(),",")})),e.push("}");var t=Kr(e).replace(/;/g,";\n").replace(/}/g,"}\n").replace(/{/g,"{\n"),i=Function.apply(null,n.concat(t));return i.apply(null,r)}return{global:c,link:i,block:a,proc:f,scope:o,cond:s,compile:l}}var ti="xyzw".split(""),ni=5121,ri=1,ii=2,ai=0,oi=1,si=2,ci=3,ui=4,fi="dither",li="blend.enable",pi="blend.color",hi="blend.equation",di="blend.func",mi="depth.enable",vi="depth.func",gi="depth.range",bi="depth.mask",yi="colorMask",wi="cull.enable",xi="cull.face",_i="frontFace",Ai="lineWidth",Ei="polygonOffset.enable",Ti="polygonOffset.offset",Ci="sample.alpha",Oi="sample.enable",Pi="sample.coverage",ki="stencil.enable",Di="stencil.mask",Mi="stencil.func",Si="stencil.opFront",zi="stencil.opBack",Fi="scissor.enable",Li="scissor.box",Ri="viewport",ji="profile",Bi="framebuffer",Ii="vert",Ni="frag",Vi="elements",Ui="primitive",Hi="count",qi="offset",Yi="instances",Gi="vao",Qi="Width",Wi="Height",Xi=Bi+Qi,Ji=Bi+Wi,Zi=Ri+Qi,$i=Ri+Wi,Ki="drawingBuffer",ea=Ki+Qi,ta=Ki+Wi,na=[di,hi,Mi,Si,zi,Pi,Ri,Li,Ti],ra=34962,ia=34963,aa=2884,oa=3042,sa=3024,ca=2960,ua=2929,fa=3089,la=32823,pa=32926,ha=32928,da=5126,ma=35664,va=35665,ga=35666,ba=5124,ya=35667,wa=35668,xa=35669,_a=35670,Aa=35671,Ea=35672,Ta=35673,Ca=35674,Oa=35675,Pa=35676,ka=35678,Da=35680,Ma=4,Sa=1028,za=1029,Fa=2304,La=2305,Ra=32775,ja=32776,Ba=519,Ia=7680,Na=0,Va=1,Ua=32774,Ha=513,qa=36160,Ya=36064,Ga={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},Qa={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},Wa={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},Xa={cw:Fa,ccw:La};function Ja(e){return Array.isArray(e)||ye(e)||we(e)}function Za(e){return e.sort((function(e,t){return e===Ri?-1:t===Ri?1:e<t?-1:1}))}function $a(e,t,n,r){this.thisDep=e,this.contextDep=t,this.propDep=n,this.append=r}function Ka(e){return e&&!(e.thisDep||e.contextDep||e.propDep)}function eo(e){return new $a(!1,!1,!1,e)}function to(e,t){var n=e.type;if(n===ai){var r=e.data.length;return new $a(!0,r>=1,r>=2,t)}if(n===ui){var i=e.data;return new $a(i.thisDep,i.contextDep,i.propDep,t)}return new $a(n===ci,n===si,n===oi,t)}var no=new $a(!1,!1,!1,(function(){}));function ro(e,t,n,r,i,a,o,s,c,u,l,p,h,d,m){var v=u.Record,g={add:32774,subtract:32778,"reverse subtract":32779};n.ext_blend_minmax&&(g.min=Ra,g.max=ja);var b=n.angle_instanced_arrays,y=n.webgl_draw_buffers,w={dirty:!0,profile:m.profile},x={},A=[],E={},T={};function C(e){return e.replace(".","_")}function O(e,t,n){var r=C(e);A.push(e),x[r]=w[r]=!!n,E[r]=t}function P(e,t,n){var r=C(e);A.push(e),Array.isArray(n)?(w[r]=n.slice(),x[r]=n.slice()):w[r]=x[r]=n,T[r]=t}O(fi,sa),O(li,oa),P(pi,"blendColor",[0,0,0,0]),P(hi,"blendEquationSeparate",[Ua,Ua]),P(di,"blendFuncSeparate",[Va,Na,Va,Na]),O(mi,ua,!0),P(vi,"depthFunc",Ha),P(gi,"depthRange",[0,1]),P(bi,"depthMask",!0),P(yi,yi,[!0,!0,!0,!0]),O(wi,aa),P(xi,"cullFace",za),P(_i,_i,La),P(Ai,Ai,1),O(Ei,la),P(Ti,"polygonOffset",[0,0]),O(Ci,pa),O(Oi,ha),P(Pi,"sampleCoverage",[1,!1]),O(ki,ca),P(Di,"stencilMask",-1),P(Mi,"stencilFunc",[Ba,0,-1]),P(Si,"stencilOpSeparate",[Sa,Ia,Ia,Ia]),P(zi,"stencilOpSeparate",[za,Ia,Ia,Ia]),O(Fi,fa),P(Li,"scissor",[0,0,e.drawingBufferWidth,e.drawingBufferHeight]),P(Ri,Ri,[0,0,e.drawingBufferWidth,e.drawingBufferHeight]);var k={gl:e,context:h,strings:t,next:x,current:w,draw:p,elements:a,buffer:i,shader:l,attributes:u.state,vao:u,uniforms:c,framebuffer:s,extensions:n,timer:d,isBufferArgs:Ja},D={primTypes:at,compareFuncs:Qa,blendFuncs:Ga,blendEquations:g,stencilOps:Wa,glTypes:Be,orientationType:Xa};y&&(D.backBuffer=[za],D.drawBuffer=_(r.maxDrawbuffers,(function(e){return 0===e?[0]:_(e,(function(e){return Ya+e}))})));var M=0;function S(){var e=ei(),n=e.link,r=e.global;e.id=M++,e.batchId="0";var i=n(k),a=e.shared={props:"a0"};Object.keys(k).forEach((function(e){a[e]=r.def(i,".",e)}));var o=e.next={},s=e.current={};Object.keys(T).forEach((function(e){Array.isArray(w[e])&&(o[e]=r.def(a.next,".",e),s[e]=r.def(a.current,".",e))}));var c=e.constants={};Object.keys(D).forEach((function(e){c[e]=r.def(JSON.stringify(D[e]))})),e.invoke=function(t,r){switch(r.type){case ai:var i=["this",a.context,a.props,e.batchId];return t.def(n(r.data),".call(",i.slice(0,Math.max(r.data.length+1,4)),")");case oi:return t.def(a.props,r.data);case si:return t.def(a.context,r.data);case ci:return t.def("this",r.data);case ui:return r.data.append(e,t),r.data.ref}},e.attribCache={};var f={};return e.scopeAttrib=function(e){var r=t.id(e);if(r in f)return f[r];var i=u.scope[r];i||(i=u.scope[r]=new v);var a=f[r]=n(i);return a},e}function z(e){var t,n=e.static,r=e.dynamic;if(ji in n){var i=!!n[ji];t=eo((function(e,t){return i})),t.enable=i}else if(ji in r){var a=r[ji];t=to(a,(function(e,t){return e.invoke(t,a)}))}return t}function F(e,t){var n=e.static,r=e.dynamic;if(Bi in n){var i=n[Bi];return i?(i=s.getFramebuffer(i),eo((function(e,t){var n=e.link(i),r=e.shared;t.set(r.framebuffer,".next",n);var a=r.context;return t.set(a,"."+Xi,n+".width"),t.set(a,"."+Ji,n+".height"),n}))):eo((function(e,t){var n=e.shared;t.set(n.framebuffer,".next","null");var r=n.context;return t.set(r,"."+Xi,r+"."+ea),t.set(r,"."+Ji,r+"."+ta),"null"}))}if(Bi in r){var a=r[Bi];return to(a,(function(e,t){var n=e.invoke(t,a),r=e.shared,i=r.framebuffer,o=t.def(i,".getFramebuffer(",n,")");t.set(i,".next",o);var s=r.context;return t.set(s,"."+Xi,o+"?"+o+".width:"+s+"."+ea),t.set(s,"."+Ji,o+"?"+o+".height:"+s+"."+ta),o}))}return null}function L(e,t,n){var r=e.static,i=e.dynamic;function a(e){if(e in r){var n,a,o=r[e],s=!0,c=0|o.x,u=0|o.y;return"width"in o?n=0|o.width:s=!1,"height"in o?a=0|o.height:s=!1,new $a(!s&&t&&t.thisDep,!s&&t&&t.contextDep,!s&&t&&t.propDep,(function(e,t){var r=e.shared.context,i=n;"width"in o||(i=t.def(r,".",Xi,"-",c));var s=a;return"height"in o||(s=t.def(r,".",Ji,"-",u)),[c,u,i,s]}))}if(e in i){var f=i[e],l=to(f,(function(e,t){var n=e.invoke(t,f),r=e.shared.context,i=t.def(n,".x|0"),a=t.def(n,".y|0"),o=t.def('"width" in ',n,"?",n,".width|0:","(",r,".",Xi,"-",i,")"),s=t.def('"height" in ',n,"?",n,".height|0:","(",r,".",Ji,"-",a,")");return[i,a,o,s]}));return t&&(l.thisDep=l.thisDep||t.thisDep,l.contextDep=l.contextDep||t.contextDep,l.propDep=l.propDep||t.propDep),l}return t?new $a(t.thisDep,t.contextDep,t.propDep,(function(e,t){var n=e.shared.context;return[0,0,t.def(n,".",Xi),t.def(n,".",Ji)]})):null}var o=a(Ri);if(o){var s=o;o=new $a(o.thisDep,o.contextDep,o.propDep,(function(e,t){var n=s.append(e,t),r=e.shared.context;return t.set(r,"."+Zi,n[2]),t.set(r,"."+$i,n[3]),n}))}return{viewport:o,scissor_box:a(Li)}}function R(e,t){var n=e.static,r="string"===typeof n[Ni]&&"string"===typeof n[Ii];if(r){if(Object.keys(t.dynamic).length>0)return null;var i=t.static,a=Object.keys(i);if(a.length>0&&"number"===typeof i[a[0]]){for(var o=[],s=0;s<a.length;++s)o.push([0|i[a[s]],a[s]]);return o}}return null}function j(e,n,r){var i=e.static,a=e.dynamic;function o(e){if(e in i){var n=t.id(i[e]),r=eo((function(){return n}));return r.id=n,r}if(e in a){var o=a[e];return to(o,(function(e,t){var n=e.invoke(t,o),r=t.def(e.shared.strings,".id(",n,")");return r}))}return null}var s,c=o(Ni),u=o(Ii),f=null;return Ka(c)&&Ka(u)?(f=l.program(u.id,c.id,null,r),s=eo((function(e,t){return e.link(f)}))):s=new $a(c&&c.thisDep||u&&u.thisDep,c&&c.contextDep||u&&u.contextDep,c&&c.propDep||u&&u.propDep,(function(e,t){var n,r,i=e.shared.shader;n=c?c.append(e,t):t.def(i,".",Ni),r=u?u.append(e,t):t.def(i,".",Ii);var a=i+".program("+r+","+n;return t.def(a+")")})),{frag:c,vert:u,progVar:s,program:f}}function B(e,t){var n=e.static,r=e.dynamic;function i(){if(Vi in n){var e=n[Vi];Ja(e)?e=a.getElements(a.create(e,!0)):e&&(e=a.getElements(e));var t=eo((function(t,n){if(e){var r=t.link(e);return t.ELEMENTS=r,r}return t.ELEMENTS=null,null}));return t.value=e,t}if(Vi in r){var i=r[Vi];return to(i,(function(e,t){var n=e.shared,r=n.isBufferArgs,a=n.elements,o=e.invoke(t,i),s=t.def("null"),c=t.def(r,"(",o,")"),u=e.cond(c).then(s,"=",a,".createStream(",o,");").else(s,"=",a,".getElements(",o,");");return t.entry(u),t.exit(e.cond(c).then(a,".destroyStream(",s,");")),e.ELEMENTS=s,s}))}return null}var o=i();function s(){if(Ui in n){var e=n[Ui];return eo((function(t,n){return at[e]}))}if(Ui in r){var t=r[Ui];return to(t,(function(e,n){var r=e.constants.primTypes,i=e.invoke(n,t);return n.def(r,"[",i,"]")}))}return o?Ka(o)?o.value?eo((function(e,t){return t.def(e.ELEMENTS,".primType")})):eo((function(){return Ma})):new $a(o.thisDep,o.contextDep,o.propDep,(function(e,t){var n=e.ELEMENTS;return t.def(n,"?",n,".primType:",Ma)})):null}function c(e,t){if(e in n){var i=0|n[e];return eo((function(e,n){return t&&(e.OFFSET=i),i}))}if(e in r){var a=r[e];return to(a,(function(e,n){var r=e.invoke(n,a);return t&&(e.OFFSET=r),r}))}return t&&o?eo((function(e,t){return e.OFFSET="0",0})):null}var u=c(qi,!0);function f(){if(Hi in n){var e=0|n[Hi];return eo((function(){return e}))}if(Hi in r){var t=r[Hi];return to(t,(function(e,n){var r=e.invoke(n,t);return r}))}if(o){if(Ka(o)){if(o)return u?new $a(u.thisDep,u.contextDep,u.propDep,(function(e,t){var n=t.def(e.ELEMENTS,".vertCount-",e.OFFSET);return n})):eo((function(e,t){return t.def(e.ELEMENTS,".vertCount")}));var i=eo((function(){return-1}));return i}var a=new $a(o.thisDep||u.thisDep,o.contextDep||u.contextDep,o.propDep||u.propDep,(function(e,t){var n=e.ELEMENTS;return e.OFFSET?t.def(n,"?",n,".vertCount-",e.OFFSET,":-1"):t.def(n,"?",n,".vertCount:-1")}));return a}return null}return{elements:o,primitive:s(),count:f(),instances:c(Yi,!1),offset:u}}function I(e,t){var n=e.static,r=e.dynamic,i={};return A.forEach((function(e){var t=C(e);function a(a,o){if(e in n){var s=a(n[e]);i[t]=eo((function(){return s}))}else if(e in r){var c=r[e];i[t]=to(c,(function(e,t){return o(e,t,e.invoke(t,c))}))}}switch(e){case wi:case li:case fi:case ki:case mi:case Fi:case Ei:case Ci:case Oi:case bi:return a((function(e){return e}),(function(e,t,n){return n}));case vi:return a((function(e){return Qa[e]}),(function(e,t,n){var r=e.constants.compareFuncs;return t.def(r,"[",n,"]")}));case gi:return a((function(e){return e}),(function(e,t,n){var r=t.def("+",n,"[0]"),i=t.def("+",n,"[1]");return[r,i]}));case di:return a((function(e){var t="srcRGB"in e?e.srcRGB:e.src,n="srcAlpha"in e?e.srcAlpha:e.src,r="dstRGB"in e?e.dstRGB:e.dst,i="dstAlpha"in e?e.dstAlpha:e.dst;return[Ga[t],Ga[r],Ga[n],Ga[i]]}),(function(e,t,n){var r=e.constants.blendFuncs;function i(e,r){var i=t.def('"',e,r,'" in ',n,"?",n,".",e,r,":",n,".",e);return i}var a=i("src","RGB"),o=i("dst","RGB"),s=t.def(r,"[",a,"]"),c=t.def(r,"[",i("src","Alpha"),"]"),u=t.def(r,"[",o,"]"),f=t.def(r,"[",i("dst","Alpha"),"]");return[s,u,c,f]}));case hi:return a((function(e){return"string"===typeof e?[g[e],g[e]]:"object"===typeof e?[g[e.rgb],g[e.alpha]]:void 0}),(function(e,t,n){var r=e.constants.blendEquations,i=t.def(),a=t.def(),o=e.cond("typeof ",n,'==="string"');return o.then(i,"=",a,"=",r,"[",n,"];"),o.else(i,"=",r,"[",n,".rgb];",a,"=",r,"[",n,".alpha];"),t(o),[i,a]}));case pi:return a((function(e){return _(4,(function(t){return+e[t]}))}),(function(e,t,n){return _(4,(function(e){return t.def("+",n,"[",e,"]")}))}));case Di:return a((function(e){return 0|e}),(function(e,t,n){return t.def(n,"|0")}));case Mi:return a((function(e){var t=e.cmp||"keep",n=e.ref||0,r="mask"in e?e.mask:-1;return[Qa[t],n,r]}),(function(e,t,n){var r=e.constants.compareFuncs,i=t.def('"cmp" in ',n,"?",r,"[",n,".cmp]",":",Ia),a=t.def(n,".ref|0"),o=t.def('"mask" in ',n,"?",n,".mask|0:-1");return[i,a,o]}));case Si:case zi:return a((function(t){var n=t.fail||"keep",r=t.zfail||"keep",i=t.zpass||"keep";return[e===zi?za:Sa,Wa[n],Wa[r],Wa[i]]}),(function(t,n,r){var i=t.constants.stencilOps;function a(e){return n.def('"',e,'" in ',r,"?",i,"[",r,".",e,"]:",Ia)}return[e===zi?za:Sa,a("fail"),a("zfail"),a("zpass")]}));case Ti:return a((function(e){var t=0|e.factor,n=0|e.units;return[t,n]}),(function(e,t,n){var r=t.def(n,".factor|0"),i=t.def(n,".units|0");return[r,i]}));case xi:return a((function(e){var t=0;return"front"===e?t=Sa:"back"===e&&(t=za),t}),(function(e,t,n){return t.def(n,'==="front"?',Sa,":",za)}));case Ai:return a((function(e){return e}),(function(e,t,n){return n}));case _i:return a((function(e){return Xa[e]}),(function(e,t,n){return t.def(n+'==="cw"?'+Fa+":"+La)}));case yi:return a((function(e){return e.map((function(e){return!!e}))}),(function(e,t,n){return _(4,(function(e){return"!!"+n+"["+e+"]"}))}));case Pi:return a((function(e){var t="value"in e?e.value:1,n=!!e.invert;return[t,n]}),(function(e,t,n){var r=t.def('"value" in ',n,"?+",n,".value:1"),i=t.def("!!",n,".invert");return[r,i]}))}})),i}function N(e,t){var n=e.static,r=e.dynamic,i={};return Object.keys(n).forEach((function(e){var t,r=n[e];if("number"===typeof r||"boolean"===typeof r)t=eo((function(){return r}));else if("function"===typeof r){var a=r._reglType;"texture2d"===a||"textureCube"===a?t=eo((function(e){return e.link(r)})):"framebuffer"!==a&&"framebufferCube"!==a||(t=eo((function(e){return e.link(r.color[0])})))}else At(r)&&(t=eo((function(e){var t=e.global.def("[",_(r.length,(function(e){return r[e]})),"]");return t})));t.value=r,i[e]=t})),Object.keys(r).forEach((function(e){var t=r[e];i[e]=to(t,(function(e,n){return e.invoke(n,t)}))})),i}function V(e,n){var r=e.static,a=e.dynamic,o={};return Object.keys(r).forEach((function(e){var n=r[e],a=t.id(e),s=new v;if(Ja(n))s.state=ri,s.buffer=i.getBuffer(i.create(n,ra,!1,!0)),s.type=0;else{var c=i.getBuffer(n);if(c)s.state=ri,s.buffer=c,s.type=0;else if("constant"in n){var u=n.constant;s.buffer="null",s.state=ii,"number"===typeof u?s.x=u:ti.forEach((function(e,t){t<u.length&&(s[e]=u[t])}))}else{c=Ja(n.buffer)?i.getBuffer(i.create(n.buffer,ra,!1,!0)):i.getBuffer(n.buffer);var f=0|n.offset,l=0|n.stride,p=0|n.size,h=!!n.normalized,d=0;"type"in n&&(d=Be[n.type]);var m=0|n.divisor;s.buffer=c,s.state=ri,s.size=p,s.normalized=h,s.type=d||c.dtype,s.offset=f,s.stride=l,s.divisor=m}}o[e]=eo((function(e,t){var n=e.attribCache;if(a in n)return n[a];var r={isStream:!1};return Object.keys(s).forEach((function(e){r[e]=s[e]})),s.buffer&&(r.buffer=e.link(s.buffer),r.type=r.type||r.buffer+".dtype"),n[a]=r,r}))})),Object.keys(a).forEach((function(e){var t=a[e];function n(e,n){var r=e.invoke(n,t),i=e.shared,a=e.constants,o=i.isBufferArgs,s=i.buffer,c={isStream:n.def(!1)},u=new v;u.state=ri,Object.keys(u).forEach((function(e){c[e]=n.def(""+u[e])}));var f=c.buffer,l=c.type;function p(e){n(c[e],"=",r,".",e,"|0;")}return n("if(",o,"(",r,")){",c.isStream,"=true;",f,"=",s,".createStream(",ra,",",r,");",l,"=",f,".dtype;","}else{",f,"=",s,".getBuffer(",r,");","if(",f,"){",l,"=",f,".dtype;",'}else if("constant" in ',r,"){",c.state,"=",ii,";","if(typeof "+r+'.constant === "number"){',c[ti[0]],"=",r,".constant;",ti.slice(1).map((function(e){return c[e]})).join("="),"=0;","}else{",ti.map((function(e,t){return c[e]+"="+r+".constant.length>"+t+"?"+r+".constant["+t+"]:0;"})).join(""),"}}else{","if(",o,"(",r,".buffer)){",f,"=",s,".createStream(",ra,",",r,".buffer);","}else{",f,"=",s,".getBuffer(",r,".buffer);","}",l,'="type" in ',r,"?",a.glTypes,"[",r,".type]:",f,".dtype;",c.normalized,"=!!",r,".normalized;"),p("size"),p("offset"),p("stride"),p("divisor"),n("}}"),n.exit("if(",c.isStream,"){",s,".destroyStream(",f,");","}"),c}o[e]=to(t,n)})),o}function U(e,t){var n=e.static,r=e.dynamic;if(Gi in n){var i=n[Gi];return null!==i&&null===u.getVAO(i)&&(i=u.createVAO(i)),eo((function(e){return e.link(u.getVAO(i))}))}if(Gi in r){var a=r[Gi];return to(a,(function(e,t){var n=e.invoke(t,a);return t.def(e.shared.vao+".getVAO("+n+")")}))}return null}function H(e){var t=e.static,n=e.dynamic,r={};return Object.keys(t).forEach((function(e){var n=t[e];r[e]=eo((function(e,t){return"number"===typeof n||"boolean"===typeof n?""+n:e.link(n)}))})),Object.keys(n).forEach((function(e){var t=n[e];r[e]=to(t,(function(e,n){return e.invoke(n,t)}))})),r}function q(e,t,r,i,a){e.static,e.dynamic;var o=R(e,t),s=F(e),c=L(e,s),f=B(e),l=I(e),p=j(e,a,o);function h(e){var t=c[e];t&&(l[e]=t)}h(Ri),h(C(Li));var d=Object.keys(l).length>0,m={framebuffer:s,draw:f,shader:p,state:l,dirty:d,scopeVAO:null,drawVAO:null,useVAO:!1,attributes:{}};if(m.profile=z(e),m.uniforms=N(r),m.drawVAO=m.scopeVAO=U(e),!m.drawVAO&&p.program&&!o&&n.angle_instanced_arrays){var v=!0,g=p.program.attributes.map((function(e){var n=t.static[e];return v=v&&!!n,n}));if(v&&g.length>0){var b=u.getVAO(u.createVAO(g));m.drawVAO=new $a(null,null,null,(function(e,t){return e.link(b)})),m.useVAO=!0}}return o?m.useVAO=!0:m.attributes=V(t),m.context=H(i),m}function Y(e,t,n){var r=e.shared,i=r.context,a=e.scope();Object.keys(n).forEach((function(r){t.save(i,"."+r);var o=n[r];a(i,".",r,"=",o.append(e,t),";")})),t(a)}function G(e,t,n,r){var i,a=e.shared,o=a.gl,s=a.framebuffer;y&&(i=t.def(a.extensions,".webgl_draw_buffers"));var c,u=e.constants,f=u.drawBuffer,l=u.backBuffer;c=n?n.append(e,t):t.def(s,".next"),r||t("if(",c,"!==",s,".cur){"),t("if(",c,"){",o,".bindFramebuffer(",qa,",",c,".framebuffer);"),y&&t(i,".drawBuffersWEBGL(",f,"[",c,".colorAttachments.length]);"),t("}else{",o,".bindFramebuffer(",qa,",null);"),y&&t(i,".drawBuffersWEBGL(",l,");"),t("}",s,".cur=",c,";"),r||t("}")}function Q(e,t,n){var r=e.shared,i=r.gl,a=e.current,o=e.next,s=r.current,c=r.next,u=e.cond(s,".dirty");A.forEach((function(t){var r,f,l=C(t);if(!(l in n.state))if(l in o){r=o[l],f=a[l];var p=_(w[l].length,(function(e){return u.def(r,"[",e,"]")}));u(e.cond(p.map((function(e,t){return e+"!=="+f+"["+t+"]"})).join("||")).then(i,".",T[l],"(",p,");",p.map((function(e,t){return f+"["+t+"]="+e})).join(";"),";"))}else{r=u.def(c,".",l);var h=e.cond(r,"!==",s,".",l);u(h),l in E?h(e.cond(r).then(i,".enable(",E[l],");").else(i,".disable(",E[l],");"),s,".",l,"=",r,";"):h(i,".",T[l],"(",r,");",s,".",l,"=",r,";")}})),0===Object.keys(n.state).length&&u(s,".dirty=false;"),t(u)}function W(e,t,n,r){var i=e.shared,a=e.current,o=i.current,s=i.gl;Za(Object.keys(n)).forEach((function(i){var c=n[i];if(!r||r(c)){var u=c.append(e,t);if(E[i]){var f=E[i];Ka(c)?t(s,u?".enable(":".disable(",f,");"):t(e.cond(u).then(s,".enable(",f,");").else(s,".disable(",f,");")),t(o,".",i,"=",u,";")}else if(At(u)){var l=a[i];t(s,".",T[i],"(",u,");",u.map((function(e,t){return l+"["+t+"]="+e})).join(";"),";")}else t(s,".",T[i],"(",u,");",o,".",i,"=",u,";")}}))}function X(e,t){b&&(e.instancing=t.def(e.shared.extensions,".angle_instanced_arrays"))}function J(e,t,n,r,i){var a,o,s,c=e.shared,u=e.stats,f=c.current,l=c.timer,p=n.profile;function h(){return"undefined"===typeof performance?"Date.now()":"performance.now()"}function m(e){a=t.def(),e(a,"=",h(),";"),"string"===typeof i?e(u,".count+=",i,";"):e(u,".count++;"),d&&(r?(o=t.def(),e(o,"=",l,".getNumPendingQueries();")):e(l,".beginQuery(",u,");"))}function v(e){e(u,".cpuTime+=",h(),"-",a,";"),d&&(r?e(l,".pushScopeStats(",o,",",l,".getNumPendingQueries(),",u,");"):e(l,".endQuery();"))}function g(e){var n=t.def(f,".profile");t(f,".profile=",e,";"),t.exit(f,".profile=",n,";")}if(p){if(Ka(p))return void(p.enable?(m(t),v(t.exit),g("true")):g("false"));s=p.append(e,t),g(s)}else s=t.def(f,".profile");var b=e.block();m(b),t("if(",s,"){",b,"}");var y=e.block();v(y),t.exit("if(",s,"){",y,"}")}function Z(e,t,n,r,i){var a=e.shared;function o(e){switch(e){case ma:case ya:case Aa:return 2;case va:case wa:case Ea:return 3;case ga:case xa:case Ta:return 4;default:return 1}}function s(n,r,i){var o=a.gl,s=t.def(n,".location"),c=t.def(a.attributes,"[",s,"]"),u=i.state,f=i.buffer,l=[i.x,i.y,i.z,i.w],p=["buffer","normalized","offset","stride"];function h(){t("if(!",c,".buffer){",o,".enableVertexAttribArray(",s,");}");var n,a=i.type;if(n=i.size?t.def(i.size,"||",r):r,t("if(",c,".type!==",a,"||",c,".size!==",n,"||",p.map((function(e){return c+"."+e+"!=="+i[e]})).join("||"),"){",o,".bindBuffer(",ra,",",f,".buffer);",o,".vertexAttribPointer(",[s,n,a,i.normalized,i.stride,i.offset],");",c,".type=",a,";",c,".size=",n,";",p.map((function(e){return c+"."+e+"="+i[e]+";"})).join(""),"}"),b){var u=i.divisor;t("if(",c,".divisor!==",u,"){",e.instancing,".vertexAttribDivisorANGLE(",[s,u],");",c,".divisor=",u,";}")}}function d(){t("if(",c,".buffer){",o,".disableVertexAttribArray(",s,");",c,".buffer=null;","}if(",ti.map((function(e,t){return c+"."+e+"!=="+l[t]})).join("||"),"){",o,".vertexAttrib4f(",s,",",l,");",ti.map((function(e,t){return c+"."+e+"="+l[t]+";"})).join(""),"}")}u===ri?h():u===ii?d():(t("if(",u,"===",ri,"){"),h(),t("}else{"),d(),t("}"))}r.forEach((function(r){var a,c=r.name,u=n.attributes[c];if(u){if(!i(u))return;a=u.append(e,t)}else{if(!i(no))return;var f=e.scopeAttrib(c);a={},Object.keys(new v).forEach((function(e){a[e]=t.def(f,".",e)}))}s(e.link(r),o(r.info.type),a)}))}function $(e,n,r,i,a){for(var o,s=e.shared,c=s.gl,u=0;u<i.length;++u){var f,l=i[u],p=l.name,h=l.info.type,d=r.uniforms[p],m=e.link(l),v=m+".location";if(d){if(!a(d))continue;if(Ka(d)){var g=d.value;if(h===ka||h===Da){var b=e.link(g._texture||g.color[0]._texture);n(c,".uniform1i(",v,",",b+".bind());"),n.exit(b,".unbind();")}else if(h===Ca||h===Oa||h===Pa){var y=e.global.def("new Float32Array(["+Array.prototype.slice.call(g)+"])"),w=2;h===Oa?w=3:h===Pa&&(w=4),n(c,".uniformMatrix",w,"fv(",v,",false,",y,");")}else{switch(h){case da:o="1f";break;case ma:o="2f";break;case va:o="3f";break;case ga:o="4f";break;case _a:o="1i";break;case ba:o="1i";break;case Aa:o="2i";break;case ya:o="2i";break;case Ea:o="3i";break;case wa:o="3i";break;case Ta:o="4i";break;case xa:o="4i";break}n(c,".uniform",o,"(",v,",",At(g)?Array.prototype.slice.call(g):g,");")}continue}f=d.append(e,n)}else{if(!a(no))continue;f=n.def(s.uniforms,"[",t.id(p),"]")}h===ka?n("if(",f,"&&",f,'._reglType==="framebuffer"){',f,"=",f,".color[0];","}"):h===Da&&n("if(",f,"&&",f,'._reglType==="framebufferCube"){',f,"=",f,".color[0];","}");var x=1;switch(h){case ka:case Da:var A=n.def(f,"._texture");n(c,".uniform1i(",v,",",A,".bind());"),n.exit(A,".unbind();");continue;case ba:case _a:o="1i";break;case ya:case Aa:o="2i",x=2;break;case wa:case Ea:o="3i",x=3;break;case xa:case Ta:o="4i",x=4;break;case da:o="1f";break;case ma:o="2f",x=2;break;case va:o="3f",x=3;break;case ga:o="4f",x=4;break;case Ca:o="Matrix2fv";break;case Oa:o="Matrix3fv";break;case Pa:o="Matrix4fv";break}if(n(c,".uniform",o,"(",v,","),"M"===o.charAt(0)){var E=Math.pow(h-Ca+2,2),T=e.global.def("new Float32Array(",E,")");n("false,(Array.isArray(",f,")||",f," instanceof Float32Array)?",f,":(",_(E,(function(e){return T+"["+e+"]="+f+"["+e+"]"})),",",T,")")}else n(x>1?_(x,(function(e){return f+"["+e+"]"})):f);n(");")}}function K(e,t,n,r){var i=e.shared,a=i.gl,o=i.draw,s=r.draw;function c(){var i,c=s.elements,u=t;return c?((c.contextDep&&r.contextDynamic||c.propDep)&&(u=n),i=c.append(e,u)):i=u.def(o,".",Vi),i&&u("if("+i+")"+a+".bindBuffer("+ia+","+i+".buffer.buffer);"),i}function u(){var i,a=s.count,c=t;return a?((a.contextDep&&r.contextDynamic||a.propDep)&&(c=n),i=a.append(e,c)):i=c.def(o,".",Hi),i}var f=c();function l(i){var a=s[i];return a?a.contextDep&&r.contextDynamic||a.propDep?a.append(e,n):a.append(e,t):t.def(o,".",i)}var p,h,d=l(Ui),m=l(qi),v=u();if("number"===typeof v){if(0===v)return}else n("if(",v,"){"),n.exit("}");b&&(p=l(Yi),h=e.instancing);var g=f+".type",y=s.elements&&Ka(s.elements);function w(){function e(){n(h,".drawElementsInstancedANGLE(",[d,v,g,m+"<<(("+g+"-"+ni+")>>1)",p],");")}function t(){n(h,".drawArraysInstancedANGLE(",[d,m,v,p],");")}f?y?e():(n("if(",f,"){"),e(),n("}else{"),t(),n("}")):t()}function x(){function e(){n(a+".drawElements("+[d,v,g,m+"<<(("+g+"-"+ni+")>>1)"]+");")}function t(){n(a+".drawArrays("+[d,m,v]+");")}f?y?e():(n("if(",f,"){"),e(),n("}else{"),t(),n("}")):t()}b&&("number"!==typeof p||p>=0)?"string"===typeof p?(n("if(",p,">0){"),w(),n("}else if(",p,"<0){"),x(),n("}")):w():x()}function ee(e,t,n,r,i){var a=S(),o=a.proc("body",i);return b&&(a.instancing=o.def(a.shared.extensions,".angle_instanced_arrays")),e(a,o,n,r),a.compile().body}function te(e,t,n,r){X(e,t),n.useVAO?n.drawVAO?t(e.shared.vao,".setVAO(",n.drawVAO.append(e,t),");"):t(e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"):(t(e.shared.vao,".setVAO(null);"),Z(e,t,n,r.attributes,(function(){return!0}))),$(e,t,n,r.uniforms,(function(){return!0})),K(e,t,t,n)}function ne(e,t){var n=e.proc("draw",1);X(e,n),Y(e,n,t.context),G(e,n,t.framebuffer),Q(e,n,t),W(e,n,t.state),J(e,n,t,!1,!0);var r=t.shader.progVar.append(e,n);if(n(e.shared.gl,".useProgram(",r,".program);"),t.shader.program)te(e,n,t,t.shader.program);else{n(e.shared.vao,".setVAO(null);");var i=e.global.def("{}"),a=n.def(r,".id"),o=n.def(i,"[",a,"]");n(e.cond(o).then(o,".call(this,a0);").else(o,"=",i,"[",a,"]=",e.link((function(n){return ee(te,e,t,n,1)})),"(",r,");",o,".call(this,a0);"))}Object.keys(t.state).length>0&&n(e.shared.current,".dirty=true;")}function re(e,t,n,r){function i(){return!0}e.batchId="a1",X(e,t),Z(e,t,n,r.attributes,i),$(e,t,n,r.uniforms,i),K(e,t,t,n)}function ie(e,t,n,r){X(e,t);var i=n.contextDep,a=t.def(),o="a0",s="a1",c=t.def();e.shared.props=c,e.batchId=a;var u=e.scope(),f=e.scope();function l(e){return e.contextDep&&i||e.propDep}function p(e){return!l(e)}if(t(u.entry,"for(",a,"=0;",a,"<",s,";++",a,"){",c,"=",o,"[",a,"];",f,"}",u.exit),n.needsContext&&Y(e,f,n.context),n.needsFramebuffer&&G(e,f,n.framebuffer),W(e,f,n.state,l),n.profile&&l(n.profile)&&J(e,f,n,!1,!0),r)n.useVAO?n.drawVAO?l(n.drawVAO)?f(e.shared.vao,".setVAO(",n.drawVAO.append(e,f),");"):u(e.shared.vao,".setVAO(",n.drawVAO.append(e,u),");"):u(e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"):(u(e.shared.vao,".setVAO(null);"),Z(e,u,n,r.attributes,p),Z(e,f,n,r.attributes,l)),$(e,u,n,r.uniforms,p),$(e,f,n,r.uniforms,l),K(e,u,f,n);else{var h=e.global.def("{}"),d=n.shader.progVar.append(e,f),m=f.def(d,".id"),v=f.def(h,"[",m,"]");f(e.shared.gl,".useProgram(",d,".program);","if(!",v,"){",v,"=",h,"[",m,"]=",e.link((function(t){return ee(re,e,n,t,2)})),"(",d,");}",v,".call(this,a0[",a,"],",a,");")}}function ae(e,t){var n=e.proc("batch",2);e.batchId="0",X(e,n);var r=!1,i=!0;Object.keys(t.context).forEach((function(e){r=r||t.context[e].propDep})),r||(Y(e,n,t.context),i=!1);var a=t.framebuffer,o=!1;function s(e){return e.contextDep&&r||e.propDep}a?(a.propDep?r=o=!0:a.contextDep&&r&&(o=!0),o||G(e,n,a)):G(e,n,null),t.state.viewport&&t.state.viewport.propDep&&(r=!0),Q(e,n,t),W(e,n,t.state,(function(e){return!s(e)})),t.profile&&s(t.profile)||J(e,n,t,!1,"a1"),t.contextDep=r,t.needsContext=i,t.needsFramebuffer=o;var c=t.shader.progVar;if(c.contextDep&&r||c.propDep)ie(e,n,t,null);else{var u=c.append(e,n);if(n(e.shared.gl,".useProgram(",u,".program);"),t.shader.program)ie(e,n,t,t.shader.program);else{n(e.shared.vao,".setVAO(null);");var f=e.global.def("{}"),l=n.def(u,".id"),p=n.def(f,"[",l,"]");n(e.cond(p).then(p,".call(this,a0,a1);").else(p,"=",f,"[",l,"]=",e.link((function(n){return ee(ie,e,t,n,2)})),"(",u,");",p,".call(this,a0,a1);"))}}Object.keys(t.state).length>0&&n(e.shared.current,".dirty=true;")}function oe(e,n){var r=e.proc("scope",3);e.batchId="a2";var i=e.shared,a=i.current;function o(t){var a=n.shader[t];a&&r.set(i.shader,"."+t,a.append(e,r))}Y(e,r,n.context),n.framebuffer&&n.framebuffer.append(e,r),Za(Object.keys(n.state)).forEach((function(t){var a=n.state[t],o=a.append(e,r);At(o)?o.forEach((function(n,i){r.set(e.next[t],"["+i+"]",n)})):r.set(i.next,"."+t,o)})),J(e,r,n,!0,!0),[Vi,qi,Hi,Yi,Ui].forEach((function(t){var a=n.draw[t];a&&r.set(i.draw,"."+t,""+a.append(e,r))})),Object.keys(n.uniforms).forEach((function(a){r.set(i.uniforms,"["+t.id(a)+"]",n.uniforms[a].append(e,r))})),Object.keys(n.attributes).forEach((function(t){var i=n.attributes[t].append(e,r),a=e.scopeAttrib(t);Object.keys(new v).forEach((function(e){r.set(a,"."+e,i[e])}))})),n.scopeVAO&&r.set(i.vao,".targetVAO",n.scopeVAO.append(e,r)),o(Ii),o(Ni),Object.keys(n.state).length>0&&(r(a,".dirty=true;"),r.exit(a,".dirty=true;")),r("a1(",e.shared.context,",a0,",e.batchId,");")}function se(e){if("object"===typeof e&&!At(e)){for(var t=Object.keys(e),n=0;n<t.length;++n)if(f.isDynamic(e[t[n]]))return!0;return!1}}function ce(e,t,n){var r=t.static[n];if(r&&se(r)){var i=e.global,a=Object.keys(r),o=!1,s=!1,c=!1,u=e.global.def("{}");a.forEach((function(t){var n=r[t];if(f.isDynamic(n)){"function"===typeof n&&(n=r[t]=f.unbox(n));var a=to(n,null);o=o||a.thisDep,c=c||a.propDep,s=s||a.contextDep}else{switch(i(u,".",t,"="),typeof n){case"number":i(n);break;case"string":i('"',n,'"');break;case"object":Array.isArray(n)&&i("[",n.join(),"]");break;default:i(e.link(n));break}i(";")}})),t.dynamic[n]=new f.DynamicVariable(ui,{thisDep:o,contextDep:s,propDep:c,ref:u,append:l}),delete t.static[n]}function l(e,t){a.forEach((function(n){var i=r[n];if(f.isDynamic(i)){var a=e.invoke(t,i);t(u,".",n,"=",a,";")}}))}}function ue(e,t,n,r,i){var a=S();a.stats=a.link(i),Object.keys(t.static).forEach((function(e){ce(a,t,e)})),na.forEach((function(t){ce(a,e,t)}));var o=q(e,t,n,r,a);return ne(a,o),oe(a,o),ae(a,o),a.compile()}return{next:x,current:w,procs:function(){var e=S(),t=e.proc("poll"),i=e.proc("refresh"),a=e.block();t(a),i(a);var o,s=e.shared,c=s.gl,u=s.next,f=s.current;a(f,".dirty=false;"),G(e,t),G(e,i,null,!0),b&&(o=e.link(b)),n.oes_vertex_array_object&&i(e.link(n.oes_vertex_array_object),".bindVertexArrayOES(null);");for(var l=0;l<r.maxAttributes;++l){var p=i.def(s.attributes,"[",l,"]"),h=e.cond(p,".buffer");h.then(c,".enableVertexAttribArray(",l,");",c,".bindBuffer(",ra,",",p,".buffer.buffer);",c,".vertexAttribPointer(",l,",",p,".size,",p,".type,",p,".normalized,",p,".stride,",p,".offset);").else(c,".disableVertexAttribArray(",l,");",c,".vertexAttrib4f(",l,",",p,".x,",p,".y,",p,".z,",p,".w);",p,".buffer=null;"),i(h),b&&i(o,".vertexAttribDivisorANGLE(",l,",",p,".divisor);")}return i(e.shared.vao,".currentVAO=null;",e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"),Object.keys(E).forEach((function(n){var r=E[n],o=a.def(u,".",n),s=e.block();s("if(",o,"){",c,".enable(",r,")}else{",c,".disable(",r,")}",f,".",n,"=",o,";"),i(s),t("if(",o,"!==",f,".",n,"){",s,"}")})),Object.keys(T).forEach((function(n){var r,o,s=T[n],l=w[n],p=e.block();if(p(c,".",s,"("),At(l)){var h=l.length;r=e.global.def(u,".",n),o=e.global.def(f,".",n),p(_(h,(function(e){return r+"["+e+"]"})),");",_(h,(function(e){return o+"["+e+"]="+r+"["+e+"];"})).join("")),t("if(",_(h,(function(e){return r+"["+e+"]!=="+o+"["+e+"]"})).join("||"),"){",p,"}")}else r=a.def(u,".",n),o=a.def(f,".",n),p(r,");",f,".",n,"=",r,";"),t("if(",r,"!==",o,"){",p,"}");i(p)})),e.compile()}(),compile:ue}}function io(){return{vaoCount:0,bufferCount:0,elementsCount:0,framebufferCount:0,shaderCount:0,textureCount:0,cubeCount:0,renderbufferCount:0,maxTextureUnits:0}}var ao=34918,oo=34919,so=35007,co=function(e,t){if(!t.ext_disjoint_timer_query)return null;var n=[];function r(){return n.pop()||t.ext_disjoint_timer_query.createQueryEXT()}function i(e){n.push(e)}var a=[];function o(e){var n=r();t.ext_disjoint_timer_query.beginQueryEXT(so,n),a.push(n),h(a.length-1,a.length,e)}function s(){t.ext_disjoint_timer_query.endQueryEXT(so)}function c(){this.startQueryIndex=-1,this.endQueryIndex=-1,this.sum=0,this.stats=null}var u=[];function f(){return u.pop()||new c}function l(e){u.push(e)}var p=[];function h(e,t,n){var r=f();r.startQueryIndex=e,r.endQueryIndex=t,r.sum=0,r.stats=n,p.push(r)}var d=[],m=[];function v(){var e,n,r=a.length;if(0!==r){m.length=Math.max(m.length,r+1),d.length=Math.max(d.length,r+1),d[0]=0,m[0]=0;var o=0;for(e=0,n=0;n<a.length;++n){var s=a[n];t.ext_disjoint_timer_query.getQueryObjectEXT(s,oo)?(o+=t.ext_disjoint_timer_query.getQueryObjectEXT(s,ao),i(s)):a[e++]=s,d[n+1]=o,m[n+1]=e}for(a.length=e,e=0,n=0;n<p.length;++n){var c=p[n],u=c.startQueryIndex,f=c.endQueryIndex;c.sum+=d[f]-d[u];var h=m[u],v=m[f];v===h?(c.stats.gpuTime+=c.sum/1e6,l(c)):(c.startQueryIndex=h,c.endQueryIndex=v,p[e++]=c)}p.length=e}}return{beginQuery:o,endQuery:s,pushScopeStats:h,update:v,getNumPendingQueries:function(){return a.length},clear:function(){n.push.apply(n,a);for(var e=0;e<n.length;e++)t.ext_disjoint_timer_query.deleteQueryEXT(n[e]);a.length=0,n.length=0},restore:function(){a.length=0,n.length=0}}},uo=16384,fo=256,lo=1024,po=34962,ho="webglcontextlost",mo="webglcontextrestored",vo=1,go=2,bo=3;function yo(e,t){for(var n=0;n<e.length;++n)if(e[n]===t)return n;return-1}function wo(t){var n=w(t);if(!n)return null;var r=n.gl,i=r.getContextAttributes(),a=(r.isContextLost(),x(r,n));if(!a)return null;var o=h(),s=io(),c=a.extensions,u=co(r,c),d=p(),m=r.drawingBufferWidth,v=r.drawingBufferHeight,g={tick:0,time:0,viewportWidth:m,viewportHeight:v,framebufferWidth:m,framebufferHeight:v,drawingBufferWidth:m,drawingBufferHeight:v,pixelRatio:n.pixelRatio},b={},y={elements:null,primitive:4,count:-1,offset:0,instances:-1},_=be(r,c),A=$e(r,s,n,T),E=Vr(r,c,_,s,A);function T(e){return E.destroyBuffer(e)}var C=bt(r,c,A,s),O=Gr(r,o,s,n),P=sr(r,c,_,(function(){M.procs.poll()}),g,s,n),k=xr(r,c,_,s,n),D=jr(r,c,_,P,k,s),M=ro(r,o,c,_,A,C,P,D,b,E,O,y,g,u,n),S=Zr(r,D,M.procs.poll,g,i,c),z=M.next,F=r.canvas,L=[],R=[],j=[],B=[n.onDestroy],I=null;function N(){if(0===L.length)return u&&u.update(),void(I=null);I=l.next(N),$();for(var e=L.length-1;e>=0;--e){var t=L[e];t&&t(g,null,0)}r.flush(),u&&u.update()}function V(){!I&&L.length>0&&(I=l.next(N))}function U(){I&&(l.cancel(N),I=null)}function H(e){e.preventDefault(),!0,U(),R.forEach((function(e){e()}))}function q(e){r.getError(),!1,a.restore(),O.restore(),A.restore(),P.restore(),k.restore(),D.restore(),E.restore(),u&&u.restore(),M.procs.refresh(),V(),j.forEach((function(e){e()}))}function Y(){L.length=0,U(),F&&(F.removeEventListener(ho,H),F.removeEventListener(mo,q)),O.clear(),D.clear(),k.clear(),P.clear(),C.clear(),A.clear(),E.clear(),u&&u.clear(),B.forEach((function(e){e()}))}function G(t){function n(t){var n=e({},t);function r(e){if(e in n){var t=n[e];delete n[e],Object.keys(t).forEach((function(r){n[e+"."+r]=t[r]}))}}return delete n.uniforms,delete n.attributes,delete n.context,delete n.vao,"stencil"in n&&n.stencil.op&&(n.stencil.opBack=n.stencil.opFront=n.stencil.op,delete n.stencil.op),r("blend"),r("depth"),r("cull"),r("stencil"),r("polygonOffset"),r("scissor"),r("sample"),"vao"in t&&(n.vao=t.vao),n}function r(e){var t={},n={};return Object.keys(e).forEach((function(r){var i=e[r];f.isDynamic(i)?n[r]=f.unbox(i,r):t[r]=i})),{dynamic:n,static:t}}var i=r(t.context||{}),a=r(t.uniforms||{}),o=r(t.attributes||{}),s=r(n(t)),c={gpuTime:0,cpuTime:0,count:0},u=M.compile(s,o,a,i,c),l=u.draw,p=u.batch,h=u.scope,d=[];function m(e){while(d.length<e)d.push(null);return d}function v(e,t){var n;if("function"===typeof e)return h.call(this,null,e,0);if("function"===typeof t)if("number"===typeof e)for(n=0;n<e;++n)h.call(this,null,t,n);else{if(!Array.isArray(e))return h.call(this,e,t,0);for(n=0;n<e.length;++n)h.call(this,e[n],t,n)}else if("number"===typeof e){if(e>0)return p.call(this,m(0|e),0|e)}else{if(!Array.isArray(e))return l.call(this,e);if(e.length)return p.call(this,e,e.length)}}return e(v,{stats:c})}F&&(F.addEventListener(ho,H,!1),F.addEventListener(mo,q,!1));var Q=D.setFBO=G({framebuffer:f.define.call(null,vo,"framebuffer")});function W(e,t){var n=0;M.procs.poll();var i=t.color;i&&(r.clearColor(+i[0]||0,+i[1]||0,+i[2]||0,+i[3]||0),n|=uo),"depth"in t&&(r.clearDepth(+t.depth),n|=fo),"stencil"in t&&(r.clearStencil(0|t.stencil),n|=lo),r.clear(n)}function X(t){if("framebuffer"in t)if(t.framebuffer&&"framebufferCube"===t.framebuffer_reglType)for(var n=0;n<6;++n)Q(e({framebuffer:t.framebuffer.faces[n]},t),W);else Q(t,W);else W(null,t)}function J(e){function t(){var t=yo(L,e);function n(){var e=yo(L,n);L[e]=L[L.length-1],L.length-=1,L.length<=0&&U()}L[t]=n}return L.push(e),V(),{cancel:t}}function Z(){var e=z.viewport,t=z.scissor_box;e[0]=e[1]=t[0]=t[1]=0,g.viewportWidth=g.framebufferWidth=g.drawingBufferWidth=e[2]=t[2]=r.drawingBufferWidth,g.viewportHeight=g.framebufferHeight=g.drawingBufferHeight=e[3]=t[3]=r.drawingBufferHeight}function $(){g.tick+=1,g.time=ee(),Z(),M.procs.poll()}function K(){Z(),M.procs.refresh(),u&&u.update()}function ee(){return(p()-d)/1e3}function te(e,t){var n;switch(e){case"frame":return J(t);case"lost":n=R;break;case"restore":n=j;break;case"destroy":n=B;break}return n.push(t),{cancel:function(){for(var e=0;e<n.length;++e)if(n[e]===t)return n[e]=n[n.length-1],void n.pop()}}}K();var ne=e(G,{clear:X,prop:f.define.bind(null,vo),context:f.define.bind(null,go),this:f.define.bind(null,bo),draw:G({}),buffer:function(e){return A.create(e,po,!1,!1)},elements:function(e){return C.create(e,!1)},texture:P.create2D,cube:P.createCube,renderbuffer:k.create,framebuffer:D.create,framebufferCube:D.createCube,vao:E.createVAO,attributes:i,frame:J,on:te,limits:_,hasExtension:function(e){return _.extensions.indexOf(e.toLowerCase())>=0},read:S,destroy:Y,_gl:r,_refresh:K,poll:function(){$(),u&&u.update()},now:ee,stats:s});return n.onDone(null,ne),ne}return wo}))}));function br(e,t,n="png"){let r,i;if("png"===n.toLowerCase()?(r="image/png",i="png"):"webp"===n.toLowerCase()?(r="image/webp",i="webp"):"gif"===n.toLowerCase()?(r="image/gif",i="gif"):(r="image/jpeg",i="jpg"),navigator.msSaveOrOpenBlob){const n=e.msToBlob(r,1);window.navigator.msSaveBlob(n,t+"."+i)}else{const n=e.toDataURL(r,1),a=document.createElement("a");a.download=t+"."+i,a.href=n,a.dataset.downloadurl=[r,a.download,a.href].join(":"),document.body.appendChild(a),a.click(),document.body.removeChild(a)}}function yr(e){function t(t){t.stopPropagation();const n=t.which;if(65===n)e.config.view.camera.autorotate=!e.config.view.camera.autorotate;else if(67===n){if(e.camera){const t=e.camera.toConfig();i.a.log(JSON.stringify({camera:t},null,2))}}else 68===n?console.log(JSON.stringify(e.simulation.dump(),null,2)):77===n?e.pathiclesRunner.toggleMode():84===n?e.config.view.showTextures=!e.config.view.showTextures:71===n?e.config.drawGrid=!e.config.drawGrid:83===n?br(e.regl._gl.canvas,"pathicles"+(e.presetName?"--"+e.presetName:"")):78===n?e.pathiclesRunner.next():76===n?e.pathiclesRunner.toggleLooping():32===n&&e.pathiclesRunner.toggleActivity();return!1}document.addEventListener("keydown",t,!1)}function wr(e,t="float"){if(!e.hasExtension(`oes_texture_${t.replace(" ","_")}`))return!1;try{e.framebuffer({colorType:t,colorFormat:"rgba",radius:1});const n=e.framebuffer({colorType:"uint8",colorFormat:"rgba",radius:1}),r=e({vert:"\n      precision highp float;\n      attribute vec2 aXY;\n      void main () {\n        gl_Position = vec4(aXY, 0, 1);\n        gl_PointSize = 1.0;\n      }",frag:"\n      precision highp float;\n      void main () {\n        gl_FragColor = vec4(1, 0, 0, 1);\n      }",primitive:"points",count:1,attributes:{aXY:[0,0]},depth:{enable:!1}}),i=e({vert:"\n      precision highp float;\n      attribute vec2 aXY;\n      void main () {\n        gl_Position = vec4(aXY, 0, 1);\n      }",frag:"\n      precision highp float;\n      void main () {\n        gl_FragColor = vec4(1, 0, 0, 1);\n      }",attributes:{aXY:[-4,-4,4,-4,0,4]},count:3,primitive:"triangles",depth:{enable:!1}});let a;return r(),n.use(()=>{i(),a=e.read()}),0!==a[0]&&0===a[1]&&0===a[2]&&0!==a[3]}catch(n){return!1}}const xr=new r("pathicles:log");class _r{constructor({canvas:e,config:t,pixelRatio:n,control:r,simulate:i=!0}){yr(this),this.config=t,this.simulate=i,this.control=r,o()({canvas:e,profile:this.config.profile,attributes:{preserveDrawingBuffer:!1,antialiasing:!0},pixelRatio:n,onDone:(e,t)=>{if(e)return console.error(e);try{this.regl=t,wn.start("canWriteToFBOOfType"),xr("canWriteToFBOOfType: "+wr(t,"float")),wn.stop(),window.pathicles=this,wn.start("init"),this.init(t),wn.stop(),this.run(t)}catch(n){console.error(n),xr(n)}},extensions:["angle_instanced_arrays","oes_texture_float","OES_standard_derivatives"]})}destroy(){this.regl.destroy()}loadConfig(e){this.stop(this.regl),this.config=e,this.init(this.regl),this.run(this.regl)}init(e){this.regl._commands=[],this.cameras=[],this.setCameraUniforms=[],[this.cameras["free"],this.setCameraUniforms["free"]]=Dt({...this.config.view.camera},e),this.camera=this.cameras["free"],wn.start("init.simulation"),this.simulation=new bn(e,{...this.config}),wn.stop(),wn.start("init.view"),this.view=Un(e,{variables:this.simulation.variables,model:this.simulation.model,config:this.config}),wn.stop(),wn.start("init.runner"),this.pathiclesRunner=new An(this.simulation,{...this.config.runner,simulate:this.simulate}),wn.stop()}run(e){xr("run"),this.simulate&&this.pathiclesRunner.start();const t=()=>e.frame(()=>{this.simulate&&this.pathiclesRunner.next(),this.setCameraUniforms[this.control.cameraMode]({...this.cameras[this.control.cameraMode]},()=>{this.cameras["free"].tick({}),this.view.drawDiffuse({viewRange:[0,1]}),this.config.view.showTextures&&(this.simulation.drawVariableTexture({variableName:"position"}),this.simulation.drawVariableTexture({variableName:"velocity"}))})});this.loop=t()}stop(){this.loop.cancel()}}}).call(this,n("b8a8"))}});