var e=Object.defineProperty,t=Object.defineProperties,n=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,o=(t,n,r)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r,s=(e,t)=>{for(var n in t||(t={}))i.call(t,n)&&o(e,n,t[n]);if(r)for(var n of r(t))a.call(t,n)&&o(e,n,t[n]);return e},l=(e,r)=>t(e,n(r));import{c,o as u,a as f,d as h,u as p,r as d,b as m,e as g,f as v,w as b,g as y,F as x,h as w,i as _,t as A,j as S,k as T,v as E,l as C,m as M}from"./vendor.8ddcd81f.js";var P="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},O={exports:{}},D=O.exports=function(){var e="function"==typeof Promise,t="object"==typeof self?self:P,n="undefined"!=typeof Symbol,r="undefined"!=typeof Map,i="undefined"!=typeof Set,a="undefined"!=typeof WeakMap,o="undefined"!=typeof WeakSet,s="undefined"!=typeof DataView,l=n&&void 0!==Symbol.iterator,c=n&&void 0!==Symbol.toStringTag,u=i&&"function"==typeof Set.prototype.entries,f=r&&"function"==typeof Map.prototype.entries,h=u&&Object.getPrototypeOf((new Set).entries()),p=f&&Object.getPrototypeOf((new Map).entries()),d=l&&"function"==typeof Array.prototype[Symbol.iterator],m=d&&Object.getPrototypeOf([][Symbol.iterator]()),g=l&&"function"==typeof String.prototype[Symbol.iterator],v=g&&Object.getPrototypeOf(""[Symbol.iterator]()),b=8,y=-1;function x(n){var l=typeof n;if("object"!==l)return l;if(null===n)return"null";if(n===t)return"global";if(Array.isArray(n)&&(!1===c||!(Symbol.toStringTag in n)))return"Array";if("object"==typeof window&&null!==window){if("object"==typeof window.location&&n===window.location)return"Location";if("object"==typeof window.document&&n===window.document)return"Document";if("object"==typeof window.navigator){if("object"==typeof window.navigator.mimeTypes&&n===window.navigator.mimeTypes)return"MimeTypeArray";if("object"==typeof window.navigator.plugins&&n===window.navigator.plugins)return"PluginArray"}if(("function"==typeof window.HTMLElement||"object"==typeof window.HTMLElement)&&n instanceof window.HTMLElement){if("BLOCKQUOTE"===n.tagName)return"HTMLQuoteElement";if("TD"===n.tagName)return"HTMLTableDataCellElement";if("TH"===n.tagName)return"HTMLTableHeaderCellElement"}}var u=c&&n[Symbol.toStringTag];if("string"==typeof u)return u;var f=Object.getPrototypeOf(n);return f===RegExp.prototype?"RegExp":f===Date.prototype?"Date":e&&f===Promise.prototype?"Promise":i&&f===Set.prototype?"Set":r&&f===Map.prototype?"Map":o&&f===WeakSet.prototype?"WeakSet":a&&f===WeakMap.prototype?"WeakMap":s&&f===DataView.prototype?"DataView":r&&f===p?"Map Iterator":i&&f===h?"Set Iterator":d&&f===m?"Array Iterator":g&&f===v?"String Iterator":null===f?"Object":Object.prototype.toString.call(n).slice(b,y)}return x}();const I="undefined"!=typeof Buffer,L=I&&void 0!==Buffer.from,k=I?function(e){return Buffer.isBuffer(e)}:function(){return!1},z=L?function(e){return Buffer.from(e)}:I?function(e){return new Buffer(e)}:function(e){return e};function R(e){return k(e)?"Buffer":D(e)}const F=new Set(["Arguments","Array","Map","Object","Set"]);function B(e,t,n=null){switch(n||R(e)){case"Arguments":case"Array":case"Object":return e[t];case"Map":return e.get(t);case"Set":return t}}function j(e){return F.has(e)}function N(e,t,n,r=null){switch(r||R(e)){case"Arguments":case"Array":case"Object":e[t]=n;break;case"Map":e.set(t,n);break;case"Set":e.add(n)}return e}const W="undefined"!=typeof globalThis&&null!==globalThis&&globalThis.Object===Object&&globalThis,V="undefined"!=typeof global&&null!==global&&global.Object===Object&&global,U="undefined"!=typeof self&&null!==self&&self.Object===Object&&self,H=W||V||U||Function("return this")();function Y(e,t){return H[t].from?H[t].from(e):new H[t](e)}function X(e){return e}function G(){return[]}var q=new Map([["ArrayBuffer",function(e){return e.slice(0)}],["Boolean",function(e){return new Boolean(e.valueOf())}],["Buffer",function(e){return z(e)}],["DataView",function(e){return new DataView(e.buffer)}],["Date",function(e){return new Date(e.getTime())}],["Number",function(e){return new Number(e)}],["RegExp",function(e){return new RegExp(e.source,e.flags)}],["String",function(e){return new String(e)}],["Float32Array",Y],["Float64Array",Y],["Int16Array",Y],["Int32Array",Y],["Int8Array",Y],["Uint16Array",Y],["Uint32Array",Y],["Uint8Array",Y],["Uint8ClampedArray",Y],["Array Iterator",X],["Map Iterator",X],["Promise",X],["Set Iterator",X],["String Iterator",X],["function",X],["global",X],["WeakMap",X],["WeakSet",X],["boolean",X],["null",X],["number",X],["string",X],["symbol",X],["undefined",X],["Arguments",G],["Array",G],["Map",function(){return new Map}],["Object",function(){return{}}],["Set",function(){return new Set}]]);function Z(){}function Q(e,t=null,n=Z){2===arguments.length&&"function"==typeof t&&(n=t,t=null);const r=t||R(e),i=q.get(r);if("Object"===r){const t=n(e,r);if(void 0!==t)return t}return i?i(e,r):e}function $(e,t={}){"function"==typeof t&&(t={customizer:t});const{customizer:n}=t,r=R(e);if(!j(r))return J(e,null,null,null);const i=Q(e,r,n);return J(e,i,new WeakMap([[e,i]]),new WeakSet([e]))}function J(e,t,n,r,i){const a=R(e),o=Q(e,a);if(!j(a))return o;let s;switch(a){case"Arguments":case"Array":s=Object.keys(e);break;case"Object":s=Object.keys(e),s.push(...Object.getOwnPropertySymbols(e));break;case"Map":case"Set":s=e.keys()}for(let l of s){const i=B(e,l,a);if(r.has(i))N(t,l,n.get(i),a);else{const e=R(i),o=Q(i,e);j(e)&&(n.set(i,o),r.add(i)),N(t,l,J(i,o,n,r),a)}}return t}const K="nobreak",ee="DRIF",te="SBEN",ne="QUAD",re="ESTA";var ie={name:"default",debug:{logPushing:!1,logPerformance:!1,showTextures:!1,showTextureScale:1},runner:{pusher:"glsl",factor:1,enabled:!0,packFloat2UInt8:!1,prerender:!1,loops:0,mode:K,snapshotsPerTick:2,iterationsPerSnapshot:8,iterationCount:1023,iterationDurationOverC:.02,snapshotCount:128},model:{boundingBoxSize:0,emitter:{particleType:"ELECTRON",bunchShape:"SPIRAL_XY",particleCount:128,particleSeparation:.05,gamma:()=>2.25,positionJitter:[0,0,0]},interactions:{particleInteraction:!1,electricField:[0,0,0],magneticField:[0,0,0]},lattice:{elements:{},beamline:[],origin:{phi:0,position:[0,0,0]}}},view:{lights:[{position:[0,5,0],near:-5,far:10,size:9}],ambientLightAmount:.5,diffuseLightAmount:.5,stageGrid:{y:0,size:10},rgbGamma:1,isStageVisible:!0,isShadowEnabled:!0,isLatticeVisible:!0,isFieldVisible:!0,pathicleRelativeGap:3,pathicleRelativeHeight:5,pathicleWidth:.0015,showAxes:!0,showVignette:!0,viewRange:[0,1],camera:{center:[0,0,0],distance:2,phi:15/360*2*Math.PI,theta:.25*Math.PI,fovY:5*Math.PI/36,autorotate:!1,autorotateDistance:.2*Math.PI,autorotateSpeedTheta:.2*Math.PI,autorotateSpeedPhi:.2*Math.PI,zoomDecayTime:1,far:200,near:1e-4,minDistance:.1,maxDistance:20}}},ae={name:"spiral",view:{camera:{center:[0,1.5,0],distance:5,theta:Math.PI/180*90,phi:Math.PI/180*1}},runner:{iterationDurationOverC:.1,iterationsPerSnapshot:1,iterationCount:255,snapshotCount:256},model:{emitter:{bunchShape:"SPIRAL_XY",direction:[0,.2,1],gamma:5},interactions:{magneticField:[0,.01,0],particleInteraction:!1},lattice:{beamline:[],origin:{phi:0,position:[0,0,0]}}}},oe={name:"csr",view:{camera:{center:[0,1,0],distance:15,phi:15/360*2*Math.PI,theta:.5*Math.PI}},runner:{prerender:!1,loops:0,mode:K,iterationsPerSnapshot:8,iterationDurationOverC:.01,snapshotCount:32,iterationCount:2047},model:{emitter:{particleType:"ELECTRON",bunchShape:"SPIRAL_XY",gamma:2.5},interactions:{magneticField:[0,0,0],particleInteraction:!1},lattice:{elements:{l0:{type:ee,l:1.43},l1:{type:ee,l:1},l2:{type:ee,l:.35},q1:{type:ne,k1:2.87506832355,l:.25},q2:{type:ne,k1:-6.31393492954,l:.25},q3:{type:ne,k1:4.36962492724,l:.25},q4:{type:ne,k1:5.5089117863,l:.25},d1:{type:te,l:1,strength:.0021,angle:-2*Math.PI/360*45},bm:{type:te,angle:.78539816,e1:.39269908,e2:.39269908,l:1.8,strength:1e-4}},beamline:["l1","d1","l1","d1","l1","d1","l1","d1","l1","d1","l1","d1","l1","d1","l1","d1"],origin:{phi:0,position:[-.5,1,-.5]}}}},se={name:"story-dipole",view:{camera:{center:[0,1,0],distance:7,theta:0*Math.PI,phi:10/360*2*Math.PI}},runner:{prerender:!1,packFloat2UInt8:!1},model:{emitter:{particleType:"ELECTRON"},lattice:{elements:{l1:{type:ee,l:4.5},d1:{type:te,l:1,strength:75e-5,angle:2*Math.PI/360*0}},beamline:["l1","d1"],origin:{phi:0*Math.PI,position:[0,1,-5]}}}},le={name:"pathicles-logo",view:{camera:{center:[.1,1.6,0],theta:-.2,phi:-.2,distance:1}},model:{emitter:{particleType:"ELECTRON PHOTON PROTON",bunchShape:"SQUARE_XY",position:[0,1.5,-10],direction:[0,0,1]},lattice:{},beamline:[],origin:{phi:0*Math.PI,position:[0,1,-10]}}},ce={name:"story-electric",view:{camera:{center:[0,1,0],distance:5,theta:.25*Math.PI,phi:10/360*2*Math.PI}},model:{emitter:{particleType:"ELECTRON PHOTON PROTON",gamma:()=>1.5},lattice:{elements:{l:{type:ee,l:4.75},e:{type:re,l:.5,strength:-1e10}},beamline:["l","e","l"],origin:{phi:0,position:[0,1,-5]}}}};var ue={name:"story-quadrupole",view:{camera:{center:[0,1,0],distance:7,theta:55/360*2*Math.PI,phi:10/360*2*Math.PI}},model:{emitter:{bunchShape:"SPIRAL_XY",particleType:"PROTON",gamma:6},lattice:{elements:{q1:{type:ne,strength:4,l:.5},q2:{type:ne,strength:-4,l:.5},l_5:{type:ee,l:5},l_20:{type:ee,l:20},l_1:{type:ee,l:1}},beamline:["l_1","q1","l_1","q2","l_1","q1","l_1","q2","l_1","q1","l_1","q2","l_1"],origin:{phi:0,position:[0,1,-5]}}}};let fe=1;const he=(e=-1,t=1)=>(()=>{let e=1e4*Math.sin(fe++);return e-Math.floor(e)})()*(t-e)+e;var pe={name:"random",view:{camera:{center:[0,.5,0],distance:8,theta:Math.PI/180*45,phi:Math.PI/180*5}},runner:{prerender:!0,loops:2,iterationsPerSnapshot:1,iterationCount:128,snapshotCount:16,iterationDurationOverC:.1},model:{boundingBoxSize:1,boundingBoxCenter:[0,1,0],emitter:{position:[0,.5,0],direction:()=>[he(),he(),he()],particleSeparation:.1,gamma:10,bunchShape:"SQUARE_YZ",particleCount:512,particleType:"PHOTON ELECTRON PROTON"}}},de={name:"free-electron",runner:{prerender:!0,mode:K,packFloat2UInt8:!0,loops:0,iterationsPerSnapshot:1,iterationCount:10,snapshotCount:11,iterationDurationOverC:.1},model:{emitter:{gamma:1.1,particleCount:1,particleType:"ELECTRON"},lattice:{origin:{position:[0,ie.view.pathicleWidth*ie.view.pathicleRelativeHeight,0]}}}},me={name:"free-electrons",view:{camera:{center:[0,1,0],theta:.001,phi:.001,distance:8.75}},runner:{prerender:!0,mode:K,packFloat2UInt8:!1,loops:0,iterationsPerSnapshot:1,iterationCount:100,snapshotCount:11,iterationDurationOverC:.1},model:{emitter:{particleType:"ELECTRON"},lattice:{elements:{},beamline:[],origin:{phi:0,position:[0,1,-5]}}}},ge={name:"different-gammas",view:{pathicleRelativeGap:1,pathicleRelativeHeight:3,pathicleWidth:.005,camera:{center:[0,.5,-.8],distance:4,theta:Math.PI/180*0,phi:Math.PI/180*20}},runner:{prerender:!0,mode:K,loops:0,iterationsPerSnapshot:1,iterationCount:10,snapshotCount:11,iterationDurationOverC:.1},debug:{logPushing:!1},model:{emitter:{particleCount:60,particleSeparation:0,particleType:"PHOTON ELECTRON PROTON",bunchShape:"ROW_X",direction:[0,0,-1],position:({p:e})=>[(Math.floor(e/3)-10)/10+e%3*.025,ie.view.pathicleWidth*ie.view.pathicleRelativeHeight/2*2,0],directionJitter:[0,0,0],positionJitter:[0,0,0],gamma:({p:e})=>1+Math.floor(e/3)/50}}},ve={name:"different-gammas-E-1e-10",view:{pathicleRelativeGap:1,pathicleRelativeHeight:3,pathicleWidth:.005,camera:{center:[0,.5,-.8],distance:4,theta:Math.PI/180*0,phi:Math.PI/180*20}},runner:{prerender:!0,mode:K,loops:0,iterationsPerSnapshot:1,iterationCount:10,snapshotCount:11,iterationDurationOverC:.1},debug:{logPushing:!1},model:{emitter:{particleCount:60,particleSeparation:0,particleType:"PHOTON ELECTRON PROTON",bunchShape:"ROW_X",direction:[0,0,-1],position:({p:e})=>[(Math.floor(e/3)-10)/10+e%3*.025,ie.view.pathicleWidth*ie.view.pathicleRelativeHeight/2*2,0],directionJitter:[0,0,0],positionJitter:[0,0,0],gamma:({p:e})=>1+Math.floor(e/3)/50},interactions:{electricField:[0,0,-1e-10],particleInteraction:!1,magneticField:[0,0,0]}}},be={name:"different-gammas-E-1e-11",view:{pathicleRelativeGap:1,pathicleRelativeHeight:3,pathicleWidth:.005,camera:{center:[0,.5,-.8],distance:4,theta:Math.PI/180*0,phi:Math.PI/180*20}},runner:{prerender:!0,mode:K,loops:0,iterationsPerSnapshot:1,iterationCount:10,snapshotCount:11,iterationDurationOverC:.1},debug:{logPushing:!1},model:{emitter:{particleCount:60,particleSeparation:0,particleType:"PHOTON ELECTRON PROTON",bunchShape:"ROW_X",direction:[0,0,-1],position:({p:e})=>[(Math.floor(e/3)-10)/10+e%3*.025,ie.view.pathicleWidth*ie.view.pathicleRelativeHeight/2*2,0],directionJitter:[0,0,0],positionJitter:[0,0,0],gamma:({p:e})=>1+Math.floor(e/3)/50},interactions:{electricField:[0,0,-1e-11]}}},ye={name:"different-gammas-E-1e-12",view:{pathicleRelativeGap:1,pathicleRelativeHeight:3,pathicleWidth:.005,camera:{center:[0,.5,-.8],distance:4,theta:Math.PI/180*0,phi:Math.PI/180*20}},runner:{prerender:!0,mode:K,loops:0,iterationsPerSnapshot:1,iterationCount:10,snapshotCount:11,iterationDurationOverC:.1},debug:{logPushing:!1},model:{emitter:{particleCount:60,particleSeparation:0,particleType:"PHOTON ELECTRON PROTON",bunchShape:"ROW_X",direction:[0,0,-1],position:({p:e})=>[(Math.floor(e/3)-10)/10+e%3*.025,ie.view.pathicleWidth*ie.view.pathicleRelativeHeight/2*2,0],directionJitter:[0,0,0],positionJitter:[0,0,0],gamma:({p:e})=>1+Math.floor(e/3)/50},interactions:{electricField:[0,0,-1e-12],particleInteraction:!1,magneticField:[0,0,0]}}},xe={name:"free-photon",view:{camera:{center:[0,0,.5],distance:2,phi:5/360*2*Math.PI,theta:.25*Math.PI}},debug:{logPushing:!1},runner:{prerender:!0,packFloat2UInt8:!0,iterationsPerSnapshot:1,iterationCount:10,snapshotCount:11,iterationDurationOverC:.1},model:{emitter:{gamma:1.1,particleCount:1,bunchShape:"ROW_X",particleType:"PHOTON",positionJitter:[0,0,0]},lattice:{origin:{position:[0,ie.view.pathicleWidth*ie.view.pathicleRelativeHeight,0]}}}},we={name:"free-photons",view:{camera:{center:[0,.5,2],phi:0*Math.PI,theta:15/360*2*Math.PI}},runner:{packFloat2UInt8:!1,prerender:!0},model:{emitter:{particleType:"PHOTON",bunchShape:"SPIRAL_XY",position:[0,.5,-10],gamma:1}}};var _e={name:"gyrotest-1-electron",view:{camera:{center:[0,.1,0],distance:3,theta:Math.PI/180*90,phi:Math.PI/180*0}},runner:{prerender:!0,loops:0,mode:K,iterationsPerSnapshot:1,iterationCount:void 0,snapshotCount:16,iterationDurationOverC:.1},model:{emitter:{particleCount:1,particleType:"ELECTRON",bunchShape:"COLUMN",direction:[0,0,1],position:[0,ie.view.pathicleWidth*ie.view.pathicleRelativeHeight*2+.02,0],directionJitter:[0,0,0],positionJitter:[0,0,0],gamma:1.1},interactions:{particleInteraction:!1,electricField:[0,0,0],magneticField:[0,4e-4,0]}}},Ae={name:"gyrotest-128-electrons",view:{camera:{center:[1,2,0],distance:15,theta:Math.PI/180*-90,phi:Math.PI/180*5}},debug:{logPushing:!1},runner:{prerender:!0,loops:0,mode:K,iterationsPerSnapshot:1,iterationCount:511,snapshotCount:512,iterationDurationOverC:.05},model:{emitter:{particleCount:128,particleSeparation:.05,particleType:"ELECTRON",bunchShape:"ROW_Y",gamma:({p:e})=>Math.log10(1*e+1)},interactions:{particleInteraction:!1,electricField:[0,0,0],magneticField:[0,5e-4,0]},lattice:{origin:{phi:0,position:[0,ie.view.pathicleWidth*ie.view.pathicleRelativeHeight*2,0]}}}};const Se=(...e)=>{let t={},n=e=>{for(let n in e)e.hasOwnProperty(n)&&("[object Object]"===Object.prototype.toString.call(e[n])?t[n]=Se(t[n],e[n]):t[n]=e[n])};for(let r=0;r<e.length;r++)n(e[r]);return t},Te=e=>{let t=$(e);return t.name=t.name+"-uint8",t.runner||(t.runner={}),t.runner.packFloat2UInt8=!0,t},Ee={[oe.name]:oe,[ge.name]:ge,[ve.name]:ve,[be.name]:be,[ye.name]:ye,[de.name]:de,[me.name]:me,[xe.name]:xe,[we.name]:we,[_e.name]:_e,[Ae.name]:Ae,[le.name]:le,[pe.name]:pe,[ae.name]:ae,[se.name]:se,[se.name]:se,[ce.name]:ce,[ue.name]:ue};for(let co=0;co<11;co++)for(let e=0;e<11;e++){let t=$(pe);t.name=`random__${Math.pow(2,co)}__${Math.pow(2,e)}`,t.model.emitter.particleCount=Math.pow(2,co),t.runner.snapshotCount=Math.pow(2,e),t.runner.iterations=Math.pow(2,e)-1,Ee[t.name]=t}Object.keys(Ee).forEach((e=>{const t=Ee[e];Ee[Te(t).name]=Te(t)}));const Ce=e=>Se(!0,ie,Ee[e])||ie;new Map([{name:"PHOTON",mass__eVc_2:0,charge__qe:0,chargeMassRatio__Ckg_1:0,id:0,color:[235,192,0]},{name:"ELECTRON",mass__eVc_2:510998.9461,chargeMassRatio__Ckg_1:-175882001076,charge__qe:-1,id:1,color:[31,115,166]},{name:"POSITRON",mass__eVc_2:510998.9461,chargeMassRatio__Ckg_1:175882001076,charge__qe:1,id:2,color:[166,115,166]},{name:"PROTON",mass__eVc_2:938272081,charge__qe:1,chargeMassRatio__Ckg_1:95788331.56,id:3,color:[197,50,51]}].map((e=>[e.name,e])));"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var Me=function(e,t,n){var r=t[0],i=t[1],a=t[2],o=n[3]*r+n[7]*i+n[11]*a+n[15];return o=o||1,e[0]=(n[0]*r+n[4]*i+n[8]*a+n[12])/o,e[1]=(n[1]*r+n[5]*i+n[9]*a+n[13])/o,e[2]=(n[2]*r+n[6]*i+n[10]*a+n[14])/o,e};var Pe=function(e,t,n,r){var i=n[0],a=n[2],o=t[0]-i,s=t[2]-a,l=Math.sin(r),c=Math.cos(r);return e[0]=i+s*l+o*c,e[1]=t[1],e[2]=a+s*c-o*l,e};var Oe=function(e,t,n,r){var i=n[1],a=n[2],o=t[1]-i,s=t[2]-a,l=Math.sin(r),c=Math.cos(r);return e[0]=t[0],e[1]=i+o*c-s*l,e[2]=a+o*l+s*c,e};var De=function(e,t){var n=e[0],r=e[1],i=e[2],a=t[0],o=t[1],s=t[2];return Math.abs(n-a)<=1e-6*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(r-o)<=1e-6*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-s)<=1e-6*Math.max(1,Math.abs(i),Math.abs(s))};var Ie=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e};var Le=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e};var ke=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e};var ze=function(e,t){var n=t[0],r=t[1],i=t[2],a=n*n+r*r+i*i;a>0&&(a=1/Math.sqrt(a),e[0]=t[0]*a,e[1]=t[1]*a,e[2]=t[2]*a);return e};var Re=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e};var Fe=function(e,t){var n=t[0],r=t[1],i=t[2],a=t[3],o=t[4],s=t[5],l=t[6],c=t[7],u=t[8],f=t[9],h=t[10],p=t[11],d=t[12],m=t[13],g=t[14],v=t[15],b=n*s-r*o,y=n*l-i*o,x=n*c-a*o,w=r*l-i*s,_=r*c-a*s,A=i*c-a*l,S=u*m-f*d,T=u*g-h*d,E=u*v-p*d,C=f*g-h*m,M=f*v-p*m,P=h*v-p*g,O=b*P-y*M+x*C+w*E-_*T+A*S;if(!O)return null;return O=1/O,e[0]=(s*P-l*M+c*C)*O,e[1]=(i*M-r*P-a*C)*O,e[2]=(m*A-g*_+v*w)*O,e[3]=(h*_-f*A-p*w)*O,e[4]=(l*E-o*P-c*T)*O,e[5]=(n*P-i*E+a*T)*O,e[6]=(g*x-d*A-v*y)*O,e[7]=(u*A-h*x+p*y)*O,e[8]=(o*M-s*E+c*S)*O,e[9]=(r*E-n*M-a*S)*O,e[10]=(d*_-m*x+v*b)*O,e[11]=(f*x-u*_-p*b)*O,e[12]=(s*T-o*C-l*S)*O,e[13]=(n*C-r*T+i*S)*O,e[14]=(m*y-d*w-g*b)*O,e[15]=(u*w-f*y+h*b)*O,e};var Be=function(e,t,n){var r,i,a,o,s,l,c,u,f,h,p,d,m=n[0],g=n[1],v=n[2];t===e?(e[12]=t[0]*m+t[4]*g+t[8]*v+t[12],e[13]=t[1]*m+t[5]*g+t[9]*v+t[13],e[14]=t[2]*m+t[6]*g+t[10]*v+t[14],e[15]=t[3]*m+t[7]*g+t[11]*v+t[15]):(r=t[0],i=t[1],a=t[2],o=t[3],s=t[4],l=t[5],c=t[6],u=t[7],f=t[8],h=t[9],p=t[10],d=t[11],e[0]=r,e[1]=i,e[2]=a,e[3]=o,e[4]=s,e[5]=l,e[6]=c,e[7]=u,e[8]=f,e[9]=h,e[10]=p,e[11]=d,e[12]=r*m+s*g+f*v+t[12],e[13]=i*m+l*g+h*v+t[13],e[14]=a*m+c*g+p*v+t[14],e[15]=o*m+u*g+d*v+t[15]);return e};var je=function(e,t,n){var r=n[0],i=n[1],a=n[2];return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*a,e[9]=t[9]*a,e[10]=t[10]*a,e[11]=t[11]*a,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e};var Ne=Re,We=function(e,t,n,r){var i,a,o,s,l,c,u,f,h,p,d=t[0],m=t[1],g=t[2],v=r[0],b=r[1],y=r[2],x=n[0],w=n[1],_=n[2];if(Math.abs(d-x)<1e-6&&Math.abs(m-w)<1e-6&&Math.abs(g-_)<1e-6)return Ne(e);u=d-x,f=m-w,h=g-_,p=1/Math.sqrt(u*u+f*f+h*h),i=b*(h*=p)-y*(f*=p),a=y*(u*=p)-v*h,o=v*f-b*u,(p=Math.sqrt(i*i+a*a+o*o))?(i*=p=1/p,a*=p,o*=p):(i=0,a=0,o=0);s=f*o-h*a,l=h*i-u*o,c=u*a-f*i,(p=Math.sqrt(s*s+l*l+c*c))?(s*=p=1/p,l*=p,c*=p):(s=0,l=0,c=0);return e[0]=i,e[1]=s,e[2]=u,e[3]=0,e[4]=a,e[5]=l,e[6]=f,e[7]=0,e[8]=o,e[9]=c,e[10]=h,e[11]=0,e[12]=-(i*d+a*m+o*g),e[13]=-(s*d+l*m+c*g),e[14]=-(u*d+f*m+h*g),e[15]=1,e};var Ve=function(e,t,n,r,i){var a=1/Math.tan(t/2),o=1/(r-i);return e[0]=a/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(i+r)*o,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*i*r*o,e[15]=0,e};function Ue(e){var t=!0,n={aspectRatio:(e=e||{}).aspectRatio?e.aspectRatio:1,zoomAboutCursor:void 0===e.zoomAboutCursor||e.zoomAboutCursor,distance:void 0===e.distance?10:e.distance,phi:void 0===e.phi?0:e.phi,theta:void 0===e.theta?0:e.theta,fovY:void 0===e.fovY?Math.PI/4:e.fovY,near:void 0===e.near?.1:e.near,far:void 0===e.far?100:e.far,panDecayTime:e.panDecayTime||100,zoomDecayTime:e.zoomDecayTime||100,rotationDecayTime:e.rotationDecayTime||100,dirty:!0,up:e.up||new Float32Array([0,1,0]),center:e.center||new Float32Array(3),rotationCenter:e.rotationCenter||e.center&&e.center.slice()||new Float32Array(3),zoom:0,panX:0,panY:0,panZ:0,pitch:0,yaw:0,dTheta:0,dPhi:0,mouseX:0,mouseY:0},r=null,i={tick:function(e){if(b.zoom&&(n.zoom=b.zoom),b.dTheta&&(n.dTheta=b.dTheta),b.dPhi&&(n.dPhi=b.dPhi),b.panX&&(n.panX=b.panX),b.panY&&(n.panY=b.panY),b.panZ&&(n.panZ=b.panZ),b.yaw&&(n.yaw=b.yaw),b.pitch&&(n.pitch=b.pitch),v(b),e){var a=n.dPhi,o=n.dTheta,s=n.zoom,l=n.panX,c=n.panY,u=n.panZ,d=n.pitch,m=n.yaw;Object.assign(n,e),void 0!==e.dPhi&&(n.dPhi+=a),void 0!==e.dTheta&&(n.dTheta+=o),void 0!==e.zoom&&(n.zoom+=s),void 0!==e.panX&&(n.panX+=l),void 0!==e.panY&&(n.panY+=c),void 0!==e.panZ&&(n.panZ+=u),void 0!==e.pitch&&(n.pitch+=d),void 0!==e.yaw&&(n.yaw+=m)}De(n.up,f.up)&&De(n.center,f.center)&&n.near===f.near&&n.far===f.far&&n.phi===f.phi&&n.theta===f.theta&&n.distance===f.distance&&n.fovY===f.fovY||(p.dPhi=n.phi-f.phi,p.dTheta=n.theta-f.theta,p.zoom=n.distance/f.distance-1,n.theta=f.theta,n.distance=f.distance,n.phi=f.phi,p.yaw=0,p.pitch=0,p.panX=0,p.panY=0,p.panZ=0,p.mouseX=0,p.mouseY=0,y(p)),!function(){if(Math.abs(n.zoom)>1e-4)return!0;if(Math.abs(n.panX)>1e-4)return!0;if(Math.abs(n.panY)>1e-4)return!0;if(Math.abs(n.panZ)>1e-4)return!0;if(Math.abs(n.dTheta)>1e-4)return!0;if(Math.abs(n.dPhi)>1e-4)return!0;if(Math.abs(n.yaw)>1e-4)return!0;if(Math.abs(n.pitch)>1e-4)return!0}()?v(n):y(n);var g,x,w,_,A=Date.now();null!==r&&(g=A-r,x=n.panDecayTime?Math.exp(-g/n.panDecayTime/Math.LN2):0,w=n.zoomDecayTime?Math.exp(-g/n.zoomDecayTime/Math.LN2):0,_=n.rotationDecayTime?Math.exp(-g/n.rotationDecayTime/Math.LN2):0,n.zoom*=w,n.panX*=x,n.panY*=x,n.panZ*=x,n.dTheta*=_,n.dPhi*=_,n.yaw*=_,n.pitch*=_),r=A,i.state.dirty=t,t=!1,h()},taint:m,resize:g,params:n,rotate:function(e,t){b.dTheta+=e,b.dPhi+=t},pivot:function(e,t){var r=i.params.fovY;b.yaw+=e*r*n.aspectRatio,b.pitch+=t*r},pan:function(e,t){var r=i.params.distance*Math.tan(.5*i.params.fovY)*2;return b.panX+=e*n.aspectRatio*r,b.panY+=t*r,i},zoom:function(e,t,r){return b.zoom+=r,n.mouseX=e,n.mouseY=t,i},state:{}};i.state.projection=new Float32Array(16),i.state.viewInv=new Float32Array(16),i.state.view=new Float32Array(16),i.state.width=null,i.state.height=null,i.state.eye=new Float32Array(3);var a=new Float32Array(3),o=new Float32Array(3),s=new Float32Array(3),l=new Float32Array(3),c=new Float32Array(3),u=new Float32Array(16),f={up:new Float32Array(3),center:new Float32Array(3)};function h(){ke(f.up,n.up),ke(f.center,n.center),f.near=n.near,f.far=n.far,f.distance=n.distance,f.phi=n.phi,f.theta=n.theta,f.fovY=n.fovY}h();var p={};function d(){i.state.eye[0]=0,i.state.eye[1]=0,i.state.eye[2]=n.distance,Oe(i.state.eye,i.state.eye,c,-n.phi),Pe(i.state.eye,i.state.eye,c,n.theta),Ie(i.state.eye,i.state.eye,n.center),We(i.state.view,i.state.eye,n.center,n.up),Ve(i.state.projection,n.fovY,i.params.aspectRatio,n.near,n.far),Fe(i.state.viewInv,i.state.view)}function m(){t=!0}function g(e){i.params.aspectRatio=e,d(),m()}function v(e){e.zoom=0,e.dTheta=0,e.dPhi=0,e.panX=0,e.panY=0,e.panZ=0,e.yaw=0,e.pitch=0}var b={};function y(e){var t;Re(u),n.zoomAboutCursor&&(t=n.distance*Math.tan(.5*n.fovY),a[0]=e.mouseX*n.aspectRatio*t,a[1]=e.mouseY*t,a[2]=0,Be(u,u,a)),a[0]=1+e.zoom,a[1]=1+e.zoom,a[2]=1,je(u,u,a),n.zoomAboutCursor&&(t=n.distance*Math.tan(.5*n.fovY),a[0]=-e.mouseX*n.aspectRatio*t,a[1]=-e.mouseY*t,a[2]=0,Be(u,u,a)),u[12]-=.5*e.panX,u[13]-=.5*e.panY,Me(n.center,n.center,i.state.view),Me(n.center,n.center,u),Me(n.center,n.center,i.state.viewInv),n.rotateAboutCenter&&ke(n.rotationCenter,n.center),n.distance*=1+e.zoom;var r=n.phi;n.phi+=e.dPhi,n.phi=Math.min(Infinity,Math.max(-(1/0),n.phi));var c=n.phi-r,f=n.theta;n.theta+=e.dTheta;var h=n.theta-f;if(Pe(n.center,n.center,n.rotationCenter,h-n.theta),Oe(n.center,n.center,n.rotationCenter,-c),Pe(n.center,n.center,n.rotationCenter,n.theta),0!==e.yaw||0!==e.pitch){s[0]=i.state.view[0],s[1]=i.state.view[4],s[2]=i.state.view[8],ze(s,s),o[0]=i.state.view[1],o[1]=i.state.view[5],o[2]=i.state.view[9],ze(o,o),l[0]=i.state.view[2],l[1]=i.state.view[6],l[2]=i.state.view[10],ze(l,l);var p=Math.min(Infinity,Math.max(-(1/0),n.phi+.5*e.pitch)),g=p-n.phi;Le(n.center,n.center,s,-Math.sin(.5*e.yaw)*n.distance),Le(n.center,n.center,o,-Math.sin(g)*n.distance),Le(n.center,n.center,l,(2-Math.cos(.5*e.yaw)-Math.cos(g))*n.distance),n.phi=p,n.theta+=.5*e.yaw}d(),m()}return v(b),g(i.params.aspectRatio),i}var He={};function Ye(e){return e.target||e.srcElement||window}He.buttons=function(e){if("object"==typeof e){if("buttons"in e)return e.buttons;if("which"in e){if(2===(t=e.which))return 4;if(3===t)return 2;if(t>0)return 1<<t-1}else if("button"in e){var t;if(1===(t=e.button))return 4;if(2===t)return 2;if(t>=0)return 1<<t}}return 0},He.element=Ye,He.x=function(e){if("object"==typeof e){if("offsetX"in e)return e.offsetX;var t=Ye(e).getBoundingClientRect();return e.clientX-t.left}return 0},He.y=function(e){if("object"==typeof e){if("offsetY"in e)return e.offsetY;var t=Ye(e).getBoundingClientRect();return e.clientY-t.top}return 0};var Xe=function(e,t){t||(t=e,e=window);var n=0,r=0,i=0,a={shift:!1,alt:!1,control:!1,meta:!1},o=!1;function s(e){var t=!1;return"altKey"in e&&(t=t||e.altKey!==a.alt,a.alt=!!e.altKey),"shiftKey"in e&&(t=t||e.shiftKey!==a.shift,a.shift=!!e.shiftKey),"ctrlKey"in e&&(t=t||e.ctrlKey!==a.control,a.control=!!e.ctrlKey),"metaKey"in e&&(t=t||e.metaKey!==a.meta,a.meta=!!e.metaKey),t}function l(e,o){var l=Ge.x(o),c=Ge.y(o);"buttons"in o&&(e=0|o.buttons),(e!==n||l!==r||c!==i||s(o))&&(n=0|e,r=l||0,i=c||0,t&&t(n,r,i,a))}function c(e){l(0,e)}function u(){(n||r||i||a.shift||a.alt||a.meta||a.control)&&(r=i=0,n=0,a.shift=a.alt=a.control=a.meta=!1,t&&t(0,0,0,a))}function f(e){s(e)&&t&&t(n,r,i,a)}function h(e){0===Ge.buttons(e)?l(0,e):l(n,e)}function p(e){l(n|Ge.buttons(e),e)}function d(e){l(n&~Ge.buttons(e),e)}function m(){o||(o=!0,e.addEventListener("mousemove",h),e.addEventListener("mousedown",p),e.addEventListener("mouseup",d),e.addEventListener("mouseleave",c),e.addEventListener("mouseenter",c),e.addEventListener("mouseout",c),e.addEventListener("mouseover",c),e.addEventListener("blur",u),e.addEventListener("keyup",f),e.addEventListener("keydown",f),e.addEventListener("keypress",f),e!==window&&(window.addEventListener("blur",u),window.addEventListener("keyup",f),window.addEventListener("keydown",f),window.addEventListener("keypress",f)))}m();var g={element:e};return Object.defineProperties(g,{enabled:{get:function(){return o},set:function(t){t?m():function(){if(!o)return;o=!1,e.removeEventListener("mousemove",h),e.removeEventListener("mousedown",p),e.removeEventListener("mouseup",d),e.removeEventListener("mouseleave",c),e.removeEventListener("mouseenter",c),e.removeEventListener("mouseout",c),e.removeEventListener("mouseover",c),e.removeEventListener("blur",u),e.removeEventListener("keyup",f),e.removeEventListener("keydown",f),e.removeEventListener("keypress",f),e!==window&&(window.removeEventListener("blur",u),window.removeEventListener("keyup",f),window.removeEventListener("keydown",f),window.removeEventListener("keypress",f))}()},enumerable:!0},buttons:{get:function(){return n},enumerable:!0},x:{get:function(){return r},enumerable:!0},y:{get:function(){return i},enumerable:!0},mods:{get:function(){return a},enumerable:!0}}),g},Ge=He;var qe={left:0,top:0},Ze=function(e,t,n){t=t||e.currentTarget||e.srcElement,Array.isArray(n)||(n=[0,0]);var r=e.clientX||0,i=e.clientY||0,a=(o=t,o===window||o===document||o===document.body?qe:o.getBoundingClientRect());var o;return n[0]=r-a.left,n[1]=i-a.top,n};var Qe,$e,Je={exports:{}},Ke={exports:{}},et=function(e){return null!=e},tt=et,nt={object:!0,function:!0,undefined:!0},rt=function(e){return!!tt(e)&&hasOwnProperty.call(nt,typeof e)},it=function(e){if(!rt(e))return!1;try{return!!e.constructor&&e.constructor.prototype===e}catch(t){return!1}},at=function(e){if("function"!=typeof e)return!1;if(!hasOwnProperty.call(e,"length"))return!1;try{if("number"!=typeof e.length)return!1;if("function"!=typeof e.call)return!1;if("function"!=typeof e.apply)return!1}catch(t){return!1}return!it(e)},ot=/^\s*class[\s{/}]/,st=Function.prototype.toString,lt=function(e){return null!=e},ct=lt,ut=Object.keys,ft=function(){try{return Object.keys("primitive"),!0}catch(e){return!1}}()?Object.keys:function(e){return ut(ct(e)?Object(e):e)},ht=lt,pt=ft,dt=function(e){if(!ht(e))throw new TypeError("Cannot use null or undefined");return e},mt=Math.max,gt="function"==typeof($e=Object.assign)&&($e(Qe={foo:"raz"},{bar:"dwa"},{trzy:"trzy"}),Qe.foo+Qe.bar+Qe.trzy==="razdwatrzy")?Object.assign:function(e,t){var n,r,i,a=mt(arguments.length,2);for(e=Object(dt(e)),i=function(r){try{e[r]=t[r]}catch(i){n||(n=i)}},r=1;r<a;++r)pt(t=arguments[r]).forEach(i);if(void 0!==n)throw n;return e},vt=lt,bt=Array.prototype.forEach,yt=Object.create,xt=function(e,t){var n;for(n in e)t[n]=e[n]},wt="razdwatrzy",_t=String.prototype.indexOf,At="function"==typeof wt.contains&&!0===wt.contains("dwa")&&!1===wt.contains("foo")?String.prototype.contains:function(e){return _t.call(this,e,arguments[1])>-1},St=et,Tt=function(e){return!!at(e)&&!ot.test(st.call(e))},Et=gt,Ct=function(e){var t=yt(null);return bt.call(arguments,(function(e){vt(e)&&xt(Object(e),t)})),t},Mt=At;(Ke.exports=function(e,t){var n,r,i,a,o;return arguments.length<2||"string"!=typeof e?(a=t,t=e,e=null):a=arguments[2],St(e)?(n=Mt.call(e,"c"),r=Mt.call(e,"e"),i=Mt.call(e,"w")):(n=i=!0,r=!1),o={value:t,configurable:n,enumerable:r,writable:i},a?Et(Ct(a),o):o}).gs=function(e,t,n){var r,i,a,o;return"string"!=typeof e?(a=n,n=t,t=e,e=null):a=arguments[3],St(t)?Tt(t)?St(n)?Tt(n)||(a=n,n=void 0):n=void 0:(a=t,t=n=void 0):t=void 0,St(e)?(r=Mt.call(e,"c"),i=Mt.call(e,"e")):(r=!0,i=!1),o={get:t,set:n,configurable:r,enumerable:i},a?Et(Ct(a),o):o};var Pt,Ot,Dt,It,Lt,kt,zt,Rt,Ft,Bt,jt,Nt,Wt,Vt,Ut,Ht,Yt,Xt,Gt=function(e){if("function"!=typeof e)throw new TypeError(e+" is not a function");return e};Pt=Je,Ot=Je.exports,Bt=Ke.exports,jt=Gt,Nt=Function.prototype.apply,Wt=Function.prototype.call,Vt=Object.create,Ut=Object.defineProperty,Ht=Object.defineProperties,Yt=Object.prototype.hasOwnProperty,Xt={configurable:!0,enumerable:!1,writable:!0},It=function(e,t){var n,r;return jt(t),r=this,Dt.call(this,e,n=function(){Lt.call(r,e,n),Nt.call(t,this,arguments)}),n.__eeOnceListener__=t,this},zt={on:Dt=function(e,t){var n;return jt(t),Yt.call(this,"__ee__")?n=this.__ee__:(n=Xt.value=Vt(null),Ut(this,"__ee__",Xt),Xt.value=null),n[e]?"object"==typeof n[e]?n[e].push(t):n[e]=[n[e],t]:n[e]=t,this},once:It,off:Lt=function(e,t){var n,r,i,a;if(jt(t),!Yt.call(this,"__ee__"))return this;if(!(n=this.__ee__)[e])return this;if("object"==typeof(r=n[e]))for(a=0;i=r[a];++a)i!==t&&i.__eeOnceListener__!==t||(2===r.length?n[e]=r[a?0:1]:r.splice(a,1));else r!==t&&r.__eeOnceListener__!==t||delete n[e];return this},emit:kt=function(e){var t,n,r,i,a;if(Yt.call(this,"__ee__")&&(i=this.__ee__[e]))if("object"==typeof i){for(n=arguments.length,a=new Array(n-1),t=1;t<n;++t)a[t-1]=arguments[t];for(i=i.slice(),t=0;r=i[t];++t)Nt.call(r,this,a)}else switch(arguments.length){case 1:Wt.call(i,this);break;case 2:Wt.call(i,this,arguments[1]);break;case 3:Wt.call(i,this,arguments[1],arguments[2]);break;default:for(n=arguments.length,a=new Array(n-1),t=1;t<n;++t)a[t-1]=arguments[t];Nt.call(i,this,a)}}},Rt={on:Bt(Dt),once:Bt(It),off:Bt(Lt),emit:Bt(kt)},Ft=Ht({},Rt),Pt.exports=Ot=function(e){return null==e?Vt(Ft):Ht(Object(e),Rt)},Ot.methods=zt;var qt=Je.exports;const Zt={passive:!0,capture:!1};class Qt{constructor(e,t,n,r){let i,a;for(this.stability=null!=e?Math.abs(e):8,this.sensitivity=null!=t?1+Math.abs(t):100,this.tolerance=null!=n?1+Math.abs(n):1.1,this.delay=null!=r?r:150,this.lastUpDeltas=[],i=1,a=2*this.stability;1<=a?i<=a:i>=a;1<=a?i++:i--)this.lastUpDeltas.push(null);for(this.lastDownDeltas=[],i=1,a=2*this.stability;1<=a?i<=a:i>=a;1<=a?i++:i--)this.lastDownDeltas.push(null);for(this.deltasTimestamp=[],i=1,a=2*this.stability;1<=a?i<=a:i>=a;1<=a?i++:i--)this.deltasTimestamp.push(null)}check(e){var t;return null!=(e=e.originalEvent||e).wheelDelta?t=e.wheelDelta:null!=e.deltaY?t=-40*e.deltaY:null==e.detail&&0!==e.detail||(t=-40*e.detail),this.deltasTimestamp.push(Date.now()),this.deltasTimestamp.shift(),t>0?(this.lastUpDeltas.push(t),this.lastUpDeltas.shift(),this.isInertia(1)):(this.lastDownDeltas.push(t),this.lastDownDeltas.shift(),this.isInertia(-1))}isInertia(e){var t,n,r,i,a,o,s;return null===(t=-1===e?this.lastDownDeltas:this.lastUpDeltas)[0]?e:!(this.deltasTimestamp[2*this.stability-2]+this.delay>Date.now()&&t[0]===t[2*this.stability-1])&&(r=t.slice(0,this.stability),n=t.slice(this.stability,2*this.stability),s=r.reduce((function(e,t){return e+t})),a=n.reduce((function(e,t){return e+t})),o=s/r.length,i=a/n.length,Math.abs(o)<Math.abs(i*this.tolerance)&&this.sensitivity<Math.abs(i)&&e)}showLastUpDeltas(){return this.lastUpDeltas}showLastDownDeltas(){return this.lastDownDeltas}}function $t(e,t){const{phi:n,theta:r,distance:i,autorotate:a,autorotateDistance:o,autorotateSpeedTheta:l,autorotateSpeedPhi:c}=t,u=Ue(Object.assign({},t,s({fovY:t.fovY,zoomDecayTime:0,rotationDecayTime:50,panDecayTime:50,distance:i,phi:n,theta:r,center:t.center},t.aspectRatio&&{aspectRatio:t.aspectRatio})));return function(e,t,{minDistance:n,maxDistance:r}){const i=new Qt,a=.5*Math.PI;(function(e){e=e||window;const t=qt();let n,r,i=[null,null],a=[null,null],o=[null,null],s=[null,null],l=0,c={};const u=e===window?function(){n=window.innerWidth,r=window.innerHeight}:function(){n=e.clientWidth,r=e.clientHeight};let f,h,p=0,d={};const m=Xe(e,(function(e,t,n,r){f=t,h=n,p=e,d=r}));function g(a){Ze(a,e,o),u(),c.buttons=p,c.mods=d,c.x0=c.x=c.x1=2*o[0]/n-1,c.y0=c.y=c.y1=1-2*o[1]/r,c.x2=null,c.y2=null,c.dx=2*a.deltaX/n,c.dy=-2*a.deltaY/r,c.dz=2*a.deltaZ/n,c.active=1,c.zoomx=1,c.zoomy=1,c.theta=0,c.dtheta=0,c.originalEvent=a,t.emit("wheel",c),i[0]=o[0],i[1]=o[1]}let v=null,b=null,y=0;function x(a){Ze(a,e,o),y=0,u(),c.buttons=p,c.mods=d,c.x=c.x1=2*o[0]/n-1,c.y=c.y1=1-2*o[1]/r,c.x2=null,c.y2=null,c.active=y,c.x0=2*v/n-1,c.y0=1-2*b/r,c.dx=0,c.dy=0,c.dz=0,c.zoomx=1,c.zoomy=1,c.theta=0,c.dtheta=0,c.originalEvent=a,t.emit("mouseup",c),v=b=null,i[0]=o[0],i[1]=o[1]}function w(a){Ze(a,e,o),y=1,u(),v=f,b=h,c.buttons=p,c.mods=d,c.x=c.x0=c.x1=2*o[0]/n-1,c.y=c.y0=c.y1=1-2*o[1]/r,c.x2=null,c.y2=null,c.active=y,c.dx=0,c.dy=0,c.dz=0,c.zoomx=1,c.zoomy=1,c.theta=0,c.dtheta=0,c.originalEvent=a,t.emit("mousedown",c),i[0]=o[0],i[1]=o[1]}function _(a){Ze(a,e,o),u(),c.buttons=p,c.mods=d,c.x0=2*v/n-1,c.y0=1-2*b/r,c.x=c.x1=2*o[0]/n-1,c.y=c.y1=1-2*o[1]/r,c.x2=null,c.y2=null,c.dx=2*(o[0]-i[0])/n,c.dy=-2*(o[1]-i[1])/r,c.active=y,c.dz=0,c.zoomx=1,c.zoomy=1,c.theta=0,c.dtheta=0,c.originalEvent=a,t.emit("mousemove",c),i[0]=o[0],i[1]=o[1]}function A(e){let t=e.identifier;for(let n=0;n<s.length;n++)if(s[n]&&s[n].touch&&s[n].touch.identifier===t)return n;return-1}function S(i){a[0]=null,a[1]=null;for(let t=0;t<i.changedTouches.length;t++){const n=i.changedTouches[t];if(-1===A(n.identifier)&&l<2){const t=s[0]?1:0,r={position:[0,0],touch:null};s[t]=r,l++,r.touch=n,Ze(n,e,r.position)}}let o=0,f=0,h=0;for(let e=0;e<s.length;e++)s[e]&&(o+=s[e].position[0],f+=s[e].position[1],h++);if(o/=h,f/=h,l>0){if(c.theta=0,h>1){const e=s[1].position[0]-s[0].position[0],t=(s[0].position[1]-s[1].position[1])*n/r;c.theta=Math.atan2(t,e)}u(),c.buttons=0,c.mods={},c.active=l,v=o,b=f,c.x0=2*v/n-1,c.y0=1-2*b/r,c.x=2*o/n-1,c.y=1-2*f/r,c.x1=2*s[0].position[0]/n-1,c.y1=1-2*s[0].position[1]/r,l>1&&(c.x2=2*s[1].position[0]/n-1,c.y2=1-2*s[1].position[1]/r),c.active=l,c.dx=0,c.dy=0,c.dz=0,c.zoomx=1,c.zoomy=1,c.dtheta=0,c.originalEvent=i,t.emit(1===l?"touchstart":"pinchstart",c)}}function T(i){let o,u=!1;for(let t=0;t<i.changedTouches.length;t++){const n=i.changedTouches[t];o=A(n),-1!==o&&(u=!0,s[o].touch=n,Ze(n,e,s[o].position))}if(u)if(1===l){for(o=0;o<s.length&&!s[o];o++);if(s[o]&&a[o]){const e=s[o].position[0],u=s[o].position[1],f=e-a[o][0],h=u-a[o][1];c.buttons=0,c.mods={},c.active=l,c.x=c.x1=2*e/n-1,c.y=c.y1=1-2*u/r,c.x2=null,c.y2=null,c.x0=2*v/n-1,c.y0=1-2*b/r,c.dx=2*f/n,c.dy=-2*h/r,c.dz=0,c.zoomx=1,c.zoomy=1,c.theta=0,c.dtheta=0,c.originalEvent=i,t.emit("touchmove",c)}}else if(2===l&&a[0]&&a[1]){const e=a[0],o=a[1],u=o[0]-e[0],f=(o[1]-e[1])*n/r,h=s[0].position,p=s[1].position,m=p[0]-h[0],g=(h[1]-p[1])*n/r,y=.5*Math.sqrt(u*u+f*f),x=Math.atan2(f,u),w=.5*Math.sqrt(m*m+g*g),_=Math.atan2(g,m),A=.5*(o[0]+e[0]),S=.5*(o[1]+e[1]),T=.5*(p[0]+h[0]-e[0]-o[0]),E=.5*(p[1]+h[1]-e[1]-o[1]),C=w/y,M=_-x;c.buttons=0,c.mods=d,c.active=l,c.x=2*A/n-1,c.y=1-2*S/r,c.x0=2*v/n-1,c.y0=1-2*b/r,c.x1=2*h[0]/n-1,c.y1=1-2*h[1]/r,c.x2=2*p[0]/n-1,c.y2=1-2*p[1]/r,c.dx=2*T/n,c.dy=-2*E/r,c.dz=0,c.zoomx=C,c.zoomy=C,c.theta=_,c.dtheta=M,c.originalEvent=i,t.emit("pinchmove",c)}s[0]&&(a[0]=s[0].position.slice()),s[1]&&(a[1]=s[1].position.slice())}function E(e){let i;for(let t=0;t<e.changedTouches.length;t++){let n=A(e.changedTouches[t]);-1!==n&&(i=s[n],s[n]=null,l--)}let a=0,o=0;if(0===l)i&&(a=i.position[0],o=i.position[1]);else{let e=0;for(let t=0;t<s.length;t++)s[t]&&(a+=s[t].position[0],o+=s[t].position[1],e++);a/=e,o/=e}l<2&&(c.buttons=0,c.mods=d,c.active=l,c.x=2*a/n-1,c.y=1-2*o/r,c.x0=2*v/n-1,c.y0=1-2*b/r,c.dx=0,c.dy=0,c.dz=0,c.zoomx=1,c.zoomy=1,c.theta=0,c.dtheta=0,c.originalEvent=e,t.emit(0===l?"touchend":"pinchend",c)),0===l&&(v=b=null)}let C=!1;function M(){C||(C=!0,m.enabled=!0,e.addEventListener("wheel",g,Zt),e.addEventListener("mousedown",w,Zt),window.addEventListener("mousemove",_,Zt),window.addEventListener("mouseup",x,Zt),e.addEventListener("touchstart",S,Zt),window.addEventListener("touchmove",T,Zt),window.addEventListener("touchend",E,Zt),window.addEventListener("touchcancel",E,Zt))}return M(),t.enable=M,t.disable=function(){C&&(C=!1,m.enabled=!1,e.removeEventListener("wheel",g,Zt),e.removeEventListener("mousedown",w,Zt),window.removeEventListener("mousemove",_,Zt),window.removeEventListener("mouseup",x,Zt),e.removeEventListener("touchstart",S,Zt),window.removeEventListener("touchmove",T,Zt),window.removeEventListener("touchend",E,Zt),window.removeEventListener("touchcancel",E,Zt))},t})(t).on("wheel",(function(t){e.autorotate=!1,t.active&&!1!==i.check(t)&&(e.params.distance<=r&&e.zoom(t.x,t.y,.2*(Math.exp(-t.dy)-1)),e.params.distance=Math.max(n,Math.min(r,e.params.distance)))})).on("mousemove",(function(t){t.active&&1===t.buttons&&(e.autorotate=!1,t.mods.shift?e.pan(t.dx,t.dy):t.mods.meta||e.rotate(-t.dx*a,-t.dy*a))})).on("touchmove",(function(t){e.autorotate=!1,t.active&&e.rotate(-t.dx*a,-t.dy*a)}))}(u,e&&e._gl.canvas,{minDistance:t.minDistance||.1,maxDistance:t.maxDistance||50}),u.toConfig=()=>({center:u.params.center,theta:u.params.theta,phi:u.params.phi,distance:u.params.distance}),u.toggleAutorotate=()=>{u.autorotate=!u.autorotate,u.autorotate&&u.startAutorotate()},u.startAutorotate=()=>{u.autorotate=!0,u.autorotateParams=s({},u.params),u.autorotateT0=Date.now()},u.stopAutorotate=()=>{u.autorotate=!1,u.autorotateParams=s({},u.params),u.autorotateT0=Date.now()},u.doAutorotate=()=>{if(u.autorotate){const e=(Date.now()-u.autorotateT0)/1e3;u.params.distance=u.autorotateParams.distance+.1*Math.sin(o*e),u.params.theta=u.autorotateParams.theta+l*e,u.params.phi=u.autorotateParams.phi+.05*Math.sin(c*e)}},u.autorotate=a,a&&u.startAutorotate(),u.setCameraUniforms=e({uniforms:{projection:()=>u.state.projection,view:()=>u.state.view,eye:()=>u.state.eye}}),u}const Jt=e=>Math.sign(e)*Math.abs(e),Kt=({swizzle:e=(e=>[e,0,0]),round:t=Jt})=>({n:n=0,d:r=0})=>{const i=r*(n-1)/2;return Array(n).fill(0).map(((n,a)=>e(t(a*r-i))))},en=({swizzle:e=((e,t)=>[e,t,0]),round:t=Jt})=>({n:n=0,d:r=0})=>{const i=Math.ceil(Math.sqrt(n)),a=Math.ceil(n/i),o=r*(i-1)/2,s=r*(a-1)/2;return Array(n).fill(0).map(((n,a)=>{const l=a%i,c=Math.floor(a/i);return e(t(l*r-o),t(c*r-s))}))},tn=Math.PI*(3-Math.sqrt(5)),nn=({swizzle:e=((e,t)=>[e,t,0]),round:t=Jt})=>({n:n=0,d:r=tn})=>Array(n).fill(0).map(((i,a)=>{const o=a*tn,s=Math.sqrt(a)/Math.sqrt(n)*r*3;return e(t(s*Math.cos(o)),t(s*Math.sin(o)))})),rn={SQUARE_XY:en({swizzle:(e,t)=>[e,t,0]}),SQUARE_XZ:en({swizzle:(e,t)=>[e,0,t]}),SQUARE_YZ:en({swizzle:(e,t)=>[0,e,t]}),ROW_X:Kt({swizzle:e=>[e,0,0]}),ROW_Y:Kt({swizzle:e=>[0,e,0]}),ROW_Z:Kt({swizzle:e=>[0,0,e]}),COLUMN:Kt({swizzle:e=>[0,e,0]}),SPIRAL_XY:nn({swizzle:(e,t)=>[e,t,0]}),SPIRAL_YZ:nn({swizzle:(e,t)=>[0,e,t]})};var an="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},on={exports:{}},sn=on.exports=function(){var e="function"==typeof Promise,t="object"==typeof self?self:an,n="undefined"!=typeof Symbol,r="undefined"!=typeof Map,i="undefined"!=typeof Set,a="undefined"!=typeof WeakMap,o="undefined"!=typeof WeakSet,s="undefined"!=typeof DataView,l=n&&void 0!==Symbol.iterator,c=n&&void 0!==Symbol.toStringTag,u=i&&"function"==typeof Set.prototype.entries,f=r&&"function"==typeof Map.prototype.entries,h=u&&Object.getPrototypeOf((new Set).entries()),p=f&&Object.getPrototypeOf((new Map).entries()),d=l&&"function"==typeof Array.prototype[Symbol.iterator],m=d&&Object.getPrototypeOf([][Symbol.iterator]()),g=l&&"function"==typeof String.prototype[Symbol.iterator],v=g&&Object.getPrototypeOf(""[Symbol.iterator]()),b=8,y=-1;function x(n){var l=typeof n;if("object"!==l)return l;if(null===n)return"null";if(n===t)return"global";if(Array.isArray(n)&&(!1===c||!(Symbol.toStringTag in n)))return"Array";if("object"==typeof window&&null!==window){if("object"==typeof window.location&&n===window.location)return"Location";if("object"==typeof window.document&&n===window.document)return"Document";if("object"==typeof window.navigator){if("object"==typeof window.navigator.mimeTypes&&n===window.navigator.mimeTypes)return"MimeTypeArray";if("object"==typeof window.navigator.plugins&&n===window.navigator.plugins)return"PluginArray"}if(("function"==typeof window.HTMLElement||"object"==typeof window.HTMLElement)&&n instanceof window.HTMLElement){if("BLOCKQUOTE"===n.tagName)return"HTMLQuoteElement";if("TD"===n.tagName)return"HTMLTableDataCellElement";if("TH"===n.tagName)return"HTMLTableHeaderCellElement"}}var u=c&&n[Symbol.toStringTag];if("string"==typeof u)return u;var f=Object.getPrototypeOf(n);return f===RegExp.prototype?"RegExp":f===Date.prototype?"Date":e&&f===Promise.prototype?"Promise":i&&f===Set.prototype?"Set":r&&f===Map.prototype?"Map":o&&f===WeakSet.prototype?"WeakSet":a&&f===WeakMap.prototype?"WeakMap":s&&f===DataView.prototype?"DataView":r&&f===p?"Map Iterator":i&&f===h?"Set Iterator":d&&f===m?"Array Iterator":g&&f===v?"String Iterator":null===f?"Object":Object.prototype.toString.call(n).slice(b,y)}return x}();const ln="undefined"!=typeof Buffer,cn=ln&&void 0!==Buffer.from,un=ln?function(e){return Buffer.isBuffer(e)}:function(){return!1},fn=cn?function(e){return Buffer.from(e)}:ln?function(e){return new Buffer(e)}:function(e){return e};function hn(e){return un(e)?"Buffer":sn(e)}const pn=new Set(["Arguments","Array","Map","Object","Set"]);function dn(e,t,n=null){switch(n||hn(e)){case"Arguments":case"Array":case"Object":return e[t];case"Map":return e.get(t);case"Set":return t}}function mn(e){return pn.has(e)}function gn(e,t,n,r=null){switch(r||hn(e)){case"Arguments":case"Array":case"Object":e[t]=n;break;case"Map":e.set(t,n);break;case"Set":e.add(n)}return e}const vn="undefined"!=typeof globalThis&&null!==globalThis&&globalThis.Object===Object&&globalThis,bn="undefined"!=typeof global&&null!==global&&global.Object===Object&&global,yn="undefined"!=typeof self&&null!==self&&self.Object===Object&&self,xn=vn||bn||yn||Function("return this")();function wn(e,t){return xn[t].from?xn[t].from(e):new xn[t](e)}function _n(e){return e}function An(){return[]}var Sn=new Map([["ArrayBuffer",function(e){return e.slice(0)}],["Boolean",function(e){return new Boolean(e.valueOf())}],["Buffer",function(e){return fn(e)}],["DataView",function(e){return new DataView(e.buffer)}],["Date",function(e){return new Date(e.getTime())}],["Number",function(e){return new Number(e)}],["RegExp",function(e){return new RegExp(e.source,e.flags)}],["String",function(e){return new String(e)}],["Float32Array",wn],["Float64Array",wn],["Int16Array",wn],["Int32Array",wn],["Int8Array",wn],["Uint16Array",wn],["Uint32Array",wn],["Uint8Array",wn],["Uint8ClampedArray",wn],["Array Iterator",_n],["Map Iterator",_n],["Promise",_n],["Set Iterator",_n],["String Iterator",_n],["function",_n],["global",_n],["WeakMap",_n],["WeakSet",_n],["boolean",_n],["null",_n],["number",_n],["string",_n],["symbol",_n],["undefined",_n],["Arguments",An],["Array",An],["Map",function(){return new Map}],["Object",function(){return{}}],["Set",function(){return new Set}]]);function Tn(){}function En(e,t=null,n=Tn){2===arguments.length&&"function"==typeof t&&(n=t,t=null);const r=t||hn(e),i=Sn.get(r);if("Object"===r){const t=n(e,r);if(void 0!==t)return t}return i?i(e,r):e}function Cn(e,t={}){"function"==typeof t&&(t={customizer:t});const{customizer:n}=t,r=hn(e);if(!mn(r))return Mn(e,null,null,null);const i=En(e,r,n);return Mn(e,i,new WeakMap([[e,i]]),new WeakSet([e]))}function Mn(e,t,n,r,i){const a=hn(e),o=En(e,a);if(!mn(a))return o;let s;switch(a){case"Arguments":case"Array":s=Object.keys(e);break;case"Object":s=Object.keys(e),s.push(...Object.getOwnPropertySymbols(e));break;case"Map":case"Set":s=e.keys()}for(let l of s){const i=dn(e,l,a);if(r.has(i))gn(t,l,n.get(i),a);else{const e=hn(i),o=En(i,e);mn(e)&&(n.set(i,o),r.add(i)),gn(t,l,Mn(i,o,n,r),a)}}return t}const Pn="nobreak",On="DRIF",Dn="SBEN",In="QUAD",Ln="ESTA",kn=299792458;var zn={name:"default",debug:{logPushing:!1,logPerformance:!1,showTextures:!1,showTextureScale:1},runner:{pusher:"glsl",factor:1,enabled:!0,packFloat2UInt8:!1,prerender:!1,loops:0,mode:Pn,snapshotsPerTick:2,iterationsPerSnapshot:8,iterationCount:1023,iterationDurationOverC:.02,snapshotCount:128},model:{boundingBoxSize:0,emitter:{particleType:"ELECTRON",bunchShape:"SPIRAL_XY",particleCount:128,particleSeparation:.05,gamma:()=>2.25,positionJitter:[0,0,0]},interactions:{particleInteraction:!1,electricField:[0,0,0],magneticField:[0,0,0]},lattice:{elements:{},beamline:[],origin:{phi:0,position:[0,0,0]}}},view:{lights:[{position:[0,5,0],near:-5,far:10,size:9}],ambientLightAmount:.5,diffuseLightAmount:.5,stageGrid:{y:0,size:10},rgbGamma:1,isStageVisible:!0,isShadowEnabled:!0,isLatticeVisible:!0,isFieldVisible:!0,pathicleRelativeGap:3,pathicleRelativeHeight:5,pathicleWidth:.0015,showAxes:!0,showVignette:!0,viewRange:[0,1],camera:{center:[0,0,0],distance:2,phi:15/360*2*Math.PI,theta:.25*Math.PI,fovY:5*Math.PI/36,autorotate:!1,autorotateDistance:.2*Math.PI,autorotateSpeedTheta:.2*Math.PI,autorotateSpeedPhi:.2*Math.PI,zoomDecayTime:1,far:200,near:1e-4,minDistance:.1,maxDistance:20}}},Rn={name:"spiral",view:{camera:{center:[0,1.5,0],distance:5,theta:Math.PI/180*90,phi:Math.PI/180*1}},runner:{iterationDurationOverC:.1,iterationsPerSnapshot:1,iterationCount:255,snapshotCount:256},model:{emitter:{bunchShape:"SPIRAL_XY",direction:[0,.2,1],gamma:5},interactions:{magneticField:[0,.01,0],particleInteraction:!1},lattice:{beamline:[],origin:{phi:0,position:[0,0,0]}}}},Fn={name:"csr",view:{camera:{center:[0,1,0],distance:15,phi:15/360*2*Math.PI,theta:.5*Math.PI}},runner:{prerender:!1,loops:0,mode:Pn,iterationsPerSnapshot:8,iterationDurationOverC:.01,snapshotCount:32,iterationCount:2047},model:{emitter:{particleType:"ELECTRON",bunchShape:"SPIRAL_XY",gamma:2.5},interactions:{magneticField:[0,0,0],particleInteraction:!1},lattice:{elements:{l0:{type:On,l:1.43},l1:{type:On,l:1},l2:{type:On,l:.35},q1:{type:In,k1:2.87506832355,l:.25},q2:{type:In,k1:-6.31393492954,l:.25},q3:{type:In,k1:4.36962492724,l:.25},q4:{type:In,k1:5.5089117863,l:.25},d1:{type:Dn,l:1,strength:.0021,angle:-2*Math.PI/360*45},bm:{type:Dn,angle:.78539816,e1:.39269908,e2:.39269908,l:1.8,strength:1e-4}},beamline:["l1","d1","l1","d1","l1","d1","l1","d1","l1","d1","l1","d1","l1","d1","l1","d1"],origin:{phi:0,position:[-.5,1,-.5]}}}},Bn={name:"story-dipole",view:{camera:{center:[0,1,0],distance:7,theta:0*Math.PI,phi:10/360*2*Math.PI}},runner:{prerender:!1,packFloat2UInt8:!1},model:{emitter:{particleType:"ELECTRON"},lattice:{elements:{l1:{type:On,l:4.5},d1:{type:Dn,l:1,strength:75e-5,angle:2*Math.PI/360*0}},beamline:["l1","d1"],origin:{phi:0*Math.PI,position:[0,1,-5]}}}},jn={name:"pathicles-logo",view:{camera:{center:[.1,1.6,0],theta:-.2,phi:-.2,distance:1}},model:{emitter:{particleType:"ELECTRON PHOTON PROTON",bunchShape:"SQUARE_XY",position:[0,1.5,-10],direction:[0,0,1]},lattice:{},beamline:[],origin:{phi:0*Math.PI,position:[0,1,-10]}}},Nn={name:"story-electric",view:{camera:{center:[0,1,0],distance:5,theta:.25*Math.PI,phi:10/360*2*Math.PI}},model:{emitter:{particleType:"ELECTRON PHOTON PROTON",gamma:()=>1.5},lattice:{elements:{l:{type:On,l:4.75},e:{type:Ln,l:.5,strength:-1e10}},beamline:["l","e","l"],origin:{phi:0,position:[0,1,-5]}}}};var Wn={name:"story-quadrupole",view:{camera:{center:[0,1,0],distance:7,theta:55/360*2*Math.PI,phi:10/360*2*Math.PI}},model:{emitter:{bunchShape:"SPIRAL_XY",particleType:"PROTON",gamma:6},lattice:{elements:{q1:{type:In,strength:4,l:.5},q2:{type:In,strength:-4,l:.5},l_5:{type:On,l:5},l_20:{type:On,l:20},l_1:{type:On,l:1}},beamline:["l_1","q1","l_1","q2","l_1","q1","l_1","q2","l_1","q1","l_1","q2","l_1"],origin:{phi:0,position:[0,1,-5]}}}};let Vn=1;const Un=(e=-1,t=1)=>(()=>{let e=1e4*Math.sin(Vn++);return e-Math.floor(e)})()*(t-e)+e;var Hn={name:"random",view:{camera:{center:[0,.5,0],distance:8,theta:Math.PI/180*45,phi:Math.PI/180*5}},runner:{prerender:!0,loops:2,iterationsPerSnapshot:1,iterationCount:128,snapshotCount:16,iterationDurationOverC:.1},model:{boundingBoxSize:1,boundingBoxCenter:[0,1,0],emitter:{position:[0,.5,0],direction:()=>[Un(),Un(),Un()],particleSeparation:.1,gamma:10,bunchShape:"SQUARE_YZ",particleCount:512,particleType:"PHOTON ELECTRON PROTON"}}},Yn={name:"free-electron",runner:{prerender:!0,mode:Pn,packFloat2UInt8:!0,loops:0,iterationsPerSnapshot:1,iterationCount:10,snapshotCount:11,iterationDurationOverC:.1},model:{emitter:{gamma:1.1,particleCount:1,particleType:"ELECTRON"},lattice:{origin:{position:[0,zn.view.pathicleWidth*zn.view.pathicleRelativeHeight,0]}}}},Xn={name:"free-electrons",view:{camera:{center:[0,1,0],theta:.001,phi:.001,distance:8.75}},runner:{prerender:!0,mode:Pn,packFloat2UInt8:!1,loops:0,iterationsPerSnapshot:1,iterationCount:100,snapshotCount:11,iterationDurationOverC:.1},model:{emitter:{particleType:"ELECTRON"},lattice:{elements:{},beamline:[],origin:{phi:0,position:[0,1,-5]}}}},Gn={name:"different-gammas",view:{pathicleRelativeGap:1,pathicleRelativeHeight:3,pathicleWidth:.005,camera:{center:[0,.5,-.8],distance:4,theta:Math.PI/180*0,phi:Math.PI/180*20}},runner:{prerender:!0,mode:Pn,loops:0,iterationsPerSnapshot:1,iterationCount:10,snapshotCount:11,iterationDurationOverC:.1},debug:{logPushing:!1},model:{emitter:{particleCount:60,particleSeparation:0,particleType:"PHOTON ELECTRON PROTON",bunchShape:"ROW_X",direction:[0,0,-1],position:({p:e})=>[(Math.floor(e/3)-10)/10+e%3*.025,zn.view.pathicleWidth*zn.view.pathicleRelativeHeight/2*2,0],directionJitter:[0,0,0],positionJitter:[0,0,0],gamma:({p:e})=>1+Math.floor(e/3)/50}}},qn={name:"different-gammas-E-1e-10",view:{pathicleRelativeGap:1,pathicleRelativeHeight:3,pathicleWidth:.005,camera:{center:[0,.5,-.8],distance:4,theta:Math.PI/180*0,phi:Math.PI/180*20}},runner:{prerender:!0,mode:Pn,loops:0,iterationsPerSnapshot:1,iterationCount:10,snapshotCount:11,iterationDurationOverC:.1},debug:{logPushing:!1},model:{emitter:{particleCount:60,particleSeparation:0,particleType:"PHOTON ELECTRON PROTON",bunchShape:"ROW_X",direction:[0,0,-1],position:({p:e})=>[(Math.floor(e/3)-10)/10+e%3*.025,zn.view.pathicleWidth*zn.view.pathicleRelativeHeight/2*2,0],directionJitter:[0,0,0],positionJitter:[0,0,0],gamma:({p:e})=>1+Math.floor(e/3)/50},interactions:{electricField:[0,0,-1e-10],particleInteraction:!1,magneticField:[0,0,0]}}},Zn={name:"different-gammas-E-1e-11",view:{pathicleRelativeGap:1,pathicleRelativeHeight:3,pathicleWidth:.005,camera:{center:[0,.5,-.8],distance:4,theta:Math.PI/180*0,phi:Math.PI/180*20}},runner:{prerender:!0,mode:Pn,loops:0,iterationsPerSnapshot:1,iterationCount:10,snapshotCount:11,iterationDurationOverC:.1},debug:{logPushing:!1},model:{emitter:{particleCount:60,particleSeparation:0,particleType:"PHOTON ELECTRON PROTON",bunchShape:"ROW_X",direction:[0,0,-1],position:({p:e})=>[(Math.floor(e/3)-10)/10+e%3*.025,zn.view.pathicleWidth*zn.view.pathicleRelativeHeight/2*2,0],directionJitter:[0,0,0],positionJitter:[0,0,0],gamma:({p:e})=>1+Math.floor(e/3)/50},interactions:{electricField:[0,0,-1e-11]}}},Qn={name:"different-gammas-E-1e-12",view:{pathicleRelativeGap:1,pathicleRelativeHeight:3,pathicleWidth:.005,camera:{center:[0,.5,-.8],distance:4,theta:Math.PI/180*0,phi:Math.PI/180*20}},runner:{prerender:!0,mode:Pn,loops:0,iterationsPerSnapshot:1,iterationCount:10,snapshotCount:11,iterationDurationOverC:.1},debug:{logPushing:!1},model:{emitter:{particleCount:60,particleSeparation:0,particleType:"PHOTON ELECTRON PROTON",bunchShape:"ROW_X",direction:[0,0,-1],position:({p:e})=>[(Math.floor(e/3)-10)/10+e%3*.025,zn.view.pathicleWidth*zn.view.pathicleRelativeHeight/2*2,0],directionJitter:[0,0,0],positionJitter:[0,0,0],gamma:({p:e})=>1+Math.floor(e/3)/50},interactions:{electricField:[0,0,-1e-12],particleInteraction:!1,magneticField:[0,0,0]}}},$n={name:"free-photon",view:{camera:{center:[0,0,.5],distance:2,phi:5/360*2*Math.PI,theta:.25*Math.PI}},debug:{logPushing:!1},runner:{prerender:!0,packFloat2UInt8:!0,iterationsPerSnapshot:1,iterationCount:10,snapshotCount:11,iterationDurationOverC:.1},model:{emitter:{gamma:1.1,particleCount:1,bunchShape:"ROW_X",particleType:"PHOTON",positionJitter:[0,0,0]},lattice:{origin:{position:[0,zn.view.pathicleWidth*zn.view.pathicleRelativeHeight,0]}}}},Jn={name:"free-photons",view:{camera:{center:[0,.5,2],phi:0*Math.PI,theta:15/360*2*Math.PI}},runner:{packFloat2UInt8:!1,prerender:!0},model:{emitter:{particleType:"PHOTON",bunchShape:"SPIRAL_XY",position:[0,.5,-10],gamma:1}}};var Kn={name:"gyrotest-1-electron",view:{camera:{center:[0,.1,0],distance:3,theta:Math.PI/180*90,phi:Math.PI/180*0}},runner:{prerender:!0,loops:0,mode:Pn,iterationsPerSnapshot:1,iterationCount:void 0,snapshotCount:16,iterationDurationOverC:.1},model:{emitter:{particleCount:1,particleType:"ELECTRON",bunchShape:"COLUMN",direction:[0,0,1],position:[0,zn.view.pathicleWidth*zn.view.pathicleRelativeHeight*2+.02,0],directionJitter:[0,0,0],positionJitter:[0,0,0],gamma:1.1},interactions:{particleInteraction:!1,electricField:[0,0,0],magneticField:[0,4e-4,0]}}},er={name:"gyrotest-128-electrons",view:{camera:{center:[1,2,0],distance:15,theta:Math.PI/180*-90,phi:Math.PI/180*5}},debug:{logPushing:!1},runner:{prerender:!0,loops:0,mode:Pn,iterationsPerSnapshot:1,iterationCount:511,snapshotCount:512,iterationDurationOverC:.05},model:{emitter:{particleCount:128,particleSeparation:.05,particleType:"ELECTRON",bunchShape:"ROW_Y",gamma:({p:e})=>Math.log10(1*e+1)},interactions:{particleInteraction:!1,electricField:[0,0,0],magneticField:[0,5e-4,0]},lattice:{origin:{phi:0,position:[0,zn.view.pathicleWidth*zn.view.pathicleRelativeHeight*2,0]}}}};const tr=e=>{let t=Cn(e);return t.name=t.name+"-uint8",t.runner||(t.runner={}),t.runner.packFloat2UInt8=!0,t},nr={[Fn.name]:Fn,[Gn.name]:Gn,[qn.name]:qn,[Zn.name]:Zn,[Qn.name]:Qn,[Yn.name]:Yn,[Xn.name]:Xn,[$n.name]:$n,[Jn.name]:Jn,[Kn.name]:Kn,[er.name]:er,[jn.name]:jn,[Hn.name]:Hn,[Rn.name]:Rn,[Bn.name]:Bn,[Bn.name]:Bn,[Nn.name]:Nn,[Wn.name]:Wn};for(let co=0;co<11;co++)for(let e=0;e<11;e++){let t=Cn(Hn);t.name=`random__${Math.pow(2,co)}__${Math.pow(2,e)}`,t.model.emitter.particleCount=Math.pow(2,co),t.runner.snapshotCount=Math.pow(2,e),t.runner.iterations=Math.pow(2,e)-1,nr[t.name]=t}Object.keys(nr).forEach((e=>{const t=nr[e];nr[tr(t).name]=tr(t)}));const rr=[{name:"PHOTON",mass__eVc_2:0,charge__qe:0,chargeMassRatio__Ckg_1:0,id:0,color:[235,192,0]},{name:"ELECTRON",mass__eVc_2:510998.9461,chargeMassRatio__Ckg_1:-175882001076,charge__qe:-1,id:1,color:[31,115,166]},{name:"POSITRON",mass__eVc_2:510998.9461,chargeMassRatio__Ckg_1:175882001076,charge__qe:1,id:2,color:[166,115,166]},{name:"PROTON",mass__eVc_2:938272081,charge__qe:1,chargeMassRatio__Ckg_1:95788331.56,id:3,color:[197,50,51]}],ir=new Map(rr.map((e=>[e.name,e])));let ar=1;const or=(e=-1,t=1)=>(()=>{let e=1e4*Math.sin(ar++);return e-Math.floor(e)})()*(t-e)+e,sr=e=>"function"==typeof e?e:()=>e;function lr(e,t=0){const n=e.trim().split(/\s+/).map((e=>{return t=e,ir.get(t);var t}));return 0===t?n:Array(t).fill(0).map(((e,t)=>n[t%n.length]))}function cr({particleCount:e=3,particleType:t="PHOTON ELECTRON PROTON",bunchShape:n="ROW",particleSeparation:r=.1,gamma:i=1,position:a=[0,0,0],direction:o=[0,0,1],positionJitter:s=[0,0,0],directionJitter:l=[0,0,0]}){const c=sr(i),u=sr(o),f=sr(a),h=lr(t,e),p=rn[n]({n:e,d:r}),d=p.map(((e,t)=>{const n=function({position:e=[0,0,0],jitter:t=[0,0,0]}){return e.map(((e,n)=>or()*t[n]))}({jitter:s});return[1*(f({p:t})[0]+e[0]+n[0]),1*(f({p:t})[1]+e[1]+n[1]),1*(f({p:t})[2]+e[2]+n[2]),0]})),m=h.map(((e,t)=>{const n=c({p:t}),r=0===e.mass__eVc_2?1:function(e=0){return 0===e?NaN:Math.sqrt(1-1/Math.pow(e,2))}(n),i=u({p:t,localPositions:p});return 0===e.mass__eVc_2?[kn*i[0],kn*i[1],kn*i[2],kn]:[n*r*kn*i[0],n*r*kn*i[1],n*r*kn*i[2],n*kn]}));return{fourPositions:d.map((e=>e.map((e=>1*e)))),fourVelocities:m.map((e=>e.map((e=>1*e)))),particleCount:e,particleTypes:h.map((e=>e.id))}}var ur="precision highp float;\n#define GLSLIFY 1\nconst highp float c = 2.99792458e+8;\n\nuniform bool littleEndian;\nuniform float boundingBoxSize;\nuniform float deltaTOverC;\nuniform float particleInteraction;\nuniform int takeSnapshot;\nuniform int variableIdx;\nuniform sampler2D ut_particleChargesMassesChargeMassRatios;\nuniform sampler2D ut_position;\nuniform sampler2D ut_velocity;\nuniform vec2 resolution;\nuniform vec3 boundingBoxCenter;\nuniform vec3 electricField;\nuniform vec3 magneticField;\n\nstruct BeamlineElement {\n  vec3 middle;\n  vec3 size;\n  float phi;\n  int type; //0: drift, 1: dipole, 2: quadrupole, 3: esta\n  float strength;\n};\n\nconst int BEAMLINE_ELEMENT_TYPE_DRIFT = 0;\nconst int BEAMLINE_ELEMENT_TYPE_DIPOLE = 1;\nconst int BEAMLINE_ELEMENT_TYPE_QUADRUPOLE = 2;\nconst int BEAMLINE_ELEMENT_TYPE_ESTA = 3;\n\n/*__latticeSize__*/\n/*__latticeChunkGLSL__*/\n\nmat2 rot2D(float phi) {\n  float c = cos(phi);\n  float s = sin(phi);\n  return mat2(c, -s, s, c);\n}\nfloat sdBox( vec3 p, vec3 s ) {\n  vec3 d = abs(p) - .5 * s;\n  return min(max(d.x,max(d.y,d.z)),0.0) + length(max(d,0.0));\n}\n\nvec4 packFloat(float d) {\n    if(d == 0.)\n        return vec4(0, 0, 0, 0);\n    vec4 a;\n    float b, c, f;\n    f = step(0., -d);\n    d = abs(d);\n    b = floor(log2(d));\n    c = d * pow(2., -b) - 1.;\n    b = b + 127.;\n    a = vec4(0, 0, 0, 0);\n    a.a = floor(b / 2.);\n    b = b - a.a * 2.;\n    a.a = a.a + 128. * f;\n    a.b = floor(c * 128.);\n    c = c - a.b / 128.;\n    a.b = a.b + b * 128.;\n    a.g = floor(c * 32768.);\n    c = c - a.g / 32768.;\n    a.r = floor(c * 8388608.);\n    return a / 255.;\n}\n\nfloat shiftRight(float v, float amt) {\n    v = floor(v) + 0.5;\n    return floor(v / exp2(amt));\n}\nfloat shiftLeft(float v, float amt) {\n    return floor(v * exp2(amt) + 0.5);\n}\nfloat maskLast(float v, float bits) {\n    return mod(v, shiftLeft(1.0, bits));\n}\nfloat extractBits(float num, float from, float to) {\n    from = floor(from + 0.5);\n    to = floor(to + 0.5);\n    return maskLast(shiftRight(num, from), to - from);\n}\nvec4 floatToRgba(float texelFloat, bool littleEndian) {\n    if(texelFloat == 0.0)\n        return vec4(0, 0, 0, 0);\n    float sign = texelFloat > 0.0 ? 0.0 : 1.0;\n    texelFloat = abs(texelFloat);\n    float exponent = floor(log2(texelFloat));\n    float biased_exponent = exponent + 127.0;\n    float fraction = ((texelFloat / exp2(exponent)) - 1.0) * 8388608.0;\n    float t = biased_exponent / 2.0;\n    float last_bit_of_biased_exponent = fract(t) * 2.0;\n    float remaining_bits_of_biased_exponent = floor(t);\n    float byte4 = extractBits(fraction, 0.0, 8.0) / 255.0;\n    float byte3 = extractBits(fraction, 8.0, 16.0) / 255.0;\n    float byte2 = (last_bit_of_biased_exponent * 128.0 + extractBits(fraction, 16.0, 23.0)) / 255.0;\n    float byte1 = (sign * 128.0 + remaining_bits_of_biased_exponent) / 255.0;\n    return (littleEndian ? vec4(byte4, byte3, byte2, byte1) : vec4(byte1, byte2, byte3, byte4));\n}\n\nstruct ParticleData {\n  float charge;\n  float mass;\n  float chargeMassRatio;\n  float particleType;\n};\n\nParticleData getParticleData(int p) {\n  vec2 coords = vec2(float(p), 0.) / vec2(float(resolution.y), 1.);\n  vec4 data = texture2D(ut_particleChargesMassesChargeMassRatios, coords);\n  return ParticleData(data.x, data.y, data.z, data.w);\n}\n\n#ifdef PACK_FLOAT\n\n// Denormalize 8-bit color channels to integers in the range 0 to 255.\nivec4 floatsToBytes(vec4 inputFloats, bool littleEndian) {\n  ivec4 bytes = ivec4(inputFloats * 255.0);\n  return (\n    littleEndian\n    ? bytes.abgr\n    : bytes\n  );\n}\n\n// Break the four bytes down into an array of 32 bits.\nvoid bytesToBits(const in ivec4 bytes, out bool bits[32]) {\n  for (int channelIndex = 0; channelIndex < 4; ++channelIndex) {\n    float acc = float(bytes[channelIndex]);\n    for (int indexInByte = 7; indexInByte >= 0; --indexInByte) {\n      float powerOfTwo = exp2(float(indexInByte));\n      bool bit = acc >= powerOfTwo;\n      bits[channelIndex * 8 + (7 - indexInByte)] = bit;\n      acc = mod(acc, powerOfTwo);\n    }\n  }\n}\n\n// Compute the exponent of the 32-bit float.\nfloat getExponent(bool bits[32]) {\n  const int startIndex = 1;\n  const int bitStringLength = 8;\n  const int endBeforeIndex = startIndex + bitStringLength;\n  float acc = 0.0;\n  int pow2 = bitStringLength - 1;\n  for (int bitIndex = startIndex; bitIndex < endBeforeIndex; ++bitIndex) {\n    acc += float(bits[bitIndex]) * exp2(float(pow2--));\n  }\n  return acc;\n}\n\n// Compute the mantissa of the 32-bit float.\nfloat getMantissa(bool bits[32], bool subnormal) {\n  const int startIndex = 9;\n  const int bitStringLength = 23;\n  const int endBeforeIndex = startIndex + bitStringLength;\n  // Leading/implicit/hidden bit convention:\n  // If the number is not subnormal (with exponent 0), we add a leading 1 digit.\n  float acc = float(!subnormal) * exp2(float(bitStringLength));\n  int pow2 = bitStringLength - 1;\n  for (int bitIndex = startIndex; bitIndex < endBeforeIndex; ++bitIndex) {\n    acc += float(bits[bitIndex]) * exp2(float(pow2--));\n  }\n  return acc;\n}\n\n// Parse the float from its 32 bits.\nfloat bitsToFloat(bool bits[32]) {\n  float signBit = float(bits[0]) * -2.0 + 1.0;\n  float exponent = getExponent(bits);\n  bool subnormal = abs(exponent - 0.0) < 0.01;\n  float mantissa = getMantissa(bits, subnormal);\n  float exponentBias = 127.0;\n  return signBit * mantissa * exp2(exponent - exponentBias - 23.0);\n}\n\n// Decode a 32-bit float from the RGBA color channels of a texel.\nfloat rgbaToFloat(vec4 texelRGBA, bool littleEndian) {\n  ivec4 rgbaBytes = floatsToBytes(texelRGBA, littleEndian);\n  bool bits[32];\n  bytesToBits(rgbaBytes, bits);\n  return bitsToFloat(bits);\n}\n\n#endif\n\nvec4 readVariable(sampler2D tex, int p, int s) {\n\n#ifdef PACK_FLOAT\n  return vec4(rgbaToFloat(texture2D(tex, vec2(4 * s, p) / resolution), littleEndian), \n  rgbaToFloat(texture2D(tex, vec2(4 * s + 1, p) / resolution), littleEndian), \n  rgbaToFloat(texture2D(tex, vec2(4 * s + 2, p) / resolution), littleEndian), \n  rgbaToFloat(texture2D(tex, vec2(4 * s + 3, p) / resolution), littleEndian));\n#else\n  return vec4(texture2D(tex, vec2(4 * s, p) / resolution).r, texture2D(tex, vec2(4 * s + 1, p) / resolution).r, texture2D(tex, vec2(4 * s + 2, p) / resolution).r, texture2D(tex, vec2(4 * s + 3, p) / resolution).r);\n#endif\n}\n\nvec3 reflection(vec3 v, vec3 bottomLeft, vec3 topRight) {\n  return  2.*(step(bottomLeft, v) - step(topRight, v)) - vec3(1.);\n}\nvec3 getE(vec3 position) {\n\n  vec3 E = electricField;\n\n  for (int i=0; i < BEAMLINE_ELEMENT_COUNT; i++) {\n    BeamlineElement ble =  beamline[i];\n    if (ble.type == BEAMLINE_ELEMENT_TYPE_ESTA) {\n      vec3 localPosition = position;\n      localPosition -= ble.middle;\n      localPosition.xz *= rot2D(ble.phi);\n      if (sdBox(localPosition, ble.size) <= 0.) {\n        E += vec3(0., 0., ble.strength);\n      }\n    }\n  }    \n  return E;\n}\n\nvec3 getB(vec3 position) {\n  vec3 B = magneticField;\n\n  for (int i=0; i < BEAMLINE_ELEMENT_COUNT; i++) {\n    BeamlineElement ble =  beamline[i];\n    vec3 localPosition = position;\n    localPosition -= ble.middle;\n    localPosition.xz *= rot2D(ble.phi);\n    if (sdBox(localPosition, ble.size) <= 0.) {\n      if (ble.type == BEAMLINE_ELEMENT_TYPE_DIPOLE) {\n        B += vec3(0., ble.strength, 0.);\n      } else if (ble.type == BEAMLINE_ELEMENT_TYPE_QUADRUPOLE) {\n        B += abs(ble.strength) * ((ble.strength > 0.)\n        ? vec3(localPosition.y, localPosition.x, 0)\n        : vec3(-localPosition.y, -localPosition.x, 0.));\n      }\n    }\n  }\n\n  return B;\n}\n\nvec4 push_position(int p) {\n\n  ParticleData particleData = getParticleData(p);\n  vec4 fourPosition = readVariable(ut_position, p, 0);\n\n  vec3 position = fourPosition.xyz;\n  float time  = fourPosition.w;\n\n  vec4 fourVelocity_current = readVariable(ut_velocity, p, 1);\n  vec4 fourVelocity_next = readVariable(ut_velocity, p, 0);\n\n  float nextTime = time + deltaTOverC;\n\n  vec4 next = vec4(position +  fourVelocity_next.xyz / fourVelocity_next.w  * deltaTOverC, nextTime);\n\n  return next;\n}\n\nvec4 push_velocity(int p) {\n\n  ParticleData particleData = getParticleData(p);\n\n  vec4 fourPosition = readVariable(ut_position, p, 1);\n  vec4 fourVelocity = readVariable(ut_velocity, p, 0);\n\n  vec3 velocity = (particleData.particleType > .1)  ? fourVelocity.xyz / fourVelocity.w : fourVelocity.xyz;\n  velocity = fourVelocity.xyz / fourVelocity.w;\n\n  vec3 intermediatePosition = fourPosition.xyz + .5 *  velocity * deltaTOverC;\n  vec3 E = getE(intermediatePosition);\n  vec3 B = getB(intermediatePosition);\n\n  float gamma = 1.;\n  vec3 u = fourVelocity.xyz;\n\n  if (particleData.particleType > .1) {\n\n    float chargeMassRatio = particleData.chargeMassRatio;\n    float hdtc_m =   chargeMassRatio * deltaTOverC / c / 2.;\n\n    u +=  hdtc_m * E;\n    gamma = sqrt(1. + dot(u/c, u/c));\n\n    vec3 t_ =  hdtc_m  * B  / gamma;\n    u += cross(u, t_);\n    vec3 s_ = 2.0 / (1.0 + t_*t_) * t_;\n    u += cross(u, s_);\n    u += hdtc_m * E;\n    gamma = sqrt(1. + dot(u/c, u/c));\n  }\n\n  if (boundingBoxSize > 0.) {\n\n    velocity = (particleData.particleType > .1)  ? u / gamma / c : velocity;\n    vec3 nextPosition = intermediatePosition.xyz + .5 *  velocity * deltaTOverC;\n    vec3 ref = reflection(\n      nextPosition.xyz,\n      boundingBoxCenter - vec3(boundingBoxSize),\n      boundingBoxCenter + vec3(boundingBoxSize)\n    );\n    u *= ref;\n\n  }\n  return vec4(u, gamma * c);\n}\nvec4 push(int p) {\n  return (variableIdx == 0)\n  ? push_position(p)\n  : push_velocity(p);\n}\n\nvec4 readVariable(int particle, int snapshot) {\n  return (variableIdx == 0)\n  ? readVariable(ut_position, particle, snapshot)\n  : readVariable(ut_velocity, particle, snapshot);\n}\n\nvoid main () {\n\n  int particle = int(gl_FragCoord.y - .5);\n  int snapshot = int(floor((gl_FragCoord.x - .5) / 4.));\n  int fourComponentIndex = int(floor(gl_FragCoord.x - .5))  - snapshot * 4;\n  initLatticeData();\n\n  \n  vec4 value = (snapshot == 0)\n    ? push(particle)\n    : (takeSnapshot == 0)\n      ? readVariable(particle, snapshot)\n      : readVariable(particle, snapshot-1);\n\n#ifdef PACK_FLOAT\n\n  gl_FragColor =\n  (fourComponentIndex == 0)\n  ? packFloat(value.x)\n  : (fourComponentIndex == 1)\n  ? packFloat(value.y)\n  : (fourComponentIndex == 2)\n  ? packFloat(value.z)\n  : packFloat(value.w);\n\n  // gl_FragColor =\n  // (fourComponentIndex == 0)\n  // ? floatToRgba(value.x, littleEndian)\n  // : (fourComponentIndex == 1)\n  // ? floatToRgba(value.y, littleEndian)\n  // : (fourComponentIndex == 2)\n  // ? floatToRgba(value.z, littleEndian)\n  // : floatToRgba(value.w, littleEndian);\n\n#else\n  \n  gl_FragColor =\n  (fourComponentIndex == 0)\n  ? vec4(value.x, 0., 0., 0.)\n  : (fourComponentIndex == 1)\n  ? vec4(value.y, 0., 0., 0.)\n  : (fourComponentIndex == 2)\n  ? vec4(value.z, 0., 0., 0.)\n  : vec4(value.w, 0., 0., 0.);\n\n#endif\n\n}\n";function fr(e){return`\n\n  ${e.activeBeamlineElements().length>0?"BeamlineElement beamline["+e.activeBeamlineElements().length+"];":"BeamlineElement beamline[1];"}\n  void initLatticeData() {\n    ${e.toGLSLDefinition()};\n  }\n  `}class hr{constructor(e=!0,t=100){if(window.performanceLogger)return window.performanceLogger;performance.clearMarks(),performance.clearMeasures(),this.current=null,this.active=e,this.running=!1,this.maxEntries=t,this.entryCount=0,this.entries=[],window.performanceLogger=this}start(e){this.active&&this.entryCount<this.maxEntries&&(this.entryCount++,this.markName=e,performance.mark(this.markName))}stop(){this.active&&(performance.mark(this.markName+" (stop)"),this.markName=null,this.running=!1)}report(){this.running&&this.stop();const e=performance.getEntriesByType("mark");return e.map(((t,n)=>{return{name:t.name,"t":(r=e[Math.min(n+1,e.length-1)].startTime-t.startTime,1*r.toFixed(1))};var r})).filter((e=>-1===e.name.indexOf("stop")))}}function pr(){const e=new Uint8Array([170,187]);return 48042===new Uint16Array(e.buffer)[0]}const dr=(e,{width:t,height:n},r,i)=>e.texture({width:t,height:n,min:"nearest",mag:"nearest",format:"rgba",type:r,data:i});class mr{constructor(e,t,n,r,i){this.regl=e,this.particleCount=t,this.snapshotCount=n,this.numberType=r,this.initialData=i,this.pingPong=0,this.data=[new Float32Array(4*n*t),new Float32Array(4*n*t)];const a=this.width=4*n,o=this.height=t;this.buffers=[0,1].map((()=>e.framebuffer({height:this.height,width:this.width,depthStencil:!1,color:dr(e,{width:a,height:o},r)}))),i&&this.load(i)}load(e){return this.data[0]=this.data[1]="float"===this.numberType?new Float32Array(e.map((e=>e.map((e=>[e,0,0,0])))).flat(2)):new Uint8Array(new Float32Array(e.flat()).buffer),this.buffers.forEach(((e,t)=>e.color[0].subimage({width:4,height:this.particleCount,data:this.data[t]}))),this}value(){return this.buffers[this.pingPong]}reset(){this.pingPong=0,this.load(this.initialData)}toTypedArray(e=this.pingPong,t=3){let n,r;if("uint8"===this.numberType){let t=new Uint8Array(this.particleCount*this.snapshotCount*4*4);this.regl({framebuffer:this.buffers[e]})((()=>{this.regl.read({data:t})})),r=Array.from(t),n=new Float32Array(t.buffer)}if("float"===this.numberType)try{const t=new Float32Array(this.particleCount*this.snapshotCount*4*4);this.regl({framebuffer:this.buffers[e]})((()=>{this.regl.read({data:t})})),n=t}catch(i){console.error(i)}return{colorUint8Array:r,float32Array:Array.from(n).map((e=>t?Math.round(e*Math.pow(10,t))/Math.pow(10,t):e))}}pack(e){const t=[];for(let n=0;n<this.particleCount;n++){const r=[];t.push(r);for(let t=0;t<this.snapshotCount;t++)if("uint8"===this.numberType){const i=4*(n*this.snapshotCount+t);r.push([e[i],e[i+1],e[i+2],e[i+3]])}else{const i=4*(n*this.snapshotCount+t)*4;r.push([e[i],e[i+4],e[i+8],e[i+12]])}}return t}}class gr{constructor(e,t,n){this.regl=e,this.particleCount=t.length;const r=t.map((e=>Math.sqrt(Math.pow(e[0]-n[0],2)+Math.pow(e[1]-n[1],2)+Math.pow(e[2]-n[2],2)))),i=Math.max(...r),a=r.map((e=>0===i?0:e/i));this.corrections=a.map((e=>i>0&&e<.7?e:1))}toTexture(){return this.regl.texture({data:this.corrections.map((e=>[e,0,0,0])).flat(),shape:[this.particleCount,1,4],type:"float"})}}const vr="QUAD",br={DRIF:{color:[.3,.3,.3],width:.1,height:.1,gap:0},SBEN:{color:[.55,0,0],width:.5,height:.5,gap:0},QUAD:{color:[1,.5,0],color_minus:[.5,.5,0],width:.5,height:.5,gap:0},ESTA:{color:[0,.8,0],width:.5,height:.5,gap:0}},yr=["DRIF","SBEN","QUAD","ESTA"];class xr{constructor(e){if(void 0===e)throw new Error("no default constructor");this.origin=e.origin||{phi:0,position:[0,1,0]};let t=this.origin.phi,[n,r,i]=this.origin.position,a=0;this.beamline=e.beamline.map((o=>{if(!e.elements[o])throw new Error(`element ${o} not defined`);const c=e.elements[o];a+=c.l;const u=c.angle?t+c.angle/2:t,f=[n,r,i];return[n,i]=[n-Math.sin(u)*c.l,i+Math.cos(u)*c.l],t=c.angle?t+c.angle:t,l(s({color:c.type===vr&&c.strength<0?br[c.type].color_minus:br[c.type].color,type:c.type},c.strength&&{strength:c.strength}),{middle:[(f[0]+n)/2,r,(f[2]+i)/2],phi:u,local_z_min:a-c.l,local_z_max:a,size:[br[c.type].width,br[c.type].height,c.l-br[c.type].gap]})}))}get transformations(){return this.beamline.map((e=>({type:e.type,translation:e.middle,phi:e.phi,theta:e.type===vr?2*Math.PI/360*45:0,scale:e.size})))}get colors(){return this.beamline.map((e=>e.type===vr&&e.strength<0?br[e.type].color_minus:br[e.type].color))}length(){return this.beamline.length&&this.beamline[this.beamline.length-1].local_z_max}activeBeamlineElements(){return this.beamline.filter((e=>"DRIF"!=e.type))}toGLSLDefinition(){return this.activeBeamlineElements().map(((e,t)=>`beamline[${t}] = BeamlineElement(\nvec3(${e.middle.join(",")}),\nvec3(${e.size[0]}, ${e.size[1]}, ${e.size[2]}),\n${e.phi?-e.phi.toFixed(10):"0."},\n${yr.indexOf(e.type)},\n${e.strength?e.strength.toFixed(10):"0."})`)).join(";\n")}}class wr{constructor(e,{model:t,runner:n,debug:r}){this.performanceLogger=new hr(r.logPerformance),this.performanceLogger.start("Simulation()"),this._regl=e,this.configuration={model:t,runner:n,debug:r},t.emitter.position||(t.emitter.position=t.lattice.origin.position),t.emitter.direction||(t.emitter.direction=[Math.sin(t.lattice.origin.phi),0,Math.cos(t.lattice.origin.phi)]);const{snapshotCount:i}=n,{particleCount:a,particleTypes:o,fourPositions:c,fourVelocities:u}=this.initialData=new cr(t.emitter);this.configuration.runner.numberType=this.configuration.runner.packFloat2UInt8?"uint8":"float",this.configuration.runner.snapshotCount=i,this.configuration.runner._iterationsPerSnapshot=n.iterationsPerSnapshot,this.configuration.runner._snapshotsPerTick=n.snapshotsPerTick,this.configuration.runner._iterationsPerRun=this.configuration.runner.iterationCount>0?this.configuration.runner.iterationCount:(this.configuration.runner.snapshotCount-1)*this.configuration.runner._iterationsPerSnapshot,this.colorCorrector=new gr(e,c,t.emitter.position),this.variables=l(s({},this.configuration.runner),{particleCount:a,snapshotCount:i,iterations:this.configuration.runner._iterationsPerRun,particleTypes:o,position:new mr(e,a,i,this.configuration.runner.numberType,c),velocity:new mr(e,a,i,this.configuration.runner.numberType,u),iteration:0,particleColorsAndTypes:e.texture({data:o.map((e=>rr[e].color.concat(e))),shape:[a,1,4],type:"uint8"}),colorCorrections:this.colorCorrector.toTexture(),particleChargesMassesChargeMassRatios:e.texture({data:o.map((e=>[rr[e].charge__qe,rr[e].mass__eVc_2,rr[e].chargeMassRatio__Ckg_1,e])).flat(),shape:[a,1,4],type:"float"})}),this.model={boundingBoxSize:t.boundingBoxSize,boundingBoxCenter:t.boundingBoxCenter,latticeConfig:t.lattice,lattice:new xr(t.lattice),interactions:{particleInteraction:t.interactions.particleInteraction,electricField:t.interactions.electricField,magneticField:t.interactions.magneticField}},this.log(),this.pusher="glsl"===this.configuration.runner.pusher?function(e,{variables:t,model:n}){const r=new hr;r.entries=[];const i=(r,i,a)=>{const o=fr(n.lattice);return e({profile:!0,framebuffer:()=>t[r].value(),primitive:"triangles",elements:null,offset:0,dither:!1,count:3,attributes:{aXY:[-4,-4,4,-4,0,4]},uniforms:{variableIdx:a,resolution:[4*t.snapshotCount,t.particleCount],snapshotCount:t.snapshotCount,particleCount:t.particleCount,deltaTOverC:t.iterationDurationOverC,particleInteraction:n.interactions.particleInteraction?1:0,electricField:n.interactions.electricField||[0,0,0],magneticField:n.interactions.magneticField||[0,0,1],takeSnapshot:()=>t.takeSnapshot,boundingBoxSize:n.boundingBoxSize,boundingBoxCenter:n.boundingBoxCenter||[0,1,0],littleEndian:pr(),ut_particleChargesMassesChargeMassRatios:()=>t.particleChargesMassesChargeMassRatios,ut_position:()=>t.position.buffers[(t.iteration+1)%2],ut_velocity:()=>"position"===r?t.velocity.buffers[t.iteration%2]:t.velocity.buffers[(t.iteration+1)%2]},vert:"precision highp float;\n#define GLSLIFY 1\nattribute vec2 aXY;\n\nvoid main () {\n  gl_Position = vec4(aXY, 0, 1);\n}\n",frag:[...t.packFloat2UInt8?["#define PACK_FLOAT"]:[],(t.packFloat2UInt8,ur).replace("/*__latticeDefinition__*/",n.lattice.toGLSLDefinition()).replace("/*__latticeChunkGLSL__*/",o).replace("/*__latticeSize__*/",`const int BEAMLINE_ELEMENT_COUNT_OR_1 = ${n.lattice.activeBeamlineElements().length||1}; const int BEAMLINE_ELEMENT_COUNT = ${n.lattice.activeBeamlineElements().length};`)].join("\n")})},a=i("velocity",0,1),o=i("position",0,0);return(n=1,i=!1)=>{for(let e=0;e<n;e++){t.iteration++,t.position.pingPong=t.iteration%2,t.velocity.pingPong=t.iteration%2;const e=Math.floor(t.iteration/t.iterationsPerSnapshot);t.segments=t.particleCount*Math.min(e+t.iteration-e*t.iterationsPerSnapshot,t.snapshotCount-1),t.takeSnapshot=1===t.iterationsPerSnapshot||t.iteration%t.iterationsPerSnapshot==1?1:0,a(),o()}i&&(e.poll(),r.entries.push({name:"pushVelocity",particleCount:t.particleCount,snapshotCount:t.snapshotCount,packFloat2UInt8:t.packFloat2UInt8,iterations:t.iteration,stats:a.stats}),r.entries.push({name:"pushPosition",particleCount:t.particleCount,snapshotCount:t.snapshotCount,packFloat2UInt8:t.packFloat2UInt8,iterations:t.iteration,stats:o.stats}))}}(this._regl,{runner:this.configuration.runner,variables:this.variables,model:this.model,debug:this.debug}):function({runner:e,variables:t,model:n,debug:r}){(new hr).entries=[];const i=(n.lattice,t.snapshotCount,t.particleCount,t.iterationDurationOverC,n.interactions.particleInteraction,n.interactions.electricField,n.interactions.magneticField,n.boundingBoxSize,n.boundingBoxCenter,e.littleEndian,t.particleChargesMassesChargeMassRatios,()=>{for(let e=0;e<t.particleCount;e++)console.log(t.position.data[(t.iteration+1)%2])});return(e=1,n=!1)=>{for(let r=0;r<e;r++){t.iteration++,t.position.pingPong=t.iteration%2,t.velocity.pingPong=t.iteration%2;const e=Math.floor(t.iteration/t.iterationsPerSnapshot);t.segments=t.particleCount*Math.min(e+t.iteration-e*t.iterationsPerSnapshot,t.snapshotCount-1),t.takeSnapshot=1===t.iterationsPerSnapshot||t.iteration%t.iterationsPerSnapshot==1?1:0,i()}}}({runner:this.configuration.runner,variables:this.variables,model:this.model,debug:this.debug}),this.performanceLogger.stop()}push(e=1,t=!1){this.performanceLogger.start(`simulation.push (n=${e})`),this.pusher(e,t),this.log(),this.performanceLogger.stop()}logEntry(){const e=this.variables.position.toTypedArray(),t=this.variables.velocity.toTypedArray();return{iteration:this.variables.iteration,position:e,velocity:t}}log(){this.configuration.debug.logPushing&&(this._logStore||(this._logStore=[]),this._logStore.push(this.dump()))}dump(e=3){const t=this.variables.position.pack(this.variables.position.toTypedArray(this.variables.position.pingPong,e).float32Array),n=this.variables.position.pack(this.variables.velocity.toTypedArray(this.variables.position.pingPong,e).float32Array);return JSON.parse(JSON.stringify({logEntry:this.logEntry(),packedPositions:t,packedVelocities:n,colorCorrections:this.colorCorrector.corrections,configuration:this.configuration,particleTypes:this.variables.particleTypes}))}reset(){this.variables.position.reset(),this.variables.velocity.reset(),this.variables.iteration=0}prerender(){this.push(this.configuration.runner._iterationsPerRun,!1)}}const _r="nobreak",Ar="stepwise",Sr="SBEN",Tr="QUAD",Er="ESTA",Cr="initial",Mr="active",Pr="paused",Or="restart";class Dr{constructor(e,{prerender:t=!1,loops:n=0,mode:r=Ar},i){this.performanceLogger=new hr(i.logPerformance),this._simulation=e,this._prerender=t,this._loopCountMax=n,this._isLooping=n>0,this._mode=r,this.fsm={state:Cr}}toggleLooping(){this._loopCount=0,this._loopCountMax=10,this._isLooping=!this._isLooping}toggleMode(){this._mode=this._mode===Ar?_r:Ar}toggleActivity(){this.fsm.state===Mr?this.fsm={state:Pr}:this.fsm.state===Pr&&(this.fsm={state:Mr},this._isLooping&&(this._loopCount=1))}next(){const e=this._simulation.variables.iteration;this.fsm.state===Cr&&(this._loopCount=1,this._prerender?(this._simulation.prerender(),this.fsm=0===this._loopCountMax?{state:Pr}:{state:Mr}):this.fsm={state:Mr}),this.fsm.state===Mr?this._simulation.variables.iteration>this._simulation.configuration.runner._iterationsPerRun-1?this._isLooping&&this._loopCount<=this._loopCountMax?this.fsm.state="restart":this.fsm.state=Pr:(this._simulation.push(this._simulation.configuration.runner._iterationsPerSnapshot*this._simulation.configuration.runner._snapshotsPerTick),this._mode===Ar&&(this.fsm.state=Pr)):this.fsm.state===Or&&(this._loopCount++,this._simulation.reset(),this._simulation.push(this._simulation.configuration.runner._iterationsPerSnapshot*this._simulation.configuration.runner._snapshotsPerTick),this.fsm.state=this.fsm.state.replace(/restart/,this._mode===Ar?Pr:Mr));const t=this._simulation.variables.iteration;return{changed:t!==e,tick:t}}}var Ir=function(e,t,n,r,i){var a=0,o=0,s=[];n=void 0!==n?n:5;var l=0;(e=void 0!==e?e:1)>0&&l++,(t=void 0!==t?t:1)>0&&l++;for(var c=((r=void 0!==r?r:64)+1)*((i=void 0!==i?i:8)+1)+(r+2)*l,u=r*i*2+r*l,f=new Array(c),h=new Array(c),p=new Array(c),d=new Array(u),m=(t-e)/n,g=2*Math.PI,v=0;v<=i;v++){for(var b=[],y=v/i,x=y*(t-e)+e,w=0;w<=r;w++){var _=w/r,A=_*g,S=Math.sin(A),T=Math.cos(A);h[a]=[x*S,-y*n+n/2,x*T],f[a]=[S,m,T],p[a]=[_,1-y],b.push(a),a++}s.push(b)}for(w=0;w<r;w++)for(v=0;v<i;v++){var E=s[v][w],C=s[v+1][w],M=s[v+1][w+1],P=s[v][w+1];d[o]=[E,C,P],o++,d[o]=[C,M,P],o++}var O=function(i){new Array(3).fill(0);for(var s=!0===i?e:t,l=!0===i?1:-1,c=a,u=1;u<=r;u++)h[a]=[0,n*l/2,0],f[a]=[0,l,0],p[a]=[.5,.5],a++;var m=a;for(u=0;u<=r;u++){var v=u/r*g,b=Math.cos(v),y=Math.sin(v);h[a]=[s*y,n*l/2,s*b],f[a]=[0,l,0],p[a]=[.5*b+.5,.5*y*l+.5],a++}for(u=0;u<r;u++){var x=c+u,w=m+u;!0===i?(d[o]=[w,w+1,x],o++):(d[o]=[w+1,w,x],o++)}};return e>0&&O(!0),t>0&&O(!1),{uvs:p,cells:d,normals:f,positions:h}};function Lr(e){let t=[],n=[],r=[],i=[],a=0;return e.forEach((function(e){n=n.concat(e.uvs),r=r.concat(e.normals),t=t.concat(e.positions),i=i.concat(function(e,t){return e.map((function(e){return e.map((function(e){return e+t}))}))}(e.cells,a)),a+=e.positions.length})),{cells:i,positions:t,normals:r,uvs:n}}var kr="precision mediump float;\n#define GLSLIFY 1\nvarying vec3 vPosition;\nvarying vec3 vNormal;\nvarying vec3 vNormalOrig;\nvarying vec3 vColor;\nvarying vec2 vUv;\nuniform float ambientLightAmount;\nuniform float vColorCorrection;\nuniform float diffuseLightAmount;\nuniform vec3 shadowDirection;\nuniform float pathicleWidth;\nuniform vec3 eye;\nvarying vec3 vScale;\n\nfloat edger(vec2 uv, vec3 boxScale, float edgeWidth, vec3 normal) {\n\n  float edgeXY =  smoothstep(0., edgeWidth, uv.x*boxScale.z) * smoothstep(0., edgeWidth, (1.-uv.x)*boxScale.z);\n  float edgeXZ =  smoothstep(0., edgeWidth, uv.y*boxScale.y) * smoothstep(0., edgeWidth, (1.-uv.y)*boxScale.y);\n  float edgeX = (1.-(edgeXY*edgeXZ))*abs(normal.x);\n\n  float edgeYX =  smoothstep(0., edgeWidth, uv.x*boxScale.x) * smoothstep(0., edgeWidth, (1.-uv.x)*boxScale.x);\n  float edgeYZ =  smoothstep(0., edgeWidth, uv.y*boxScale.z) * smoothstep(0., edgeWidth, (1.-uv.y)*boxScale.z);\n  float edgeY = (1.-(edgeYX*edgeYZ))*abs(normal.y);\n\n  float edgeZX =  smoothstep(0., edgeWidth, uv.x*boxScale.x) * smoothstep(0., edgeWidth, (1.-uv.x)*boxScale.x);\n  float edgeZY =  smoothstep(0., edgeWidth, uv.y*boxScale.z) * smoothstep(0., edgeWidth, (1.-uv.y)*boxScale.z);\n  float edgeZ = (1.-(edgeZX*edgeZY))*abs(normal.z);\n\n  return clamp(edgeX+edgeY, 0., 1.);\n}\n\n//\n//float edgerFeathered(vec2 uv, vec3 boxScale, float edgeWidth) {\n//\n//  float feather = .1;\n//\n//  float edgeXY =  smoothstep(edgeWidth, edgeWidth+feather, uv.x*boxScale.z) * smoothstep(edgeWidth, edgeWidth+feather, (1.-uv.x)*boxScale.z);\n//  float edgeXZ =  smoothstep(edgeWidth, edgeWidth+feather, uv.y*boxScale.y) * smoothstep(edgeWidth, edgeWidth+feather, (1.-uv.y)*boxScale.y);\n//  float edgeX = (1.-(edgeXY*edgeXZ))*abs(normal.x);\n//\n//  return clamp(edgeX, 0., 1.);\n//}\n//\n//\n//float edgerHard(vec2 uv, vec3 boxScale, float edgeWidth) {\n//  float edgeXY =  step(edgeWidth*(1.+uv.x*boxScale.z), uv.x*boxScale.z) * step(edgeWidth, (1.-uv.x)*boxScale.z);\n//  float edgeXZ =  step(edgeWidth*(0.5+uv.x/2.), uv.y*boxScale.y) * step(edgeWidth*(0.5+uv.x/2.), (1.-uv.y)*boxScale.y);\n//  float edgeX = (1.-(edgeXZ))*abs(normal.x);\n//\n//  return clamp(edgeX, 0., 1.);\n//}\n\nfloat diffuse(vec3 lightDir, vec3 nrm)\n{\n  float diffAmt = max(0.0, dot(nrm, lightDir));\n  return diffAmt;\n}\nfloat specular(vec3 lightDir, vec3 viewDir, vec3 nrm, float shininess)\n{\n  vec3 halfVec = normalize(viewDir + lightDir);\n  float specAmt = max(0.0, dot(halfVec, nrm));\n  return pow(specAmt, shininess);\n}\n\nstruct DirectionalLight\n{\n  vec3 direction;\n  vec3 color;\n  float intensity;\n};\n#define NUM_DIR_LIGHTS 3\nDirectionalLight directionalLights[NUM_DIR_LIGHTS];\n\nvoid main () {\n\n  #ifdef lighting\n\n  if (length(vColor) == 0.) discard;\n  vec3 color = vColor;\n  gl_FragColor = vec4(vColor, 1.);\n\n  vec3 viewDir = normalize(eye - vPosition);\n  vec3 normal = normalize(vNormal);\n\n  directionalLights[0] = DirectionalLight(shadowDirection, vec3(1.), .15);\n  directionalLights[1] = DirectionalLight(shadowDirection+vec3(-5., 0., 5.), vec3(1.), .15);\n  directionalLights[2] = DirectionalLight(shadowDirection+vec3(5., 0., -5.), vec3(1.), .15);\n  vec3 edgedColor = vColor;\n  vec3 finalColor = ambientLightAmount * vColor;\n\n  for (int i = 0; i < NUM_DIR_LIGHTS; ++i)\n  {\n    DirectionalLight light = directionalLights[i];\n    vec3 sceneLight = mix(light.color, edgedColor.rgb + light.color * 0.5, 0.5);\n    float diffAmt = diffuse(light.direction, normal) * light.intensity;\n    float specAmt = specular(light.direction, viewDir, normal, 0.0) * light.intensity;\n\n    float shadow = 1.; //.9 * vColorCorrection;//clamp(vColorCorrection + abs(2.+v_position.y*5.), 0., 1.);\n    float specMask = edger(vUv, vScale, 1. * .02, vNormalOrig);\n//    float specMask = edger(vUv, vScale, 1. * .1, vNormalOrig) * smoothstep(5., 2., length(vPosition-eye));\n    vec3 specCol = specMask * sceneLight * specAmt;\n    finalColor += shadow * vColor * diffAmt * light.color;\n    finalColor += shadow * specCol * sceneLight;\n  }\n\n  gl_FragColor =vec4(finalColor, 1.);\n//  gl_FragColor = vec4(1., 0., 0., 1.);\n//  gl_FragColor = vec4(vColor, .5);\n  #endif\n\n}\n",zr=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e};var Rr={create:function(){var e=new Float32Array(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},clone:function(e){var t=new Float32Array(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},identity:Re,transpose:function(e,t){if(e===t){var n=t[1],r=t[2],i=t[3],a=t[6],o=t[7],s=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=n,e[6]=t[9],e[7]=t[13],e[8]=r,e[9]=a,e[11]=t[14],e[12]=i,e[13]=o,e[14]=s}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},invert:Fe,adjoint:function(e,t){var n=t[0],r=t[1],i=t[2],a=t[3],o=t[4],s=t[5],l=t[6],c=t[7],u=t[8],f=t[9],h=t[10],p=t[11],d=t[12],m=t[13],g=t[14],v=t[15];return e[0]=s*(h*v-p*g)-f*(l*v-c*g)+m*(l*p-c*h),e[1]=-(r*(h*v-p*g)-f*(i*v-a*g)+m*(i*p-a*h)),e[2]=r*(l*v-c*g)-s*(i*v-a*g)+m*(i*c-a*l),e[3]=-(r*(l*p-c*h)-s*(i*p-a*h)+f*(i*c-a*l)),e[4]=-(o*(h*v-p*g)-u*(l*v-c*g)+d*(l*p-c*h)),e[5]=n*(h*v-p*g)-u*(i*v-a*g)+d*(i*p-a*h),e[6]=-(n*(l*v-c*g)-o*(i*v-a*g)+d*(i*c-a*l)),e[7]=n*(l*p-c*h)-o*(i*p-a*h)+u*(i*c-a*l),e[8]=o*(f*v-p*m)-u*(s*v-c*m)+d*(s*p-c*f),e[9]=-(n*(f*v-p*m)-u*(r*v-a*m)+d*(r*p-a*f)),e[10]=n*(s*v-c*m)-o*(r*v-a*m)+d*(r*c-a*s),e[11]=-(n*(s*p-c*f)-o*(r*p-a*f)+u*(r*c-a*s)),e[12]=-(o*(f*g-h*m)-u*(s*g-l*m)+d*(s*h-l*f)),e[13]=n*(f*g-h*m)-u*(r*g-i*m)+d*(r*h-i*f),e[14]=-(n*(s*g-l*m)-o*(r*g-i*m)+d*(r*l-i*s)),e[15]=n*(s*h-l*f)-o*(r*h-i*f)+u*(r*l-i*s),e},determinant:function(e){var t=e[0],n=e[1],r=e[2],i=e[3],a=e[4],o=e[5],s=e[6],l=e[7],c=e[8],u=e[9],f=e[10],h=e[11],p=e[12],d=e[13],m=e[14],g=e[15];return(t*o-n*a)*(f*g-h*m)-(t*s-r*a)*(u*g-h*d)+(t*l-i*a)*(u*m-f*d)+(n*s-r*o)*(c*g-h*p)-(n*l-i*o)*(c*m-f*p)+(r*l-i*s)*(c*d-u*p)},multiply:function(e,t,n){var r=t[0],i=t[1],a=t[2],o=t[3],s=t[4],l=t[5],c=t[6],u=t[7],f=t[8],h=t[9],p=t[10],d=t[11],m=t[12],g=t[13],v=t[14],b=t[15],y=n[0],x=n[1],w=n[2],_=n[3];return e[0]=y*r+x*s+w*f+_*m,e[1]=y*i+x*l+w*h+_*g,e[2]=y*a+x*c+w*p+_*v,e[3]=y*o+x*u+w*d+_*b,y=n[4],x=n[5],w=n[6],_=n[7],e[4]=y*r+x*s+w*f+_*m,e[5]=y*i+x*l+w*h+_*g,e[6]=y*a+x*c+w*p+_*v,e[7]=y*o+x*u+w*d+_*b,y=n[8],x=n[9],w=n[10],_=n[11],e[8]=y*r+x*s+w*f+_*m,e[9]=y*i+x*l+w*h+_*g,e[10]=y*a+x*c+w*p+_*v,e[11]=y*o+x*u+w*d+_*b,y=n[12],x=n[13],w=n[14],_=n[15],e[12]=y*r+x*s+w*f+_*m,e[13]=y*i+x*l+w*h+_*g,e[14]=y*a+x*c+w*p+_*v,e[15]=y*o+x*u+w*d+_*b,e},translate:Be,scale:je,rotate:function(e,t,n,r){var i,a,o,s,l,c,u,f,h,p,d,m,g,v,b,y,x,w,_,A,S,T,E,C,M=r[0],P=r[1],O=r[2],D=Math.sqrt(M*M+P*P+O*O);if(Math.abs(D)<1e-6)return null;M*=D=1/D,P*=D,O*=D,i=Math.sin(n),a=Math.cos(n),o=1-a,s=t[0],l=t[1],c=t[2],u=t[3],f=t[4],h=t[5],p=t[6],d=t[7],m=t[8],g=t[9],v=t[10],b=t[11],y=M*M*o+a,x=P*M*o+O*i,w=O*M*o-P*i,_=M*P*o-O*i,A=P*P*o+a,S=O*P*o+M*i,T=M*O*o+P*i,E=P*O*o-M*i,C=O*O*o+a,e[0]=s*y+f*x+m*w,e[1]=l*y+h*x+g*w,e[2]=c*y+p*x+v*w,e[3]=u*y+d*x+b*w,e[4]=s*_+f*A+m*S,e[5]=l*_+h*A+g*S,e[6]=c*_+p*A+v*S,e[7]=u*_+d*A+b*S,e[8]=s*T+f*E+m*C,e[9]=l*T+h*E+g*C,e[10]=c*T+p*E+v*C,e[11]=u*T+d*E+b*C,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]);return e},rotateX:function(e,t,n){var r=Math.sin(n),i=Math.cos(n),a=t[4],o=t[5],s=t[6],l=t[7],c=t[8],u=t[9],f=t[10],h=t[11];t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]);return e[4]=a*i+c*r,e[5]=o*i+u*r,e[6]=s*i+f*r,e[7]=l*i+h*r,e[8]=c*i-a*r,e[9]=u*i-o*r,e[10]=f*i-s*r,e[11]=h*i-l*r,e},rotateY:function(e,t,n){var r=Math.sin(n),i=Math.cos(n),a=t[0],o=t[1],s=t[2],l=t[3],c=t[8],u=t[9],f=t[10],h=t[11];t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]);return e[0]=a*i-c*r,e[1]=o*i-u*r,e[2]=s*i-f*r,e[3]=l*i-h*r,e[8]=a*r+c*i,e[9]=o*r+u*i,e[10]=s*r+f*i,e[11]=l*r+h*i,e},rotateZ:function(e,t,n){var r=Math.sin(n),i=Math.cos(n),a=t[0],o=t[1],s=t[2],l=t[3],c=t[4],u=t[5],f=t[6],h=t[7];t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]);return e[0]=a*i+c*r,e[1]=o*i+u*r,e[2]=s*i+f*r,e[3]=l*i+h*r,e[4]=c*i-a*r,e[5]=u*i-o*r,e[6]=f*i-s*r,e[7]=h*i-l*r,e},fromRotation:function(e,t,n){var r,i,a,o=n[0],s=n[1],l=n[2],c=Math.sqrt(o*o+s*s+l*l);if(Math.abs(c)<1e-6)return null;return o*=c=1/c,s*=c,l*=c,r=Math.sin(t),i=Math.cos(t),a=1-i,e[0]=o*o*a+i,e[1]=s*o*a+l*r,e[2]=l*o*a-s*r,e[3]=0,e[4]=o*s*a-l*r,e[5]=s*s*a+i,e[6]=l*s*a+o*r,e[7]=0,e[8]=o*l*a+s*r,e[9]=s*l*a-o*r,e[10]=l*l*a+i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromRotationTranslation:function(e,t,n){var r=t[0],i=t[1],a=t[2],o=t[3],s=r+r,l=i+i,c=a+a,u=r*s,f=r*l,h=r*c,p=i*l,d=i*c,m=a*c,g=o*s,v=o*l,b=o*c;return e[0]=1-(p+m),e[1]=f+b,e[2]=h-v,e[3]=0,e[4]=f-b,e[5]=1-(u+m),e[6]=d+g,e[7]=0,e[8]=h+v,e[9]=d-g,e[10]=1-(u+p),e[11]=0,e[12]=n[0],e[13]=n[1],e[14]=n[2],e[15]=1,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromTranslation:zr,fromXRotation:function(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=n,e[7]=0,e[8]=0,e[9]=-n,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromYRotation:function(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=0,e[2]=-n,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=n,e[9]=0,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromZRotation:function(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=n,e[2]=0,e[3]=0,e[4]=-n,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromQuat:function(e,t){var n=t[0],r=t[1],i=t[2],a=t[3],o=n+n,s=r+r,l=i+i,c=n*o,u=r*o,f=r*s,h=i*o,p=i*s,d=i*l,m=a*o,g=a*s,v=a*l;return e[0]=1-f-d,e[1]=u+v,e[2]=h-g,e[3]=0,e[4]=u-v,e[5]=1-c-d,e[6]=p+m,e[7]=0,e[8]=h+g,e[9]=p-m,e[10]=1-c-f,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},frustum:function(e,t,n,r,i,a,o){var s=1/(n-t),l=1/(i-r),c=1/(a-o);return e[0]=2*a*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*a*l,e[6]=0,e[7]=0,e[8]=(n+t)*s,e[9]=(i+r)*l,e[10]=(o+a)*c,e[11]=-1,e[12]=0,e[13]=0,e[14]=o*a*2*c,e[15]=0,e},perspective:Ve,perspectiveFromFieldOfView:function(e,t,n,r){var i=Math.tan(t.upDegrees*Math.PI/180),a=Math.tan(t.downDegrees*Math.PI/180),o=Math.tan(t.leftDegrees*Math.PI/180),s=Math.tan(t.rightDegrees*Math.PI/180),l=2/(o+s),c=2/(i+a);return e[0]=l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=c,e[6]=0,e[7]=0,e[8]=-(o-s)*l*.5,e[9]=(i-a)*c*.5,e[10]=r/(n-r),e[11]=-1,e[12]=0,e[13]=0,e[14]=r*n/(n-r),e[15]=0,e},ortho:function(e,t,n,r,i,a,o){var s=1/(t-n),l=1/(r-i),c=1/(a-o);return e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*c,e[11]=0,e[12]=(t+n)*s,e[13]=(i+r)*l,e[14]=(o+a)*c,e[15]=1,e},lookAt:We,str:function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"}};const Fr=()=>{const e=[];for(let t=0;t<51;t++)for(let n=0;n<3;n++)for(let r=0;r<51;r++)e.push([.1*(t-25),.1*(n-1)+1,.1*(r-25)]);return e};var Br=function(e,t,n,r,i,a){void 0===e&&(e=1),void 0===t&&(t=e),void 0===n&&(n=e),void 0===r&&(r=1),void 0===i&&(i=r),void 0===a&&(a=r);var o=0,s=[],l=[],c=[],u=[];function f(e,t,n,r,i,a,f,h,p,d){for(var m=o,g=0;g<=f;g++)for(var v=0;v<=a;v++){var b=s[o]=[0,0,0];b[e]=(-r/2+v*r/a)*p,b[t]=(-i/2+g*i/f)*d,b[n]=h;var y=l[o]=[0,0,0];y[e]=0,y[t]=0,y[n]=h/Math.abs(h);var x=c[o]=[0,0];x[0]=v/a,x[1]=1-g/f,++o}for(g=0;g<f;g++)for(v=0;v<a;v++){var w=m+g*(a+1)+v;u.push([w,w+a+1,w+a+2]),u.push([w,w+a+2,w+1])}}return f(0,1,2,e,t,r,i,n/2,1,-1),f(0,1,2,e,t,r,i,-n/2,-1,-1),f(2,1,0,n,t,a,i,-e/2,1,-1),f(2,1,0,n,t,a,i,e/2,-1,-1),f(0,2,1,e,n,r,a,t/2,1,1),f(0,2,1,e,n,r,a,-t/2,1,-1),{positions:s,normals:l,uvs:c,cells:u}},jr="precision highp float;\n#define GLSLIFY 1\nattribute vec3 aPosition;\n\nattribute vec3 aNormal;\nattribute vec2 aUV;\n\nattribute float a_particle;\nattribute float a_snapshot;\n\nuniform int particleCount;\nuniform int snapshotCount;\nuniform int iterations;\nuniform int packFloat2UInt8;\n\nuniform vec2 viewRange;\n\nuniform float pathicleWidth;\nuniform float pathicleGap;\nuniform float pathicleHeight;\nuniform float stageGrid_size;\n\nuniform vec2 resolution;\nuniform sampler2D utColorCorrections;\nuniform sampler2D utParticleColorAndType;\nuniform sampler2D ut_position;\nuniform sampler2D ut_velocity;\nuniform mat4 projection, view, model;\nuniform vec3 eye;\n\nuniform mat4 shadowProjectionMatrix;\nuniform mat4 shadowViewMatrix;\nuniform vec3 shadowDirection;\nuniform bool littleEndian;\nvarying float v_visibility;\nvarying vec3 vScale;\nvarying vec3 v_position;\nvarying vec3 vNormal;\nvarying vec3 vNormalOrig;\nvarying vec2 vUv;\nvarying vec3 vShadowCoord;\nvarying vec3 vColor;\nvarying float vColorCorrection;\nvarying vec4 v_lightNDC;\nuniform sampler2D shadowMap;\n\nconst mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);\n\nfloat inverse(float m) {\n  return 1.0 / m;\n}\n\nmat2 inverse(mat2 m) {\n  return mat2(m[1][1],-m[0][1],\n             -m[1][0], m[0][0]) / (m[0][0]*m[1][1] - m[0][1]*m[1][0]);\n}\n\nmat3 inverse(mat3 m) {\n  float a00 = m[0][0], a01 = m[0][1], a02 = m[0][2];\n  float a10 = m[1][0], a11 = m[1][1], a12 = m[1][2];\n  float a20 = m[2][0], a21 = m[2][1], a22 = m[2][2];\n\n  float b01 = a22 * a11 - a12 * a21;\n  float b11 = -a22 * a10 + a12 * a20;\n  float b21 = a21 * a10 - a11 * a20;\n\n  float det = a00 * b01 + a01 * b11 + a02 * b21;\n\n  return mat3(b01, (-a22 * a01 + a02 * a21), (a12 * a01 - a02 * a11),\n              b11, (a22 * a00 - a02 * a20), (-a12 * a00 + a02 * a10),\n              b21, (-a21 * a00 + a01 * a20), (a11 * a00 - a01 * a10)) / det;\n}\n\nmat4 inverse(mat4 m) {\n  float\n      a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n      a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n      a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n      a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\n\n      b00 = a00 * a11 - a01 * a10,\n      b01 = a00 * a12 - a02 * a10,\n      b02 = a00 * a13 - a03 * a10,\n      b03 = a01 * a12 - a02 * a11,\n      b04 = a01 * a13 - a03 * a11,\n      b05 = a02 * a13 - a03 * a12,\n      b06 = a20 * a31 - a21 * a30,\n      b07 = a20 * a32 - a22 * a30,\n      b08 = a20 * a33 - a23 * a30,\n      b09 = a21 * a32 - a22 * a31,\n      b10 = a21 * a33 - a23 * a31,\n      b11 = a22 * a33 - a23 * a32,\n\n      det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n\n  return mat4(\n      a11 * b11 - a12 * b10 + a13 * b09,\n      a02 * b10 - a01 * b11 - a03 * b09,\n      a31 * b05 - a32 * b04 + a33 * b03,\n      a22 * b04 - a21 * b05 - a23 * b03,\n      a12 * b08 - a10 * b11 - a13 * b07,\n      a00 * b11 - a02 * b08 + a03 * b07,\n      a32 * b02 - a30 * b05 - a33 * b01,\n      a20 * b05 - a22 * b02 + a23 * b01,\n      a10 * b10 - a11 * b08 + a13 * b06,\n      a01 * b08 - a00 * b10 - a03 * b06,\n      a30 * b04 - a31 * b02 + a33 * b00,\n      a21 * b02 - a20 * b04 - a23 * b00,\n      a11 * b07 - a10 * b09 - a12 * b06,\n      a00 * b09 - a01 * b07 + a02 * b06,\n      a31 * b01 - a30 * b03 - a32 * b00,\n      a20 * b03 - a21 * b01 + a22 * b00) / det;\n}\n\nfloat transpose(float m) {\n  return m;\n}\n\nmat2 transpose(mat2 m) {\n  return mat2(m[0][0], m[1][0],\n              m[0][1], m[1][1]);\n}\n\nmat3 transpose(mat3 m) {\n  return mat3(m[0][0], m[1][0], m[2][0],\n              m[0][1], m[1][1], m[2][1],\n              m[0][2], m[1][2], m[2][2]);\n}\n\nmat4 transpose(mat4 m) {\n  return mat4(m[0][0], m[1][0], m[2][0], m[3][0],\n              m[0][1], m[1][1], m[2][1], m[3][1],\n              m[0][2], m[1][2], m[2][2], m[3][2],\n              m[0][3], m[1][3], m[2][3], m[3][3]);\n}\n\nmat4 lookAt(vec3 eye, vec3 at, vec3 up) {\n  vec3 zaxis = normalize(eye - at);\n  vec3 xaxis = normalize(cross(zaxis, up));\n  vec3 yaxis = cross(xaxis, zaxis);\n  zaxis *= -1.;\n  return mat4(\n  vec4(xaxis.x, xaxis.y, xaxis.z, -dot(xaxis, eye)),\n  vec4(yaxis.x, yaxis.y, yaxis.z, -dot(yaxis, eye)),\n  vec4(zaxis.x, zaxis.y, zaxis.z, -dot(zaxis, eye)),\n  vec4(0, 0, 0, 1)\n  );\n}\n\n#ifdef PACK_FLOAT\n\n// Denormalize 8-bit color channels to integers in the range 0 to 255.\nivec4 floatsToBytes(vec4 inputFloats, bool littleEndian) {\n  ivec4 bytes = ivec4(inputFloats * 255.0);\n  return (\n    littleEndian\n    ? bytes.abgr\n    : bytes\n  );\n}\n\n// Break the four bytes down into an array of 32 bits.\nvoid bytesToBits(const in ivec4 bytes, out bool bits[32]) {\n  for (int channelIndex = 0; channelIndex < 4; ++channelIndex) {\n    float acc = float(bytes[channelIndex]);\n    for (int indexInByte = 7; indexInByte >= 0; --indexInByte) {\n      float powerOfTwo = exp2(float(indexInByte));\n      bool bit = acc >= powerOfTwo;\n      bits[channelIndex * 8 + (7 - indexInByte)] = bit;\n      acc = mod(acc, powerOfTwo);\n    }\n  }\n}\n\n// Compute the exponent of the 32-bit float.\nfloat getExponent(bool bits[32]) {\n  const int startIndex = 1;\n  const int bitStringLength = 8;\n  const int endBeforeIndex = startIndex + bitStringLength;\n  float acc = 0.0;\n  int pow2 = bitStringLength - 1;\n  for (int bitIndex = startIndex; bitIndex < endBeforeIndex; ++bitIndex) {\n    acc += float(bits[bitIndex]) * exp2(float(pow2--));\n  }\n  return acc;\n}\n\n// Compute the mantissa of the 32-bit float.\nfloat getMantissa(bool bits[32], bool subnormal) {\n  const int startIndex = 9;\n  const int bitStringLength = 23;\n  const int endBeforeIndex = startIndex + bitStringLength;\n  // Leading/implicit/hidden bit convention:\n  // If the number is not subnormal (with exponent 0), we add a leading 1 digit.\n  float acc = float(!subnormal) * exp2(float(bitStringLength));\n  int pow2 = bitStringLength - 1;\n  for (int bitIndex = startIndex; bitIndex < endBeforeIndex; ++bitIndex) {\n    acc += float(bits[bitIndex]) * exp2(float(pow2--));\n  }\n  return acc;\n}\n\n// Parse the float from its 32 bits.\nfloat bitsToFloat(bool bits[32]) {\n  float signBit = float(bits[0]) * -2.0 + 1.0;\n  float exponent = getExponent(bits);\n  bool subnormal = abs(exponent - 0.0) < 0.01;\n  float mantissa = getMantissa(bits, subnormal);\n  float exponentBias = 127.0;\n  return signBit * mantissa * exp2(exponent - exponentBias - 23.0);\n}\n\n// Decode a 32-bit float from the RGBA color channels of a texel.\nfloat rgbaToFloat(vec4 texelRGBA, bool littleEndian) {\n  ivec4 rgbaBytes = floatsToBytes(texelRGBA, littleEndian);\n  bool bits[32];\n  bytesToBits(rgbaBytes, bits);\n  return bitsToFloat(bits);\n}\n\n#endif\n\nvec4 readVariable(sampler2D tex, int p, int s) {\n\n#ifdef PACK_FLOAT\n  return vec4(rgbaToFloat(texture2D(tex, vec2(4 * s, p) / resolution), littleEndian), \n  rgbaToFloat(texture2D(tex, vec2(4 * s + 1, p) / resolution), littleEndian), \n  rgbaToFloat(texture2D(tex, vec2(4 * s + 2, p) / resolution), littleEndian), \n  rgbaToFloat(texture2D(tex, vec2(4 * s + 3, p) / resolution), littleEndian));\n#else\n  return vec4(texture2D(tex, vec2(4 * s, p) / resolution).r, texture2D(tex, vec2(4 * s + 1, p) / resolution).r, texture2D(tex, vec2(4 * s + 2, p) / resolution).r, texture2D(tex, vec2(4 * s + 3, p) / resolution).r);\n#endif\n}\n\nfloat unpackRGBA (vec4 v) {\n  return dot(v, 1.0 / vec4(1.0, 255.0, 65025.0, 16581375.0));\n}\nfloat shadowValue() {\n  vec3 tex = texture2D(shadowMap, vUv).rgb;\n\n  vec3 lightPos = v_lightNDC.xyz / v_lightNDC.w;\n\n  float bias = 0.001;\n  float depth = lightPos.z - bias;\n  float occluder = unpackRGBA(texture2D(shadowMap, lightPos.xy));\n\n  // Compare actual depth from light to the occluded depth rendered in the depth map\n  // If the occluded depth is smaller, we must be in shadow\n  return mix(.0, 1., occluder-depth);\n\n}\n\nfloat insideBox3D(vec3 v, vec3 bottomLeft, vec3 topRight) {\n  vec3 s = step(bottomLeft, v) - step(topRight, v);\n  return s.x * s.y * s.z;\n}\n\nfloat get_colorCorrection(int p) {\n  vec2 coords = vec2(float(p), 0.) / vec2(float(particleCount), 1.);\n  return texture2D(utColorCorrections, coords).r;\n}\n\nvec4 get_color(int p) {\n  vec2 coords = vec2(float(p), 0.) / vec2(float(particleCount), 1.);\n  return texture2D(utParticleColorAndType, coords);\n}\nfloat visibility(vec4 fourPosition) {\n\n  bool outsideBox = insideBox3D(fourPosition.xyz, vec3(stageGrid_size), vec3(-stageGrid_size)) == 0.;\n  bool beyondProgressLower = (viewRange[0] * float(snapshotCount) >= float(snapshotCount)-a_snapshot);\n  bool beyondProgressUpper =  (viewRange[1] * float(snapshotCount) < float(snapshotCount)-a_snapshot);\n  return  (outsideBox || beyondProgressLower || beyondProgressUpper ) ? 0. : 1.;\n}\n\nvoid main () {\n\n  vec4 fourPosition = readVariable(ut_position, int(a_particle), int(a_snapshot));\n  vec4 previousFourPosition = readVariable(ut_position, int(a_particle), int(a_snapshot) + 1);\n\n  mat4 lookAtMat4 = lookAt(fourPosition.xyz, previousFourPosition.xyz, vec3(0., 1., 0.));\n\n#ifdef lighting\n    vScale = vec3(\n      pathicleWidth  * 1.,\n      pathicleHeight,\n      length(previousFourPosition.xyz - fourPosition.xyz) - pathicleGap);\n#endif\n\n#ifdef shadow\n    vScale = vec3(\n      pathicleWidth * 10.,\n      pathicleHeight,\n      length(previousFourPosition.xyz - fourPosition.xyz) );\n#endif\n\n  vec3 scaledPosition = aPosition * vScale;\n\n  v_position = (((lookAtMat4 * vec4(scaledPosition, 1.)).xyz\n    + 0.5 * (fourPosition.xyz + previousFourPosition.xyz)));\n\n  vNormalOrig = aNormal;\n  vNormal = normalize((transpose(inverse(lookAtMat4)) * vec4(aNormal, 0.)).xyz);\n\n  vUv = aUV;\n\n  vShadowCoord = (shadowProjectionMatrix *  shadowViewMatrix * model * vec4(v_position, 1.0)).xyz;\n  vColor = get_color(int(a_particle)).rgb;\n  v_visibility = visibility(fourPosition);\n\n#ifdef lighting\n\n  v_lightNDC = texUnitConverter * shadowProjectionMatrix * shadowViewMatrix * model * vec4(v_position, 1.0);\n  vColorCorrection = get_colorCorrection(int(a_particle));\n  v_visibility = v_visibility; // * clamp(shadowValue(), 1., 1.);\n\n  gl_Position = projection * view *  model * vec4(v_position, 1.0);\n\n#endif// lighting\n\n#ifdef shadow\n\n  gl_Position =vec4(vShadowCoord, 1.0);\n\n#endif// shadow\n}\n\n",Nr="precision highp float;\n#define GLSLIFY 1\n//#extension GL_OES_standard_derivatives : enable\n\nvarying float v_visibility;\nvarying vec3 v_position;\nvarying vec3 vScale;\nvarying vec3 vNormal;\nvarying vec3 vNormalOrig;\nvarying vec2 vUv;\nvarying vec4 vAmbientColor;\nvarying vec3 vColor;\nvarying float vColorCorrection;\nvarying vec4 v_lightNDC;\n\nuniform float ambientLightAmount;\nuniform float diffuseLightAmount;\nuniform float stageSize;\n\nuniform float pathicleWidth;\nuniform vec3 eye;\nuniform vec2 uResolution;\n\nvarying vec3 vShadowCoord;\nuniform vec3 shadowDirection;\nuniform sampler2D shadowMap;\nuniform float minBias;\nuniform float maxBias;\n\nfloat edger(vec2 uv, vec3 boxScale, float edgeWidth, vec3 normal) {\n\n  float edgeXY =  smoothstep(0., edgeWidth, uv.x*boxScale.z) * smoothstep(0., edgeWidth, (1.-uv.x)*boxScale.z);\n  float edgeXZ =  smoothstep(0., edgeWidth, uv.y*boxScale.y) * smoothstep(0., edgeWidth, (1.-uv.y)*boxScale.y);\n  float edgeX = (1.-(edgeXY*edgeXZ))*abs(normal.x);\n\n  float edgeYX =  smoothstep(0., edgeWidth, uv.x*boxScale.x) * smoothstep(0., edgeWidth, (1.-uv.x)*boxScale.x);\n  float edgeYZ =  smoothstep(0., edgeWidth, uv.y*boxScale.z) * smoothstep(0., edgeWidth, (1.-uv.y)*boxScale.z);\n  float edgeY = (1.-(edgeYX*edgeYZ))*abs(normal.y);\n\n  float edgeZX =  smoothstep(0., edgeWidth, uv.x*boxScale.x) * smoothstep(0., edgeWidth, (1.-uv.x)*boxScale.x);\n  float edgeZY =  smoothstep(0., edgeWidth, uv.y*boxScale.z) * smoothstep(0., edgeWidth, (1.-uv.y)*boxScale.z);\n  float edgeZ = (1.-(edgeZX*edgeZY))*abs(normal.z);\n\n  return clamp(edgeX+edgeY, 0., 1.);\n}\n\n//\n//float edgerFeathered(vec2 uv, vec3 boxScale, float edgeWidth) {\n//\n//  float feather = .1;\n//\n//  float edgeXY =  smoothstep(edgeWidth, edgeWidth+feather, uv.x*boxScale.z) * smoothstep(edgeWidth, edgeWidth+feather, (1.-uv.x)*boxScale.z);\n//  float edgeXZ =  smoothstep(edgeWidth, edgeWidth+feather, uv.y*boxScale.y) * smoothstep(edgeWidth, edgeWidth+feather, (1.-uv.y)*boxScale.y);\n//  float edgeX = (1.-(edgeXY*edgeXZ))*abs(normal.x);\n//\n//  return clamp(edgeX, 0., 1.);\n//}\n//\n//\n//float edgerHard(vec2 uv, vec3 boxScale, float edgeWidth) {\n//  float edgeXY =  step(edgeWidth*(1.+uv.x*boxScale.z), uv.x*boxScale.z) * step(edgeWidth, (1.-uv.x)*boxScale.z);\n//  float edgeXZ =  step(edgeWidth*(0.5+uv.x/2.), uv.y*boxScale.y) * step(edgeWidth*(0.5+uv.x/2.), (1.-uv.y)*boxScale.y);\n//  float edgeX = (1.-(edgeXZ))*abs(normal.x);\n//\n//  return clamp(edgeX, 0., 1.);\n//}\n\nvec4 packRGBA (float v) {\n  vec4 pack = fract(vec4(1.0, 255.0, 65025.0, 16581375.0) * v);\n  pack -= pack.yzww * vec2(1.0 / 255.0, 0.0).xxxy;\n  return pack;\n}\n\nfloat unpackRGBA (vec4 v) {\n  return dot(v, 1.0 / vec4(1.0, 255.0, 65025.0, 16581375.0));\n}\n\nfloat shadowValue() {\n  vec3 tex = texture2D(shadowMap, vUv).rgb;\n\n  vec3 lightPos = v_lightNDC.xyz / v_lightNDC.w;\n\n  float bias = 0.001;\n  float depth = lightPos.z - bias;\n  float occluder = unpackRGBA(texture2D(shadowMap, lightPos.xy));\n\n  // Compare actual depth from light to the occluded depth rendered in the depth map\n  // If the occluded depth is smaller, we must be in shadow\n  return mix(0.2, 1.0, step(depth, occluder));\n\n}\n\nfloat map(float value, float min1, float max1, float min2, float max2) {\n  return min2 + (value - min1) * (max2 - min2) / (max1 - min1);\n}\n\nfloat diffuse(vec3 lightDir, vec3 nrm)\n{\n  float diffAmt = max(0.0, dot(nrm, lightDir));\n  return diffAmt;\n}\nfloat specular(vec3 lightDir, vec3 viewDir, vec3 nrm, float shininess)\n{\n  vec3 halfVec = normalize(viewDir + lightDir);\n  float specAmt = max(0.0, dot(halfVec, nrm));\n  return pow(specAmt, shininess);\n}\n\nstruct DirectionalLight\n{\n  vec3 direction;\n  vec3 color;\n  float intensity;\n};\n#define NUM_DIR_LIGHTS 3\nDirectionalLight directionalLights[NUM_DIR_LIGHTS];\n\nvoid main () {\n\n    if (v_visibility < .9) discard;\n\n  #ifdef lighting\n\n  vec3 viewDir = normalize(eye - v_position);\n  vec3 normal = normalize(vNormal);\n\n  directionalLights[0] = DirectionalLight(shadowDirection, vec3(1.), .15);\n  directionalLights[1] = DirectionalLight(shadowDirection+vec3(-5., 0., 5.), vec3(1.), .15);\n  directionalLights[2] = DirectionalLight(shadowDirection+vec3(5., 0., -5.), vec3(1.), .15);\n  vec3 edgedColor = vColor;\n  vec3 finalColor = ambientLightAmount * vColor;\n\n  for (int i = 0; i < NUM_DIR_LIGHTS; ++i)\n  {\n    DirectionalLight light = directionalLights[i];\n    vec3 sceneLight = mix(light.color, edgedColor.rgb + light.color * 0.5, 0.5);\n    float diffAmt = diffuse(light.direction, normal) * light.intensity;\n    float specAmt = specular(light.direction, viewDir, normal, 0.0) * light.intensity;\n\n    float shadow = .9 * vColorCorrection;//clamp(vColorCorrection + abs(2.+v_position.y*5.), 0., 1.);\n    float specMask = edger(vUv, vScale, 1. * pathicleWidth, vNormalOrig) * smoothstep(5., 2., length(v_position-eye));\n    vec3 specCol = specMask * sceneLight * specAmt;\n    finalColor += shadow * vColor * diffAmt * light.color;\n    finalColor += shadow * specCol * sceneLight;\n  }\n\n  gl_FragColor =vec4(finalColor, 1.); //map(v_visibility, 0.5, 1., 0.75, .9));\n\n  #endif// lighting\n\n  #ifdef shadow\n  gl_FragColor = packRGBA(vShadowCoord.z );\n  #endif\n\n}\n\n";const Wr=({particleCount:e,snapshotCount:t})=>Array(e*t).fill(0).map(((t,n)=>Math.floor(n/e))),Vr=({particleCount:e,snapshotCount:t})=>Array(e*t).fill(0).map(((t,n)=>n%e));var Ur="precision highp float;\n#extension GL_OES_standard_derivatives : enable\n#define GLSLIFY 1\n\n#define SQRT2 1.41421356\n#define PI 3.14159\n\nuniform vec3 shadowDirection;\nuniform sampler2D shadowMap;\nuniform float minBias;\nuniform float maxBias;\nuniform float stageSize;\n\nvarying vec3 vShadowCoord;\nvarying vec3 vPosition;\nvarying vec3 vNormal;\nvarying vec2 vUv;\n\nfloat unpackRGBA (vec4 v) {\n  return dot(v, 1.0 / vec4(1.0, 255.0, 65025.0, 16581375.0));\n}\n\n// Can go down to 10 or so, and still be usable, probably...\n#define ITERATIONS 5\n\n// Set this to 0.0 to stop the pixel movement.\n#define TIME iTime\n\n#define TAU  6.28318530718\n\n//-------------------------------------------------------------------------------------------\n// Use last part of hash function to generate new random radius and angle...\nvec2 Sample(inout vec2 r)\n{\n  r = fract(r * vec2(33.3983, 43.4427));\n  return r-.5;\n  //return sqrt(r.x+.001) * vec2(sin(r.y * TAU), cos(r.y * TAU))*.5; // <<=== circular sampling.\n}\n\n  //-------------------------------------------------------------------------------------------\n  #define HASHSCALE 443.8975\nvec2 Hash22(vec2 p)\n{\n  vec3 p3 = fract(vec3(p.xyx) * HASHSCALE);\n  p3 += dot(p3, p3.yzx+19.19);\n  return fract(vec2((p3.x + p3.y)*p3.z, (p3.x+p3.z)*p3.y));\n}\n\n//-------------------------------------------------------------------------------------------\nvec3 Blur(sampler2D tex, vec2 uv, float radius)\n{\n  radius = radius * .04;\n\n  vec2 circle = vec2(radius); // * vec2((iResolution.y / iResolution.x), 1.0);\n\n  // Remove the time reference to prevent random jittering if you don't like it.\n  vec2 random = Hash22(uv);\n\n  // Do the blur here...\n  vec3 acc = vec3(0.0);\n  for (int i = 0; i < ITERATIONS; i++) {\n    acc += texture2D(tex, uv+ circle * Sample(random), radius*1.0).xyz;\n  }\n  return acc / float(ITERATIONS);\n}\n\nfloat fBlur(sampler2D tex, vec2 uv, float radius)\n{\n  vec2 circle = vec2(radius);\n\n  // Remove the time reference to prevent random jittering if you don't like it.\n  vec2 random = Hash22(uv);\n\n  // Do the blur here...\n  float acc = 0.;\n  for (int i = 0; i < ITERATIONS; i++) {\n    acc += unpackRGBA(texture2D(tex, uv+ circle * Sample(random), radius*1.0));\n  }\n  return acc / float(ITERATIONS);\n}\n\nvec3 mainColor = vec3(1.);\nvec3 lineColor = vec3(.7);\nvec4 gridControl = vec4(.1, 10., .5, .99);\nvec3 gridOffset = vec3(0., 0., 0.);\nfloat getVisibility(float position) {\n  float majorGridFrequency=gridControl.y;\n  if (floor(position+0.5) == floor(position/majorGridFrequency+0.5)*majorGridFrequency)\n  {\n    return 1.0;\n  }\n  return gridControl.z;\n}\nfloat getAnisotropicAttenuation(float differentialLength) {\n  const float maxNumberOfLines=4.0;\n  return clamp(1.0/(differentialLength+1.0)-1.0/maxNumberOfLines, 0.0, 1.0);\n}\nfloat isPointOnLine(float position, float differentialLength) {\n  float fractionPartOfPosition = position-floor(position+0.5);\n  fractionPartOfPosition/=differentialLength;\n  fractionPartOfPosition=clamp(fractionPartOfPosition, -1., 1.);\n  float result=0.5+0.5*cos(fractionPartOfPosition*PI);\n  return result;\n}\nfloat contributionOnAxis(float position) {\n  float differentialLength=length(vec2(dFdx(position), dFdy(position)));\n  differentialLength*=SQRT2;\n  float result=isPointOnLine(position, differentialLength);\n  float visibility=getVisibility(position);\n  result*=visibility;\n  float anisotropicAttenuation=getAnisotropicAttenuation(differentialLength);\n  result*=anisotropicAttenuation;\n  return result;\n}\nfloat normalImpactOnAxis(float x) {\n  float normalImpact=clamp(1.0-3.0*abs(x*x*x), 0.0, 1.0);\n  return normalImpact;\n}\n\nvoid main(void) {\n\n  float amountInLight =1.-fBlur(shadowMap, vShadowCoord.xy, .01);\n\n  float gridRatio=gridControl.x;\n  vec3 gridPos=(vPosition+gridOffset.xyz)/gridRatio;\n  float x=contributionOnAxis(gridPos.x);\n  float y=contributionOnAxis(gridPos.y);\n  float z=contributionOnAxis(gridPos.z);\n  vec3 normal=normalize(vNormal);\n  float grid=clamp(x+y+z, 0., 1.);\n\n  vec3 color=mix(mainColor, lineColor, grid);\n  float opacity = clamp(grid, 0.2, gridControl.w*grid)*.5;\n  float fogDistance = length(vPosition);\n  float fogAmount = smoothstep(stageSize/2.*1., stageSize/2.*.5, fogDistance);\n\n  gl_FragColor =vec4(color.rgb, fogAmount*opacity)\n    + vec4(vec3(-.25*amountInLight), 1.);\n\n}\n\n",Hr="precision highp float;\n#define GLSLIFY 1\n\nattribute vec3 position;\nattribute vec2 uv;\n//\nuniform vec3 uOffset;\nuniform mat4 projection;\nuniform mat4 view;\n\nuniform mat4 shadowProjectionMatrix;\nuniform mat4 shadowViewMatrix;\nuniform vec3 shadowDirection;\nvarying vec2 vUv;\nvarying vec3 vPosition;\nvarying vec3 vNormal;\nvarying vec3 vShadowCoord;\nconst mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);\n\nvoid main () {\n  vUv = 0. * uv ;\n\n  vec4 worldPosition = vec4(position + uOffset, 1.0);\n  vPosition = worldPosition.xyz;\n  vShadowCoord = (texUnitConverter * shadowProjectionMatrix * shadowViewMatrix * worldPosition).xyz;\n\n  gl_Position = projection * view * vec4(vPosition, 1.);\n}\n";var Yr="precision mediump float;\n#define GLSLIFY 1\nattribute vec3 aPosition;\nattribute vec3 aColor;\nattribute vec3 aNormal;\nattribute vec2 aUV;\nvarying vec2 vUv;\nattribute vec3 aTranslation;\nattribute vec3 aScale;\nattribute float aPhi;\nattribute float aTheta;\nuniform mat4 projection, view;\n// These three are instanced attributes.\nvarying vec4 vPosition;\nvarying vec3 vNormal;\nvarying vec3 vNormalOrig;\nvarying vec3 vColor;\nvarying vec3 vScale;\n\nfloat inverse(float m) {\n  return 1.0 / m;\n}\n\nmat2 inverse(mat2 m) {\n  return mat2(m[1][1],-m[0][1],\n             -m[1][0], m[0][0]) / (m[0][0]*m[1][1] - m[0][1]*m[1][0]);\n}\n\nmat3 inverse(mat3 m) {\n  float a00 = m[0][0], a01 = m[0][1], a02 = m[0][2];\n  float a10 = m[1][0], a11 = m[1][1], a12 = m[1][2];\n  float a20 = m[2][0], a21 = m[2][1], a22 = m[2][2];\n\n  float b01 = a22 * a11 - a12 * a21;\n  float b11 = -a22 * a10 + a12 * a20;\n  float b21 = a21 * a10 - a11 * a20;\n\n  float det = a00 * b01 + a01 * b11 + a02 * b21;\n\n  return mat3(b01, (-a22 * a01 + a02 * a21), (a12 * a01 - a02 * a11),\n              b11, (a22 * a00 - a02 * a20), (-a12 * a00 + a02 * a10),\n              b21, (-a21 * a00 + a01 * a20), (a11 * a00 - a01 * a10)) / det;\n}\n\nmat4 inverse(mat4 m) {\n  float\n      a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n      a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n      a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n      a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\n\n      b00 = a00 * a11 - a01 * a10,\n      b01 = a00 * a12 - a02 * a10,\n      b02 = a00 * a13 - a03 * a10,\n      b03 = a01 * a12 - a02 * a11,\n      b04 = a01 * a13 - a03 * a11,\n      b05 = a02 * a13 - a03 * a12,\n      b06 = a20 * a31 - a21 * a30,\n      b07 = a20 * a32 - a22 * a30,\n      b08 = a20 * a33 - a23 * a30,\n      b09 = a21 * a32 - a22 * a31,\n      b10 = a21 * a33 - a23 * a31,\n      b11 = a22 * a33 - a23 * a32,\n\n      det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n\n  return mat4(\n      a11 * b11 - a12 * b10 + a13 * b09,\n      a02 * b10 - a01 * b11 - a03 * b09,\n      a31 * b05 - a32 * b04 + a33 * b03,\n      a22 * b04 - a21 * b05 - a23 * b03,\n      a12 * b08 - a10 * b11 - a13 * b07,\n      a00 * b11 - a02 * b08 + a03 * b07,\n      a32 * b02 - a30 * b05 - a33 * b01,\n      a20 * b05 - a22 * b02 + a23 * b01,\n      a10 * b10 - a11 * b08 + a13 * b06,\n      a01 * b08 - a00 * b10 - a03 * b06,\n      a30 * b04 - a31 * b02 + a33 * b00,\n      a21 * b02 - a20 * b04 - a23 * b00,\n      a11 * b07 - a10 * b09 - a12 * b06,\n      a00 * b09 - a01 * b07 + a02 * b06,\n      a31 * b01 - a30 * b03 - a32 * b00,\n      a20 * b03 - a21 * b01 + a22 * b00) / det;\n}\n\nfloat transpose(float m) {\n  return m;\n}\n\nmat2 transpose(mat2 m) {\n  return mat2(m[0][0], m[1][0],\n              m[0][1], m[1][1]);\n}\n\nmat3 transpose(mat3 m) {\n  return mat3(m[0][0], m[1][0], m[2][0],\n              m[0][1], m[1][1], m[2][1],\n              m[0][2], m[1][2], m[2][2]);\n}\n\nmat4 transpose(mat4 m) {\n  return mat4(m[0][0], m[1][0], m[2][0], m[3][0],\n              m[0][1], m[1][1], m[2][1], m[3][1],\n              m[0][2], m[1][2], m[2][2], m[3][2],\n              m[0][3], m[1][3], m[2][3], m[3][3]);\n}\n\nmat4 fromYRotation (float phi) {\n  float s = sin(phi);\n  float c = cos(phi);\n  return mat4(\n  c,   0.,  -s,   0.,\n  0.,  1.,   0.,   0.,\n  s,   0.,   c,   0.,\n  0.,  0.,   0.,   1.);\n}\nmat4 fromZRotation (float theta) {\n  float s = sin(theta);\n  float c = cos(theta);\n  return mat4(\n  c,   -s,  0.,   0.,\n  s,   c,   0.,   0.,\n  0.,  0.,   1.,   0.,\n  0.,  0.,   0.,   1.);\n}\nvoid main () {\n\n  vUv = aUV;\n  vScale = aScale;\n\n// Translate\nmat4 tPos = mat4(vec4(1.0,0.0,0.0,0.0),\nvec4(0.0,1.0,0.0,0.0),\nvec4(0.0,0.0,1.0,0.0),\nvec4(aTranslation,1.0));\n\n//// Rotate\n//mat4 rXPos = mat4(vec4(1.0,0.0,0.0,0.0),\n//vec4(0.0,cos(rotationX),-sin(rotationX),0.0),\n//vec4(0.0,sin(rotationX),cos(rotationX),0.0),\n//vec4(0.0,0.0,0.0,1.0));\n\nmat4 rYPos = mat4(vec4(cos(aPhi),0.,-sin(aPhi),0.0),\nvec4(0.0,1.0,0.0,0.0),\nvec4(sin(aPhi),0.0,cos(aPhi),0.0),\nvec4(0.0,0.0,0.0,1.0));\n\nmat4 rZPos = mat4(vec4(cos(aTheta),-sin(aTheta),0.0,0.0),\nvec4(sin(aTheta),cos(aTheta),0.0,0.0),\nvec4(0.0,0.0,1.0,0.0),\nvec4(0.0,0.0,0.0,1.0));\n\n// Scale\nmat4 sScale = mat4(vec4(aScale.x,0.0,0.0,0.0),\nvec4(0.0,aScale.y,0.0,0.0),\nvec4(0.0,0.0,aScale.z,0.0),\nvec4(0.0,0.0,0.0,1.0));\n\n  mat4 aModel = tPos *  rZPos * rYPos * sScale;\n  vPosition =  aModel * vec4(aPosition,1.0);\n  vColor = aColor;\n\n#ifdef lighting\n\n  vNormalOrig = aNormal;\n  vNormal = normalize((transpose(inverse(aModel)) * vec4(aNormal, 0.)).xyz);\n  gl_Position = projection * view  * vPosition;\n\n#endif// lighting\n\n#ifdef shadow\n\n//  gl_Position =vec4(vShadowCoord, 1.0);\n\n#endif// shadow\n}\n",Xr="precision mediump float;\n#define GLSLIFY 1\nvarying vec4 vPosition;\nvarying vec3 vNormal;\nvarying vec3 vNormalOrig;\nvarying vec3 vColor;\nvarying vec2 vUv;\nuniform float ambientLightAmount;\nuniform float diffuseLightAmount;\nuniform vec3 shadowDirection;\nuniform float pathicleWidth;\nuniform vec3 eye;\nvarying vec3 vScale;\n\nfloat edger(vec2 uv, vec3 boxScale, float edgeWidth, vec3 normal) {\n\n  float edgeXY =  smoothstep(0., edgeWidth, uv.x*boxScale.z) * smoothstep(0., edgeWidth, (1.-uv.x)*boxScale.z);\n  float edgeXZ =  smoothstep(0., edgeWidth, uv.y*boxScale.y) * smoothstep(0., edgeWidth, (1.-uv.y)*boxScale.y);\n  float edgeX = (1.-(edgeXY*edgeXZ))*abs(normal.x);\n\n  float edgeYX =  smoothstep(0., edgeWidth, uv.x*boxScale.x) * smoothstep(0., edgeWidth, (1.-uv.x)*boxScale.x);\n  float edgeYZ =  smoothstep(0., edgeWidth, uv.y*boxScale.z) * smoothstep(0., edgeWidth, (1.-uv.y)*boxScale.z);\n  float edgeY = (1.-(edgeYX*edgeYZ))*abs(normal.y);\n\n  float edgeZX =  smoothstep(0., edgeWidth, uv.x*boxScale.x) * smoothstep(0., edgeWidth, (1.-uv.x)*boxScale.x);\n  float edgeZY =  smoothstep(0., edgeWidth, uv.y*boxScale.z) * smoothstep(0., edgeWidth, (1.-uv.y)*boxScale.z);\n  float edgeZ = (1.-(edgeZX*edgeZY))*abs(normal.z);\n\n  return clamp(edgeX+edgeY, 0., 1.);\n}\n\n//\n//float edgerFeathered(vec2 uv, vec3 boxScale, float edgeWidth) {\n//\n//  float feather = .1;\n//\n//  float edgeXY =  smoothstep(edgeWidth, edgeWidth+feather, uv.x*boxScale.z) * smoothstep(edgeWidth, edgeWidth+feather, (1.-uv.x)*boxScale.z);\n//  float edgeXZ =  smoothstep(edgeWidth, edgeWidth+feather, uv.y*boxScale.y) * smoothstep(edgeWidth, edgeWidth+feather, (1.-uv.y)*boxScale.y);\n//  float edgeX = (1.-(edgeXY*edgeXZ))*abs(normal.x);\n//\n//  return clamp(edgeX, 0., 1.);\n//}\n//\n//\n//float edgerHard(vec2 uv, vec3 boxScale, float edgeWidth) {\n//  float edgeXY =  step(edgeWidth*(1.+uv.x*boxScale.z), uv.x*boxScale.z) * step(edgeWidth, (1.-uv.x)*boxScale.z);\n//  float edgeXZ =  step(edgeWidth*(0.5+uv.x/2.), uv.y*boxScale.y) * step(edgeWidth*(0.5+uv.x/2.), (1.-uv.y)*boxScale.y);\n//  float edgeX = (1.-(edgeXZ))*abs(normal.x);\n//\n//  return clamp(edgeX, 0., 1.);\n//}\n\nfloat diffuse(vec3 lightDir, vec3 nrm)\n{\n  float diffAmt = max(0.0, dot(nrm, lightDir));\n  return diffAmt;\n}\nfloat specular(vec3 lightDir, vec3 viewDir, vec3 nrm, float shininess)\n{\n  vec3 halfVec = normalize(viewDir + lightDir);\n  float specAmt = max(0.0, dot(halfVec, nrm));\n  return pow(specAmt, shininess);\n}\n\nstruct DirectionalLight\n{\n  vec3 direction;\n  vec3 color;\n  float intensity;\n};\n#define NUM_DIR_LIGHTS 3\nDirectionalLight directionalLights[NUM_DIR_LIGHTS];\n\nvoid main () {\n\n  #ifdef lighting\n\n  if (vColor.r == vColor.g && vColor.r == vColor.b ) discard;\n  vec3 color = vColor;\n  gl_FragColor = vec4(vColor, 1.);\n\n  vec3 viewDir = normalize(eye - vPosition.xyz);\n  vec3 normal = normalize(vNormal);\n\n  directionalLights[0] = DirectionalLight(shadowDirection, vec3(1.), .5);\n  directionalLights[1] = DirectionalLight(shadowDirection+vec3(-1., 0., 1.), vec3(1.), .1);\n  directionalLights[2] = DirectionalLight(shadowDirection+vec3(1., 0., -1.), vec3(1.), .1);\n  vec3 edgedColor = vColor;\n  vec3 finalColor = ambientLightAmount * vColor;\n\n  for (int i = 0; i < NUM_DIR_LIGHTS; ++i)\n  {\n    DirectionalLight light = directionalLights[i];\n    vec3 sceneLight = mix(light.color, edgedColor.rgb + light.color * 0.5, 0.5);\n    float diffAmt = diffuse(light.direction, normal) * light.intensity;\n    float specAmt = specular(light.direction, viewDir, normal, 0.0) * light.intensity;\n\n    float shadow = 1.; //.9 * vColorCorrection;//clamp(vColorCorrection + abs(2.+v_position.y*5.), 0., 1.);\n    float specMask = .5*edger(vUv, vScale, 1. * .02, vNormalOrig);\n//    float specMask = edger(vUv, vScale, 1. * .1, vNormalOrig) * smoothstep(5., 2., length(vPosition-eye));\n    vec3 specCol = specMask * sceneLight * specAmt;\n    finalColor += shadow * vColor * diffAmt * light.color;\n    finalColor += shadow * specCol * sceneLight;\n  }\n\n  gl_FragColor =vec4(finalColor, 1.);\n  #endif\n\n}\n";function Gr(e,{model:t},n){const r=(r,i)=>{const a=r===Er?function(){const e=Br(1,1,.05);return e.positions=e.positions.map((([e,t,n])=>[e,t,n-1])),Lr([e,Br(1,1,.05)])}():r===Tr?function(){const e=Br(.75,.1,1);e.positions=e.positions.map((([e,t,n])=>[e,t+.5,n]));const t=Br(.1,.75,1);t.positions=t.positions.map((([e,t,n])=>[e-.5,t,n]));const n=Br(.1,.75,1);n.positions=n.positions.map((([e,t,n])=>[e+.5,t,n]));const r=Br(.75,.1,1);return r.positions=r.positions.map((([e,t,n])=>[e,t-.5,n])),Lr([e,r,n,t])}():function(){const e=Br(1,.1,1);e.positions=e.positions.map((([e,t,n])=>[e,t+.4,n]));const t=Br(1,.1,1);return t.positions=t.positions.map((([e,t,n])=>[e,t-.4,n])),Lr([e,t])}(),o=t.lattice.beamline.filter((e=>e.type===r)),l=t.lattice.transformations.filter((e=>e.type===r));return e({depth:{enable:!0},blend:{enable:!1,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:1},equation:{rgb:"add",alpha:"add"},color:[0,0,0,1]},cull:{enable:!0,face:"back"},elements:a.cells,instances:o.length,attributes:{aPosition:a.positions,aNormal:a.normals,aUV:a.uvs,aColor:{buffer:e.buffer(o.map((e=>e.color))),divisor:1},aTranslation:{buffer:e.buffer(l.map((e=>e.translation))),divisor:1},aPhi:{buffer:e.buffer(l.map((e=>-e.phi))),divisor:1},aTheta:{buffer:e.buffer(l.map((e=>-e.theta))),divisor:1},aScale:{buffer:e.buffer(l.map((e=>e.scale))),divisor:1}},vert:[`#define ${i} 1`,Yr].join("\n"),frag:[`#define ${i} 1`,Xr].join("\n"),uniforms:s({},n.uniforms)})};return{quadLighting:r(Tr,"lighting"),quadShadow:r(Tr,"shadow"),sbenLighting:r(Sr,"lighting"),sbenShadow:r(Sr,"shadow"),estaLighting:r(Er,"lighting"),estaShadow:r(Er,"shadow")}}var qr=function(){var e=new Float32Array(3);return e[0]=0,e[1]=0,e[2]=0,e};var Zr=function(e){var t=new Float32Array(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t};var Qr=function(e,t,n){var r=new Float32Array(3);return r[0]=e,r[1]=t,r[2]=n,r};var $r=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]};var Jr=function(e,t){var n=Kr(e[0],e[1],e[2]),r=Kr(t[0],t[1],t[2]);ei(n,n),ei(r,r);var i=ti(n,r);return i>1?0:Math.acos(i)},Kr=Qr,ei=ze,ti=$r;var ni=function(e,t,n,r){return e[0]=t,e[1]=n,e[2]=r,e};var ri=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]};var ii=function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e};var ai=ii,oi=function(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2],e};var si=oi,li=function(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e[2]=t[2]/n[2],e};var ci=li,ui=function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e[2]=Math.min(t[2],n[2]),e};var fi=function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e[2]=Math.max(t[2],n[2]),e};var hi=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e};var pi=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e};var di=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e};var mi=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e};var gi=function(e,t){var n=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(n*n+r*r+i*i)};var vi=gi,bi=function(e,t){var n=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2];return n*n+r*r+i*i};var yi=bi,xi=function(e){var t=e[0],n=e[1],r=e[2];return Math.sqrt(t*t+n*n+r*r)};var wi=xi,_i=function(e){var t=e[0],n=e[1],r=e[2];return t*t+n*n+r*r};var Ai=_i,Si=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e};var Ti=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e};var Ei=function(e,t,n){var r=t[0],i=t[1],a=t[2],o=n[0],s=n[1],l=n[2];return e[0]=i*l-a*s,e[1]=a*o-r*l,e[2]=r*s-i*o,e};var Ci=function(e,t,n,r){var i=t[0],a=t[1],o=t[2];return e[0]=i+r*(n[0]-i),e[1]=a+r*(n[1]-a),e[2]=o+r*(n[2]-o),e};var Mi=function(e,t){t=t||1;var n=2*Math.random()*Math.PI,r=2*Math.random()-1,i=Math.sqrt(1-r*r)*t;return e[0]=Math.cos(n)*i,e[1]=Math.sin(n)*i,e[2]=r*t,e};var Pi=function(e,t,n){var r=t[0],i=t[1],a=t[2];return e[0]=r*n[0]+i*n[3]+a*n[6],e[1]=r*n[1]+i*n[4]+a*n[7],e[2]=r*n[2]+i*n[5]+a*n[8],e};var Oi=function(e,t,n){var r=t[0],i=t[1],a=t[2],o=n[0],s=n[1],l=n[2],c=n[3],u=c*r+s*a-l*i,f=c*i+l*r-o*a,h=c*a+o*i-s*r,p=-o*r-s*i-l*a;return e[0]=u*c+p*-o+f*-l-h*-s,e[1]=f*c+p*-s+h*-o-u*-l,e[2]=h*c+p*-l+u*-s-f*-o,e};var Di=function(e,t,n,r){var i=n[0],a=n[1],o=t[0]-i,s=t[1]-a,l=Math.sin(r),c=Math.cos(r);return e[0]=i+o*c-s*l,e[1]=a+o*l+s*c,e[2]=t[2],e};var Ii=function(e,t,n,r,i,a){var o,s;t||(t=3);n||(n=0);s=r?Math.min(r*t+n,e.length):e.length;for(o=n;o<s;o+=t)Li[0]=e[o],Li[1]=e[o+1],Li[2]=e[o+2],i(Li,Li,a),e[o]=Li[0],e[o+1]=Li[1],e[o+2]=Li[2];return e},Li=qr();var ki={EPSILON:1e-6,create:qr,clone:Zr,angle:Jr,fromValues:Qr,copy:ke,set:ni,equals:De,exactEquals:ri,add:Ie,subtract:ii,sub:ai,multiply:oi,mul:si,divide:li,div:ci,min:ui,max:fi,floor:hi,ceil:pi,round:di,scale:mi,scaleAndAdd:Le,distance:gi,dist:vi,squaredDistance:bi,sqrDist:yi,length:xi,len:wi,squaredLength:_i,sqrLen:Ai,negate:Si,inverse:Ti,normalize:ze,dot:$r,cross:Ei,lerp:Ci,random:Mi,transformMat4:Me,transformMat3:Pi,transformQuat:Oi,rotateX:Oe,rotateY:Pe,rotateZ:Di,forEach:Ii};class zi{constructor(e,{position:t,size:n,near:r,far:i}){this.SHADOW_MAP_SIZE=1024,this.regl=e,this.size=n,this.fbo=e.framebuffer({color:e.texture({radius:1024}),depth:!1}),this.fboBlurred=e.framebuffer({color:e.texture({radius:1024}),depth:!0}),this.update(t,this.size,r,i)}update(e,t=this.size,n=this.near,r=this.far){this.shadowDirection=[...e],ki.normalize(this.shadowDirection,e),this.shadowViewMatrix=Rr.lookAt([],e,[0,0,0],[0,0,1]),this.size=t,this.near=n,this.far=r,this.shadowProjectionMatrix=Rr.ortho([],-t,t,-t,t,this.near,this.far)}get uniforms(){return{shadowProjectionMatrix:()=>this.shadowProjectionMatrix,shadowViewMatrix:()=>this.shadowViewMatrix,shadowDirection:()=>this.shadowDirection,minBias:()=>.001,maxBias:()=>.3}}}var Ri=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e},Fi=function(e,t){var n=t[0],r=t[1],i=t[2];return e[0]=n,e[1]=r,e[2]=i,e[3]=Math.sqrt(Math.abs(1-n*n-r*r-i*i)),e};var Bi=function(e){var t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},ji=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e};var Ni=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},Wi=function(){var e=new Float32Array(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e};var Vi=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},Ui=function(e,t){var n,r=t[0]+t[4]+t[8];if(r>0)n=Math.sqrt(r+1),e[3]=.5*n,n=.5/n,e[0]=(t[5]-t[7])*n,e[1]=(t[6]-t[2])*n,e[2]=(t[1]-t[3])*n;else{var i=0;t[4]>t[0]&&(i=1),t[8]>t[3*i+i]&&(i=2);var a=(i+1)%3,o=(i+2)%3;n=Math.sqrt(t[3*i+i]-t[3*a+a]-t[3*o+o]+1),e[i]=.5*n,n=.5/n,e[3]=(t[3*a+o]-t[3*o+a])*n,e[a]=(t[3*a+i]+t[3*i+a])*n,e[o]=(t[3*o+i]+t[3*i+o])*n}return e};var Hi=function(e,t,n,r){var i=new Float32Array(4);return i[0]=e,i[1]=t,i[2]=n,i[3]=r,i},Yi=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e};var Xi=function(e,t){var n=t[0],r=t[1],i=t[2],a=t[3],o=n*n+r*r+i*i+a*a,s=o?1/o:0;return e[0]=-n*s,e[1]=-r*s,e[2]=-i*s,e[3]=a*s,e};var Gi=function(e){var t=e[0],n=e[1],r=e[2],i=e[3];return Math.sqrt(t*t+n*n+r*r+i*i)};var qi=function(e,t,n,r){var i=t[0],a=t[1],o=t[2],s=t[3];return e[0]=i+r*(n[0]-i),e[1]=a+r*(n[1]-a),e[2]=o+r*(n[2]-o),e[3]=s+r*(n[3]-s),e},Zi=function(e,t,n){var r=t[0],i=t[1],a=t[2],o=t[3],s=n[0],l=n[1],c=n[2],u=n[3];return e[0]=r*u+o*s+i*c-a*l,e[1]=i*u+o*l+a*s-r*c,e[2]=a*u+o*c+r*l-i*s,e[3]=o*u-r*s-i*l-a*c,e};var Qi=function(e,t){var n=t[0],r=t[1],i=t[2],a=t[3],o=n*n+r*r+i*i+a*a;o>0&&(o=1/Math.sqrt(o),e[0]=n*o,e[1]=r*o,e[2]=i*o,e[3]=a*o);return e},$i=function(e,t,n){n*=.5;var r=t[0],i=t[1],a=t[2],o=t[3],s=Math.sin(n),l=Math.cos(n);return e[0]=r*l+o*s,e[1]=i*l+a*s,e[2]=a*l-i*s,e[3]=o*l-r*s,e};var Ji=function(e,t,n){n*=.5;var r=t[0],i=t[1],a=t[2],o=t[3],s=Math.sin(n),l=Math.cos(n);return e[0]=r*l-a*s,e[1]=i*l+o*s,e[2]=a*l+r*s,e[3]=o*l-i*s,e};var Ki=function(e,t,n){n*=.5;var r=t[0],i=t[1],a=t[2],o=t[3],s=Math.sin(n),l=Math.cos(n);return e[0]=r*l+i*s,e[1]=i*l-r*s,e[2]=a*l+o*s,e[3]=o*l-a*s,e};var ea=function(e,t,n){n*=.5;var r=Math.sin(n);return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=Math.cos(n),e};var ta=$r,na=Ei,ra=xi,ia=ze,aa=Qi,oa=ea,sa=function(e,t,n){var r=ta(t,n);return r<-.999999?(na(la,ca,t),ra(la)<1e-6&&na(la,ua,t),ia(la,la),oa(e,la,Math.PI),e):r>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(na(la,t,n),e[0]=la[0],e[1]=la[1],e[2]=la[2],e[3]=1+r,aa(e,e))},la=[0,0,0],ca=[1,0,0],ua=[0,1,0];var fa=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e};var ha=function(e,t,n,r,i){return e[0]=t,e[1]=n,e[2]=r,e[3]=i,e};var pa=Ui,da=Qi,ma=function(e,t,n,r){return ga[0]=n[0],ga[3]=n[1],ga[6]=n[2],ga[1]=r[0],ga[4]=r[1],ga[7]=r[2],ga[2]=-t[0],ga[5]=-t[1],ga[8]=-t[2],da(e,pa(e,ga))},ga=function(){var e=new Float32Array(9);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}();var va=function(e,t,n,r){var i,a,o,s,l,c=t[0],u=t[1],f=t[2],h=t[3],p=n[0],d=n[1],m=n[2],g=n[3];(a=c*p+u*d+f*m+h*g)<0&&(a=-a,p=-p,d=-d,m=-m,g=-g);1-a>1e-6?(i=Math.acos(a),o=Math.sin(i),s=Math.sin((1-r)*i)/o,l=Math.sin(r*i)/o):(s=1-r,l=r);return e[0]=s*c+l*p,e[1]=s*u+l*d,e[2]=s*f+l*m,e[3]=s*h+l*g,e};var ba=va,ya=function(e,t,n,r,i,a){return ba(xa,t,i,a),ba(wa,n,r,a),ba(e,xa,wa,2*a*(1-a)),e},xa=[0,0,0,1],wa=[0,0,0,1];var _a={add:Ri,calculateW:Fi,clone:Bi,conjugate:ji,copy:Ni,create:Wi,dot:Vi,fromMat3:Ui,fromValues:Hi,identity:Yi,invert:Xi,length:Gi,lerp:qi,multiply:Zi,normalize:Qi,rotateX:$i,rotateY:Ji,rotateZ:Ki,rotationTo:sa,scale:fa,set:ha,setAxes:ma,setAxisAngle:ea,slerp:va,sqlerp:ya,squaredLength:function(e){var t=e[0],n=e[1],r=e[2],i=e[3];return t*t+n*n+r*r+i*i}};class Aa{constructor(e,{runner:t,variables:n,model:r,view:i,debug:a}){this.regl=e,this.performanceLogger=new hr(a.logPerformance),this.performanceLogger.start("BoxesViewSimple()"),this.lightPosition=i.lights[0].position,this.config=i,this.shadow=new zi(e,this.config.lights[0]),this.setParams=e({uniforms:{stageGrid_size:this.config.stageGrid.size/2,viewRange:e.prop("viewRange"),ambientLightAmount:this.config.ambientLightAmount,diffuseLightAmount:this.config.diffuseLightAmount}}),this.drawModel=function(e,{variables:t,view:n},r){const i=Br();let a=Rr.identity([]);const o=o=>e(s({depth:{enable:!0},blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:1},equation:{rgb:"add",alpha:"add"},color:[0,0,0,1]},cull:{enable:!0,face:"back"},elements:i.cells,instances:()=>t.segments,attributes:{aPosition:i.positions,aNormal:i.normals,aUV:i.uvs,a_particle:{buffer:e.buffer(Vr(t)),divisor:1},a_snapshot:{buffer:e.buffer(Wr(t)),divisor:1}},vert:[...t.packFloat2UInt8?["#define PACK_FLOAT"]:[],`#define ${o} 1`,jr].join("\n"),frag:[`#define ${o} 1`,Nr].join("\n"),uniforms:l(s(s(l(s({},r.uniforms),{stageSize:n.stageGrid.size}),"shadow"===o&&{projection:r.shadowProjectionMatrix,view:r.shadowViewMatrix}),"lighting"===o&&{shadowMap:r.fbo}),{utColorCorrections:(e,t)=>t.colorCorrections,utParticleColorAndType:(e,t)=>t.particleColorsAndTypes,ut_position:(e,t)=>t.position,viewRange:(e,t)=>t.viewRange||[0,1],snapshotCount:t.snapshotCount,iterations:t.iterations,iteration:()=>t.iteration,packFloat2UInt8:t.packFloat2UInt8?1:0,littleEndian:pr(),resolution:[4*t.snapshotCount,t.particleCount],particleCount:t.particleCount,pathicleGap:n.pathicleRelativeGap*n.pathicleWidth,pathicleHeight:n.pathicleWidth*n.pathicleRelativeHeight,pathicleWidth:n.pathicleWidth,model:(e,t)=>(a=Rr.identity([]),zr(a,[t.modelTranslateX||0,t.modelTranslateY||0,0]))})},"shadow"===o&&{framebuffer:r.fbo}));return{lighting:o("lighting"),shadow:o("shadow")}}(e,{runner:t,variables:n,view:i},this.shadow),this.drawStage=function(e,t,n){const r=function(e,t,n,r,i){e=e||1,t=t||1,n=n||1,r=r||1;const a=!(!i||!i.quads)&&i.quads,o=[],s=[],l=[],c=[];for(let u=0;u<=r;u++)for(let i=0;i<=n;i++){const f=i/n,h=u/r,p=-e/2+f*e,d=t/2-h*t;o.push([p,0,d]),s.push([f,1-h]),l.push([0,0,1]),u<r&&i<n&&(a?c.push([u*(n+1)+i,(u+1)*(n+1)+i,(u+1)*(n+1)+i+1,u*(n+1)+i+1]):(c.push([u*(n+1)+i,(u+1)*(n+1)+i+1,u*(n+1)+i+1]),c.push([(u+1)*(n+1)+i+1,u*(n+1)+i,(u+1)*(n+1)+i])))}return{positions:o,normals:l,uvs:s,cells:c}}(t.stageGrid.size,t.stageGrid.size);return{lighting:(i="lighting",e({blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:1},equation:{rgb:"add",alpha:"add"},color:[0,0,0,1]},cull:{enable:!0,face:"front"},depth:!0,primitive:"triangles",elements:r.cells,attributes:{position:r.positions,uv:r.uvs},uniforms:s(l(s({},n.uniforms),{stageSize:t.stageGrid.size,uOffset:[0,t.stageGrid.y,0]}),"lighting"===i&&{shadowMap:n.fbo}),vert:[`#define ${i} 1`,Hr].join("\n"),frag:[`#define ${i} 1`,Ur].join("\n")}))};var i}(e,i,this.shadow),this.drawLattice=Gr(e,{runner:t,model:r,view:i},this.shadow),this.drawFields=function(e,{model:t,view:n},r){const i=Ir(0,.01,.05),a=Ir(.005,.005,.05);a.positions=a.positions.map((([e,t,n])=>[e,t-.05,n]));const o=Lr([i,a]);let c=Rr.identity([]);const u=i=>e(s({depth:{enable:!0},blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:1},equation:{rgb:"add",alpha:"add"},color:[0,0,0,1]},cull:{enable:!0,face:"back"},elements:o.cells,instances:()=>7803,attributes:{aPosition:o.positions,aNormal:o.normals,aUV:o.uvs,aOffset:{buffer:e.buffer(Fr()),divisor:1}},vert:[`#define ${i} 1`,"precision mediump float;\n#define GLSLIFY 1\nattribute vec3 aOffset;\nattribute vec3 aPosition;\nattribute vec3 aNormal;\nattribute vec2 aUV;\nvarying vec2 vUv;\nvarying float v_visibility;\n// These three are instanced attributes.\nuniform mat4 projection, view;\nuniform vec3 magneticField;\nvarying vec3 vPosition;\nvarying float vColorCorrection;\nvarying vec3 vNormal;\nvarying vec3 vNormalOrig;\nvarying vec3 vColor;\nvarying vec3 vScale;\n\nstruct BeamlineElement {\n  vec3 middle;\n  vec3 size;\n  float phi;\n  int type; //0: drift, 1: dipole, 2: quadrupole, 3: esta\n  float strength;\n};\n\n/*__latticeSize__*/\n\nconst int BEAMLINE_ELEMENT_TYPE_DRIFT = 0;\nconst int BEAMLINE_ELEMENT_TYPE_DIPOLE = 1;\nconst int BEAMLINE_ELEMENT_TYPE_QUADRUPOLE = 2;\n\nmat3 mat3LookAt(vec3 eye, vec3 target, float roll) {\n  vec3 rr = vec3(sin(roll), cos(roll), 0.0);\n  vec3 ww = normalize(target - eye);\n  vec3 uu = normalize(cross(ww, rr));\n  vec3 vv = normalize(cross(uu, ww));\n\n  return mat3(uu, vv, ww);\n}\n\n/*__latticeChunkGLSL__*/\n\nmat2 rot2D(float phi) {\n  float c = cos(phi);\n  float s = sin(phi);\n  return mat2(c, -s, s, c);\n}\nfloat sdBox(vec3 p, vec3 s) {\n  vec3 d = abs(p) - .5 * s;\n  return min(max(d.x, max(d.y, d.z)), 0.0) + length(max(d, 0.0));\n}\nBeamlineElement getBeamlineElement(float id) {\n  for(int i = 0; i < BEAMLINE_ELEMENT_COUNT; i++) {\n    if(float(i) == id)\n      return beamline[i];\n  }\n  return beamline[0];\n}\n\nvec3 getB(vec3 position) {\n\n  vec3 B = magneticField;\n  \n\n  for(int i = 0; i < BEAMLINE_ELEMENT_COUNT; i++) {\n    BeamlineElement ble = beamline[i];\n    vec3 localPosition = position;\n    localPosition -= ble.middle;\n    localPosition.xz *= rot2D(ble.phi);\n    if(sdBox(localPosition, ble.size) <= 0.) {\n      if(ble.type == BEAMLINE_ELEMENT_TYPE_DIPOLE) {\n        B += vec3(0., ble.strength, 0.);\n      } else if(ble.type == BEAMLINE_ELEMENT_TYPE_QUADRUPOLE) {\n        B += abs(ble.strength) *\n          ((ble.strength > 0.) ? vec3(localPosition.y, localPosition.x, 0) : vec3(-localPosition.y, -localPosition.x, 0.));\n      }\n    }\n  }\n\n  return B;\n}\n\nmat3 rotateAlign(vec3 v1, vec3 v2) {\n  vec3 axis = cross(v1, v2);\n\n  float cosA = dot(v1, v2);\n  float k = 1. / (1. + cosA);\n\n  return mat3((axis.x * axis.x * k) + cosA, (axis.y * axis.x * k) - axis.z, (axis.z * axis.x * k) + axis.y, (axis.x * axis.y * k) + axis.z, (axis.y * axis.y * k) + cosA, (axis.z * axis.y * k) - axis.x, (axis.x * axis.z * k) - axis.y, (axis.y * axis.z * k) + axis.x, (axis.z * axis.z * k) + cosA);\n\n}\n\nvoid main() {\n  initLatticeData();\n  vUv = aUV;\n  vNormal = aNormal;\n  vNormalOrig = aNormal;\n\n  vec3 b = getB(aOffset);\n\n  vColor = .1 * vec3(b);\n  float scale = length(b) == 0. ? .0 : min(length(b)*1000., 1.) / 1.;\n  vec3 direction = normalize(b);\n\n  // mat3 lookAt = mat3LookAt(vec3(0.), direction, 0.1);\n\n  // Translate\n  mat4 tPos = mat4(vec4(1.0, 0.0, 0.0, 0.0), vec4(0.0, 1.0, 0.0, 0.0), vec4(0.0, 0.0, 1.0, 0.0), vec4(aOffset, 1.0));\n\n  // float angleX = dot(b, vec3(1., 0., 0.));\n  // float angleZ = 0.;\n  // float angleY = 0.;\n\n// // Rotate\n//   mat4 rXPos = mat4(vec4(1.0, 0.0, 0.0, 0.0), vec4(0.0, cos(angleX), -sin(angleX), 0.0), vec4(0.0, sin(angleX), cos(angleX), 0.0), vec4(0.0, 0.0, 0.0, 1.0));\n\n//   mat4 rYPos = mat4(vec4(cos(angleY), 0., -sin(angleY), 0.0), vec4(0.0, 1.0, 0.0, 0.0), vec4(sin(angleY), 0.0, cos(angleY), 0.0), vec4(0.0, 0.0, 0.0, 1.0));\n\n//   mat4 rZPos = mat4(vec4(cos(angleZ), -sin(angleZ), 0.0, 0.0), vec4(sin(angleZ), cos(angleZ), 0.0, 0.0), vec4(0.0, 0.0, 1.0, 0.0), vec4(0.0, 0.0, 0.0, 1.0));\n\n// Scale\n  // mat4 sScale = mat4(vec4(1., 0.0, 0.0, 0.0), vec4(0.0, scale, 0.0, 0.0), vec4(0.0, 0.0, 1., 0.0), vec4(0.0, 0.0, 0.0, 1.0));\n  mat3 sScale = mat3(vec3(1., 0.0, 0.0), vec3(0.0, scale, 0.0), vec3(0.0, 0.0, 1.));\n\n  // mat4 aModel = tPos * rotateAlign(b) * sScale;\n\n  vPosition = ( tPos *  vec4( sScale *  aPosition, 1.)).xyz;\n\n  gl_Position = projection * view * vec4(vPosition, 1.);\n}\n".replace("/*__latticeDefinition__*/",t.lattice.toGLSLDefinition()).replace("/*__latticeChunkGLSL__*/",fr(t.lattice)).replace("/*__latticeSize__*/",`const int BEAMLINE_ELEMENT_COUNT_OR_1 = ${t.lattice.activeBeamlineElements().length||1}; const int BEAMLINE_ELEMENT_COUNT = ${t.lattice.activeBeamlineElements().length};`)].join("\n"),frag:[`#define ${i} 1`,kr].join("\n"),uniforms:l(s(s(l(s({},r.uniforms),{stageSize:n.stageGrid.size,magneticField:t.interactions.magneticField}),"shadow"===i&&{projection:r.shadowProjectionMatrix,view:r.shadowViewMatrix}),"lighting"===i&&{shadowMap:r.fbo}),{utColorCorrections:(e,t)=>t.colorCorrections,model:(e,t)=>(c=Rr.identity([]),zr(c,[t.modelTranslateX||0,t.modelTranslateY||0,0]))})},"shadow"===i&&{framebuffer:r.fbo}));return{lighting:u("lighting"),shadow:u("shadow")}}(e,{model:r,view:i},this.shadow),this.drawAxis=function(e,t){const n=new Float32Array(16);return e({frag:"\n      precision highp float;\n      uniform vec3 axis;\n      void main () {\n        gl_FragColor = vec4(axis,1);\n      }\n    ",vert:"\n      precision highp float;\n      uniform mat4 projection, view, model;\n      uniform vec3 eye, center;\n      attribute vec3 position;\n      void main () {\n        gl_Position = projection * view * model * vec4(position,1);\n      }\n    ",uniforms:{axis:e.prop("axis"),model:function(e,t){Rr.identity(n),Rr.rotate(n,n,0,t.axis);const r=new Float32Array(16);let i=[0,0,0,0];return _a.rotationTo(i,[0,1,0],t.axis),Rr.fromQuat(r,i),Rr.multiply(n,n,r),n}},attributes:{position:[[0,0,0],[0,t-.1,0],[.05,t-.2,0],[0,t,0],[-.05,t-.2,0],[0,t-.1,0]],axis:e.prop("axis")},depth:{enable:!1},count:6,primitive:"line strip"})}(e,.5),this.drawVignette=function(e){return{lighting:e({blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:1},equation:{rgb:"add",alpha:"add"},color:[0,0,0,1]},frag:"precision highp float;\n#define GLSLIFY 1\n\n// Based on distance functions found at:\n// http://iquilezles.org/www/articles/distfunctions/distfunctions.htm\nfloat sdSquare(vec2 point, float width) {\n  vec2 d = abs(point) - width;\n  return min(max(d.x,d.y),0.0) + length(max(d,0.0));\n}\n\nfloat vignette(vec2 uv, vec2 size, float roundness, float smoothness) {\n  // Center UVs\n  uv -= 0.5;\n\n  // Shift UVs based on the larger of width or height\n  float minWidth = min(size.x, size.y);\n  uv.x = sign(uv.x) * clamp(abs(uv.x) - abs(minWidth - size.x), 0.0, 1.0);\n  uv.y = sign(uv.y) * clamp(abs(uv.y) - abs(minWidth - size.y), 0.0, 1.0);\n\n  // Signed distance calculation\n  float boxSize = minWidth * (1.0 - roundness);\n  float dist = sdSquare(uv, boxSize) - (minWidth * roundness);\n\n  return 1. - smoothstep(0.0, smoothness, dist);\n}\n\nuniform vec2 screenSize;\nuniform vec2 size;\nuniform float roundness;\nuniform float smoothness;\n\nvoid main() {\n  vec2 uv = gl_FragCoord.xy / screenSize;\n  float v = vignette(uv, size, roundness, smoothness);\n  gl_FragColor = vec4(vec3(v), 1.-2.*v);\n}\n",vert:"\n    precision mediump float;\n    attribute vec2 position;\n    void main() {\n      gl_Position = vec4(position, 0, 1);\n    }",attributes:{position:e.buffer([-4,-4,4,-4,0,4])},uniforms:{color:[1,1,0,1],screenSize:({viewportWidth:e,viewportHeight:t})=>[e,t],size:[.1,.1],roundness:.9,smoothness:.9},count:3,depth:{enable:!0}})}}(e)}drawDiffuse(e){this.performanceLogger.start(`BoxesViewSimple.drawDiffuse (t=${e.tick})`),this.regl.clear({color:[1,1,1,1],depth:1}),this.setParams({},(()=>{this.regl.clear({color:[1,1,1,1],depth:1,framebuffer:this.shadow.fbo}),this.config.isShadowEnabled&&this.drawModel.shadow(e),this.config.showAxes&&this.drawAxis([{axis:[1,0,0]},{axis:[0,1,0]},{axis:[0,0,1]}]),this.config.isStageVisible&&this.drawStage.lighting(e),this.config.isFieldVisible&&this.drawFields.lighting(e),this.config.isLatticeVisible&&this.drawLattice.estaLighting(e),this.config.isLatticeVisible&&this.drawLattice.quadLighting(e),this.config.isLatticeVisible&&this.drawLattice.sbenLighting(e),this.drawModel.lighting(e),this.config.showVignette&&this.drawVignette.lighting(e)})),this.performanceLogger.stop("BoxesViewSimple.drawDiffuse")}destroy(){}}function Sa(e,t,n){const r=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,r);const i=e.createTexture();e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,t,1,1,0,e.RGBA,n,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i,0);return e.checkFramebufferStatus(e.FRAMEBUFFER)===e.FRAMEBUFFER_COMPLETE}function Ta(){const e={};try{const t=document.createElement("canvas");if(window.WebGLRenderingContext&&(t.getContext("webgl")||t.getContext("experimental-webgl"))){const n=t.getContext("webgl")||t.getContext("experimental-webgl");return e.colorType=function(e){return e.getExtension("WEBGL_color_buffer_float")&&e.getExtension("OES_texture_float")&&Sa(e,e.RGBA,e.FLOAT)?"float":(e.getExtension("WEBGL_color_buffer_float")&&e.getExtension("OES_texture_half_float")&&Sa(e,e.RGBA,e.HALF_FLOAT),"half float")}(n),e.precision={VERTEX_SHADER:{LOW_FLOAT:n.getShaderPrecisionFormat(n.VERTEX_SHADER,n.LOW_FLOAT),MEDIUM_FLOAT:n.getShaderPrecisionFormat(n.VERTEX_SHADER,n.MEDIUM_FLOAT),HIGH_FLOAT:n.getShaderPrecisionFormat(n.VERTEX_SHADER,n.HIGH_FLOAT),LOW_INT:n.getShaderPrecisionFormat(n.VERTEX_SHADER,n.LOW_INT),MEDIUM_INT:n.getShaderPrecisionFormat(n.VERTEX_SHADER,n.MEDIUM_INT),HIGH_INT:n.getShaderPrecisionFormat(n.VERTEX_SHADER,n.HIGH_INT)},FRAGMENT_SHADER:{LOW_FLOAT:n.getShaderPrecisionFormat(n.FRAGMENT_SHADER,n.LOW_FLOAT),MEDIUM_FLOAT:n.getShaderPrecisionFormat(n.FRAGMENT_SHADER,n.MEDIUM_FLOAT),HIGH_FLOAT:n.getShaderPrecisionFormat(n.FRAGMENT_SHADER,n.HIGH_FLOAT),LOW_INT:n.getShaderPrecisionFormat(n.FRAGMENT_SHADER,n.LOW_INT),MEDIUM_INT:n.getShaderPrecisionFormat(n.FRAGMENT_SHADER,n.MEDIUM_INT),HIGH_INT:n.getShaderPrecisionFormat(n.FRAGMENT_SHADER,n.HIGH_INT)}},e}}catch(t){throw t}}const Ea=0,Ca=1,Ma=2;function Pa(e){return e({vert:"precision mediump float;\n#define GLSLIFY 1\nattribute vec2 position;\nvarying vec2 uv;\nvoid main () {\n  uv = position;\n  gl_Position = vec4(1.0 - 2.0 * position, 0, 1);\n}\n",frag:"precision highp float;\n#define GLSLIFY 1\nuniform sampler2D texture;\nuniform float decode;\nvarying vec2 uv;\nfloat unpackRGBA (vec4 v) {\n  return dot(v, 1.0 / vec4(1.0, 255.0, 65025.0, 16581375.0));\n}\nvoid main () {\n  vec4 texel = texture2D(texture, uv);\n  gl_FragColor = (decode == 0.) ? texel :\n    (decode == 1.) ?  vec4(unpackRGBA(texel),0.,0.,1.)\n    : vec4(texel.r,texel.r,texel.r,1.);\n}\n\n",attributes:{position:[-4,-4,4,-4,0,4]},uniforms:{texture:(e,{texture:t})=>t,decode:(e,{decode:t=Ea})=>t},viewport:{x:(e,t)=>t.x0||50,y:(e,t)=>t.y0||50,width:(e,t)=>t.texture.width*(t.scale||1),height:(e,t)=>t.texture.height*(t.scale||1)},depth:{enable:!1},count:3})}class Oa{constructor({canvas:e,config:t}){this.configuration=t,this.isDirty=!0,window.performanceLogger=null,this.performanceLogger=new hr(this.configuration.debug.logPerformance),c({canvas:e,profile:this.configuration.debug.profile,attributes:{preserveDrawingBuffer:!0,antialiasing:!0},extensions:["angle_instanced_arrays","oes_texture_float","OES_standard_derivatives","OES_texture_half_float","WEBGL_depth_texture","EXT_color_buffer_half_float"],optionalExtensions:["EXT_disjoint_timer_query"],onDone:(e,t)=>{if(e)return console.error(e);try{this.regl=t,window.pathicles=this,this.performanceLogger.start("checkSupport"),this.checkSupport(t),this.performanceLogger.start("init"),this.init(t),this.run(t)}catch(n){console.error(n)}}})}resize(){this.regl.poll(),this.isDirty=!0}destroy(){this.regl.destroy()}loadConfig(e){this.stop(this.regl),this.configuration=e,this.init(this.regl),this.run(this.regl),this.isDirty=!0}checkSupport(){this.support=Ta()}toggleShowTextures(){this.configuration.debug.showTextures=!this.configuration.debug.showTextures,this.isDirty=!0}init(e){this.camera=$t(e,l(s({},this.configuration.view.camera),{aspectRatio:e._gl.canvas.clientWidth/e._gl.canvas.clientHeight})),this.drawTexture=Pa(e),this.simulation=new wr(e,this.configuration,this.support),this.runner=new Dr(this.simulation,this.configuration.runner,this.configuration.debug),this.view=new Aa(e,{variables:this.simulation.variables,runner:this.simulation.runner,model:this.simulation.model,view:this.configuration.view,debug:this.configuration.debug})}run(e){this.loop=e.frame((({viewportHeight:e,tick:t})=>{const{changed:n}=this.runner.next();this.isDirty=this.isDirty||n,this.camera.doAutorotate(),this.camera.tick(),(this.isDirty||this.camera.state.dirty)&&(this.isDirty=!1,this.camera.setCameraUniforms(s({},this.camera),(()=>{this.view.drawDiffuse({tick:t,colorCorrections:this.simulation.variables.colorCorrections,particleColorsAndTypes:this.simulation.variables.particleColorsAndTypes,position:this.simulation.variables.position.value()}),this.configuration.debug.showTextures&&(this.drawTexture({decode:this.configuration.runner.packFloat2UInt8?Ca:Ma,y0:e-this.simulation.variables.velocity.height*this.configuration.debug.showTextureScale,texture:this.simulation.variables.position.value(),scale:1*this.configuration.debug.showTextureScale}),this.drawTexture({decode:this.configuration.runner.packFloat2UInt8?Ca:Ma,texture:this.simulation.variables.velocity.value(),y0:e-50-2*this.simulation.variables.velocity.height*this.configuration.debug.showTextureScale,scale:this.configuration.debug.showTextureScale}))}))),this.performanceLogger.stop()}))}stop(){this.loop&&this.loop.cancel()}}var Da=function(e,t,n,r,i,a){var o,s,l,c,u=n.length,f=n[0].length;if(t<1)throw new Error("degree must be at least 1 (linear)");if(t>u-1)throw new Error("degree must be less than or equal to point count - 1");if(!i)for(i=[],o=0;o<u;o++)i[o]=1;if(r){if(r.length!==u+t+1)throw new Error("bad knot vector length")}else{r=[];for(o=0;o<u+t+1;o++)r[o]=o}var h=[t,r.length-1-t],p=r[h[0]],d=r[h[1]];if((e=e*(d-p)+p)<p||e>d)throw new Error("out of bounds");for(l=h[0];l<h[1]&&!(e>=r[l]&&e<=r[l+1]);l++);var m,g=[];for(o=0;o<u;o++){for(g[o]=[],s=0;s<f;s++)g[o][s]=n[o][s]*i[o];g[o][f]=i[o]}for(c=1;c<=t+1;c++)for(o=l;o>l-t-1+c;o--)for(m=(e-r[o])/(r[o+t+1-c]-r[o]),s=0;s<f+1;s++)g[o][s]=(1-m)*g[o-1][s]+m*g[o][s];for(a=a||[],o=0;o<f;o++)a[o]=g[l][o]/g[l][f];return a};var Ia={exports:{}},La=Ia.exports=function(){function e(e,t){this.id=Z++,this.type=e,this.data=t}function t(e){if(0===e.length)return[];var n=e.charAt(0),r=e.charAt(e.length-1);if(1<e.length&&n===r&&('"'===n||"'"===n))return['"'+e.substr(1,e.length-2).replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'];if(n=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(e))return t(e.substr(0,n.index)).concat(t(n[1])).concat(t(e.substr(n.index+n[0].length)));if(1===(n=e.split(".")).length)return['"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'];for(e=[],r=0;r<n.length;++r)e=e.concat(t(n[r]));return e}function n(e){return"["+t(e).join("][")+"]"}function r(t,n){return"function"==typeof t?new e(0,t):"number"==typeof t||"boolean"==typeof t?new e(5,t):Array.isArray(t)?new e(6,t.map((function(e,t){return r(e)}))):t instanceof e?t:void 0}function i(){var e={"":0},t=[""];return{id:function(n){var r=e[n];return r||(r=e[n]=t.length,t.push(n),r)},str:function(e){return t[e]}}}function a(e,t,n){function r(){var t=window.innerWidth,r=window.innerHeight;e!==document.body&&(t=(r=a.getBoundingClientRect()).right-r.left,r=r.bottom-r.top),a.width=n*t,a.height=n*r}var i,a=document.createElement("canvas");return q(a.style,{border:0,margin:0,padding:0,top:0,left:0,width:"100%",height:"100%"}),e.appendChild(a),e===document.body&&(a.style.position="absolute",q(e.style,{margin:0,padding:0})),e!==document.body&&"function"==typeof ResizeObserver?(i=new ResizeObserver((function(){setTimeout(r)}))).observe(e):window.addEventListener("resize",r,!1),r(),{canvas:a,onDestroy:function(){i?i.disconnect():window.removeEventListener("resize",r),e.removeChild(a)}}}function o(e,t){function n(n){try{return e.getContext(n,t)}catch(r){return null}}return n("webgl")||n("experimental-webgl")||n("webgl-experimental")}function s(e){return"string"==typeof e?e.split():e}function l(e){return"string"==typeof e?document.querySelector(e):e}function c(e){var t,n,r,i,c=e||{};e={};var u=[],f=[],h="undefined"==typeof window?1:window.devicePixelRatio,p=!1,d=function(e){},m=function(){};if("string"==typeof c?t=document.querySelector(c):"object"==typeof c&&("string"==typeof c.nodeName&&"function"==typeof c.appendChild&&"function"==typeof c.getBoundingClientRect?t=c:"function"==typeof c.drawArrays||"function"==typeof c.drawElements?r=(i=c).canvas:("gl"in c?i=c.gl:"canvas"in c?r=l(c.canvas):"container"in c&&(n=l(c.container)),"attributes"in c&&(e=c.attributes),"extensions"in c&&(u=s(c.extensions)),"optionalExtensions"in c&&(f=s(c.optionalExtensions)),"onDone"in c&&(d=c.onDone),"profile"in c&&(p=!!c.profile),"pixelRatio"in c&&(h=+c.pixelRatio))),t&&("canvas"===t.nodeName.toLowerCase()?r=t:n=t),!i){if(!r){if(!(t=a(n||document.body,d,h)))return null;r=t.canvas,m=t.onDestroy}void 0===e.premultipliedAlpha&&(e.premultipliedAlpha=!0),i=o(r,e)}return i?{gl:i,canvas:r,container:n,extensions:u,optionalExtensions:f,pixelRatio:h,profile:p,onDone:d,onDestroy:m}:(m(),d("webgl not supported, try upgrading your browser or graphics drivers http://get.webgl.org"),null)}function u(e,t){function n(t){var n;t=t.toLowerCase();try{n=r[t]=e.getExtension(t)}catch(i){}return!!n}for(var r={},i=0;i<t.extensions.length;++i){var a=t.extensions[i];if(!n(a))return t.onDestroy(),t.onDone('"'+a+'" extension is not supported by the current WebGL context, try upgrading your system or a different browser'),null}return t.optionalExtensions.forEach(n),{extensions:r,restore:function(){Object.keys(r).forEach((function(e){if(r[e]&&!n(e))throw Error("(regl): error restoring extension "+e)}))}}}function f(e,t){for(var n=Array(e),r=0;r<e;++r)n[r]=t(r);return n}function h(e){var t,n;return t=(65535<e)<<4,t|=n=(255<(e>>>=t))<<3,(t|=n=(15<(e>>>=n))<<2)|(n=(3<(e>>>=n))<<1)|e>>>n>>1}function p(){function e(e){e:{for(var t=16;268435456>=t;t*=16)if(e<=t){e=t;break e}e=0}return 0<(t=n[h(e)>>2]).length?t.pop():new ArrayBuffer(e)}function t(e){n[h(e.byteLength)>>2].push(e)}var n=f(8,(function(){return[]}));return{alloc:e,free:t,allocType:function(t,n){var r=null;switch(t){case 5120:r=new Int8Array(e(n),0,n);break;case 5121:r=new Uint8Array(e(n),0,n);break;case 5122:r=new Int16Array(e(2*n),0,n);break;case 5123:r=new Uint16Array(e(2*n),0,n);break;case 5124:r=new Int32Array(e(4*n),0,n);break;case 5125:r=new Uint32Array(e(4*n),0,n);break;case 5126:r=new Float32Array(e(4*n),0,n);break;default:return null}return r.length!==n?r.subarray(0,n):r},freeType:function(e){t(e.buffer)}}}function d(e){return!!e&&"object"==typeof e&&Array.isArray(e.shape)&&Array.isArray(e.stride)&&"number"==typeof e.offset&&e.shape.length===e.stride.length&&(Array.isArray(e.data)||te(e.data))}function m(e,t,n,r,i,a){for(var o=0;o<t;++o)for(var s=e[o],l=0;l<n;++l)for(var c=s[l],u=0;u<r;++u)i[a++]=c[u]}function g(e,t,n,r,i){for(var a=1,o=n+1;o<t.length;++o)a*=t[o];var s=t[n];if(t.length-n==4){var l=t[n+1],c=t[n+2];for(t=t[n+3],o=0;o<s;++o)m(e[o],l,c,t,r,i),i+=a}else for(o=0;o<s;++o)g(e[o],t,n+1,r,i),i+=a}function v(e){return 0|ie[Object.prototype.toString.call(e)]}function b(e,t){for(var n=0;n<t.length;++n)e[n]=t[n]}function y(e,t,n,r,i,a,o){for(var s=0,l=0;l<n;++l)for(var c=0;c<r;++c)e[s++]=t[i*l+a*c+o]}function x(e,t,n,r){function i(t){this.id=l++,this.buffer=e.createBuffer(),this.type=t,this.usage=35044,this.byteLength=0,this.dimension=1,this.dtype=5121,this.persistentData=null,n.profile&&(this.stats={size:0})}function a(t,n,r){t.byteLength=n.byteLength,e.bufferData(t.type,n,r)}function o(e,t,n,r,i,o){if(e.usage=n,Array.isArray(t)){if(e.dtype=r||5126,0<t.length)if(Array.isArray(t[0])){i=le(t);for(var s=r=1;s<i.length;++s)r*=i[s];e.dimension=r,a(e,t=se(t,i,e.dtype),n),o?e.persistentData=t:K.freeType(t)}else"number"==typeof t[0]?(e.dimension=i,b(i=K.allocType(e.dtype,t.length),t),a(e,i,n),o?e.persistentData=i:K.freeType(i)):te(t[0])&&(e.dimension=t[0].length,e.dtype=r||v(t[0])||5126,a(e,t=se(t,[t.length,t[0].length],e.dtype),n),o?e.persistentData=t:K.freeType(t))}else if(te(t))e.dtype=r||v(t),e.dimension=i,a(e,t,n),o&&(e.persistentData=new Uint8Array(new Uint8Array(t.buffer)));else if(d(t)){i=t.shape;var l=t.stride,c=(s=t.offset,0),u=0,f=0,h=0;1===i.length?(c=i[0],u=1,f=l[0],h=0):2===i.length&&(c=i[0],u=i[1],f=l[0],h=l[1]),e.dtype=r||v(t.data)||5126,e.dimension=u,y(i=K.allocType(e.dtype,c*u),t.data,c,u,f,h,s),a(e,i,n),o?e.persistentData=i:K.freeType(i)}else t instanceof ArrayBuffer&&(e.dtype=5121,e.dimension=i,a(e,t,n),o&&(e.persistentData=new Uint8Array(new Uint8Array(t))))}function s(n){t.bufferCount--,r(n),e.deleteBuffer(n.buffer),n.buffer=null,delete c[n.id]}var l=0,c={};i.prototype.bind=function(){e.bindBuffer(this.type,this.buffer)},i.prototype.destroy=function(){s(this)};var u=[];return n.profile&&(t.getTotalBufferSize=function(){var e=0;return Object.keys(c).forEach((function(t){e+=c[t].stats.size})),e}),{create:function(r,a,l,u){function f(t){var r=35044,i=null,a=0,s=0,l=1;return Array.isArray(t)||te(t)||d(t)||t instanceof ArrayBuffer?i=t:"number"==typeof t?a=0|t:t&&("data"in t&&(i=t.data),"usage"in t&&(r=oe[t.usage]),"type"in t&&(s=ae[t.type]),"dimension"in t&&(l=0|t.dimension),"length"in t&&(a=0|t.length)),h.bind(),i?o(h,i,r,s,l,u):(a&&e.bufferData(h.type,a,r),h.dtype=s||5121,h.usage=r,h.dimension=l,h.byteLength=a),n.profile&&(h.stats.size=h.byteLength*ce[h.dtype]),f}t.bufferCount++;var h=new i(a);return c[h.id]=h,l||f(r),f._reglType="buffer",f._buffer=h,f.subdata=function(t,n){var r,i=0|(n||0);if(h.bind(),te(t)||t instanceof ArrayBuffer)e.bufferSubData(h.type,i,t);else if(Array.isArray(t)){if(0<t.length)if("number"==typeof t[0]){var a=K.allocType(h.dtype,t.length);b(a,t),e.bufferSubData(h.type,i,a),K.freeType(a)}else(Array.isArray(t[0])||te(t[0]))&&(r=le(t),a=se(t,r,h.dtype),e.bufferSubData(h.type,i,a),K.freeType(a))}else if(d(t)){r=t.shape;var o=t.stride,s=a=0,l=0,c=0;1===r.length?(a=r[0],s=1,l=o[0],c=0):2===r.length&&(a=r[0],s=r[1],l=o[0],c=o[1]),r=Array.isArray(t.data)?h.dtype:v(t.data),y(r=K.allocType(r,a*s),t.data,a,s,l,c,t.offset),e.bufferSubData(h.type,i,r),K.freeType(r)}return f},n.profile&&(f.stats=h.stats),f.destroy=function(){s(h)},f},createStream:function(e,t){var n=u.pop();return n||(n=new i(e)),n.bind(),o(n,t,35040,0,1,!1),n},destroyStream:function(e){u.push(e)},clear:function(){ne(c).forEach(s),u.forEach(s)},getBuffer:function(e){return e&&e._buffer instanceof i?e._buffer:null},restore:function(){ne(c).forEach((function(t){t.buffer=e.createBuffer(),e.bindBuffer(t.type,t.buffer),e.bufferData(t.type,t.persistentData||t.byteLength,t.usage)}))},_initBuffer:o}}function w(e,t,n,r){function i(e){this.id=l++,s[this.id]=this,this.buffer=e,this.primType=4,this.type=this.vertCount=0}function a(r,i,a,o,s,l,c){var u;if(r.buffer.bind(),i?((u=c)||te(i)&&(!d(i)||te(i.data))||(u=t.oes_element_index_uint?5125:5123),n._initBuffer(r.buffer,i,a,u,3)):(e.bufferData(34963,l,a),r.buffer.dtype=u||5121,r.buffer.usage=a,r.buffer.dimension=3,r.buffer.byteLength=l),u=c,!c){switch(r.buffer.dtype){case 5121:case 5120:u=5121;break;case 5123:case 5122:u=5123;break;case 5125:case 5124:u=5125}r.buffer.dtype=u}r.type=u,0>(i=s)&&(i=r.buffer.byteLength,5123===u?i>>=1:5125===u&&(i>>=2)),r.vertCount=i,i=o,0>o&&(i=4,1===(o=r.buffer.dimension)&&(i=0),2===o&&(i=1),3===o&&(i=4)),r.primType=i}function o(e){r.elementsCount--,delete s[e.id],e.buffer.destroy(),e.buffer=null}var s={},l=0,c={uint8:5121,uint16:5123};t.oes_element_index_uint&&(c.uint32=5125),i.prototype.bind=function(){this.buffer.bind()};var u=[];return{create:function(e,t){function s(e){if(e)if("number"==typeof e)l(e),u.primType=4,u.vertCount=0|e,u.type=5121;else{var t=null,n=35044,r=-1,i=-1,o=0,f=0;Array.isArray(e)||te(e)||d(e)?t=e:("data"in e&&(t=e.data),"usage"in e&&(n=oe[e.usage]),"primitive"in e&&(r=ue[e.primitive]),"count"in e&&(i=0|e.count),"type"in e&&(f=c[e.type]),"length"in e?o=0|e.length:(o=i,5123===f||5122===f?o*=2:5125!==f&&5124!==f||(o*=4))),a(u,t,n,r,i,o,f)}else l(),u.primType=4,u.vertCount=0,u.type=5121;return s}var l=n.create(null,34963,!0),u=new i(l._buffer);return r.elementsCount++,s(e),s._reglType="elements",s._elements=u,s.subdata=function(e,t){return l.subdata(e,t),s},s.destroy=function(){o(u)},s},createStream:function(e){var t=u.pop();return t||(t=new i(n.create(null,34963,!0,!1)._buffer)),a(t,e,35040,-1,-1,0,0),t},destroyStream:function(e){u.push(e)},getElements:function(e){return"function"==typeof e&&e._elements instanceof i?e._elements:null},clear:function(){ne(s).forEach(o)}}}function _(e){for(var t=K.allocType(5123,e.length),n=0;n<e.length;++n)if(isNaN(e[n]))t[n]=65535;else if(e[n]===1/0)t[n]=31744;else if(e[n]===-1/0)t[n]=64512;else{fe[0]=e[n];var r=(a=he[0])>>>31<<15,i=(a<<1>>>24)-127,a=a>>13&1023;t[n]=-24>i?r:-14>i?r+(a+1024>>-14-i):15<i?r+31744:r+(i+15<<10)+a}return t}function A(e){return Array.isArray(e)||te(e)}function S(e){return"[object "+e+"]"}function T(e){return Array.isArray(e)&&(0===e.length||"number"==typeof e[0])}function E(e){return!(!Array.isArray(e)||0===e.length||!A(e[0]))}function C(e){return Object.prototype.toString.call(e)}function M(e){if(!e)return!1;var t=C(e);return 0<=_e.indexOf(t)||T(e)||E(e)||d(e)}function P(e,t){36193===e.type?(e.data=_(t),K.freeType(t)):e.data=t}function O(e,t,n,r,i,a){if(e=void 0!==Se[e]?Se[e]:me[e]*Ae[t],a&&(e*=6),i){for(r=0;1<=n;)r+=e*n*n,n/=2;return r}return e*n*r}function D(e,t,n,r,i,a,o){function s(){this.format=this.internalformat=6408,this.type=5121,this.flipY=this.premultiplyAlpha=this.compressed=!1,this.unpackAlignment=1,this.colorSpace=37444,this.channels=this.height=this.width=0}function l(e,t){e.internalformat=t.internalformat,e.format=t.format,e.type=t.type,e.compressed=t.compressed,e.premultiplyAlpha=t.premultiplyAlpha,e.flipY=t.flipY,e.unpackAlignment=t.unpackAlignment,e.colorSpace=t.colorSpace,e.width=t.width,e.height=t.height,e.channels=t.channels}function c(e,t){if("object"==typeof t&&t){"premultiplyAlpha"in t&&(e.premultiplyAlpha=t.premultiplyAlpha),"flipY"in t&&(e.flipY=t.flipY),"alignment"in t&&(e.unpackAlignment=t.alignment),"colorSpace"in t&&(e.colorSpace=V[t.colorSpace]),"type"in t&&(e.type=U[t.type]);var n=e.width,r=e.height,i=e.channels,a=!1;"shape"in t?(n=t.shape[0],r=t.shape[1],3===t.shape.length&&(i=t.shape[2],a=!0)):("radius"in t&&(n=r=t.radius),"width"in t&&(n=t.width),"height"in t&&(r=t.height),"channels"in t&&(i=t.channels,a=!0)),e.width=0|n,e.height=0|r,e.channels=0|i,n=!1,"format"in t&&(n=t.format,r=e.internalformat=H[n],e.format=ae[r],n in U&&!("type"in t)&&(e.type=U[n]),n in Y&&(e.compressed=!0),n=!0),!a&&n?e.channels=me[e.format]:a&&!n&&e.channels!==de[e.format]&&(e.format=e.internalformat=de[e.channels])}}function u(t){e.pixelStorei(37440,t.flipY),e.pixelStorei(37441,t.premultiplyAlpha),e.pixelStorei(37443,t.colorSpace),e.pixelStorei(3317,t.unpackAlignment)}function f(){s.call(this),this.yOffset=this.xOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function h(e,t){var n=null;if(M(t)?n=t:t&&(c(e,t),"x"in t&&(e.xOffset=0|t.x),"y"in t&&(e.yOffset=0|t.y),M(t.data)&&(n=t.data)),t.copy){var r=i.viewportWidth,a=i.viewportHeight;e.width=e.width||r-e.xOffset,e.height=e.height||a-e.yOffset,e.needsCopy=!0}else if(n){if(te(n))e.channels=e.channels||4,e.data=n,"type"in t||5121!==e.type||(e.type=0|ie[Object.prototype.toString.call(n)]);else if(T(n)){switch(e.channels=e.channels||4,a=(r=n).length,e.type){case 5121:case 5123:case 5125:case 5126:(a=K.allocType(e.type,a)).set(r),e.data=a;break;case 36193:e.data=_(r)}e.alignment=1,e.needsFree=!0}else if(d(n)){r=n.data,Array.isArray(r)||5121!==e.type||(e.type=0|ie[Object.prototype.toString.call(r)]),a=n.shape;var o,s,l,u,f=n.stride;3===a.length?(l=a[2],u=f[2]):u=l=1,o=a[0],s=a[1],a=f[0],f=f[1],e.alignment=1,e.width=o,e.height=s,e.channels=l,e.format=e.internalformat=de[l],e.needsFree=!0,o=u,n=n.offset,l=e.width,u=e.height,s=e.channels;for(var h=K.allocType(36193===e.type?5126:e.type,l*u*s),p=0,m=0;m<u;++m)for(var g=0;g<l;++g)for(var v=0;v<s;++v)h[p++]=r[a*g+f*m+o*v+n];P(e,h)}else if(C(n)===ge||C(n)===ve||C(n)===be)C(n)===ge||C(n)===ve?e.element=n:e.element=n.canvas,e.width=e.element.width,e.height=e.element.height,e.channels=4;else if(C(n)===ye)e.element=n,e.width=n.width,e.height=n.height,e.channels=4;else if(C(n)===xe)e.element=n,e.width=n.naturalWidth,e.height=n.naturalHeight,e.channels=4;else if(C(n)===we)e.element=n,e.width=n.videoWidth,e.height=n.videoHeight,e.channels=4;else if(E(n)){for(r=e.width||n[0].length,a=e.height||n.length,f=e.channels,f=A(n[0][0])?f||n[0][0].length:f||1,o=re.shape(n),l=1,u=0;u<o.length;++u)l*=o[u];l=K.allocType(36193===e.type?5126:e.type,l),re.flatten(n,o,"",l),P(e,l),e.alignment=1,e.width=r,e.height=a,e.channels=f,e.format=e.internalformat=de[f],e.needsFree=!0}}else e.width=e.width||1,e.height=e.height||1,e.channels=e.channels||4}function p(t,n,i,a,o){var s=t.element,l=t.data,c=t.internalformat,f=t.format,h=t.type,p=t.width,d=t.height;u(t),s?e.texSubImage2D(n,o,i,a,f,h,s):t.compressed?e.compressedTexSubImage2D(n,o,i,a,c,p,d,l):t.needsCopy?(r(),e.copyTexSubImage2D(n,o,i,a,t.xOffset,t.yOffset,p,d)):e.texSubImage2D(n,o,i,a,p,d,f,h,l)}function m(){return oe.pop()||new f}function g(e){e.needsFree&&K.freeType(e.data),f.call(e),oe.push(e)}function v(){s.call(this),this.genMipmaps=!1,this.mipmapHint=4352,this.mipmask=0,this.images=Array(16)}function b(e,t,n){var r=e.images[0]=m();e.mipmask=1,r.width=e.width=t,r.height=e.height=n,r.channels=e.channels=4}function y(e,t){var n=null;if(M(t))l(n=e.images[0]=m(),e),h(n,t),e.mipmask=1;else if(c(e,t),Array.isArray(t.mipmap))for(var r=t.mipmap,i=0;i<r.length;++i)l(n=e.images[i]=m(),e),n.width>>=i,n.height>>=i,h(n,r[i]),e.mipmask|=1<<i;else l(n=e.images[0]=m(),e),h(n,t),e.mipmask=1;l(e,e.images[0])}function x(t,n){for(var i=t.images,a=0;a<i.length&&i[a];++a){var o=i[a],s=n,l=a,c=o.element,f=o.data,h=o.internalformat,p=o.format,d=o.type,m=o.width,g=o.height;u(o),c?e.texImage2D(s,l,p,p,d,c):o.compressed?e.compressedTexImage2D(s,l,h,m,g,0,f):o.needsCopy?(r(),e.copyTexImage2D(s,l,p,o.xOffset,o.yOffset,m,g,0)):e.texImage2D(s,l,p,m,g,0,p,d,f||null)}}function w(){var e=se.pop()||new v;s.call(e);for(var t=e.mipmask=0;16>t;++t)e.images[t]=null;return e}function S(e){for(var t=e.images,n=0;n<t.length;++n)t[n]&&g(t[n]),t[n]=null;se.push(e)}function D(){this.magFilter=this.minFilter=9728,this.wrapT=this.wrapS=33071,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=4352}function I(e,t){"min"in t&&(e.minFilter=W[t.min],0<=pe.indexOf(e.minFilter)&&!("faces"in t)&&(e.genMipmaps=!0)),"mag"in t&&(e.magFilter=N[t.mag]);var n=e.wrapS,r=e.wrapT;if("wrap"in t){var i=t.wrap;"string"==typeof i?n=r=j[i]:Array.isArray(i)&&(n=j[i[0]],r=j[i[1]])}else"wrapS"in t&&(n=j[t.wrapS]),"wrapT"in t&&(r=j[t.wrapT]);if(e.wrapS=n,e.wrapT=r,"anisotropic"in t&&(e.anisotropic=t.anisotropic),"mipmap"in t){switch(n=!1,typeof t.mipmap){case"string":e.mipmapHint=B[t.mipmap],n=e.genMipmaps=!0;break;case"boolean":n=e.genMipmaps=t.mipmap;break;case"object":e.genMipmaps=!1,n=!0}!n||"min"in t||(e.minFilter=9984)}}function L(n,r){e.texParameteri(r,10241,n.minFilter),e.texParameteri(r,10240,n.magFilter),e.texParameteri(r,10242,n.wrapS),e.texParameteri(r,10243,n.wrapT),t.ext_texture_filter_anisotropic&&e.texParameteri(r,34046,n.anisotropic),n.genMipmaps&&(e.hint(33170,n.mipmapHint),e.generateMipmap(r))}function k(t){s.call(this),this.mipmask=0,this.internalformat=6408,this.id=le++,this.refCount=1,this.target=t,this.texture=e.createTexture(),this.unit=-1,this.bindCount=0,this.texInfo=new D,o.profile&&(this.stats={size:0})}function z(t){e.activeTexture(33984),e.bindTexture(t.target,t.texture)}function R(){var t=fe[0];t?e.bindTexture(t.target,t.texture):e.bindTexture(3553,null)}function F(t){var n=t.texture,r=t.unit,i=t.target;0<=r&&(e.activeTexture(33984+r),e.bindTexture(i,null),fe[r]=null),e.deleteTexture(n),t.texture=null,t.params=null,t.pixels=null,t.refCount=0,delete ce[t.id],a.textureCount--}var B={"don't care":4352,"dont care":4352,nice:4354,fast:4353},j={repeat:10497,clamp:33071,mirror:33648},N={nearest:9728,linear:9729},W=q({mipmap:9987,"nearest mipmap nearest":9984,"linear mipmap nearest":9985,"nearest mipmap linear":9986,"linear mipmap linear":9987},N),V={none:0,browser:37444},U={uint8:5121,rgba4:32819,rgb565:33635,"rgb5 a1":32820},H={alpha:6406,luminance:6409,"luminance alpha":6410,rgb:6407,rgba:6408,rgba4:32854,"rgb5 a1":32855,rgb565:36194},Y={};t.ext_srgb&&(H.srgb=35904,H.srgba=35906),t.oes_texture_float&&(U.float32=U.float=5126),t.oes_texture_half_float&&(U.float16=U["half float"]=36193),t.webgl_depth_texture&&(q(H,{depth:6402,"depth stencil":34041}),q(U,{uint16:5123,uint32:5125,"depth stencil":34042})),t.webgl_compressed_texture_s3tc&&q(Y,{"rgb s3tc dxt1":33776,"rgba s3tc dxt1":33777,"rgba s3tc dxt3":33778,"rgba s3tc dxt5":33779}),t.webgl_compressed_texture_atc&&q(Y,{"rgb atc":35986,"rgba atc explicit alpha":35987,"rgba atc interpolated alpha":34798}),t.webgl_compressed_texture_pvrtc&&q(Y,{"rgb pvrtc 4bppv1":35840,"rgb pvrtc 2bppv1":35841,"rgba pvrtc 4bppv1":35842,"rgba pvrtc 2bppv1":35843}),t.webgl_compressed_texture_etc1&&(Y["rgb etc1"]=36196);var X=Array.prototype.slice.call(e.getParameter(34467));Object.keys(Y).forEach((function(e){var t=Y[e];0<=X.indexOf(t)&&(H[e]=t)}));var G=Object.keys(H);n.textureFormats=G;var Z=[];Object.keys(H).forEach((function(e){Z[H[e]]=e}));var Q=[];Object.keys(U).forEach((function(e){Q[U[e]]=e}));var $=[];Object.keys(N).forEach((function(e){$[N[e]]=e}));var J=[];Object.keys(W).forEach((function(e){J[W[e]]=e}));var ee=[];Object.keys(j).forEach((function(e){ee[j[e]]=e}));var ae=G.reduce((function(e,n){var r=H[n];return 6409===r||6406===r||6409===r||6410===r||6402===r||34041===r||t.ext_srgb&&(35904===r||35906===r)?e[r]=r:32855===r||0<=n.indexOf("rgba")?e[r]=6408:e[r]=6407,e}),{}),oe=[],se=[],le=0,ce={},ue=n.maxTextureUnits,fe=Array(ue).map((function(){return null}));return q(k.prototype,{bind:function(){this.bindCount+=1;var t=this.unit;if(0>t){for(var n=0;n<ue;++n){var r=fe[n];if(r){if(0<r.bindCount)continue;r.unit=-1}fe[n]=this,t=n;break}o.profile&&a.maxTextureUnits<t+1&&(a.maxTextureUnits=t+1),this.unit=t,e.activeTexture(33984+t),e.bindTexture(this.target,this.texture)}return t},unbind:function(){--this.bindCount},decRef:function(){0>=--this.refCount&&F(this)}}),o.profile&&(a.getTotalTextureSize=function(){var e=0;return Object.keys(ce).forEach((function(t){e+=ce[t].stats.size})),e}),{create2D:function(t,n){function r(e,t){var n=i.texInfo;D.call(n);var a=w();return"number"==typeof e?b(a,0|e,"number"==typeof t?0|t:0|e):e?(I(n,e),y(a,e)):b(a,1,1),n.genMipmaps&&(a.mipmask=(a.width<<1)-1),i.mipmask=a.mipmask,l(i,a),i.internalformat=a.internalformat,r.width=a.width,r.height=a.height,z(i),x(a,3553),L(n,3553),R(),S(a),o.profile&&(i.stats.size=O(i.internalformat,i.type,a.width,a.height,n.genMipmaps,!1)),r.format=Z[i.internalformat],r.type=Q[i.type],r.mag=$[n.magFilter],r.min=J[n.minFilter],r.wrapS=ee[n.wrapS],r.wrapT=ee[n.wrapT],r}var i=new k(3553);return ce[i.id]=i,a.textureCount++,r(t,n),r.subimage=function(e,t,n,a){t|=0,n|=0,a|=0;var o=m();return l(o,i),o.width=0,o.height=0,h(o,e),o.width=o.width||(i.width>>a)-t,o.height=o.height||(i.height>>a)-n,z(i),p(o,3553,t,n,a),R(),g(o),r},r.resize=function(t,n){var a=0|t,s=0|n||a;if(a===i.width&&s===i.height)return r;r.width=i.width=a,r.height=i.height=s,z(i);for(var l=0;i.mipmask>>l;++l){var c=a>>l,u=s>>l;if(!c||!u)break;e.texImage2D(3553,l,i.format,c,u,0,i.format,i.type,null)}return R(),o.profile&&(i.stats.size=O(i.internalformat,i.type,a,s,!1,!1)),r},r._reglType="texture2d",r._texture=i,o.profile&&(r.stats=i.stats),r.destroy=function(){i.decRef()},r},createCube:function(t,n,r,i,s,u){function f(e,t,n,r,i,a){var s,u=d.texInfo;for(D.call(u),s=0;6>s;++s)v[s]=w();if("number"!=typeof e&&e){if("object"==typeof e)if(t)y(v[0],e),y(v[1],t),y(v[2],n),y(v[3],r),y(v[4],i),y(v[5],a);else if(I(u,e),c(d,e),"faces"in e)for(e=e.faces,s=0;6>s;++s)l(v[s],d),y(v[s],e[s]);else for(s=0;6>s;++s)y(v[s],e)}else for(e=0|e||1,s=0;6>s;++s)b(v[s],e,e);for(l(d,v[0]),d.mipmask=u.genMipmaps?(v[0].width<<1)-1:v[0].mipmask,d.internalformat=v[0].internalformat,f.width=v[0].width,f.height=v[0].height,z(d),s=0;6>s;++s)x(v[s],34069+s);for(L(u,34067),R(),o.profile&&(d.stats.size=O(d.internalformat,d.type,f.width,f.height,u.genMipmaps,!0)),f.format=Z[d.internalformat],f.type=Q[d.type],f.mag=$[u.magFilter],f.min=J[u.minFilter],f.wrapS=ee[u.wrapS],f.wrapT=ee[u.wrapT],s=0;6>s;++s)S(v[s]);return f}var d=new k(34067);ce[d.id]=d,a.cubeCount++;var v=Array(6);return f(t,n,r,i,s,u),f.subimage=function(e,t,n,r,i){n|=0,r|=0,i|=0;var a=m();return l(a,d),a.width=0,a.height=0,h(a,t),a.width=a.width||(d.width>>i)-n,a.height=a.height||(d.height>>i)-r,z(d),p(a,34069+e,n,r,i),R(),g(a),f},f.resize=function(t){if((t|=0)!==d.width){f.width=d.width=t,f.height=d.height=t,z(d);for(var n=0;6>n;++n)for(var r=0;d.mipmask>>r;++r)e.texImage2D(34069+n,r,d.format,t>>r,t>>r,0,d.format,d.type,null);return R(),o.profile&&(d.stats.size=O(d.internalformat,d.type,f.width,f.height,!1,!0)),f}},f._reglType="textureCube",f._texture=d,o.profile&&(f.stats=d.stats),f.destroy=function(){d.decRef()},f},clear:function(){for(var t=0;t<ue;++t)e.activeTexture(33984+t),e.bindTexture(3553,null),fe[t]=null;ne(ce).forEach(F),a.cubeCount=0,a.textureCount=0},getTexture:function(e){return null},restore:function(){for(var t=0;t<ue;++t){var n=fe[t];n&&(n.bindCount=0,n.unit=-1,fe[t]=null)}ne(ce).forEach((function(t){t.texture=e.createTexture(),e.bindTexture(t.target,t.texture);for(var n=0;32>n;++n)if(0!=(t.mipmask&1<<n))if(3553===t.target)e.texImage2D(3553,n,t.internalformat,t.width>>n,t.height>>n,0,t.internalformat,t.type,null);else for(var r=0;6>r;++r)e.texImage2D(34069+r,n,t.internalformat,t.width>>n,t.height>>n,0,t.internalformat,t.type,null);L(t.texInfo,t.target)}))},refresh:function(){for(var t=0;t<ue;++t){var n=fe[t];n&&(n.bindCount=0,n.unit=-1,fe[t]=null),e.activeTexture(33984+t),e.bindTexture(3553,null),e.bindTexture(34067,null)}}}}function I(e,t,n,r,i,a){function o(e,t,n){this.target=e,this.texture=t,this.renderbuffer=n;var r=e=0;t?(e=t.width,r=t.height):n&&(e=n.width,r=n.height),this.width=e,this.height=r}function s(e){e&&(e.texture&&e.texture._texture.decRef(),e.renderbuffer&&e.renderbuffer._renderbuffer.decRef())}function l(e,t,n){e&&(e.texture?e.texture._texture.refCount+=1:e.renderbuffer._renderbuffer.refCount+=1)}function c(t,n){n&&(n.texture?e.framebufferTexture2D(36160,t,n.target,n.texture._texture.texture,0):e.framebufferRenderbuffer(36160,t,36161,n.renderbuffer._renderbuffer.renderbuffer))}function u(e){var t=3553,n=null,r=null,i=e;return"object"==typeof e&&(i=e.data,"target"in e&&(t=0|e.target)),"texture2d"===(e=i._reglType)||"textureCube"===e?n=i:"renderbuffer"===e&&(r=i,t=36161),new o(t,n,r)}function f(e,t,n,a,s){return n?((e=r.create2D({width:e,height:t,format:a,type:s}))._texture.refCount=0,new o(3553,e,null)):((e=i.create({width:e,height:t,format:a}))._renderbuffer.refCount=0,new o(36161,null,e))}function h(e){return e&&(e.texture||e.renderbuffer)}function p(e,t,n){e&&(e.texture?e.texture.resize(t,n):e.renderbuffer&&e.renderbuffer.resize(t,n),e.width=t,e.height=n)}function d(){this.id=A++,S[this.id]=this,this.framebuffer=e.createFramebuffer(),this.height=this.width=0,this.colorAttachments=[],this.depthStencilAttachment=this.stencilAttachment=this.depthAttachment=null}function m(e){e.colorAttachments.forEach(s),s(e.depthAttachment),s(e.stencilAttachment),s(e.depthStencilAttachment)}function g(t){e.deleteFramebuffer(t.framebuffer),t.framebuffer=null,a.framebufferCount--,delete S[t.id]}function v(t){var r;e.bindFramebuffer(36160,t.framebuffer);var i=t.colorAttachments;for(r=0;r<i.length;++r)c(36064+r,i[r]);for(r=i.length;r<n.maxColorAttachments;++r)e.framebufferTexture2D(36160,36064+r,3553,null,0);e.framebufferTexture2D(36160,33306,3553,null,0),e.framebufferTexture2D(36160,36096,3553,null,0),e.framebufferTexture2D(36160,36128,3553,null,0),c(36096,t.depthAttachment),c(36128,t.stencilAttachment),c(33306,t.depthStencilAttachment),e.checkFramebufferStatus(36160),e.isContextLost(),e.bindFramebuffer(36160,y.next?y.next.framebuffer:null),y.cur=y.next,e.getError()}function b(e,t){function n(e,t){var i,a=0,o=0,s=!0,c=!0;i=null;var p=!0,d="rgba",g="uint8",b=1,y=null,_=null,A=null,S=!1;"number"==typeof e?(a=0|e,o=0|t||a):e?("shape"in e?(a=(o=e.shape)[0],o=o[1]):("radius"in e&&(a=o=e.radius),"width"in e&&(a=e.width),"height"in e&&(o=e.height)),("color"in e||"colors"in e)&&(i=e.color||e.colors),i||("colorCount"in e&&(b=0|e.colorCount),"colorTexture"in e&&(p=!!e.colorTexture,d="rgba4"),"colorType"in e&&(g=e.colorType,!p)&&("half float"===g||"float16"===g?d="rgba16f":"float"!==g&&"float32"!==g||(d="rgba32f")),"colorFormat"in e&&(d=e.colorFormat,0<=x.indexOf(d)?p=!0:0<=w.indexOf(d)&&(p=!1))),("depthTexture"in e||"depthStencilTexture"in e)&&(S=!(!e.depthTexture&&!e.depthStencilTexture)),"depth"in e&&("boolean"==typeof e.depth?s=e.depth:(y=e.depth,c=!1)),"stencil"in e&&("boolean"==typeof e.stencil?c=e.stencil:(_=e.stencil,s=!1)),"depthStencil"in e&&("boolean"==typeof e.depthStencil?s=c=e.depthStencil:(A=e.depthStencil,c=s=!1))):a=o=1;var T=null,E=null,C=null,M=null;if(Array.isArray(i))T=i.map(u);else if(i)T=[u(i)];else for(T=Array(b),i=0;i<b;++i)T[i]=f(a,o,p,d,g);for(a=a||T[0].width,o=o||T[0].height,y?E=u(y):s&&!c&&(E=f(a,o,S,"depth","uint32")),_?C=u(_):c&&!s&&(C=f(a,o,!1,"stencil","uint8")),A?M=u(A):!y&&!_&&c&&s&&(M=f(a,o,S,"depth stencil","depth stencil")),s=null,i=0;i<T.length;++i)l(T[i]),T[i]&&T[i].texture&&(c=Ce[T[i].texture._texture.format]*Me[T[i].texture._texture.type],null===s&&(s=c));return l(E),l(C),l(M),m(r),r.width=a,r.height=o,r.colorAttachments=T,r.depthAttachment=E,r.stencilAttachment=C,r.depthStencilAttachment=M,n.color=T.map(h),n.depth=h(E),n.stencil=h(C),n.depthStencil=h(M),n.width=r.width,n.height=r.height,v(r),n}var r=new d;return a.framebufferCount++,n(e,t),q(n,{resize:function(e,t){var i=Math.max(0|e,1),a=Math.max(0|t||i,1);if(i===r.width&&a===r.height)return n;for(var o=r.colorAttachments,s=0;s<o.length;++s)p(o[s],i,a);return p(r.depthAttachment,i,a),p(r.stencilAttachment,i,a),p(r.depthStencilAttachment,i,a),r.width=n.width=i,r.height=n.height=a,v(r),n},_reglType:"framebuffer",_framebuffer:r,destroy:function(){g(r),m(r)},use:function(e){y.setFBO({framebuffer:n},e)}})}var y={cur:null,next:null,dirty:!1,setFBO:null},x=["rgba"],w=["rgba4","rgb565","rgb5 a1"];t.ext_srgb&&w.push("srgba"),t.ext_color_buffer_half_float&&w.push("rgba16f","rgb16f"),t.webgl_color_buffer_float&&w.push("rgba32f");var _=["uint8"];t.oes_texture_half_float&&_.push("half float","float16"),t.oes_texture_float&&_.push("float","float32");var A=0,S={};return q(y,{getFramebuffer:function(e){return"function"==typeof e&&"framebuffer"===e._reglType&&(e=e._framebuffer)instanceof d?e:null},create:b,createCube:function(e){function t(e){var i,a={color:null},o=0,s=null;i="rgba";var l="uint8",c=1;if("number"==typeof e?o=0|e:e?("shape"in e?o=e.shape[0]:("radius"in e&&(o=0|e.radius),"width"in e?o=0|e.width:"height"in e&&(o=0|e.height)),("color"in e||"colors"in e)&&(s=e.color||e.colors),s||("colorCount"in e&&(c=0|e.colorCount),"colorType"in e&&(l=e.colorType),"colorFormat"in e&&(i=e.colorFormat)),"depth"in e&&(a.depth=e.depth),"stencil"in e&&(a.stencil=e.stencil),"depthStencil"in e&&(a.depthStencil=e.depthStencil)):o=1,s)if(Array.isArray(s))for(e=[],i=0;i<s.length;++i)e[i]=s[i];else e=[s];else for(e=Array(c),s={radius:o,format:i,type:l},i=0;i<c;++i)e[i]=r.createCube(s);for(a.color=Array(e.length),i=0;i<e.length;++i)c=e[i],o=o||c.width,a.color[i]={target:34069,data:e[i]};for(i=0;6>i;++i){for(c=0;c<e.length;++c)a.color[c].target=34069+i;0<i&&(a.depth=n[0].depth,a.stencil=n[0].stencil,a.depthStencil=n[0].depthStencil),n[i]?n[i](a):n[i]=b(a)}return q(t,{width:o,height:o,color:e})}var n=Array(6);return t(e),q(t,{faces:n,resize:function(e){var r=0|e;if(r===t.width)return t;var i=t.color;for(e=0;e<i.length;++e)i[e].resize(r);for(e=0;6>e;++e)n[e].resize(r);return t.width=t.height=r,t},_reglType:"framebufferCube",destroy:function(){n.forEach((function(e){e.destroy()}))}})},clear:function(){ne(S).forEach(g)},restore:function(){y.cur=null,y.next=null,y.dirty=!0,ne(S).forEach((function(t){t.framebuffer=e.createFramebuffer(),v(t)}))}})}function L(){this.w=this.z=this.y=this.x=this.state=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=5126,this.divisor=this.stride=this.offset=0}function k(e,t,n,r,i,a,o){function s(e){if(e!==v.currentVAO){var n=t.oes_vertex_array_object;e?n.bindVertexArrayOES(e.vao):n.bindVertexArrayOES(null),v.currentVAO=e}}function l(n){if(n!==v.currentVAO){if(n)n.bindAttrs();else{for(var r=t.angle_instanced_arrays,i=0;i<p.length;++i){var a=p[i];a.buffer?(e.enableVertexAttribArray(i),a.buffer.bind(),e.vertexAttribPointer(i,a.size,a.type,a.normalized,a.stride,a.offfset),r&&a.divisor&&r.vertexAttribDivisorANGLE(i,a.divisor)):(e.disableVertexAttribArray(i),e.vertexAttrib4f(i,a.x,a.y,a.z,a.w))}o.elements?e.bindBuffer(34963,o.elements.buffer.buffer):e.bindBuffer(34963,null)}v.currentVAO=n}}function c(){ne(g).forEach((function(e){e.destroy()}))}function u(){this.id=++m,this.attributes=[],this.elements=null,this.ownsElements=!1,this.offset=this.count=0,this.instances=-1,this.primitive=4;var e=t.oes_vertex_array_object;this.vao=e?e.createVertexArrayOES():null,g[this.id]=this,this.buffers=[]}function f(){t.oes_vertex_array_object&&ne(g).forEach((function(e){e.refresh()}))}var h=n.maxAttributes,p=Array(h);for(n=0;n<h;++n)p[n]=new L;var m=0,g={},v={Record:L,scope:{},state:p,currentVAO:null,targetVAO:null,restore:t.oes_vertex_array_object?f:function(){},createVAO:function(e){function t(e){var r;Array.isArray(e)?(r=e,n.elements&&n.ownsElements&&n.elements.destroy(),n.elements=null,n.ownsElements=!1,n.offset=0,n.count=0,n.instances=-1,n.primitive=4):(e.elements?(r=e.elements,n.ownsElements?("function"==typeof r&&"elements"===r._reglType?n.elements.destroy():n.elements(r),n.ownsElements=!1):a.getElements(e.elements)?(n.elements=e.elements,n.ownsElements=!1):(n.elements=a.create(e.elements),n.ownsElements=!0)):(n.elements=null,n.ownsElements=!1),r=e.attributes,n.offset=0,n.count=-1,n.instances=-1,n.primitive=4,n.elements&&(n.count=n.elements._elements.vertCount,n.primitive=n.elements._elements.primType),"offset"in e&&(n.offset=0|e.offset),"count"in e&&(n.count=0|e.count),"instances"in e&&(n.instances=0|e.instances),"primitive"in e&&(n.primitive=ue[e.primitive])),e={};var o=n.attributes;o.length=r.length;for(var s=0;s<r.length;++s){var l,c=r[s],u=o[s]=new L,f=c.data||c;Array.isArray(f)||te(f)||d(f)?(n.buffers[s]&&(l=n.buffers[s],te(f)&&l._buffer.byteLength>=f.byteLength?l.subdata(f):(l.destroy(),n.buffers[s]=null)),n.buffers[s]||(l=n.buffers[s]=i.create(c,34962,!1,!0)),u.buffer=i.getBuffer(l),u.size=0|u.buffer.dimension,u.normalized=!1,u.type=u.buffer.dtype,u.offset=0,u.stride=0,u.divisor=0,u.state=1,e[s]=1):i.getBuffer(c)?(u.buffer=i.getBuffer(c),u.size=0|u.buffer.dimension,u.normalized=!1,u.type=u.buffer.dtype,u.offset=0,u.stride=0,u.divisor=0,u.state=1):i.getBuffer(c.buffer)?(u.buffer=i.getBuffer(c.buffer),u.size=0|(+c.size||u.buffer.dimension),u.normalized=!!c.normalized||!1,u.type="type"in c?ae[c.type]:u.buffer.dtype,u.offset=0|(c.offset||0),u.stride=0|(c.stride||0),u.divisor=0|(c.divisor||0),u.state=1):"x"in c&&(u.x=+c.x||0,u.y=+c.y||0,u.z=+c.z||0,u.w=+c.w||0,u.state=2)}for(l=0;l<n.buffers.length;++l)!e[l]&&n.buffers[l]&&(n.buffers[l].destroy(),n.buffers[l]=null);return n.refresh(),t}var n=new u;return r.vaoCount+=1,t.destroy=function(){for(var e=0;e<n.buffers.length;++e)n.buffers[e]&&n.buffers[e].destroy();n.buffers.length=0,n.ownsElements&&(n.elements.destroy(),n.elements=null,n.ownsElements=!1),n.destroy()},t._vao=n,t._reglType="vao",t(e)},getVAO:function(e){return"function"==typeof e&&e._vao?e._vao:null},destroyBuffer:function(t){for(var n=0;n<p.length;++n){var r=p[n];r.buffer===t&&(e.disableVertexAttribArray(n),r.buffer=null)}},setVAO:t.oes_vertex_array_object?s:l,clear:t.oes_vertex_array_object?c:function(){}};return u.prototype.bindAttrs=function(){for(var n=t.angle_instanced_arrays,r=this.attributes,i=0;i<r.length;++i){var o=r[i];o.buffer?(e.enableVertexAttribArray(i),e.bindBuffer(34962,o.buffer.buffer),e.vertexAttribPointer(i,o.size,o.type,o.normalized,o.stride,o.offset),n&&o.divisor&&n.vertexAttribDivisorANGLE(i,o.divisor)):(e.disableVertexAttribArray(i),e.vertexAttrib4f(i,o.x,o.y,o.z,o.w))}for(n=r.length;n<h;++n)e.disableVertexAttribArray(n);(n=a.getElements(this.elements))?e.bindBuffer(34963,n.buffer.buffer):e.bindBuffer(34963,null)},u.prototype.refresh=function(){var e=t.oes_vertex_array_object;e&&(e.bindVertexArrayOES(this.vao),this.bindAttrs(),v.currentVAO=null,e.bindVertexArrayOES(null))},u.prototype.destroy=function(){if(this.vao){var e=t.oes_vertex_array_object;this===v.currentVAO&&(v.currentVAO=null,e.bindVertexArrayOES(null)),e.deleteVertexArrayOES(this.vao),this.vao=null}this.ownsElements&&(this.elements.destroy(),this.elements=null,this.ownsElements=!1),g[this.id]&&(delete g[this.id],--r.vaoCount)},v}function z(e,t,n,r){function i(e,t,n,r){this.name=e,this.id=t,this.location=n,this.info=r}function a(e,t){for(var n=0;n<e.length;++n)if(e[n].id===t.id)return void(e[n].location=t.location);e.push(t)}function o(n,r,i){if(!(o=(i=35632===n?c:u)[r])){var a=t.str(r),o=e.createShader(n);e.shaderSource(o,a),e.compileShader(o),i[r]=o}return o}function s(e,t){this.id=p++,this.fragId=e,this.vertId=t,this.program=null,this.uniforms=[],this.attributes=[],this.refCount=1,r.profile&&(this.stats={uniformsCount:0,attributesCount:0})}function l(n,s,l){var c;c=o(35632,n.fragId);var u=o(35633,n.vertId);if(s=n.program=e.createProgram(),e.attachShader(s,c),e.attachShader(s,u),l)for(c=0;c<l.length;++c)u=l[c],e.bindAttribLocation(s,u[0],u[1]);e.linkProgram(s),u=e.getProgramParameter(s,35718),r.profile&&(n.stats.uniformsCount=u);var f=n.uniforms;for(c=0;c<u;++c)if(l=e.getActiveUniform(s,c)){if(1<l.size)for(var h=0;h<l.size;++h){var p=l.name.replace("[0]","["+h+"]");a(f,new i(p,t.id(p),e.getUniformLocation(s,p),l))}h=l.name,1<l.size&&(h=h.replace("[0]","")),a(f,new i(h,t.id(h),e.getUniformLocation(s,h),l))}for(u=e.getProgramParameter(s,35721),r.profile&&(n.stats.attributesCount=u),n=n.attributes,c=0;c<u;++c)(l=e.getActiveAttrib(s,c))&&a(n,new i(l.name,t.id(l.name),e.getAttribLocation(s,l.name),l))}var c={},u={},f={},h=[],p=0;return r.profile&&(n.getMaxUniformsCount=function(){var e=0;return h.forEach((function(t){t.stats.uniformsCount>e&&(e=t.stats.uniformsCount)})),e},n.getMaxAttributesCount=function(){var e=0;return h.forEach((function(t){t.stats.attributesCount>e&&(e=t.stats.attributesCount)})),e}),{clear:function(){var t=e.deleteShader.bind(e);ne(c).forEach(t),c={},ne(u).forEach(t),u={},h.forEach((function(t){e.deleteProgram(t.program)})),h.length=0,f={},n.shaderCount=0},program:function(t,r,i,a){var o=f[r];o||(o=f[r]={});var p=o[t];if(p&&(p.refCount++,!a))return p;var d=new s(r,t);return n.shaderCount++,l(d,i,a),p||(o[t]=d),h.push(d),q(d,{destroy:function(){if(d.refCount--,0>=d.refCount){e.deleteProgram(d.program);var t=h.indexOf(d);h.splice(t,1),n.shaderCount--}0>=o[d.vertId].refCount&&(e.deleteShader(u[d.vertId]),delete u[d.vertId],delete f[d.fragId][d.vertId]),Object.keys(f[d.fragId]).length||(e.deleteShader(c[d.fragId]),delete c[d.fragId],delete f[d.fragId])}})},restore:function(){c={},u={};for(var e=0;e<h.length;++e)l(h[e],null,h[e].attributes.map((function(e){return[e.location,e.name]})))},shader:o,frag:-1,vert:-1}}function R(e,t,n,r,i,a,o){function s(i){var a;a=null===t.next?5121:t.next.colorAttachments[0].texture._texture.type;var o=0,s=0,l=r.framebufferWidth,c=r.framebufferHeight,u=null;return te(i)?u=i:i&&(o=0|i.x,s=0|i.y,l=0|(i.width||r.framebufferWidth-o),c=0|(i.height||r.framebufferHeight-s),u=i.data||null),n(),i=l*c*4,u||(5121===a?u=new Uint8Array(i):5126===a&&(u=u||new Float32Array(i))),e.pixelStorei(3333,4),e.readPixels(o,s,l,c,6408,a,u),u}function l(e){var n;return t.setFBO({framebuffer:e.framebuffer},(function(){n=s(e)})),n}return function(e){return e&&"framebuffer"in e?l(e):s(e)}}function F(e){return Array.prototype.slice.call(e)}function B(e){return F(e).join("")}function j(){function e(){var e=[],t=[];return q((function(){e.push.apply(e,F(arguments))}),{def:function(){var r="v"+n++;return t.push(r),0<arguments.length&&(e.push(r,"="),e.push.apply(e,F(arguments)),e.push(";")),r},toString:function(){return B([0<t.length?"var "+t.join(",")+";":"",B(e)])}})}function t(){function t(e,t){r(e,t,"=",n.def(e,t),";")}var n=e(),r=e(),i=n.toString,a=r.toString;return q((function(){n.apply(n,F(arguments))}),{def:n.def,entry:n,exit:r,save:t,set:function(e,r,i){t(e,r),n(e,r,"=",i,";")},toString:function(){return i()+a()}})}var n=0,r=[],i=[],a=e(),o={};return{global:a,link:function(e){for(var t=0;t<i.length;++t)if(i[t]===e)return r[t];return t="g"+n++,r.push(t),i.push(e),t},block:e,proc:function(e,n){function r(){var e="a"+i.length;return i.push(e),e}var i=[];n=n||0;for(var a=0;a<n;++a)r();var s=(a=t()).toString;return o[e]=q(a,{arg:r,toString:function(){return B(["function(",i.join(),"){",s(),"}"])}})},scope:t,cond:function(){var e=B(arguments),n=t(),r=t(),i=n.toString,a=r.toString;return q(n,{then:function(){return n.apply(n,F(arguments)),this},else:function(){return r.apply(r,F(arguments)),this},toString:function(){var t=a();return t&&(t="else{"+t+"}"),B(["if(",e,"){",i(),"}",t])}})},compile:function(){var e=['"use strict";',a,"return {"];Object.keys(o).forEach((function(t){e.push('"',t,'":',o[t].toString(),",")})),e.push("}");var t=B(e).replace(/;/g,";\n").replace(/}/g,"}\n").replace(/{/g,"{\n");return Function.apply(null,r.concat(t)).apply(null,i)}}}function N(e){return Array.isArray(e)||te(e)||d(e)}function W(e){return e.sort((function(e,t){return"viewport"===e?-1:"viewport"===t?1:e<t?-1:1}))}function V(e,t,n,r){this.thisDep=e,this.contextDep=t,this.propDep=n,this.append=r}function U(e){return e&&!(e.thisDep||e.contextDep||e.propDep)}function H(e){return new V(!1,!1,!1,e)}function Y(e,t){var n=e.type;if(0===n)return new V(!0,1<=(n=e.data.length),2<=n,t);if(4===n)return new V((n=e.data).thisDep,n.contextDep,n.propDep,t);if(5===n)return new V(!1,!1,!1,t);if(6===n){for(var r=n=!1,i=!1,a=0;a<e.data.length;++a){var o=e.data[a];1===o.type?i=!0:2===o.type?r=!0:3===o.type?n=!0:0===o.type?(n=!0,1<=(o=o.data)&&(r=!0),2<=o&&(i=!0)):4===o.type&&(n=n||o.data.thisDep,r=r||o.data.contextDep,i=i||o.data.propDep)}return new V(n,r,i,t)}return new V(3===n,2===n,1===n,t)}function X(e,t,n,r,i,a,o,s,l,c,u,h,p,d,m){function g(e){return e.replace(".","_")}function v(e,t,n){var r=g(e);de.push(e),pe[r]=he[r]=!!n,me[r]=t}function b(e,t,n){var r=g(e);de.push(e),Array.isArray(n)?(he[r]=n.slice(),pe[r]=n.slice()):he[r]=pe[r]=n,ge[r]=t}function y(){var e=j(),n=e.link,r=e.global;e.id=ye++,e.batchId="0";var i=n(ve),a=e.shared={props:"a0"};Object.keys(ve).forEach((function(e){a[e]=r.def(i,".",e)}));var o=e.next={},s=e.current={};Object.keys(ge).forEach((function(e){Array.isArray(he[e])&&(o[e]=r.def(a.next,".",e),s[e]=r.def(a.current,".",e))}));var l=e.constants={};Object.keys(be).forEach((function(e){l[e]=r.def(JSON.stringify(be[e]))})),e.invoke=function(t,r){switch(r.type){case 0:var i=["this",a.context,a.props,e.batchId];return t.def(n(r.data),".call(",i.slice(0,Math.max(r.data.length+1,4)),")");case 1:return t.def(a.props,r.data);case 2:return t.def(a.context,r.data);case 3:return t.def("this",r.data);case 4:return r.data.append(e,t),r.data.ref;case 5:return r.data.toString();case 6:return r.data.map((function(n){return e.invoke(t,n)}))}},e.attribCache={};var u={};return e.scopeAttrib=function(e){if((e=t.id(e))in u)return u[e];var r=c.scope[e];return r||(r=c.scope[e]=new oe),u[e]=n(r)},e}function x(e){var t,n=e.static;if(e=e.dynamic,"profile"in n){var r=!!n.profile;(t=H((function(e,t){return r}))).enable=r}else if("profile"in e){var i=e.profile;t=Y(i,(function(e,t){return e.invoke(t,i)}))}return t}function w(e,t){var n=e.static,r=e.dynamic;if("framebuffer"in n){var i=n.framebuffer;return i?(i=s.getFramebuffer(i),H((function(e,t){var n=e.link(i),r=e.shared;return t.set(r.framebuffer,".next",n),r=r.context,t.set(r,".framebufferWidth",n+".width"),t.set(r,".framebufferHeight",n+".height"),n}))):H((function(e,t){var n=e.shared;return t.set(n.framebuffer,".next","null"),n=n.context,t.set(n,".framebufferWidth",n+".drawingBufferWidth"),t.set(n,".framebufferHeight",n+".drawingBufferHeight"),"null"}))}if("framebuffer"in r){var a=r.framebuffer;return Y(a,(function(e,t){var n=e.invoke(t,a),r=e.shared,i=r.framebuffer;return n=t.def(i,".getFramebuffer(",n,")"),t.set(i,".next",n),r=r.context,t.set(r,".framebufferWidth",n+"?"+n+".width:"+r+".drawingBufferWidth"),t.set(r,".framebufferHeight",n+"?"+n+".height:"+r+".drawingBufferHeight"),n}))}return null}function _(e,t,n){function r(e){if(e in i){var n=i[e];e=!0;var r,o,s=0|n.x,l=0|n.y;return"width"in n?r=0|n.width:e=!1,"height"in n?o=0|n.height:e=!1,new V(!e&&t&&t.thisDep,!e&&t&&t.contextDep,!e&&t&&t.propDep,(function(e,t){var i=e.shared.context,a=r;"width"in n||(a=t.def(i,".","framebufferWidth","-",s));var c=o;return"height"in n||(c=t.def(i,".","framebufferHeight","-",l)),[s,l,a,c]}))}if(e in a){var c=a[e];return e=Y(c,(function(e,t){var n=e.invoke(t,c),r=e.shared.context,i=t.def(n,".x|0"),a=t.def(n,".y|0");return[i,a,t.def('"width" in ',n,"?",n,".width|0:","(",r,".","framebufferWidth","-",i,")"),n=t.def('"height" in ',n,"?",n,".height|0:","(",r,".","framebufferHeight","-",a,")")]})),t&&(e.thisDep=e.thisDep||t.thisDep,e.contextDep=e.contextDep||t.contextDep,e.propDep=e.propDep||t.propDep),e}return t?new V(t.thisDep,t.contextDep,t.propDep,(function(e,t){var n=e.shared.context;return[0,0,t.def(n,".","framebufferWidth"),t.def(n,".","framebufferHeight")]})):null}var i=e.static,a=e.dynamic;if(e=r("viewport")){var o=e;e=new V(e.thisDep,e.contextDep,e.propDep,(function(e,t){var n=o.append(e,t),r=e.shared.context;return t.set(r,".viewportWidth",n[2]),t.set(r,".viewportHeight",n[3]),n}))}return{viewport:e,scissor_box:r("scissor.box")}}function S(e,t){if("string"==typeof(n=e.static).frag&&"string"==typeof n.vert){if(0<Object.keys(t.dynamic).length)return null;var n=t.static,r=Object.keys(n);if(0<r.length&&"number"==typeof n[r[0]]){for(var i=[],a=0;a<r.length;++a)i.push([0|n[r[a]],r[a]]);return i}}return null}function T(e,n,r){function i(e){if(e in a){var n=t.id(a[e]);return(e=H((function(){return n}))).id=n,e}if(e in o){var r=o[e];return Y(r,(function(e,t){var n=e.invoke(t,r);return t.def(e.shared.strings,".id(",n,")")}))}return null}var a=e.static,o=e.dynamic,s=i("frag"),l=i("vert"),c=null;return U(s)&&U(l)?(c=u.program(l.id,s.id,null,r),e=H((function(e,t){return e.link(c)}))):e=new V(s&&s.thisDep||l&&l.thisDep,s&&s.contextDep||l&&l.contextDep,s&&s.propDep||l&&l.propDep,(function(e,t){var n,r,i=e.shared.shader;return n=s?s.append(e,t):t.def(i,".","frag"),r=l?l.append(e,t):t.def(i,".","vert"),t.def(i+".program("+r+","+n+")")})),{frag:s,vert:l,progVar:e,program:c}}function E(e,t){function n(e,t){if(e in r){var n=0|r[e];return t?o.offset=n:o.instances=n,H((function(e,r){return t&&(e.OFFSET=n),n}))}if(e in i){var a=i[e];return Y(a,(function(e,n){var r=e.invoke(n,a);return t&&(e.OFFSET=r),r}))}if(t){if(u)return H((function(e,t){return e.OFFSET=0}));if(s)return new V(l.thisDep,l.contextDep,l.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.vao+".currentVAO.offset:0")}))}else if(s)return new V(l.thisDep,l.contextDep,l.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.vao+".currentVAO.instances:-1")}));return null}var r=e.static,i=e.dynamic,o={},s=!1,l=function(){if("vao"in r){var e=r.vao;return null!==e&&null===c.getVAO(e)&&(e=c.createVAO(e)),s=!0,o.vao=e,H((function(t){var n=c.getVAO(e);return n?t.link(n):"null"}))}if("vao"in i){s=!0;var t=i.vao;return Y(t,(function(e,n){var r=e.invoke(n,t);return n.def(e.shared.vao+".getVAO("+r+")")}))}return null}(),u=!1,f=function(){if("elements"in r){var e=r.elements;if(o.elements=e,N(e)){var t=o.elements=a.create(e,!0);e=a.getElements(t),u=!0}else e&&(e=a.getElements(e),u=!0);return(t=H((function(t,n){if(e){var r=t.link(e);return t.ELEMENTS=r}return t.ELEMENTS=null}))).value=e,t}if("elements"in i){u=!0;var n=i.elements;return Y(n,(function(e,t){var r=(i=e.shared).isBufferArgs,i=i.elements,a=e.invoke(t,n),o=t.def("null");return r=t.def(r,"(",a,")"),a=e.cond(r).then(o,"=",i,".createStream(",a,");").else(o,"=",i,".getElements(",a,");"),t.entry(a),t.exit(e.cond(r).then(i,".destroyStream(",o,");")),e.ELEMENTS=o}))}return s?new V(l.thisDep,l.contextDep,l.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.elements+".getElements("+e.shared.vao+".currentVAO.elements):null")})):null}(),h=n("offset",!0),p=function(){if("primitive"in r){var e=r.primitive;return o.primitive=e,H((function(t,n){return ue[e]}))}if("primitive"in i){var t=i.primitive;return Y(t,(function(e,n){var r=e.constants.primTypes,i=e.invoke(n,t);return n.def(r,"[",i,"]")}))}return u?U(f)?f.value?H((function(e,t){return t.def(e.ELEMENTS,".primType")})):H((function(){return 4})):new V(f.thisDep,f.contextDep,f.propDep,(function(e,t){var n=e.ELEMENTS;return t.def(n,"?",n,".primType:",4)})):s?new V(l.thisDep,l.contextDep,l.propDep,(function(e,t){return t.def(e.shared.vao+".currentVAO?"+e.shared.vao+".currentVAO.primitive:4")})):null}(),d=function(){if("count"in r){var e=0|r.count;return o.count=e,H((function(){return e}))}if("count"in i){var t=i.count;return Y(t,(function(e,n){return e.invoke(n,t)}))}return u?U(f)?f?h?new V(h.thisDep,h.contextDep,h.propDep,(function(e,t){return t.def(e.ELEMENTS,".vertCount-",e.OFFSET)})):H((function(e,t){return t.def(e.ELEMENTS,".vertCount")})):H((function(){return-1})):new V(f.thisDep||h.thisDep,f.contextDep||h.contextDep,f.propDep||h.propDep,(function(e,t){var n=e.ELEMENTS;return e.OFFSET?t.def(n,"?",n,".vertCount-",e.OFFSET,":-1"):t.def(n,"?",n,".vertCount:-1")})):s?new V(l.thisDep,l.contextDep,l.propDep,(function(e,t){return t.def(e.shared.vao,".currentVAO?",e.shared.vao,".currentVAO.count:-1")})):null}(),m=n("instances",!1);return{elements:f,primitive:p,count:d,instances:m,offset:h,vao:l,vaoActive:s,elementsActive:u,static:o}}function C(e,t){var n=e.static,r=e.dynamic,i={};return de.forEach((function(e){function t(t,o){if(e in n){var s=t(n[e]);i[a]=H((function(){return s}))}else if(e in r){var l=r[e];i[a]=Y(l,(function(e,t){return o(e,t,e.invoke(t,l))}))}}var a=g(e);switch(e){case"cull.enable":case"blend.enable":case"dither":case"stencil.enable":case"depth.enable":case"scissor.enable":case"polygonOffset.enable":case"sample.alpha":case"sample.enable":case"depth.mask":return t((function(e){return e}),(function(e,t,n){return n}));case"depth.func":return t((function(e){return Ie[e]}),(function(e,t,n){return t.def(e.constants.compareFuncs,"[",n,"]")}));case"depth.range":return t((function(e){return e}),(function(e,t,n){return[t.def("+",n,"[0]"),t=t.def("+",n,"[1]")]}));case"blend.func":return t((function(e){return[De["srcRGB"in e?e.srcRGB:e.src],De["dstRGB"in e?e.dstRGB:e.dst],De["srcAlpha"in e?e.srcAlpha:e.src],De["dstAlpha"in e?e.dstAlpha:e.dst]]}),(function(e,t,n){function r(e,r){return t.def('"',e,r,'" in ',n,"?",n,".",e,r,":",n,".",e)}e=e.constants.blendFuncs;var i=r("src","RGB"),a=r("dst","RGB"),o=(i=t.def(e,"[",i,"]"),t.def(e,"[",r("src","Alpha"),"]"));return[i,a=t.def(e,"[",a,"]"),o,e=t.def(e,"[",r("dst","Alpha"),"]")]}));case"blend.equation":return t((function(e){return"string"==typeof e?[se[e],se[e]]:"object"==typeof e?[se[e.rgb],se[e.alpha]]:void 0}),(function(e,t,n){var r=e.constants.blendEquations,i=t.def(),a=t.def();return(e=e.cond("typeof ",n,'==="string"')).then(i,"=",a,"=",r,"[",n,"];"),e.else(i,"=",r,"[",n,".rgb];",a,"=",r,"[",n,".alpha];"),t(e),[i,a]}));case"blend.color":return t((function(e){return f(4,(function(t){return+e[t]}))}),(function(e,t,n){return f(4,(function(e){return t.def("+",n,"[",e,"]")}))}));case"stencil.mask":return t((function(e){return 0|e}),(function(e,t,n){return t.def(n,"|0")}));case"stencil.func":return t((function(e){return[Ie[e.cmp||"keep"],e.ref||0,"mask"in e?e.mask:-1]}),(function(e,t,n){return[e=t.def('"cmp" in ',n,"?",e.constants.compareFuncs,"[",n,".cmp]",":",7680),t.def(n,".ref|0"),t=t.def('"mask" in ',n,"?",n,".mask|0:-1")]}));case"stencil.opFront":case"stencil.opBack":return t((function(t){return["stencil.opBack"===e?1029:1028,Le[t.fail||"keep"],Le[t.zfail||"keep"],Le[t.zpass||"keep"]]}),(function(t,n,r){function i(e){return n.def('"',e,'" in ',r,"?",a,"[",r,".",e,"]:",7680)}var a=t.constants.stencilOps;return["stencil.opBack"===e?1029:1028,i("fail"),i("zfail"),i("zpass")]}));case"polygonOffset.offset":return t((function(e){return[0|e.factor,0|e.units]}),(function(e,t,n){return[t.def(n,".factor|0"),t=t.def(n,".units|0")]}));case"cull.face":return t((function(e){var t=0;return"front"===e?t=1028:"back"===e&&(t=1029),t}),(function(e,t,n){return t.def(n,'==="front"?',1028,":",1029)}));case"lineWidth":return t((function(e){return e}),(function(e,t,n){return n}));case"frontFace":return t((function(e){return ke[e]}),(function(e,t,n){return t.def(n+'==="cw"?2304:2305')}));case"colorMask":return t((function(e){return e.map((function(e){return!!e}))}),(function(e,t,n){return f(4,(function(e){return"!!"+n+"["+e+"]"}))}));case"sample.coverage":return t((function(e){return["value"in e?e.value:1,!!e.invert]}),(function(e,t,n){return[t.def('"value" in ',n,"?+",n,".value:1"),t=t.def("!!",n,".invert")]}))}})),i}function M(e,t){var n=e.static,r=e.dynamic,i={};return Object.keys(n).forEach((function(e){var t,r=n[e];if("number"==typeof r||"boolean"==typeof r)t=H((function(){return r}));else if("function"==typeof r){var a=r._reglType;"texture2d"===a||"textureCube"===a?t=H((function(e){return e.link(r)})):"framebuffer"!==a&&"framebufferCube"!==a||(t=H((function(e){return e.link(r.color[0])})))}else A(r)&&(t=H((function(e){return e.global.def("[",f(r.length,(function(e){return r[e]})),"]")})));t.value=r,i[e]=t})),Object.keys(r).forEach((function(e){var t=r[e];i[e]=Y(t,(function(e,n){return e.invoke(n,t)}))})),i}function P(e,n){var r=e.static,a=e.dynamic,o={};return Object.keys(r).forEach((function(e){var n=r[e],a=t.id(e),s=new oe;if(N(n))s.state=1,s.buffer=i.getBuffer(i.create(n,34962,!1,!0)),s.type=0;else if(c=i.getBuffer(n))s.state=1,s.buffer=c,s.type=0;else if("constant"in n){var l=n.constant;s.buffer="null",s.state=2,"number"==typeof l?s.x=l:Pe.forEach((function(e,t){t<l.length&&(s[e]=l[t])}))}else{var c=N(n.buffer)?i.getBuffer(i.create(n.buffer,34962,!1,!0)):i.getBuffer(n.buffer),u=0|n.offset,f=0|n.stride,h=0|n.size,p=!!n.normalized,d=0;"type"in n&&(d=ae[n.type]),n=0|n.divisor,s.buffer=c,s.state=1,s.size=h,s.normalized=p,s.type=d||c.dtype,s.offset=u,s.stride=f,s.divisor=n}o[e]=H((function(e,t){var n=e.attribCache;if(a in n)return n[a];var r={isStream:!1};return Object.keys(s).forEach((function(e){r[e]=s[e]})),s.buffer&&(r.buffer=e.link(s.buffer),r.type=r.type||r.buffer+".dtype"),n[a]=r}))})),Object.keys(a).forEach((function(e){var t=a[e];o[e]=Y(t,(function(e,n){function r(e){n(l[e],"=",i,".",e,"|0;")}var i=e.invoke(n,t),a=e.shared,o=e.constants,s=a.isBufferArgs,l=(a=a.buffer,{isStream:n.def(!1)}),c=new oe;c.state=1,Object.keys(c).forEach((function(e){l[e]=n.def(""+c[e])}));var u=l.buffer,f=l.type;return n("if(",s,"(",i,")){",l.isStream,"=true;",u,"=",a,".createStream(",34962,",",i,");",f,"=",u,".dtype;","}else{",u,"=",a,".getBuffer(",i,");","if(",u,"){",f,"=",u,".dtype;",'}else if("constant" in ',i,"){",l.state,"=",2,";","if(typeof "+i+'.constant === "number"){',l[Pe[0]],"=",i,".constant;",Pe.slice(1).map((function(e){return l[e]})).join("="),"=0;","}else{",Pe.map((function(e,t){return l[e]+"="+i+".constant.length>"+t+"?"+i+".constant["+t+"]:0;"})).join(""),"}}else{","if(",s,"(",i,".buffer)){",u,"=",a,".createStream(",34962,",",i,".buffer);","}else{",u,"=",a,".getBuffer(",i,".buffer);","}",f,'="type" in ',i,"?",o.glTypes,"[",i,".type]:",u,".dtype;",l.normalized,"=!!",i,".normalized;"),r("size"),r("offset"),r("stride"),r("divisor"),n("}}"),n.exit("if(",l.isStream,"){",a,".destroyStream(",u,");","}"),l}))})),o}function O(e){var t=e.static,n=e.dynamic,r={};return Object.keys(t).forEach((function(e){var n=t[e];r[e]=H((function(e,t){return"number"==typeof n||"boolean"==typeof n?""+n:e.link(n)}))})),Object.keys(n).forEach((function(e){var t=n[e];r[e]=Y(t,(function(e,n){return e.invoke(n,t)}))})),r}function D(e,t,r,i,a){function o(e){var t=l[e];t&&(f[e]=t)}var s=S(e,t),l=_(e,p=w(e)),u=E(e),f=C(e),h=T(e,a,s);o("viewport"),o(g("scissor.box"));var p,d=0<Object.keys(f).length;if((p={framebuffer:p,draw:u,shader:h,state:f,dirty:d,scopeVAO:null,drawVAO:null,useVAO:!1,attributes:{}}).profile=x(e),p.uniforms=M(r),p.drawVAO=p.scopeVAO=u.vao,!p.drawVAO&&h.program&&!s&&n.angle_instanced_arrays&&u.static.elements){var m=!0;if(e=h.program.attributes.map((function(e){return e=t.static[e],m=m&&!!e,e})),m&&0<e.length){var v=c.getVAO(c.createVAO({attributes:e,elements:u.static.elements}));p.drawVAO=new V(null,null,null,(function(e,t){return e.link(v)})),p.useVAO=!0}}return s?p.useVAO=!0:p.attributes=P(t),p.context=O(i),p}function I(e,t,n){var r=e.shared.context,i=e.scope();Object.keys(n).forEach((function(a){t.save(r,"."+a);var o=n[a].append(e,t);Array.isArray(o)?i(r,".",a,"=[",o.join(),"];"):i(r,".",a,"=",o,";")})),t(i)}function L(e,t,n,r){var i,a=(s=e.shared).gl,o=s.framebuffer;ce&&(i=t.def(s.extensions,".webgl_draw_buffers"));var s=(l=e.constants).drawBuffer,l=l.backBuffer;e=n?n.append(e,t):t.def(o,".next"),r||t("if(",e,"!==",o,".cur){"),t("if(",e,"){",a,".bindFramebuffer(",36160,",",e,".framebuffer);"),ce&&t(i,".drawBuffersWEBGL(",s,"[",e,".colorAttachments.length]);"),t("}else{",a,".bindFramebuffer(",36160,",null);"),ce&&t(i,".drawBuffersWEBGL(",l,");"),t("}",o,".cur=",e,";"),r||t("}")}function k(e,t,n){var r=e.shared,i=r.gl,a=e.current,o=e.next,s=r.current,l=r.next,c=e.cond(s,".dirty");de.forEach((function(t){var r,u;if(!((t=g(t))in n.state))if(t in o){r=o[t],u=a[t];var h=f(he[t].length,(function(e){return c.def(r,"[",e,"]")}));c(e.cond(h.map((function(e,t){return e+"!=="+u+"["+t+"]"})).join("||")).then(i,".",ge[t],"(",h,");",h.map((function(e,t){return u+"["+t+"]="+e})).join(";"),";"))}else r=c.def(l,".",t),h=e.cond(r,"!==",s,".",t),c(h),t in me?h(e.cond(r).then(i,".enable(",me[t],");").else(i,".disable(",me[t],");"),s,".",t,"=",r,";"):h(i,".",ge[t],"(",r,");",s,".",t,"=",r,";")})),0===Object.keys(n.state).length&&c(s,".dirty=false;"),t(c)}function z(e,t,n,r){var i=e.shared,a=e.current,o=i.current,s=i.gl;W(Object.keys(n)).forEach((function(i){var l=n[i];if(!r||r(l)){var c=l.append(e,t);if(me[i]){var u=me[i];U(l)?t(s,c?".enable(":".disable(",u,");"):t(e.cond(c).then(s,".enable(",u,");").else(s,".disable(",u,");")),t(o,".",i,"=",c,";")}else if(A(c)){var f=a[i];t(s,".",ge[i],"(",c,");",c.map((function(e,t){return f+"["+t+"]="+e})).join(";"),";")}else t(s,".",ge[i],"(",c,");",o,".",i,"=",c,";")}}))}function R(e,t){le&&(e.instancing=t.def(e.shared.extensions,".angle_instanced_arrays"))}function F(e,t,n,r,i){function a(){return"undefined"==typeof performance?"Date.now()":"performance.now()"}function o(e){e(c=t.def(),"=",a(),";"),"string"==typeof i?e(h,".count+=",i,";"):e(h,".count++;"),d&&(r?e(u=t.def(),"=",m,".getNumPendingQueries();"):e(m,".beginQuery(",h,");"))}function s(e){e(h,".cpuTime+=",a(),"-",c,";"),d&&(r?e(m,".pushScopeStats(",u,",",m,".getNumPendingQueries(),",h,");"):e(m,".endQuery();"))}function l(e){var n=t.def(p,".profile");t(p,".profile=",e,";"),t.exit(p,".profile=",n,";")}var c,u,f=e.shared,h=e.stats,p=f.current,m=f.timer;if(n=n.profile){if(U(n))return void(n.enable?(o(t),s(t.exit),l("true")):l("false"));l(n=n.append(e,t))}else n=t.def(p,".profile");o(f=e.block()),t("if(",n,"){",f,"}"),s(e=e.block()),t.exit("if(",n,"){",e,"}")}function B(e,t,n,r,i){function a(e){switch(e){case 35664:case 35667:case 35671:return 2;case 35665:case 35668:case 35672:return 3;case 35666:case 35669:case 35673:return 4;default:return 1}}function o(n,r,i){function a(){t("if(!",u,".buffer){",l,".enableVertexAttribArray(",c,");}");var n,a=i.type;n=i.size?t.def(i.size,"||",r):r,t("if(",u,".type!==",a,"||",u,".size!==",n,"||",p.map((function(e){return u+"."+e+"!=="+i[e]})).join("||"),"){",l,".bindBuffer(",34962,",",f,".buffer);",l,".vertexAttribPointer(",[c,n,a,i.normalized,i.stride,i.offset],");",u,".type=",a,";",u,".size=",n,";",p.map((function(e){return u+"."+e+"="+i[e]+";"})).join(""),"}"),le&&(a=i.divisor,t("if(",u,".divisor!==",a,"){",e.instancing,".vertexAttribDivisorANGLE(",[c,a],");",u,".divisor=",a,";}"))}function o(){t("if(",u,".buffer){",l,".disableVertexAttribArray(",c,");",u,".buffer=null;","}if(",Pe.map((function(e,t){return u+"."+e+"!=="+h[t]})).join("||"),"){",l,".vertexAttrib4f(",c,",",h,");",Pe.map((function(e,t){return u+"."+e+"="+h[t]+";"})).join(""),"}")}var l=s.gl,c=t.def(n,".location"),u=t.def(s.attributes,"[",c,"]");n=i.state;var f=i.buffer,h=[i.x,i.y,i.z,i.w],p=["buffer","normalized","offset","stride"];1===n?a():2===n?o():(t("if(",n,"===",1,"){"),a(),t("}else{"),o(),t("}"))}var s=e.shared;r.forEach((function(r){var s,l=r.name,c=n.attributes[l];if(c){if(!i(c))return;s=c.append(e,t)}else{if(!i(ze))return;var u=e.scopeAttrib(l);s={},Object.keys(new oe).forEach((function(e){s[e]=t.def(u,".",e)}))}o(e.link(r),a(r.info.type),s)}))}function X(e,n,r,i,a,o){for(var s,l=e.shared,c=l.gl,u={},h=0;h<i.length;++h){var p=(y=i[h]).name,d=y.info.type,m=y.info.size,g=r.uniforms[p];if(1<m){if(!g)continue;var v=p.replace("[0]","");if(u[v])continue;u[v]=1}var b,y=e.link(y)+".location";if(g){if(!a(g))continue;if(U(g)){if(p=g.value,35678===d||35680===d)n(c,".uniform1i(",y,",",(d=e.link(p._texture||p.color[0]._texture))+".bind());"),n.exit(d,".unbind();");else if(35674===d||35675===d||35676===d)m=e.global.def("new Float32Array(["+Array.prototype.slice.call(p)+"])"),p=2,35675===d?p=3:35676===d&&(p=4),n(c,".uniformMatrix",p,"fv(",y,",false,",m,");");else{switch(d){case 5126:s="1f";break;case 35664:s="2f";break;case 35665:s="3f";break;case 35666:s="4f";break;case 35670:case 5124:s="1i";break;case 35671:case 35667:s="2i";break;case 35672:case 35668:s="3i";break;case 35673:s="4i";break;case 35669:s="4i"}1<m?(s+="v",p=e.global.def("["+Array.prototype.slice.call(p)+"]")):p=A(p)?Array.prototype.slice.call(p):p,n(c,".uniform",s,"(",y,",",p,");")}continue}b=g.append(e,n)}else{if(!a(ze))continue;b=n.def(l.uniforms,"[",t.id(p),"]")}switch(35678===d?n("if(",b,"&&",b,'._reglType==="framebuffer"){',b,"=",b,".color[0];","}"):35680===d&&n("if(",b,"&&",b,'._reglType==="framebufferCube"){',b,"=",b,".color[0];","}"),p=1,d){case 35678:case 35680:d=n.def(b,"._texture"),n(c,".uniform1i(",y,",",d,".bind());"),n.exit(d,".unbind();");continue;case 5124:case 35670:s="1i";break;case 35667:case 35671:s="2i",p=2;break;case 35668:case 35672:s="3i",p=3;break;case 35669:case 35673:s="4i",p=4;break;case 5126:s="1f";break;case 35664:s="2f",p=2;break;case 35665:s="3f",p=3;break;case 35666:s="4f",p=4;break;case 35674:s="Matrix2fv";break;case 35675:s="Matrix3fv";break;case 35676:s="Matrix4fv"}if(-1===s.indexOf("Matrix")&&1<m&&(s+="v",p=1),"M"===s.charAt(0)){n(c,".uniform",s,"(",y,","),y=Math.pow(d-35674+2,2);var x=e.global.def("new Float32Array(",y,")");Array.isArray(b)?n("false,(",f(y,(function(e){return x+"["+e+"]="+b[e]})),",",x,")"):n("false,(Array.isArray(",b,")||",b," instanceof Float32Array)?",b,":(",f(y,(function(e){return x+"["+e+"]="+b+"["+e+"]"})),",",x,")"),n(");")}else{if(1<p){d=[];var w=[];for(m=0;m<p;++m)Array.isArray(b)?w.push(b[m]):w.push(n.def(b+"["+m+"]")),o&&d.push(n.def());o&&n("if(!",e.batchId,"||",d.map((function(e,t){return e+"!=="+w[t]})).join("||"),"){",d.map((function(e,t){return e+"="+w[t]+";"})).join("")),n(c,".uniform",s,"(",y,",",w.join(","),");")}else o&&(d=n.def(),n("if(!",e.batchId,"||",d,"!==",b,"){",d,"=",b,";")),n(c,".uniform",s,"(",y,",",b,");");o&&n("}")}}}function G(e,t,n,r){function i(i){var a=d[i];return a?a.contextDep&&r.contextDynamic||a.propDep?a.append(e,n):a.append(e,t):t.def(p,".",i)}function a(){function e(){n(u,".drawElementsInstancedANGLE(",[g,b,y,v+"<<(("+y+"-5121)>>1)",c],");")}function t(){n(u,".drawArraysInstancedANGLE(",[g,v,b,c],");")}m&&"null"!==m?x?e():(n("if(",m,"){"),e(),n("}else{"),t(),n("}")):t()}function o(){function e(){n(h+".drawElements("+[g,b,y,v+"<<(("+y+"-5121)>>1)"]+");")}function t(){n(h+".drawArrays("+[g,v,b]+");")}m&&"null"!==m?x?e():(n("if(",m,"){"),e(),n("}else{"),t(),n("}")):t()}var s,l,c,u,f=e.shared,h=f.gl,p=f.draw,d=r.draw,m=(s=d.elements,l=t,s?((s.contextDep&&r.contextDynamic||s.propDep)&&(l=n),s=s.append(e,l),d.elementsActive&&l("if("+s+")"+h+".bindBuffer(34963,"+s+".buffer.buffer);")):(s=l.def(),l(s,"=",p,".","elements",";","if(",s,"){",h,".bindBuffer(",34963,",",s,".buffer.buffer);}","else if(",f.vao,".currentVAO){",s,"=",e.shared.elements+".getElements("+f.vao,".currentVAO.elements);",fe?"":"if("+s+")"+h+".bindBuffer(34963,"+s+".buffer.buffer);","}")),s),g=i("primitive"),v=i("offset"),b=function(){var i=d.count,a=t;return i?((i.contextDep&&r.contextDynamic||i.propDep)&&(a=n),i=i.append(e,a)):i=a.def(p,".","count"),i}();if("number"==typeof b){if(0===b)return}else n("if(",b,"){"),n.exit("}");le&&(c=i("instances"),u=e.instancing);var y=m+".type",x=d.elements&&U(d.elements)&&!d.vaoActive;le&&("number"!=typeof c||0<=c)?"string"==typeof c?(n("if(",c,">0){"),a(),n("}else if(",c,"<0){"),o(),n("}")):a():o()}function Z(e,t,n,r,i){return i=(t=y()).proc("body",i),le&&(t.instancing=i.def(t.shared.extensions,".angle_instanced_arrays")),e(t,i,n,r),t.compile().body}function $(e,t,n,r){R(e,t),n.useVAO?n.drawVAO?t(e.shared.vao,".setVAO(",n.drawVAO.append(e,t),");"):t(e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"):(t(e.shared.vao,".setVAO(null);"),B(e,t,n,r.attributes,(function(){return!0}))),X(e,t,n,r.uniforms,(function(){return!0}),!1),G(e,t,t,n)}function J(e,t){var n=e.proc("draw",1);R(e,n),I(e,n,t.context),L(e,n,t.framebuffer),k(e,n,t),z(e,n,t.state),F(e,n,t,!1,!0);var r=t.shader.progVar.append(e,n);if(n(e.shared.gl,".useProgram(",r,".program);"),t.shader.program)$(e,n,t,t.shader.program);else{n(e.shared.vao,".setVAO(null);");var i=e.global.def("{}"),a=n.def(r,".id"),o=n.def(i,"[",a,"]");n(e.cond(o).then(o,".call(this,a0);").else(o,"=",i,"[",a,"]=",e.link((function(n){return Z($,e,t,n,1)})),"(",r,");",o,".call(this,a0);"))}0<Object.keys(t.state).length&&n(e.shared.current,".dirty=true;"),e.shared.vao&&n(e.shared.vao,".setVAO(null);")}function K(e,t,n,r){function i(){return!0}e.batchId="a1",R(e,t),B(e,t,n,r.attributes,i),X(e,t,n,r.uniforms,i,!1),G(e,t,t,n)}function ee(e,t,n,r){function i(e){return e.contextDep&&o||e.propDep}function a(e){return!i(e)}R(e,t);var o=n.contextDep,s=t.def(),l=t.def();e.shared.props=l,e.batchId=s;var c=e.scope(),u=e.scope();t(c.entry,"for(",s,"=0;",s,"<","a1",";++",s,"){",l,"=","a0","[",s,"];",u,"}",c.exit),n.needsContext&&I(e,u,n.context),n.needsFramebuffer&&L(e,u,n.framebuffer),z(e,u,n.state,i),n.profile&&i(n.profile)&&F(e,u,n,!1,!0),r?(n.useVAO?n.drawVAO?i(n.drawVAO)?u(e.shared.vao,".setVAO(",n.drawVAO.append(e,u),");"):c(e.shared.vao,".setVAO(",n.drawVAO.append(e,c),");"):c(e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"):(c(e.shared.vao,".setVAO(null);"),B(e,c,n,r.attributes,a),B(e,u,n,r.attributes,i)),X(e,c,n,r.uniforms,a,!1),X(e,u,n,r.uniforms,i,!0),G(e,c,u,n)):(t=e.global.def("{}"),r=n.shader.progVar.append(e,u),l=u.def(r,".id"),c=u.def(t,"[",l,"]"),u(e.shared.gl,".useProgram(",r,".program);","if(!",c,"){",c,"=",t,"[",l,"]=",e.link((function(t){return Z(K,e,n,t,2)})),"(",r,");}",c,".call(this,a0[",s,"],",s,");"))}function te(e,t){function n(e){return e.contextDep&&i||e.propDep}var r=e.proc("batch",2);e.batchId="0",R(e,r);var i=!1,a=!0;Object.keys(t.context).forEach((function(e){i=i||t.context[e].propDep})),i||(I(e,r,t.context),a=!1);var o=!1;if((s=t.framebuffer)?(s.propDep?i=o=!0:s.contextDep&&i&&(o=!0),o||L(e,r,s)):L(e,r,null),t.state.viewport&&t.state.viewport.propDep&&(i=!0),k(e,r,t),z(e,r,t.state,(function(e){return!n(e)})),t.profile&&n(t.profile)||F(e,r,t,!1,"a1"),t.contextDep=i,t.needsContext=a,t.needsFramebuffer=o,(a=t.shader.progVar).contextDep&&i||a.propDep)ee(e,r,t,null);else if(a=a.append(e,r),r(e.shared.gl,".useProgram(",a,".program);"),t.shader.program)ee(e,r,t,t.shader.program);else{r(e.shared.vao,".setVAO(null);");var s=e.global.def("{}"),l=(o=r.def(a,".id"),r.def(s,"[",o,"]"));r(e.cond(l).then(l,".call(this,a0,a1);").else(l,"=",s,"[",o,"]=",e.link((function(n){return Z(ee,e,t,n,2)})),"(",a,");",l,".call(this,a0,a1);"))}0<Object.keys(t.state).length&&r(e.shared.current,".dirty=true;"),e.shared.vao&&r(e.shared.vao,".setVAO(null);")}function ne(e,n){function r(t){var r=n.shader[t];r&&i.set(a.shader,"."+t,r.append(e,i))}var i=e.proc("scope",3);e.batchId="a2";var a=e.shared,o=a.current;I(e,i,n.context),n.framebuffer&&n.framebuffer.append(e,i),W(Object.keys(n.state)).forEach((function(t){var r=n.state[t].append(e,i);A(r)?r.forEach((function(n,r){i.set(e.next[t],"["+r+"]",n)})):i.set(a.next,"."+t,r)})),F(e,i,n,!0,!0),["elements","offset","count","instances","primitive"].forEach((function(t){var r=n.draw[t];r&&i.set(a.draw,"."+t,""+r.append(e,i))})),Object.keys(n.uniforms).forEach((function(r){var o=n.uniforms[r].append(e,i);Array.isArray(o)&&(o="["+o.join()+"]"),i.set(a.uniforms,"["+t.id(r)+"]",o)})),Object.keys(n.attributes).forEach((function(t){var r=n.attributes[t].append(e,i),a=e.scopeAttrib(t);Object.keys(new oe).forEach((function(e){i.set(a,"."+e,r[e])}))})),n.scopeVAO&&i.set(a.vao,".targetVAO",n.scopeVAO.append(e,i)),r("vert"),r("frag"),0<Object.keys(n.state).length&&(i(o,".dirty=true;"),i.exit(o,".dirty=true;")),i("a1(",e.shared.context,",a0,",e.batchId,");")}function re(e){if("object"==typeof e&&!A(e)){for(var t=Object.keys(e),n=0;n<t.length;++n)if(Q.isDynamic(e[t[n]]))return!0;return!1}}function ie(e,t,n){function r(e,t){o.forEach((function(n){var r=i[n];Q.isDynamic(r)&&(r=e.invoke(t,r),t(u,".",n,"=",r,";"))}))}var i=t.static[n];if(i&&re(i)){var a=e.global,o=Object.keys(i),s=!1,l=!1,c=!1,u=e.global.def("{}");o.forEach((function(t){var n=i[t];if(Q.isDynamic(n))"function"==typeof n&&(n=i[t]=Q.unbox(n)),t=Y(n,null),s=s||t.thisDep,c=c||t.propDep,l=l||t.contextDep;else{switch(a(u,".",t,"="),typeof n){case"number":a(n);break;case"string":a('"',n,'"');break;case"object":Array.isArray(n)&&a("[",n.join(),"]");break;default:a(e.link(n))}a(";")}})),t.dynamic[n]=new Q.DynamicVariable(4,{thisDep:s,contextDep:l,propDep:c,ref:u,append:r}),delete t.static[n]}}var oe=c.Record,se={add:32774,subtract:32778,"reverse subtract":32779};n.ext_blend_minmax&&(se.min=32775,se.max=32776);var le=n.angle_instanced_arrays,ce=n.webgl_draw_buffers,fe=n.oes_vertex_array_object,he={dirty:!0,profile:m.profile},pe={},de=[],me={},ge={};v("dither",3024),v("blend.enable",3042),b("blend.color","blendColor",[0,0,0,0]),b("blend.equation","blendEquationSeparate",[32774,32774]),b("blend.func","blendFuncSeparate",[1,0,1,0]),v("depth.enable",2929,!0),b("depth.func","depthFunc",513),b("depth.range","depthRange",[0,1]),b("depth.mask","depthMask",!0),b("colorMask","colorMask",[!0,!0,!0,!0]),v("cull.enable",2884),b("cull.face","cullFace",1029),b("frontFace","frontFace",2305),b("lineWidth","lineWidth",1),v("polygonOffset.enable",32823),b("polygonOffset.offset","polygonOffset",[0,0]),v("sample.alpha",32926),v("sample.enable",32928),b("sample.coverage","sampleCoverage",[1,!1]),v("stencil.enable",2960),b("stencil.mask","stencilMask",-1),b("stencil.func","stencilFunc",[519,0,-1]),b("stencil.opFront","stencilOpSeparate",[1028,7680,7680,7680]),b("stencil.opBack","stencilOpSeparate",[1029,7680,7680,7680]),v("scissor.enable",3089),b("scissor.box","scissor",[0,0,e.drawingBufferWidth,e.drawingBufferHeight]),b("viewport","viewport",[0,0,e.drawingBufferWidth,e.drawingBufferHeight]);var ve={gl:e,context:p,strings:t,next:pe,current:he,draw:h,elements:a,buffer:i,shader:u,attributes:c.state,vao:c,uniforms:l,framebuffer:s,extensions:n,timer:d,isBufferArgs:N},be={primTypes:ue,compareFuncs:Ie,blendFuncs:De,blendEquations:se,stencilOps:Le,glTypes:ae,orientationType:ke};ce&&(be.backBuffer=[1029],be.drawBuffer=f(r.maxDrawbuffers,(function(e){return 0===e?[0]:f(e,(function(e){return 36064+e}))})));var ye=0;return{next:pe,current:he,procs:function(){var e=y(),t=e.proc("poll"),i=e.proc("refresh"),a=e.block();t(a),i(a);var o,s=e.shared,l=s.gl,c=s.next,u=s.current;a(u,".dirty=false;"),L(e,t),L(e,i,null,!0),le&&(o=e.link(le)),n.oes_vertex_array_object&&i(e.link(n.oes_vertex_array_object),".bindVertexArrayOES(null);");for(var h=0;h<r.maxAttributes;++h){var p=i.def(s.attributes,"[",h,"]"),d=e.cond(p,".buffer");d.then(l,".enableVertexAttribArray(",h,");",l,".bindBuffer(",34962,",",p,".buffer.buffer);",l,".vertexAttribPointer(",h,",",p,".size,",p,".type,",p,".normalized,",p,".stride,",p,".offset);").else(l,".disableVertexAttribArray(",h,");",l,".vertexAttrib4f(",h,",",p,".x,",p,".y,",p,".z,",p,".w);",p,".buffer=null;"),i(d),le&&i(o,".vertexAttribDivisorANGLE(",h,",",p,".divisor);")}return i(e.shared.vao,".currentVAO=null;",e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"),Object.keys(me).forEach((function(n){var r=me[n],o=a.def(c,".",n),s=e.block();s("if(",o,"){",l,".enable(",r,")}else{",l,".disable(",r,")}",u,".",n,"=",o,";"),i(s),t("if(",o,"!==",u,".",n,"){",s,"}")})),Object.keys(ge).forEach((function(n){var r,o,s=ge[n],h=he[n],p=e.block();p(l,".",s,"("),A(h)?(s=h.length,r=e.global.def(c,".",n),o=e.global.def(u,".",n),p(f(s,(function(e){return r+"["+e+"]"})),");",f(s,(function(e){return o+"["+e+"]="+r+"["+e+"];"})).join("")),t("if(",f(s,(function(e){return r+"["+e+"]!=="+o+"["+e+"]"})).join("||"),"){",p,"}")):(r=a.def(c,".",n),o=a.def(u,".",n),p(r,");",u,".",n,"=",r,";"),t("if(",r,"!==",o,"){",p,"}")),i(p)})),e.compile()}(),compile:function(e,t,n,r,i){var a=y();a.stats=a.link(i),Object.keys(t.static).forEach((function(e){ie(a,t,e)})),Oe.forEach((function(t){ie(a,e,t)}));var o=D(e,t,n,r,a);return J(a,o),ne(a,o),te(a,o),q(a.compile(),{destroy:function(){o.shader.program.destroy()}})}}}function G(e,t){for(var n=0;n<e.length;++n)if(e[n]===t)return n;return-1}var q=function(e,t){for(var n=Object.keys(t),r=0;r<n.length;++r)e[n[r]]=t[n[r]];return e},Z=0,Q={DynamicVariable:e,define:function(t,r){return new e(t,n(r+""))},isDynamic:function(t){return"function"==typeof t&&!t._reglType||t instanceof e},unbox:r,accessor:n},$={next:"function"==typeof requestAnimationFrame?function(e){return requestAnimationFrame(e)}:function(e){return setTimeout(e,16)},cancel:"function"==typeof cancelAnimationFrame?function(e){return cancelAnimationFrame(e)}:clearTimeout},J="undefined"!=typeof performance&&performance.now?function(){return performance.now()}:function(){return+new Date},K=p();K.zero=p();var ee=function(e,t){var n=1;t.ext_texture_filter_anisotropic&&(n=e.getParameter(34047));var r=1,i=1;t.webgl_draw_buffers&&(r=e.getParameter(34852),i=e.getParameter(36063));var a=!!t.oes_texture_float;if(a){a=e.createTexture(),e.bindTexture(3553,a),e.texImage2D(3553,0,6408,1,1,0,6408,5126,null);var o=e.createFramebuffer();if(e.bindFramebuffer(36160,o),e.framebufferTexture2D(36160,36064,3553,a,0),e.bindTexture(3553,null),36053!==e.checkFramebufferStatus(36160))a=!1;else{e.viewport(0,0,1,1),e.clearColor(1,0,0,1),e.clear(16384);var s=K.allocType(5126,4);e.readPixels(0,0,1,1,6408,5126,s),e.getError()?a=!1:(e.deleteFramebuffer(o),e.deleteTexture(a),a=1===s[0]),K.freeType(s)}}return s=!0,"undefined"!=typeof navigator&&(/MSIE/.test(navigator.userAgent)||/Trident\//.test(navigator.appVersion)||/Edge/.test(navigator.userAgent))||(s=e.createTexture(),o=K.allocType(5121,36),e.activeTexture(33984),e.bindTexture(34067,s),e.texImage2D(34069,0,6408,3,3,0,6408,5121,o),K.freeType(o),e.bindTexture(34067,null),e.deleteTexture(s),s=!e.getError()),{colorBits:[e.getParameter(3410),e.getParameter(3411),e.getParameter(3412),e.getParameter(3413)],depthBits:e.getParameter(3414),stencilBits:e.getParameter(3415),subpixelBits:e.getParameter(3408),extensions:Object.keys(t).filter((function(e){return!!t[e]})),maxAnisotropic:n,maxDrawbuffers:r,maxColorAttachments:i,pointSizeDims:e.getParameter(33901),lineWidthDims:e.getParameter(33902),maxViewportDims:e.getParameter(3386),maxCombinedTextureUnits:e.getParameter(35661),maxCubeMapSize:e.getParameter(34076),maxRenderbufferSize:e.getParameter(34024),maxTextureUnits:e.getParameter(34930),maxTextureSize:e.getParameter(3379),maxAttributes:e.getParameter(34921),maxVertexUniforms:e.getParameter(36347),maxVertexTextureUnits:e.getParameter(35660),maxVaryingVectors:e.getParameter(36348),maxFragmentUniforms:e.getParameter(36349),glsl:e.getParameter(35724),renderer:e.getParameter(7937),vendor:e.getParameter(7936),version:e.getParameter(7938),readFloat:a,npotTextureCube:s}},te=function(e){return e instanceof Uint8Array||e instanceof Uint16Array||e instanceof Uint32Array||e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array||e instanceof Float32Array||e instanceof Float64Array||e instanceof Uint8ClampedArray},ne=function(e){return Object.keys(e).map((function(t){return e[t]}))},re={shape:function(e){for(var t=[];e.length;e=e[0])t.push(e.length);return t},flatten:function(e,t,n,r){var i=1;if(t.length)for(var a=0;a<t.length;++a)i*=t[a];else i=0;switch(n=r||K.allocType(n,i),t.length){case 0:break;case 1:for(r=t[0],t=0;t<r;++t)n[t]=e[t];break;case 2:for(r=t[0],t=t[1],a=i=0;a<r;++a)for(var o=e[a],s=0;s<t;++s)n[i++]=o[s];break;case 3:m(e,t[0],t[1],t[2],n,0);break;default:g(e,t,0,n,0)}return n}},ie={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121},ae={int8:5120,int16:5122,int32:5124,uint8:5121,uint16:5123,uint32:5125,float:5126,float32:5126},oe={dynamic:35048,stream:35040,static:35044},se=re.flatten,le=re.shape,ce=[];ce[5120]=1,ce[5122]=2,ce[5124]=4,ce[5121]=1,ce[5123]=2,ce[5125]=4,ce[5126]=4;var ue={points:0,point:0,lines:1,line:1,triangles:4,triangle:4,"line loop":2,"line strip":3,"triangle strip":5,"triangle fan":6},fe=new Float32Array(1),he=new Uint32Array(fe.buffer),pe=[9984,9986,9985,9987],de=[0,6409,6410,6407,6408],me={};me[6409]=me[6406]=me[6402]=1,me[34041]=me[6410]=2,me[6407]=me[35904]=3,me[6408]=me[35906]=4;var ge=S("HTMLCanvasElement"),ve=S("OffscreenCanvas"),be=S("CanvasRenderingContext2D"),ye=S("ImageBitmap"),xe=S("HTMLImageElement"),we=S("HTMLVideoElement"),_e=Object.keys(ie).concat([ge,ve,be,ye,xe,we]),Ae=[];Ae[5121]=1,Ae[5126]=4,Ae[36193]=2,Ae[5123]=2,Ae[5125]=4;var Se=[];Se[32854]=2,Se[32855]=2,Se[36194]=2,Se[34041]=4,Se[33776]=.5,Se[33777]=.5,Se[33778]=1,Se[33779]=1,Se[35986]=.5,Se[35987]=1,Se[34798]=1,Se[35840]=.5,Se[35841]=.25,Se[35842]=.5,Se[35843]=.25,Se[36196]=.5;var Te=[];Te[32854]=2,Te[32855]=2,Te[36194]=2,Te[33189]=2,Te[36168]=1,Te[34041]=4,Te[35907]=4,Te[34836]=16,Te[34842]=8,Te[34843]=6;var Ee=function(e,t,n,r,i){function a(e){this.id=c++,this.refCount=1,this.renderbuffer=e,this.format=32854,this.height=this.width=0,i.profile&&(this.stats={size:0})}function o(t){var n=t.renderbuffer;e.bindRenderbuffer(36161,null),e.deleteRenderbuffer(n),t.renderbuffer=null,t.refCount=0,delete u[t.id],r.renderbufferCount--}var s={rgba4:32854,rgb565:36194,"rgb5 a1":32855,depth:33189,stencil:36168,"depth stencil":34041};t.ext_srgb&&(s.srgba=35907),t.ext_color_buffer_half_float&&(s.rgba16f=34842,s.rgb16f=34843),t.webgl_color_buffer_float&&(s.rgba32f=34836);var l=[];Object.keys(s).forEach((function(e){l[s[e]]=e}));var c=0,u={};return a.prototype.decRef=function(){0>=--this.refCount&&o(this)},i.profile&&(r.getTotalRenderbufferSize=function(){var e=0;return Object.keys(u).forEach((function(t){e+=u[t].stats.size})),e}),{create:function(t,n){function o(t,n){var r=0,a=0,u=32854;if("object"==typeof t&&t?("shape"in t?(r=0|(a=t.shape)[0],a=0|a[1]):("radius"in t&&(r=a=0|t.radius),"width"in t&&(r=0|t.width),"height"in t&&(a=0|t.height)),"format"in t&&(u=s[t.format])):"number"==typeof t?(r=0|t,a="number"==typeof n?0|n:r):t||(r=a=1),r!==c.width||a!==c.height||u!==c.format)return o.width=c.width=r,o.height=c.height=a,c.format=u,e.bindRenderbuffer(36161,c.renderbuffer),e.renderbufferStorage(36161,u,r,a),i.profile&&(c.stats.size=Te[c.format]*c.width*c.height),o.format=l[c.format],o}var c=new a(e.createRenderbuffer());return u[c.id]=c,r.renderbufferCount++,o(t,n),o.resize=function(t,n){var r=0|t,a=0|n||r;return r===c.width&&a===c.height||(o.width=c.width=r,o.height=c.height=a,e.bindRenderbuffer(36161,c.renderbuffer),e.renderbufferStorage(36161,c.format,r,a),i.profile&&(c.stats.size=Te[c.format]*c.width*c.height)),o},o._reglType="renderbuffer",o._renderbuffer=c,i.profile&&(o.stats=c.stats),o.destroy=function(){c.decRef()},o},clear:function(){ne(u).forEach(o)},restore:function(){ne(u).forEach((function(t){t.renderbuffer=e.createRenderbuffer(),e.bindRenderbuffer(36161,t.renderbuffer),e.renderbufferStorage(36161,t.format,t.width,t.height)})),e.bindRenderbuffer(36161,null)}}},Ce=[];Ce[6408]=4,Ce[6407]=3;var Me=[];Me[5121]=1,Me[5126]=4,Me[36193]=2;var Pe=["x","y","z","w"],Oe="blend.func blend.equation stencil.func stencil.opFront stencil.opBack sample.coverage viewport scissor.box polygonOffset.offset".split(" "),De={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},Ie={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},Le={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},ke={cw:2304,ccw:2305},ze=new V(!1,!1,!1,(function(){})),Re=function(e,t){function n(){this.endQueryIndex=this.startQueryIndex=-1,this.sum=0,this.stats=null}function r(e,t,r){var i=o.pop()||new n;i.startQueryIndex=e,i.endQueryIndex=t,i.sum=0,i.stats=r,s.push(i)}if(!t.ext_disjoint_timer_query)return null;var i=[],a=[],o=[],s=[],l=[],c=[];return{beginQuery:function(e){var n=i.pop()||t.ext_disjoint_timer_query.createQueryEXT();t.ext_disjoint_timer_query.beginQueryEXT(35007,n),a.push(n),r(a.length-1,a.length,e)},endQuery:function(){t.ext_disjoint_timer_query.endQueryEXT(35007)},pushScopeStats:r,update:function(){var e,n;if(0!==(e=a.length)){c.length=Math.max(c.length,e+1),l.length=Math.max(l.length,e+1),l[0]=0;var r=c[0]=0;for(n=e=0;n<a.length;++n){var u=a[n];t.ext_disjoint_timer_query.getQueryObjectEXT(u,34919)?(r+=t.ext_disjoint_timer_query.getQueryObjectEXT(u,34918),i.push(u)):a[e++]=u,l[n+1]=r,c[n+1]=e}for(a.length=e,n=e=0;n<s.length;++n){var f=(r=s[n]).startQueryIndex;u=r.endQueryIndex,r.sum+=l[u]-l[f],f=c[f],(u=c[u])===f?(r.stats.gpuTime+=r.sum/1e6,o.push(r)):(r.startQueryIndex=f,r.endQueryIndex=u,s[e++]=r)}s.length=e}},getNumPendingQueries:function(){return a.length},clear:function(){i.push.apply(i,a);for(var e=0;e<i.length;e++)t.ext_disjoint_timer_query.deleteQueryEXT(i[e]);a.length=0,i.length=0},restore:function(){a.length=0,i.length=0}}};return function(e){function t(){if(0===Y.length)S&&S.update(),ne=null;else{ne=$.next(t),p();for(var e=Y.length-1;0<=e;--e){var n=Y[e];n&&n(M,null,0)}g.flush(),S&&S.update()}}function n(){!ne&&0<Y.length&&(ne=$.next(t))}function r(){ne&&($.cancel(t),ne=null)}function a(e){e.preventDefault(),r(),Z.forEach((function(e){e()}))}function o(e){g.getError(),b.restore(),B.restore(),O.restore(),j.restore(),N.restore(),W.restore(),F.restore(),S&&S.restore(),V.procs.refresh(),n(),K.forEach((function(e){e()}))}function s(e){function t(e,t){var n={},r={};return Object.keys(e).forEach((function(i){var a=e[i];if(Q.isDynamic(a))r[i]=Q.unbox(a,i);else{if(t&&Array.isArray(a))for(var o=0;o<a.length;++o)if(Q.isDynamic(a[o]))return void(r[i]=Q.unbox(a,i));n[i]=a}})),{dynamic:r,static:n}}function n(e){for(;f.length<e;)f.push(null);return f}var r=t(e.context||{},!0),i=t(e.uniforms||{},!0),a=t(e.attributes||{},!1);e=t(function(e){function t(e){if(e in n){var t=n[e];delete n[e],Object.keys(t).forEach((function(r){n[e+"."+r]=t[r]}))}}var n=q({},e);return delete n.uniforms,delete n.attributes,delete n.context,delete n.vao,"stencil"in n&&n.stencil.op&&(n.stencil.opBack=n.stencil.opFront=n.stencil.op,delete n.stencil.op),t("blend"),t("depth"),t("cull"),t("stencil"),t("polygonOffset"),t("scissor"),t("sample"),"vao"in e&&(n.vao=e.vao),n}(e),!1);var o={gpuTime:0,cpuTime:0,count:0},s=V.compile(e,a,i,r,o),l=s.draw,c=s.batch,u=s.scope,f=[];return q((function(e,t){var r;if("function"==typeof e)return u.call(this,null,e,0);if("function"==typeof t)if("number"==typeof e)for(r=0;r<e;++r)u.call(this,null,t,r);else{if(!Array.isArray(e))return u.call(this,e,t,0);for(r=0;r<e.length;++r)u.call(this,e[r],t,r)}else if("number"==typeof e){if(0<e)return c.call(this,n(0|e),0|e)}else{if(!Array.isArray(e))return l.call(this,e);if(e.length)return c.call(this,e,e.length)}}),{stats:o,destroy:function(){s.destroy()}})}function l(e,t){var n=0;V.procs.poll();var r=t.color;r&&(g.clearColor(+r[0]||0,+r[1]||0,+r[2]||0,+r[3]||0),n|=16384),"depth"in t&&(g.clearDepth(+t.depth),n|=256),"stencil"in t&&(g.clearStencil(0|t.stencil),n|=1024),g.clear(n)}function f(e){return Y.push(e),n(),{cancel:function(){function t(){var e=G(Y,t);Y[e]=Y[Y.length-1],--Y.length,0>=Y.length&&r()}var n=G(Y,e);Y[n]=t}}}function h(){var e=U.viewport,t=U.scissor_box;e[0]=e[1]=t[0]=t[1]=0,M.viewportWidth=M.framebufferWidth=M.drawingBufferWidth=e[2]=t[2]=g.drawingBufferWidth,M.viewportHeight=M.framebufferHeight=M.drawingBufferHeight=e[3]=t[3]=g.drawingBufferHeight}function p(){M.tick+=1,M.time=m(),h(),V.procs.poll()}function d(){j.refresh(),h(),V.procs.refresh(),S&&S.update()}function m(){return(J()-T)/1e3}if(!(e=c(e)))return null;var g=e.gl,v=g.getContextAttributes();g.isContextLost();var b=u(g,e);if(!b)return null;var y=i(),_={vaoCount:0,bufferCount:0,elementsCount:0,framebufferCount:0,shaderCount:0,textureCount:0,cubeCount:0,renderbufferCount:0,maxTextureUnits:0},A=b.extensions,S=Re(g,A),T=J(),E=g.drawingBufferWidth,C=g.drawingBufferHeight,M={tick:0,time:0,viewportWidth:E,viewportHeight:C,framebufferWidth:E,framebufferHeight:C,drawingBufferWidth:E,drawingBufferHeight:C,pixelRatio:e.pixelRatio},P=(E={elements:null,primitive:4,count:-1,offset:0,instances:-1},ee(g,A)),O=x(g,_,e,(function(e){return F.destroyBuffer(e)})),L=w(g,A,O,_),F=k(g,A,P,_,O,L,E),B=z(g,y,_,e),j=D(g,A,P,(function(){V.procs.poll()}),M,_,e),N=Ee(g,A,P,_,e),W=I(g,A,P,j,N,_),V=X(g,y,A,P,O,L,j,W,{},F,B,E,M,S,e),U=(y=R(g,W,V.procs.poll,M),V.next),H=g.canvas,Y=[],Z=[],K=[],te=[e.onDestroy],ne=null;H&&(H.addEventListener("webglcontextlost",a,!1),H.addEventListener("webglcontextrestored",o,!1));var re=W.setFBO=s({framebuffer:Q.define.call(null,1,"framebuffer")});return d(),v=q(s,{clear:function(e){if("framebuffer"in e)if(e.framebuffer&&"framebufferCube"===e.framebuffer_reglType)for(var t=0;6>t;++t)re(q({framebuffer:e.framebuffer.faces[t]},e),l);else re(e,l);else l(null,e)},prop:Q.define.bind(null,1),context:Q.define.bind(null,2),this:Q.define.bind(null,3),draw:s({}),buffer:function(e){return O.create(e,34962,!1,!1)},elements:function(e){return L.create(e,!1)},texture:j.create2D,cube:j.createCube,renderbuffer:N.create,framebuffer:W.create,framebufferCube:W.createCube,vao:F.createVAO,attributes:v,frame:f,on:function(e,t){var n;switch(e){case"frame":return f(t);case"lost":n=Z;break;case"restore":n=K;break;case"destroy":n=te}return n.push(t),{cancel:function(){for(var e=0;e<n.length;++e)if(n[e]===t){n[e]=n[n.length-1],n.pop();break}}}},limits:P,hasExtension:function(e){return 0<=P.extensions.indexOf(e.toLowerCase())},read:y,destroy:function(){Y.length=0,r(),H&&(H.removeEventListener("webglcontextlost",a),H.removeEventListener("webglcontextrestored",o)),B.clear(),W.clear(),N.clear(),F.clear(),j.clear(),L.clear(),O.clear(),S&&S.clear(),te.forEach((function(e){e()}))},_gl:g,_refresh:d,poll:function(){p(),S&&S.update()},now:m,stats:_}),e.onDone(null,v),v}}();class ka{constructor({canvas:e,pixelRatio:t,control:n}){this.config=zn,this.control=n,La({canvas:e,attributes:{preserveDrawingBuffer:!0,antialiasing:!0},pixelRatio:t,extensions:["angle_instanced_arrays","oes_texture_float","OES_standard_derivatives","OES_texture_half_float","EXT_color_buffer_half_float"],onDone:(e,t)=>{if(e)return console.error(e);try{this.regl=t,this.init(t),this.run(t)}catch(n){console.error(n)}}})}resize(){this.regl.poll()}destroy(){this.regl.destroy()}init(e){this.regl._commands=[],this.camera=$t(this.regl,l(s({},this.config.view.camera),{aspectRatio:this.regl._gl.canvas.clientWidth/this.regl._gl.canvas.clientHeight})),this.initStory(),this.drawTexture=Pa(e),this.config.model.lattice=new xr(this.config.model.lattice),this.view=new Aa(e,{variables:this.variables,model:this.config.model,view:this.config.view,debug:this.config.debug})}initStory(){this.story=function(e,t,n,r){let i=0;t.forEach(((n,r)=>{console.log("sequencer.start"),n.loaded=!1,n.variables={snapshotCount:128,particleCount:64,iterations:127,pingPong:0,segments:8128,iteration:128,littleEndian:pr()},n._s=r,n._t0=i,n._t0_normalized=i/t.duration,n._t1=i+n.duration,n._t1_normalized=n._t1/t.duration,i=n._t1,n.data().then((({data:t,name:r,configuration:i})=>{n.preset=r,n.configuration=i,n.runner=n.configuration.runner,n.model=n.configuration.model,n.variables.position={buffers:[dr(e,{width:4*n.runner.snapshotCount,height:n.model.emitter.particleCount},"float",new Float32Array(t.position.map((e=>[e,0,0,0])).flat()))]},n.variables.particleColorsAndTypes=e.texture({data:t.particleTypes.map((e=>rr[e].color.concat(e))).flat(),shape:[64,1,4]}),n.variables.colorCorrections=e.texture({data:t.colorCorrections.map((e=>[e,0,0,0])).flat(),shape:[64,1,4],type:"float"}),n.model={lattice:new xr(n.model.lattice),boundingBoxSize:i.model.boundingBoxSize,interactions:{particleInteraction:i.model.interactions.particleInteraction,electricField:i.model.interactions.electricField,magneticField:i.model.interactions.magneticField}},n.cameraBSplines={distance:e=>Da(e,2,n.cameraSploints.distance),phi:e=>Da(e,2,n.cameraSploints.phi),theta:e=>Da(e,2,n.cameraSploints.theta),centerX:e=>Da(e,2,n.cameraSploints.centerX),centerY:e=>Da(e,2,n.cameraSploints.centerY),centerZ:e=>Da(e,2,n.cameraSploints.centerZ)},n.loaded=!0}))}));const a={sceneIdx:0,scene:t[0]},o={};function s(e){e>1&&(e=1);const n=(t.find((t=>t._t0_normalized<=e&&e<=t._t1_normalized))||{_s:0})._s;return n!==a.sceneIdx&&n>=0&&n<t.length?(o.sceneIdx={from:a.sceneIdx,to:n},a.sceneIdx=n,a.scene=t[n]):delete o.sceneIdx,a.sceneProgress=(e-a.scene._t0_normalized)*t.duration/a.scene.duration,a.viewRange=[a.sceneProgress-.5,a.sceneProgress],Object.keys(o).length>0}let l=0;s(l);const c={setPosition:function(e){return l=e,s(e)&&r&&r(a,o),c},getPosition:function(){return l},getState:function(){return a}};return c}(this.regl,this.control.scenes,0,(()=>{})),this.variables=this.story.getState().scene.variables,this.model=this.story.getState().scene.model}run(e){this.loop=e.frame((({time:t,tick:n})=>{const r=this.story.getState();if(r.scene.loaded){let i,a;i=r.sceneProgress;const o=r.scene.pathicles&&r.scene.pathicles.autoLoop;o&&(n%127==0&&(this.modelTranslateX=.1*or(),this.modelTranslateY=.1*or()),a=[t%2-.5,t%2+.1],this.modelTranslateX=0,this.modelTranslateY=0),this.camera.params.phi=r.scene.cameraBSplines.phi(i)[0],this.camera.params.distance=r.scene.cameraBSplines.distance(i)[0],this.camera.params.theta=r.scene.cameraBSplines.theta(i)[0],this.camera.params.center=[r.scene.cameraBSplines.centerX(i)[0],r.scene.cameraBSplines.centerY(i)[0],r.scene.cameraBSplines.centerZ(i)[0]],this.camera.tick(),(o||this.camera.state.dirty)&&this.camera.setCameraUniforms(l(s({},this.camera),{scene:r.scene,sceneProgress:i}),(()=>{e.clear({color:[0,0,0,0],depth:1}),this.view.drawDiffuse({colorCorrections:r.scene.variables.colorCorrections,particleColorsAndTypes:r.scene.variables.particleColorsAndTypes,position:r.scene.variables.position.buffers[0],modelTranslateX:this.modelTranslateX,modelTranslateY:this.modelTranslateY,viewRange:a}),this.config.debug.showTextures&&this.drawTexture({texture:r.scene.variables.position.buffers[0],x0:0})}))}}))}}var za={name:"Hotkeys",data:()=>({supportedShortcuts:[]}),props:{shortcuts:{type:Array,required:!0},debug:{type:Boolean,default:!1}},methods:{onUseKeyboardShortcuts(e){const t=e.keyCode||e.which;if(this.supportedShortcuts.some((({keyCode:e})=>e===t))){const{keyString:e}=this.supportedShortcuts.find((({keyCode:e})=>e===t));this.debug&&console.log(`CMD (CTRL) + ${e} (${t}) pressed`),this.$emit("triggered",{key:t,keyString:e})}}},created(){this.shortcuts&&this.shortcuts.length&&this.shortcuts.forEach((e=>{e&&this.supportedShortcuts.push({keyString:e,keyCode:e.charCodeAt(0)})}))},mounted(){document.addEventListener("keydown",this.onUseKeyboardShortcuts,!1),this.debug&&console.log("Vue Keyboard Shortcuts ENABLED")},beforeUnmount(){document.removeEventListener("keydown",this.onUseKeyboardShortcuts),this.debug&&console.log("Vue Keyboard Shortcuts DISABLED")}};za.render=function(e,t,n,r,i,a){return u(),f("div")};var Ra=h({name:"Pathicles",components:{Hotkeys:za},props:{presetName:{type:String,default:"story-dipole"},showInfo:{type:Boolean,default:!0},prerender:{type:Boolean,default:!0},debug:{type:Boolean,default:!1},maxCanvasWidth:{type:Number,default:2048},maxCanvasHeight:{type:Number,default:1024},maxPixelRatio:{type:Number,default:2},clickToInteract:{type:Boolean,default:!1}},setup(e){const t=p(),n=d(e.showInfo),r=d(null),i=d(null),{height:a,width:o}=m(),{width:s,height:l}=g(r),c=v((()=>({width:s.value+"px",height:l.value+"px"}))),u=v((()=>Math.min(window.devicePixelRatio,e.maxPixelRatio))),f=v((()=>s.value*u.value)),h=v((()=>l.value*u.value)),y=d(!e.clickToInteract),x=d(null);b(o,(()=>{x&&x.value&&x.value.resize()})),b(a,(()=>{x&&x.value&&x.value.resize()})),b(t,(()=>{x&&x.value&&x.value.runner.toggleActivity()}));const w=d(null);return{canvasContainer:r,canvas:i,focused:t,canvasStyles:c,canvasWidth:f,canvasHeight:h,reglInstance:x,showInfo:n,info:w,isInteractive:y}},mounted(){this.loadConfig(),this.$nextTick((()=>{this.reglInstance=new Oa({canvas:this.$refs.canvas,config:this.config,control:{viewRange:this.viewRange,progress:this.progress,cameraMode:this.cameraMode}})}))},unmounted(){this.reglInstance.destroy()},methods:{onTriggeredEventHandler(e){"I"===e.keyString?this.showInfo=!this.showInfo:"A"===e.keyString?this.reglInstance.camera.toggleAutorotate():"D"===e.keyString?console.log(this.reglInstance.simulation.dump()):"M"===e.keyString?this.reglInstance.runner.toggleMode():"T"===e.keyString?this.reglInstance.toggleShowTextures():"S"===e.keyString?function(e,t,n="png"){let r,i;if("png"===n.toLowerCase()?(r="image/png",i="png"):"webp"===n.toLowerCase()?(r="image/webp",i="webp"):"gif"===n.toLowerCase()?(r="image/gif",i="gif"):(r="image/jpeg",i="jpg"),navigator.msSaveOrOpenBlob){const n=e.msToBlob(r,1);window.navigator.msSaveBlob(n,t+"."+i)}else{const n=e.toDataURL(r,1),a=document.createElement("a");a.download=t+"."+i,a.href=n,a.dataset.downloadurl=[r,a.download,a.href].join(":"),document.body.appendChild(a),a.click(),document.body.removeChild(a)}}(this.reglInstance.regl._gl.canvas,"pathicles"+(this.reglInstance.presetName?"--"+this.reglInstance.presetName:"")):"N"===e.keyString?this.reglInstance.runner.next():"L"===e.keyString?this.reglInstance.runner.toggleLooping():" "===e.keyString&&this.reglInstance.runner.toggleActivity()},loadConfig(){this.config=Ce(this.presetName),this.info={particles:this.config.model.emitter.particleCount,snapshots:this.config.runner.snapshotCount,iterations:this.config.runner.iterationCount,dt:this.config.runner.iterationDurationOverC+" c","":this.config.model.emitter.gamma.toString().replace(/=>/,"=>\n")}}},watch:{presetName(e){this.loadConfig(e),this.reglInstance.loadConfig(this.config)}}});const Fa={class:"interaction-overlay"},Ba={key:0,class:"info"},ja={class:"canvas-container",ref:"canvasContainer"};let Na;Ra.render=function(e,t,n,r,i,a){const o=za;return u(),f("div",{class:["pathicles",{"is-interactive":e.isInteractive}],ref:"scrollContainer"},[y("div",Fa,[y("div",{class:"button",onClick:t[1]||(t[1]=t=>e.isInteractive=!e.isInteractive)},"Start")]),y(o,{shortcuts:["I","D","A","M","N","L","S","T"," "],debug:!1,onTriggered:e.onTriggeredEventHandler},null,8,["onTriggered"]),e.showInfo?(u(),f("dl",Ba,[(u(!0),f(x,null,w(e.info,((e,t)=>(u(),f("div",{key:t},[y("dt",null,A(t),1),y("dd",null,A(e),1)])))),128))])):_("",!0),y("div",ja,[y("canvas",{id:"canvas",ref:"canvas",style:e.canvasStyles,height:e.canvasHeight,width:e.canvasWidth},null,12,["height","width"])],512)],2)};const Wa={},Va=function(e,t){if(!t||0===t.length)return e();if(void 0===Na){const e=document.createElement("link").relList;Na=e&&e.supports&&e.supports("modulepreload")?"modulepreload":"preload"}return Promise.all(t.map((e=>{if(e in Wa)return;Wa[e]=!0;const t=e.endsWith(".css"),n=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${n}`))return;const r=document.createElement("link");return r.rel=t?"stylesheet":Na,t||(r.as="script",r.crossOrigin=""),r.href=e,document.head.appendChild(r),t?new Promise(((e,t)=>{r.addEventListener("load",e),r.addEventListener("error",t)})):void 0}))).then((()=>e()))},Ua=()=>Va((()=>import("./story-dipole.b9d4b7b0.js")),[]),Ha=()=>Va((()=>import("./story-electric.a3fe6dfb.js")),[]),Ya=()=>Va((()=>import("./story-quadrupole.aab31515.js")),[]);var Xa=h({name:"PathiclesStory",setup(e){const t=p(),n=d(null),r=d(null),i=d(null),{height:a,width:o}=m(),{height:l}=g(n),{y:c}=S(),{width:u,height:f}=g(r),h=v((()=>({width:u.value+"px",height:f.value+"px"}))),y=v((()=>Math.min(window.devicePixelRatio,e.maxPixelRatio))),x=v((()=>u.value*y.value)),w=v((()=>f.value*y.value)),_=d(0),A=d("guided"),T=d(0),E=d(null);b(c,(e=>{T.value=e/(l.value-f.value),E&&E.value&&(E.value.story.setPosition(T.value),_.value=E.value.story.getState().sceneIdx,M.value=E.value.story.getState().sceneProgress.toFixed(2))})),b(o,(()=>{E&&E.value&&E.value.resize()})),b(a,(()=>{E&&E.value&&E.value.resize()}));const C=e.story.scenes;C.forEach((e=>{e.duration=e.duration||(e.type&&e.type,1)})),C.duration=C.reduce(((e,t)=>e+t.duration),0),C.forEach((e=>{e.presetName=e.pathicles.preset,e.configuration=Ce(e.presetName),e.configuration.view.camera=s(s({},e.configuration.view.camera),e.pathicles.camera)}));const M=d(0);return{canvasContainer:r,scrollContainer:n,canvas:i,focused:t,scenes:C,pixelRatio:y,canvasStyles:h,canvasWidth:x,canvasHeight:w,activeSceneIdx:_,sceneProgress:M,progress:T,reglInstance:E,cameraMode:A}},props:{story:{type:Object,mandatory:!0},showInfo:{type:Boolean,default:!1},debug:{default:!0,type:Boolean},scrollFactor:{type:Number,default:1},maxCanvasWidth:{type:Number,default:2048},maxCanvasHeight:{type:Number,default:1024},maxPixelRatio:{type:Number,default:2}},mounted(){const e=(e,t,n,r)=>void 0===r?[[e[0===t?0:t-1].configuration.view.camera[n]],[e[t].configuration.view.camera[n]],[e[t<e.length-2?t+1:t].configuration.view.camera[n]]]:[[e[0===t?0:t-1].configuration.view.camera[n][r]],[e[t].configuration.view.camera[n][r]],[e[t<e.length-2&&0!==t?t+1:t].configuration.view.camera[n][r]]];this.story.scenes.forEach(((t,n)=>{t.cameraSploints={phi:e(this.story.scenes,n,"phi"),theta:e(this.story.scenes,n,"theta"),distance:e(this.story.scenes,n,"distance"),centerX:e(this.story.scenes,n,"center",0),centerY:e(this.story.scenes,n,"center",1),centerZ:e(this.story.scenes,n,"center",2)}})),this.story.scenes.forEach((e=>{e.pathicles&&e.pathicles.data&&("story-quadrupole.js"===e.pathicles.data?e.data=Ya:"story-dipole.js"===e.pathicles.data?e.data=Ua:e.data=Ha)})),this.$nextTick((()=>{this.reglInstance=new ka({canvas:this.canvas,pixelRatio:this.pixelRatio,control:{viewRange:this.viewRange,cameraMode:this.cameraMode,scenes:this.story.scenes}})}))},unmounted(){this.reglInstance.destroy()}});const Ga={key:0,class:"info"},qa=y("dt",null,"progress",-1),Za=y("dt",null,"sceneProgress",-1),Qa=y("dt",null,"activeSceneIdx",-1),$a=y("dt",null,"focused",-1),Ja={class:"canvas-container",ref:"canvasContainer"},Ka={class:"scenes"},eo={key:0,class:"scene-content-wrapper options"},to={class:"scene-main"},no={key:0,class:"subtitle"},ro={key:1,class:"subtitle"},io={class:"body"};Xa.render=function(e,t,n,r,i,a){return u(),f("div",{class:"pathicles-story__container",ref:"scrollContainer","data-active-scene":e.activeSceneIdx},[e.debug?(u(),f("dl",Ga,[y("div",null,[qa,y("dd",null,A(e.progress),1)]),y("div",null,[Za,y("dd",null,A(e.sceneProgress),1)]),y("div",null,[Qa,y("dd",null,A(e.activeSceneIdx),1)]),y("div",null,[$a,y("dd",null,A(e.focused),1)])])):_("",!0),y("div",Ja,[y("canvas",{id:"canvas",ref:"canvas",style:e.canvasStyles,height:e.canvasHeight,width:e.canvasWidth},null,12,["height","width"])],512),y("div",Ka,[(u(!0),f(x,null,w(e.story.scenes,((t,n)=>(u(),f("div",{class:["scene",t.type],id:"scrolly-story__scene--"+n,style:{height:100*t.duration+"vh"},key:"scene-"+n,"data-scene":n,"data-active":n===e.activeSceneIdx,"data-status":n===e.activeSceneIdx?"present":n<e.activeSceneIdx?"past":"future"},["options"===t.type?(u(),f("div",eo)):_("",!0),"caption"===t.type?(u(),f("div",{key:1,class:"scene-content-wrapper",id:"scrolly-story__scene-content-wrapper--"+n,style:{opacity:n===e.activeSceneIdx?1-4*e.sceneProgress:1}},[y("div",to,[y("div",{class:"title","data-index":t.scene_index},[t.title?(u(),f("span",{key:0,class:"pathicles",innerHTML:t.title},null,8,["innerHTML"])):_("",!0)],8,["data-index"]),t.subtitle_1_1?(u(),f("div",no,[y("span",{class:"pathicles",innerHTML:t.subtitle_1_1},null,8,["innerHTML"])])):_("",!0),t.subtitle_1_2?(u(),f("div",ro,[y("span",{class:"pathicles",innerHTML:t.subtitle_1_2},null,8,["innerHTML"])])):_("",!0),y("div",io,[y("p",{innerHTML:t.body},null,8,["innerHTML"])])])],12,["id"])):_("",!0)],14,["id","data-scene","data-active","data-status"])))),128))])],8,["data-active-scene"])};const ao={class:"configurator"},oo=C("preset"),so=y("option",{value:"story"},"STORY",-1);const lo={name:"App",components:{Pathicles:Ra,PathiclesStory:Xa},data:()=>({story:{scenes:[{type:"caption",title:"<strong>Wir&nbsp;beschleunigen</strong>",subtitle_1_1:"<strong>Teilchen</strong> in&nbsp;unseren&nbsp;Berufen",subtitle_1_2:"<strong>und die Beschleunigerphysik</strong> im Berufsverband.",image:"/images/story/story-electric.jpg",pathicles:{autoLoop:!0,preset:"story-electric",data:"story-electric.js",camera:{center:[0,1.5,0],distance:10,theta:0*Math.PI,phi:10/360*Math.PI}}},{type:"caption",title:"Beschleunigung<br><strong>macht&nbsp;schneller</strong>.",body:'Elektrische Krfte wirken sich auf Photonen, Elektronen und Protonen verschieden aus: Masselose <span class="photon">Photonen</span> sind immer mit Lichtgeschwindigkeit unterwegs, daran ndert auch eine Kraft nichts.  <span class="electron">Elektronen</span> werden rasch auf Fast-Lichtgeschwindigkeit beschleunigt, erreichen diese aber nie ganz. <span class="proton">Protonen</span> sind schwerer und brauchen etwas lnger, um in Fahrt zu kommen.\n',image:"/images/story/story-electric.jpg",scene_index:1,pathicles:{preset:"story-electric",data:"story-electric.js",camera:{center:[0,1.5,0],distance:5,theta:.5*Math.PI,phi:-10/360*Math.PI}}},{type:"caption",title:"Beschleunigung<br><strong>hlt&nbsp;auf&nbsp;Spur</strong>.",scene_index:2,body:"Magnetfelder wirken senkrecht zur Geschwindigkeit geladener Teilchen, die dadurch ihre Richtung ndern. Gleichfrmige Magnetfelder fhren zu einer Kreisbahn und kommen etwa in Ringbeschleunigern zum Einsatz.\n",image:"/images/story/story-dipole.jpg",pathicles:{preset:"story-dipole",data:"story-dipole.js",camera:{center:[0,1.5,0],distance:1,theta:.5*Math.PI,phi:-10/360*Math.PI}}},{type:"caption",title:"Beschleunigung<br><strong>schafft Zusammenhalt</strong>.",scene_index:3,body:"Magnetfelder, deren Strke mit Abstand zur optimalen Teilchenbahn zunimmt, wirken wie optische Linsen: In einer Ebene bringen sie die Teilchen zusammen, in der dazu senkrechten Ebene jedoch auseinander. In modernen Beschleunigern sorgen hunderte solcher Bndelungsmagnete fr den Zusammenhalt.\n",image:"/images/story/story-quadrupole.jpg",pathicles:{preset:"story-quadrupole",data:"story-quadrupole.js",camera:{center:[0,1.5,0],distance:10,theta:.75*Math.PI,phi:-10/360*Math.PI}}},{type:"options",pathicles:{autoLoop:!0,preset:"story-empty",data:"story-electric.js",camera:{center:[0,1.5,0],distance:10,theta:1*Math.PI,phi:-10/360*Math.PI}}},{type:"options",pathicles:{autoLoop:!0,preset:"story-empty",data:"story-electric.js",camera:{center:[0,1.5,0],distance:10,theta:1*Math.PI,phi:-10/360*Math.PI}}}]},presets:Ee,presetName:"story-electric"}),computed:{urlSearchParams:()=>{let e=new URL(window.location.href);return new URLSearchParams(e.search)},printMode:function(){return null!==this.urlSearchParams.get("print")},prerender:function(){return null!==this.urlSearchParams.get("prerender")}},beforeMount(){this.urlSearchParams.get("presetName")&&(this.presetName=this.urlSearchParams.get("presetName"))},mounted(){this.onPresetChange()},methods:{onPresetChange(){let e=this.urlSearchParams;e.set("presetName",this.presetName),history.pushState({},null,document.location.pathname+"?"+e.toString())}},render:function(e,t,n,r,i,a){const o=Xa,s=Ra;return u(),f("div",{class:["app",{print:a.printMode}]},[y("div",ao,[y("label",null,[oo,T(y("select",{"onUpdate:modelValue":t[1]||(t[1]=t=>e.presetName=t),onChange:t[2]||(t[2]=e=>a.onPresetChange(e))},[so,(u(!0),f(x,null,w(Object.keys(e.presets),(t=>(u(),f("option",{value:t,selected:t===e.presetName},A(t),9,["value","selected"])))),256))],544),[[E,e.presetName]])])]),"story"===e.presetName?(u(),f(o,{key:0,story:e.story},null,8,["story"])):(u(),f(s,{key:1,"preset-name":e.presetName,prerender:a.prerender,"click-to-interact":!1},null,8,["preset-name","prerender","click-to-interact"]))],2)}};M(lo).mount("#app");
